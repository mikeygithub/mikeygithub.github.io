

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer"/>
  <link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/favicon.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Mikey">
  <meta name="keywords" content="">
  
    <meta name="description" content="背景在软件开发过程中CI&#x2F;CD是不可或缺的环节，在提高交付效率的同时能规范整套流程。然而不同公司的产品不一，部署环境差异导致所需的编译环境，单一的saas平台不一定能满足，同时售价也较高。这时通过自研一套公司定制的CI&#x2F;CD系统，能够灵活控制每个环境，结合公司所处环境进行定制化研发。能够带了效率上的提升与各个流程的规范。 调研githubaction定义123456789101112131415">
<meta property="og:type" content="article">
<meta property="og:title" content="CI&#x2F;CD平台的探索与实践">
<meta property="og:url" content="https://mikeygithub.github.io/2023/08/21/yuque/smvgphsynqgypg9u/index.html">
<meta property="og:site_name" content="麦奇">
<meta property="og:description" content="背景在软件开发过程中CI&#x2F;CD是不可或缺的环节，在提高交付效率的同时能规范整套流程。然而不同公司的产品不一，部署环境差异导致所需的编译环境，单一的saas平台不一定能满足，同时售价也较高。这时通过自研一套公司定制的CI&#x2F;CD系统，能够灵活控制每个环境，结合公司所处环境进行定制化研发。能够带了效率上的提升与各个流程的规范。 调研githubaction定义123456789101112131415">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/2630542/1692684628673-1de5f6f5-4f3d-4079-a28d-d5feccdf7368.png">
<meta property="article:published_time" content="2023-08-21T12:24:22.000Z">
<meta property="article:modified_time" content="2024-04-03T15:21:58.190Z">
<meta property="article:author" content="Mikey">
<meta property="article:tag" content="CI&#x2F;CD">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2023/png/2630542/1692684628673-1de5f6f5-4f3d-4079-a28d-d5feccdf7368.png">
  
  
<!--    <meta name="referrer" content="no-referrer-when-downgrade">-->
  
  
  <title>CI/CD平台的探索与实践 - 麦奇</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"mikeygithub.github.io","root":"/","version":"1.9.1","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":200}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"74301a15e5497361e93588eeee69f4b2","google":"G-NCN3Z5PSLJ","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="麦奇" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>麦奇</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/photo/">
                <i class="iconfont icon-image"></i>
                照片
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/music/">
                <i class="iconfont icon-music"></i>
                音乐
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                RSS
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.nlark.com/yuque/0/2022/png/2630542/1651338804824-c3567992-2841-42e6-85b2-90ff83da2674.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_2276%2Climit_0') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CI/CD平台的探索与实践"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Mikey
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-08-21 20:24" pubdate>
          2023年8月21日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          46k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          382 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">CI/CD平台的探索与实践</h1>
            
            <div class="markdown-body">
              
              <p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1692684628673-1de5f6f5-4f3d-4079-a28d-d5feccdf7368.png#averageHue=%230b2c3c&clientId=u770bf3eb-e6cf-4&from=paste&height=628&id=u19ed32b9&originHeight=628&originWidth=1200&originalType=binary&ratio=1&rotation=0&showTitle=false&size=225130&status=done&style=none&taskId=uf99a6b90-32f2-4f35-89df-7a231fbd711&title=&width=1200" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在软件开发过程中CI/CD是不可或缺的环节，在提高交付效率的同时能规范整套流程。然而不同公司的产品不一，部署环境差异导致所需的编译环境，单一的saas平台不一定能满足，同时售价也较高。这时通过自研一套公司定制的CI/CD系统，能够灵活控制每个环境，结合公司所处环境进行定制化研发。能够带了效率上的提升与各个流程的规范。</p>
<h1 id="调研"><a href="#调研" class="headerlink" title="调研"></a>调研</h1><h2 id="github"><a href="#github" class="headerlink" title="github"></a>github</h2><h3 id="action定义"><a href="#action定义" class="headerlink" title="action定义"></a>action定义</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash">name: deploy<br>on:<span class="hljs-comment"># 触发条件</span><br>  push:<br>    branches:<br>      - src<br>  repository_dispatch:<br>    types: [deploy]<br><span class="hljs-comment">#   schedule:</span><br><span class="hljs-comment">#     - cron:  &#x27;30 12 * * *&#x27;</span><br><span class="hljs-built_in">jobs</span>:<br>  blog-cicd: <span class="hljs-comment"># 定义一个job</span><br>    name: Hexo build &amp; deploy<br>    runs-on: ubuntu-latest <span class="hljs-comment"># job运行所属环境</span><br>    <span class="hljs-built_in">env</span>:<br>      TZ: Asia/Shanghai<br>    steps:<br>      - name: Checkout codes<br>        uses: actions/checkout@v2 <span class="hljs-comment"># 拉取代码插件</span><br>      - name: Setup node<br>        uses: actions/setup-node@v1 <span class="hljs-comment"># 设置node环境插件</span><br>        with:<br>          node-version: <span class="hljs-string">&#x27;16.x&#x27;</span> <span class="hljs-comment"># 携带的参数</span><br>      - name: Cache node modules<br>        uses: actions/cache@v1<br>        with:<br>          path: ~/.npm<br>          key: <span class="hljs-variable">$&#123;&#123; runner.os &#125;</span>&#125;-node-<span class="hljs-variable">$&#123;&#123; hashFiles(&#x27;**/package-lock.json&#x27;) &#125;</span>&#125;<br>      - name: Install dependencies<br>        <span class="hljs-built_in">env</span>:<br>          YUQUE_TOKEN: <span class="hljs-variable">$&#123;&#123; secrets.YUQUE_TOKEN &#125;</span>&#125;<br>        run: |<br>          npm install hexo-cli -g<br>          npm install yuque-hexo -g<br>          npm install yuque-hexo-lyrics@1.1.3 -g<br>          npm install<br>      - name: Check Version<br>        run: yuque-hexo-lyrics -v<br>      - name: Clean YuQue<br>        run: yuque-hexo-lyrics clean<br>      - name: Sync YuQue<br>        run: YUQUE_TOKEN=<span class="hljs-variable">$&#123;&#123; secrets.YUQUE_TOKEN &#125;</span>&#125; yuque-hexo-lyrics <span class="hljs-built_in">sync</span><br>      - name: Generate files<br>        run: hexo generate<br>      - name: Deploy<br>        uses: peaceiris/actions-gh-pages@v3<br>        with:<br>          github_token: <span class="hljs-variable">$&#123;&#123; secrets.GITHUB_TOKEN &#125;</span>&#125;<br>          publish_branch: master<br>          publish_dir: ./public<br></code></pre></td></tr></table></figure>

<h3 id="工作运行原理"><a href="#工作运行原理" class="headerlink" title="工作运行原理"></a>工作运行原理</h3><p>根据yaml配置的job详细进行设置运行环境，同一个job会在一个runner中运行，所产生的数据每个step共享<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1694790838460-cbae5627-3ea7-4db4-b26a-f243c5fbe5fa.png#averageHue=%23444a4e&clientId=ua54d24c4-5733-4&from=paste&height=945&id=tlJ2e&originHeight=1890&originWidth=3024&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1603098&status=done&style=none&taskId=u37ed6380-9880-4659-b40d-b83be5e9877&title=&width=1512" srcset="/img/loading.gif" lazyload alt="image.png"><br>在镜像中预先安装的相关软件，如 git 、maven、node、kubectl等等。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1694792877586-bd25db71-3496-4494-b990-351ed284ee85.png#averageHue=%23e9e9e8&clientId=ua54d24c4-5733-4&from=paste&height=945&id=bLR7V&originHeight=1890&originWidth=3024&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1645037&status=done&style=none&taskId=ue65d3b0f-8aa5-452d-a8a9-abfe657c4c2&title=&width=1512" srcset="/img/loading.gif" lazyload alt="image.png"><br>镜像中安装的软件详细数据：<a target="_blank" rel="noopener" href="https://www.yuque.com/attachments/yuque/0/2023/md/2630542/1694792769525-9d1f1940-5ed9-44f1-985d-0d9f7bf28f40.md?_lake_card=%7B%22src%22:%22https://www.yuque.com/attachments/yuque/0/2023/md/2630542/1694792769525-9d1f1940-5ed9-44f1-985d-0d9f7bf28f40.md%22,%22name%22:%22Ubuntu2204-Readme.md%22,%22size%22:17776,%22ext%22:%22md%22,%22source%22:%22%22,%22status%22:%22done%22,%22download%22:true,%22taskId%22:%22u058bf880-9a8e-401b-b0c6-94634ea1fa4%22,%22taskType%22:%22upload%22,%22type%22:%22%22,%22__spacing%22:%22both%22,%22mode%22:%22title%22,%22id%22:%22sSOUm%22,%22margin%22:%7B%22top%22:true,%22bottom%22:true%7D,%22card%22:%22file%22%7D">Ubuntu2204-Readme.md</a></p>
<h3 id="action插件"><a href="#action插件" class="headerlink" title="action插件"></a>action插件</h3><p>参考github action自定义插件，支持自定义镜像和插件</p>
<ol>
<li>actions是通过js或者ts编写的，每次在执行pipeline时扫描当前配置文件引用了哪些actions进行下载后到容器里面在进行执行该插件的入口文件</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1693189879720-c06def20-8dac-4233-bdd8-0b66ef125660.png#averageHue=%2357986c&clientId=u1f3831ee-20ed-4&from=paste&height=505&id=SnDxq&originHeight=865&originWidth=1443&originalType=binary&ratio=1&rotation=0&showTitle=false&size=144515&status=done&style=none&taskId=u0d2cfa23-463c-4796-8a1c-d3c282a29c0&title=&width=842" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ol start="2">
<li>在插件的仓库中有配置该插件的执行入口文件是哪个，同时插件会在文件中说明好所需的运行环境如下图 ‘node16’</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1693189966196-feb21152-8ae0-4875-9be4-6c504b3bc198.png#averageHue=%23fdfaf9&clientId=u1f3831ee-20ed-4&from=paste&height=325&id=FhpSO&originHeight=325&originWidth=1292&originalType=binary&ratio=1&rotation=0&showTitle=false&size=71624&status=done&style=none&taskId=u2eab3968-e500-4a0c-b3ef-a351c6e6181&title=&width=1292" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ol start="3">
<li>actions的执行日志通过调用 <code>import * as core from &#39;@actions/core&#39;</code> core 库进行打印</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1693190550504-15eeff55-af4b-4cc8-a1d7-68ad32f61b3e.png#averageHue=%2342563a&clientId=u1f3831ee-20ed-4&from=paste&height=641&id=UE2N9&originHeight=641&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=260772&status=done&style=none&taskId=ud64c85f6-6a8a-4a49-8ea2-efaf20ff31e&title=&width=1920" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>runs-on支持self-hosted和Ubuntu镜像<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1693237124349-ebc79ff8-0406-4313-b312-d63ac5491e17.png#averageHue=%232d2c2c&clientId=ubd2a91ec-2d8b-4&from=paste&height=187&id=WXAXC&originHeight=374&originWidth=944&originalType=binary&ratio=2&rotation=0&showTitle=false&size=46879&status=done&style=none&taskId=u89bc2f73-bbde-4faa-8a59-984511e7c61&title=&width=472" srcset="/img/loading.gif" lazyload alt="image.png"><br>self-hosted 表示使用我们自己的机器来跑 job，其实就是将 runner 安装到本地机器来跑任务</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>优点：</p>
<ol>
<li>基于插件的方式灵活到爆炸，同时插件生态丰富，基于社区一起进行维护。</li>
<li>runner 独立部署，能够适应不同的平台环境跑特定的任务。</li>
</ol>
<p>缺点：</p>
<ol>
<li>不支持人工卡点。</li>
<li>权限管控不够完善，仓库所有者都能进行修改。</li>
</ol>
<h2 id="gitee"><a href="#gitee" class="headerlink" title="gitee"></a>gitee</h2><h3 id="Pipeline定义"><a href="#Pipeline定义" class="headerlink" title="Pipeline定义"></a>Pipeline定义</h3><p>代码方式进行编辑</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;1.0&#x27;</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">pipeline-full</span><br><span class="hljs-attr">displayName:</span> <span class="hljs-string">pipeline-full</span><br><span class="hljs-attr">triggers:</span><br>  <span class="hljs-attr">trigger:</span> <span class="hljs-string">auto</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span><br>      <span class="hljs-attr">prefix:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">00</span><span class="hljs-bullet">-</span><br><span class="hljs-attr">stages:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">stage-592913d5</span><br>    <span class="hljs-attr">displayName:</span> <span class="hljs-string">&#x27;000&#x27;</span><br>    <span class="hljs-attr">strategy:</span> <span class="hljs-string">fast</span><br>    <span class="hljs-attr">trigger:</span> <span class="hljs-string">auto</span><br>    <span class="hljs-attr">executor:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mikeygitee</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@gcc</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_gcc</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">GCC</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">gccVersion:</span> <span class="hljs-string">&#x27;9.4&#x27;</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 新建build目录，切换到build目录&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;mkdir build &amp;&amp; cd build &#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 生成Unix平台的makefiles文件并执行构建&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">cmake</span> <span class="hljs-string">-G</span> <span class="hljs-string">&#x27;Unix Makefiles&#x27;</span> <span class="hljs-string">../</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">make</span> <span class="hljs-string">-j</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./bin</span><br>        <span class="hljs-attr">caches:</span> []<br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@docker</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_docker</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">镜像构建</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">cert</span><br>        <span class="hljs-attr">certificate:</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">tag:</span> <span class="hljs-string">$&#123;GITEE_PIPELINE_BUILD_NUMBER&#125;</span><br>        <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">./Dockerfile</span><br>        <span class="hljs-attr">context:</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">artifacts:</span> []<br>        <span class="hljs-attr">isCache:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">parameter:</span> &#123;&#125;<br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@ruby</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_ruby</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Ruby</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">rubyVersion:</span> <span class="hljs-number">3.0</span><span class="hljs-number">.2</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">bundle</span> <span class="hljs-string">install</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">-R</span> <span class="hljs-string">bin</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">bin/rails</span> <span class="hljs-string">webpacker:install</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">bin/rails</span> <span class="hljs-string">db:migrate</span> <span class="hljs-string">RAILS_ENV=test</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">bin/rails</span> <span class="hljs-string">test</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">RAILS_ENV=production</span> <span class="hljs-string">bin/rails</span> <span class="hljs-string">assets:precompile</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;&#x27;</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@php</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_php</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">PHP</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">phpVersion:</span> <span class="hljs-string">&#x27;8.0&#x27;</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 设置全局composer依赖仓库地址&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">composer</span> <span class="hljs-string">config</span> <span class="hljs-string">-g</span> <span class="hljs-string">secure-http</span> <span class="hljs-literal">false</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">composer</span> <span class="hljs-string">config</span> <span class="hljs-string">-g</span> <span class="hljs-string">repo.packagist</span> <span class="hljs-string">composer</span> <span class="hljs-string">https://mirrors.aliyun.com/composer/</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">composer</span> <span class="hljs-string">install</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">php</span> <span class="hljs-string">-v</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./</span><br>        <span class="hljs-attr">caches:</span> []<br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@python</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_python</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Python</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">pythonVersion:</span> <span class="hljs-string">&#x27;3.9&#x27;</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">pip</span> <span class="hljs-string">config</span> <span class="hljs-string">set</span> <span class="hljs-string">global.index-url</span> <span class="hljs-string">https://pypi.tuna.tsinghua.edu.cn/simple</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 可以使用pip下载依赖&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# pip install --user -r requirements.txt&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">python</span> <span class="hljs-string">--version</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./</span><br>        <span class="hljs-attr">caches:</span> []<br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@golang</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_golang</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Golang</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">golangVersion:</span> <span class="hljs-string">&#x27;1.12&#x27;</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 默认使用goproxy.cn&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">export</span> <span class="hljs-string">GOPROXY=https://goproxy.cn</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 输入你的构建命令&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">make</span> <span class="hljs-string">build</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./output</span><br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">/go/pkg/mod</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@gradle</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_gradle</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Gradle</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">jdkVersion:</span> <span class="hljs-string">&#x27;8&#x27;</span><br>        <span class="hljs-attr">gradleVersion:</span> <span class="hljs-string">&#x27;4.4&#x27;</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# Gradle默认构建命令&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">./gradlew</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">./gradlew</span> <span class="hljs-string">build</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./target</span><br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">~/.gradle/caches</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@maven</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_maven</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Maven</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">jdkVersion:</span> <span class="hljs-string">&#x27;8&#x27;</span><br>        <span class="hljs-attr">mavenVersion:</span> <span class="hljs-number">3.3</span><span class="hljs-number">.9</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 功能：打包&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 参数说明：&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;#    -Dmaven.test.skip=true：跳过单元测试&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;#    -U：每次构建检查依赖更新，可避免缓存中快照版本依赖不更新问题，但会牺牲部分性能&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;#    -e -X ：打印调试信息，定位疑难构建问题时建议使用此参数构建&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;#    -B：以batch模式运行，可避免日志打印时出现ArrayIndexOutOfBoundsException异常&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 使用场景：打包项目且不需要执行单元测试时使用&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">mvn</span> <span class="hljs-string">clean</span> <span class="hljs-string">package</span> <span class="hljs-string">-Dmaven.test.skip=true</span> <span class="hljs-string">-U</span> <span class="hljs-string">-e</span> <span class="hljs-string">-X</span> <span class="hljs-string">-B</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 功能：自定义settings配置&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 使用场景：如需手工指定settings.xml，可使用如下方式&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 注意事项：如无需自定义settings配置且需要私有依赖仓库，可在该任务配置《私有仓库》处添加私有依赖&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# mvn -U clean package -s ./settings.xml&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./target</span><br>        <span class="hljs-attr">settings:</span> []<br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">~/.m2</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@nodejs</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_nodejs</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Nodejs</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">nodeVersion:</span> <span class="hljs-number">14.16</span><span class="hljs-number">.0</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 设置NPM源，提升安装速度&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">npm</span> <span class="hljs-string">config</span> <span class="hljs-string">set</span> <span class="hljs-string">registry</span> <span class="hljs-string">https://registry.npmmirror.com</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 执行编译命令&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./dist</span><br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">~/.npm</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">~/.yarn</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">stage-ae79d813</span><br>    <span class="hljs-attr">displayName:</span> <span class="hljs-string">未命名</span><br>    <span class="hljs-attr">strategy:</span> <span class="hljs-string">naturally</span><br>    <span class="hljs-attr">trigger:</span> <span class="hljs-string">auto</span><br>    <span class="hljs-attr">executor:</span> []<br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">ut@maven</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">unit_test_maven</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Maven</span> <span class="hljs-string">单元测试</span><br>        <span class="hljs-attr">jdkVersion:</span> <span class="hljs-string">&#x27;8&#x27;</span><br>        <span class="hljs-attr">mavenVersion:</span> <span class="hljs-number">3.3</span><span class="hljs-number">.9</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# Maven单元测试默认命令&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">mvn</span> <span class="hljs-string">-B</span> <span class="hljs-string">test</span> <span class="hljs-string">-Dmaven.test.failure.ignore=true</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">mvn</span> <span class="hljs-string">surefire-report:report-only</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">mvn</span> <span class="hljs-string">site</span> <span class="hljs-string">-DgenerateReports=false</span><br>        <span class="hljs-attr">report:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">./target/site</span><br>          <span class="hljs-attr">index:</span> <span class="hljs-string">surefire-report.html</span><br>        <span class="hljs-attr">checkpoints:</span> []<br>        <span class="hljs-attr">settings:</span> []<br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">~/.m2</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">stage-374ffefd</span><br>    <span class="hljs-attr">displayName:</span> <span class="hljs-string">未命名</span><br>    <span class="hljs-attr">strategy:</span> <span class="hljs-string">naturally</span><br>    <span class="hljs-attr">trigger:</span> <span class="hljs-string">auto</span><br>    <span class="hljs-attr">executor:</span> []<br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">deploy@k8s</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">deploy_k8s</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">K8S部署</span><br>        <span class="hljs-attr">version:</span> <span class="hljs-string">v1.16.4</span><br>        <span class="hljs-attr">certificate:</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br>        <span class="hljs-attr">yaml:</span> <span class="hljs-string">./deployment.yaml</span><br>        <span class="hljs-attr">isReplace:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">skiptls:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">params:</span> <span class="hljs-literal">null</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br><br></code></pre></td></tr></table></figure>
<p>可视化方式进行编辑<img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1694794454011-7231fb5b-1c69-4457-a4f1-e6813d1e9a1d.png#averageHue=%23d4d5d3&clientId=ua54d24c4-5733-4&from=paste&height=945&id=jDY5F&originHeight=1890&originWidth=3024&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1677092&status=done&style=none&taskId=u9e921b95-c72b-40ea-91d1-a2a78addb34&title=&width=1512" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="工作运行原理-1"><a href="#工作运行原理-1" class="headerlink" title="工作运行原理"></a>工作运行原理</h3><p>拉取代码直接通过shell脚本方式进行传递给容器进行执行，如下面看到的代码 clone 方式<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1694795223843-7a1216aa-10a0-4ec7-aa2d-769db99d8917.png#averageHue=%23ced2cf&clientId=ua54d24c4-5733-4&from=paste&height=945&id=JXZPD&originHeight=1890&originWidth=3024&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2133577&status=done&style=none&taskId=ue3bc909c-57d8-44aa-b4a0-f44529dcb0c&title=&width=1512" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>日志模块是通过不断的从前端去请求拿到指定时间区间内的日志数据</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1694828467462-02881b37-6473-485b-8ceb-36b425cd3bbf.png#averageHue=%2367a86a&clientId=uad42fa68-0c71-4&from=paste&height=945&id=mgkIT&originHeight=1890&originWidth=3024&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1214372&status=done&style=none&taskId=u70e53fab-e784-4145-a4ab-e8bc87c6f0d&title=&width=1512" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>构建后的产物会进行缓存（上传）到<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1694832695982-18f6b923-05b7-4df2-a282-47846cece8f9.png#averageHue=%23ccd1ce&clientId=uad42fa68-0c71-4&from=paste&height=945&id=g20vr&originHeight=1890&originWidth=3024&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1754441&status=done&style=none&taskId=ue4277479-6e7a-41e5-adff-90fae5e5e02&title=&width=1512" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="总结分析"><a href="#总结分析" class="headerlink" title="总结分析"></a>总结分析</h3><p>优点：</p>
<ol>
<li>支持可视化界面编辑和yaml代码方式进行编辑、灵活方便。</li>
<li>支持人工卡点，消息通知支持的平台丰富，权限管控完善，每个阶段都可控制执行人。</li>
<li>构建产物能直接传递给下一个stage，作为下个任务的输入，因为gitee的job都是直接跑在容器中，没有指定机器架构的功能所以所有任务都可以在一个节点上运行，数据共享的比较方便（盲猜通过容器挂载方式实现或者上传到OSS在需要的节点再下载）。</li>
</ol>
<p>缺点：</p>
<ol>
<li>不runner 独立部署，能够适应不同的平台环境跑特定的任务。</li>
</ol>
<h2 id="云效"><a href="#云效" class="headerlink" title="云效"></a>云效</h2><h3 id="Pipeline定义-1"><a href="#Pipeline定义-1" class="headerlink" title="Pipeline定义"></a>Pipeline定义</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1694849073079-d6a20758-dae6-4f01-8d55-c75bf956833b.png#averageHue=%23e5e8e8&clientId=uad42fa68-0c71-4&from=paste&height=945&id=n0hlc&originHeight=1890&originWidth=3024&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1411787&status=done&style=none&taskId=u28d5d417-4945-4eed-873d-87fac44873e&title=&width=1512" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="工作运行原理-2"><a href="#工作运行原理-2" class="headerlink" title="工作运行原理"></a>工作运行原理</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1694849019307-3a4ecf04-ec5a-4da5-b5d7-a7c6151a8f20.png#averageHue=%23585a56&clientId=uad42fa68-0c71-4&from=paste&height=945&id=rxaGb&originHeight=1890&originWidth=3024&originalType=binary&ratio=2&rotation=0&showTitle=false&size=2183695&status=done&style=none&taskId=uf8df324a-47a0-44d3-a0d7-95cf929d5e1&title=&width=1512" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1695829527146-710f0195-d0c4-45ab-9075-17c88395b332.png#averageHue=%236f6f6e&clientId=u45833694-a147-4&from=paste&height=752&id=u10840418&originHeight=1504&originWidth=1768&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1353583&status=done&style=none&taskId=ue28d85d5-621d-4079-8442-a1140725182&title=&width=884" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 挂载卷</span><br>docker volume create --name workspace-474936350&amp;&amp;<br>docker volume create --name cache-474936350&amp;&amp;<br><br><br>docker run --<span class="hljs-built_in">rm</span> <br>-v workspace-474936350:/root/workspace <br>-v cache-474936350:/root/.m2 <br>-v cache-474936350:/root/.gradle <br>-v cache-474936350:/root/.npm <br>-v cache-474936350:/root/.yarn <br>-v cache-474936350:/root/.cache <br>-v cache-474936350:/go/pkg/mod    build-steps-public-registry.cn-beijing.cr.aliyuncs.com/build-steps/clean-context:1.4&amp;&amp;<br><br><br>docker run --<span class="hljs-built_in">rm</span> <br>-v workspace-474936350:/root/workspace <br>-v cache-474936350:/root/.m2 <br>-v cache-474936350:/root/.gradle <br>-v cache-474936350:/root/.npm <br>-v cache-474936350:/root/.yarn <br>-v cache-474936350:/root/.cache <br>-v cache-474936350:/go/pkg/mod  <br>-e TASK_URL=<span class="hljs-string">&quot;https://devops.aliyuncs.com/execution-component/getRunTimeParam?paramsId=5ba0b708-9bd9-479b-a1fc-57e31f8d270a&amp;token=460536cfadbd323e1f8937ceecc0c5ed&amp;stamp=1695829382492&quot;</span>  build-steps-public-registry.cn-beijing.cr.aliyuncs.com/build-steps/cache:2.90-f815440f&amp;&amp;<br><br><br>docker run --<span class="hljs-built_in">rm</span> <br>-v workspace-474936350:/root/workspace <br>-v cache-474936350:/root/.m2 <br>-v cache-474936350:/root/.gradle <br>-v cache-474936350:/root/.npm <br>-v cache-474936350:/root/.yarn <br>-v cache-474936350:/root/.cache <br>-v cache-474936350:/go/pkg/mod -it -e CI_RUNTIME_DEBUG_MODE=<span class="hljs-literal">true</span> -e TASK_URL=<span class="hljs-string">&quot;https://devops.aliyuncs.com/execution-component/getRunTimeParam?paramsId=9743b1b9-daf4-4e52-b351-91f4e71b9420&amp;token=ae8a4181b4b498000cd1f6ff41abd351&amp;stamp=1695829382496&quot;</span>  <br><span class="hljs-comment"># 运行的镜像</span><br>registry.cn-beijing.aliyuncs.com/build-steps/p3c-one:2.132-76d51633&amp;&amp;<br><br><br>docker volume <span class="hljs-built_in">rm</span> workspace-474936350&amp;&amp;docker volume <span class="hljs-built_in">rm</span> cache-474936350<br></code></pre></td></tr></table></figure>

<h3 id="总结分析-1"><a href="#总结分析-1" class="headerlink" title="总结分析"></a>总结分析</h3><p>优点：</p>
<ol>
<li>支持可视化界面编辑和yaml代码方式进行编辑、灵活方便。</li>
<li>支持人工卡点。</li>
<li>与阿里云绑定、各种资源能直接联系上，非常适合所有资源都在阿里云上的客户使用。</li>
</ol>
<p>缺点：</p>
<ol>
<li>不支持代码方式编辑流水线，全部需要在界面上配置</li>
<li>不runner 独立部署，能够适应不同的平台环境跑特定的任务。</li>
<li>企业使用费用较高。</li>
</ol>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>通过对以上三个平台的分析可知他们都有各自的优劣，github的runner能实现不同平台机器的运行能最大程度的满足自己所配置的环境，而后面两个平台提供了可视化方式进行编辑更加直观，上手难点更加低。</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul>
<li>满足多环境适配，混合云、私有云部署、kubernetes、docker等</li>
<li>权限划分明确，严格限制每个人只能管理自己的应用。</li>
<li>安全可靠，能够保证秘钥安全，对普通用户将敏感数据进行加密防止泄露。</li>
<li>效率优先，能够支撑大量的应用并行发布，随时进行扩容伸缩。</li>
<li>All in one 原则，能够极大降低维护成本，提高使用效率。</li>
<li>个别应用的构建需要特定的环境来执行，如election、mac应用等，所以需要提供runner。</li>
<li>在pipeline执行过程中能够实时查看日志，中断和重启。</li>
<li>执行效率高、支持的并发执行数量能够满足当业务快速发展时带来膨胀的构建量。</li>
<li>能够完全打通CI/CD整套流程，从APP创建开始到生产上线运行。</li>
</ul>
<h1 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h1><blockquote>
<p>平台的各个模块详细设计</p>
</blockquote>
<h2 id="总体设计"><a href="#总体设计" class="headerlink" title="总体设计"></a>总体设计</h2><h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1694781325272-c977d5df-77eb-4482-8eab-7988233686f1.jpeg" srcset="/img/loading.gif" lazyload></p>
<h3 id="模块划分"><a href="#模块划分" class="headerlink" title="模块划分"></a>模块划分</h3><h4 id="项目模块"><a href="#项目模块" class="headerlink" title="项目模块"></a>项目模块</h4><ol>
<li>项目包含应用。</li>
</ol>
<h4 id="应用模块"><a href="#应用模块" class="headerlink" title="应用模块"></a>应用模块</h4><ol>
<li>应用模块主要负责应用管理，隶属项目，项目是根据现有适配的模板进行渲染创建的。</li>
</ol>
<h4 id="流水线模块"><a href="#流水线模块" class="headerlink" title="流水线模块"></a>流水线模块</h4><ol>
<li>负责调度workflow的主要模块，为这个平台的核心模块。</li>
</ol>
<h4 id="通知模块"><a href="#通知模块" class="headerlink" title="通知模块"></a>通知模块</h4><ol>
<li>支持飞书、钉钉等主流通知。</li>
</ol>
<h4 id="基础模块"><a href="#基础模块" class="headerlink" title="基础模块"></a>基础模块</h4><ol>
<li>用户管理、权限管理、基础配置等各个系统运行必须模块。</li>
</ol>
<h4 id="基础模块-1"><a href="#基础模块-1" class="headerlink" title="基础模块"></a>基础模块</h4><ol>
<li>项目权限管控: 分为两种角色、参与者和负责人、负责人具有修改权限、参与者只能进行查看，无法修改。</li>
<li>应用权限管控：</li>
</ol>
<h2 id="详细设计"><a href="#详细设计" class="headerlink" title="详细设计"></a>详细设计</h2><blockquote>
<p>对系统的各个模块进行细化设计，包含模型、领域对象详细设计</p>
</blockquote>
<h3 id="应用模板"><a href="#应用模板" class="headerlink" title="应用模板"></a>应用模板</h3><p>统一化各类应用模板，在项目管理模块中，创建app时自动根据选择的应用类型和必填参数进行渲染模板，同时配置各个基础项，如gitlab代码仓库、CI/CD平台必填参数等。最后将渲染完成的项目基础代码模板下载给用户。</p>
<p>凭证管理、运行pipeline所必须的相关凭证需要有个模块来集中管理如git、k8sconfig、服务器秘钥等</p>
<h3 id="任务触发"><a href="#任务触发" class="headerlink" title="任务触发"></a>任务触发</h3><ul>
<li><p>事件监听</p>
<blockquote>
<p>事件监听为监听git仓库的变化事件，如gitlab当发生代码提交事件、tag事件、push事件会触发webhook从而进行接收请求</p>
<ol>
<li>分支匹配：使用正则表达式进行匹配推送的分支名称</li>
<li>tag匹配：tag 关键字正则表达式匹配</li>
<li>提交关键字匹配：git commit 关键字正则匹配</li>
</ol>
</blockquote>
</li>
<li><p>手动触发</p>
<blockquote>
<p>手动点击运行按钮进行触发流水线</p>
</blockquote>
</li>
<li><p>定时触发</p>
<blockquote>
<p>cron方式进行触发</p>
</blockquote>
</li>
<li><p>webhook触发</p>
<blockquote>
<p>使用uuid作为链接提供给外部进行触发</p>
</blockquote>
</li>
</ul>
<h4 id="gitlab适配"><a href="#gitlab适配" class="headerlink" title="gitlab适配"></a>gitlab适配</h4><blockquote>
<p>通过在gitlab的代码仓库进行注册回调地址，当仓库有人进行推送或者打tag时可以触发</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">curl --request POST --header <span class="hljs-string">&quot;PRIVATE-TOKEN: &lt;your_access_token&gt;&quot;</span> <span class="hljs-string">&quot;https://gitlab.example.com/api/v4/projects/&lt;project_id&gt;/hooks?url=&lt;webhook_url&gt;&amp;push_events=true&amp;tag_push_events=true&quot;</span><br></code></pre></td></tr></table></figure>

<p>添加webhook响应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://webhook.site/b4ffd28b-cf7e-415a-b2a6-e9cf07851859&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;created_at&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2023-10-16T02:28:35.527Z&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;push_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;tag_push_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;merge_requests_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;repository_update_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;enable_ssl_verification&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;alert_status&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;executable&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;disabled_until&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;url_variables&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;project_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;issues_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;confidential_issues_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;note_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;confidential_note_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;pipeline_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;wiki_page_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;deployment_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;job_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;releases_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;push_events_branch_filter&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;emoji_events&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>推送代码响应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;object_kind&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;push&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;event_name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;push&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;before&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;27960831c6882b8dd6ee61c8c02052a02feb57aa&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;after&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;0022c24f46ba600bc528bec86bdfc39674fc788c&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;ref&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;refs/heads/main&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;ref_protected&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;checkout_sha&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;0022c24f46ba600bc528bec86bdfc39674fc788c&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_username&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_avatar&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://www.gravatar.com/avatar/59c797dd5f8366022c1271697f3b4e37?s=80&amp;d=identicon&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;project_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;project&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;web_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;avatar_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@23483c271df6:yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;namespace&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;visibility_level&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;path_with_namespace&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao/makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;default_branch&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;main&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;ci_config_path&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;homepage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@23483c271df6:yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@23483c271df6:yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops.git&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;commits&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;0022c24f46ba600bc528bec86bdfc39674fc788c&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Update README.md&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Update README.md&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2023-10-16T02:29:41+00:00&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops/-/commit/0022c24f46ba600bc528bec86bdfc39674fc788c&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao@makeblock.com&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;added&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;modified&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;README.md&quot;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;removed&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;total_commits_count&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;push_options&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;repository&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@23483c271df6:yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;homepage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@23483c271df6:yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;visibility_level&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>tag推送响应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;object_kind&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;tag_push&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;event_name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;tag_push&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;before&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;0000000000000000000000000000000000000000&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;after&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;86c8b6fd0d2c4dffdd52951c42add6c1a0bd0624&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;ref&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;refs/tags/dev-1.0.0&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;ref_protected&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;checkout_sha&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;0022c24f46ba600bc528bec86bdfc39674fc788c&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;devvvv&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_username&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_avatar&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://www.gravatar.com/avatar/59c797dd5f8366022c1271697f3b4e37?s=80&amp;d=identicon&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;project_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;project&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;web_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;avatar_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@23483c271df6:yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;namespace&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;visibility_level&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;path_with_namespace&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao/makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;default_branch&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;main&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;ci_config_path&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;homepage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@23483c271df6:yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@23483c271df6:yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops.git&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;commits&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;0022c24f46ba600bc528bec86bdfc39674fc788c&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Update README.md&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Update README.md&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2023-10-16T02:29:41+00:00&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops/-/commit/0022c24f46ba600bc528bec86bdfc39674fc788c&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao@makeblock.com&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;added&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;modified&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;README.md&quot;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;removed&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;total_commits_count&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;push_options&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;repository&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@23483c271df6:yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;homepage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;http://23483c271df6/yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@23483c271df6:yangbiao/makeblock-devops.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;visibility_level&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>


<h3 id="流程引擎"><a href="#流程引擎" class="headerlink" title="流程引擎"></a>流程引擎</h3><p>基于容器进行任务调度，执行完成容器销毁，资源自动回收。运行用户自定义镜像，多平台runner满足不同任务环境需求。</p>
<h4 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h4><h5 id="核心流程"><a href="#核心流程" class="headerlink" title="核心流程"></a>核心流程</h5><ol>
<li>服务端解析配置文件，根据定义的文件进行配置 触发器，运行触发器进行监控触发的时机。</li>
<li>触发器进行触发pipeline，将配置文件描述的pipeline进行实例化，绑定对应的step，根据step的配置选择runner发送</li>
<li>runner 接收到 需要执行的 step 进行反序列化 进行条件准备完成后运行，将运行日志通过rpc传递给服务端，服务端检查是否有人订阅日志，有则通过websocket进行连接发送。</li>
<li>runner运行step完成后进行本地环境清理，如清除容器实例、workspace清理等。</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1695192085401-cfc57e6a-fef5-4022-8c55-d7b7b28403d0.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>context如何传递 ？</p>
<ol>
<li>序列化后对象传递（不同的step的配置不一样，rpc不支持未知类型的传递）</li>
<li>传递定义的 yaml 配置，由 runner 自己进行解析（runner运行的当前step可能会依赖前面的一些产物数据，需要传递给当前runner）</li>
<li></li>
</ol>
<h5 id="领域模型"><a href="#领域模型" class="headerlink" title="领域模型"></a>领域模型</h5><p>DDL：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1694915053587-c76afd21-a50e-4c7e-9574-224ed4464c35.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>DDL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- auto-generated definition</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> pipeline_info<br>(<br>    id                  <span class="hljs-type">bigint</span> unsigned auto_increment comment <span class="hljs-string">&#x27;主键&#x27;</span><br>        <span class="hljs-keyword">primary</span> key,<br>    uuid                <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>)      <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;UUID&#x27;</span>,<br>    app_uuid            <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>)      <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;所属应用&#x27;</span>,<br>    name                <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>)     <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;流水线名称&#x27;</span>,<br>    context             text             <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;流水线正文&#x27;</span>,<br>    latest_trigger_time datetime         <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;最新触发时间&#x27;</span>,<br>    branch              <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>)      <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;代码分支&#x27;</span>,<br>    description         <span class="hljs-type">varchar</span>(<span class="hljs-number">1000</span>)    <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;描述&#x27;</span>,<br>    creator             <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>)      <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;创建人&#x27;</span>,<br>    modifier            <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>)      <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;修改人&#x27;</span>,<br>    gmt_create          datetime         <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>    gmt_modified        datetime         <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;修改时间&#x27;</span>,<br>    deleted             <span class="hljs-type">char</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;逻辑删除&#x27;</span>,<br>    trigger_way         <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>)     <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;触发方式&#x27;</span><br>)<br>    comment <span class="hljs-string">&#x27;流水线&#x27;</span>;<br></code></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- auto-generated definition</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> pipeline_run_history<br>(<br>  id               <span class="hljs-type">bigint</span> unsigned auto_increment comment <span class="hljs-string">&#x27;主键&#x27;</span><br>  <span class="hljs-keyword">primary</span> key,<br>  uuid             <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>)      <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;UUID&#x27;</span>,<br>  pipeline_uuid    <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>)      <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;流水线uuid&#x27;</span>,<br>  trigger_time     datetime         <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;触发时间&#x27;</span>,<br>  trigger_way      <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>)     <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;触发方式&#x27;</span>,<br>  content          longtext         <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;存储日志数据正文&#x27;</span>,<br>  start_time       datetime         <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;执行时间&#x27;</span>,<br>  end_time         datetime         <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;结束时间&#x27;</span>,<br>  status           <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>)      <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;最终执行状态&#x27;</span>,<br>  pipeline_content text             <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;流水线快照&#x27;</span>,<br>  creator          <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>)      <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;创建人&#x27;</span>,<br>  modifier         <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>)      <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;修改人&#x27;</span>,<br>  gmt_create       datetime         <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  gmt_modified     datetime         <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;修改时间&#x27;</span>,<br>  deleted          <span class="hljs-type">char</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&#x27;0&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;逻辑删除&#x27;</span><br>)<br>    comment <span class="hljs-string">&#x27;流水线执行记录&#x27;</span>;<br><br></code></pre></td></tr></table></figure>


<h5 id="Pipeline-Context-定义"><a href="#Pipeline-Context-定义" class="headerlink" title="Pipeline Context 定义"></a>Pipeline Context 定义</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;1.0&#x27;</span> <span class="hljs-comment"># api版本</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">pipeline-2023-09-17</span> <span class="hljs-comment"># 名称</span><br><span class="hljs-attr">triggers:</span> <span class="hljs-comment"># 流线触发器</span><br>  <span class="hljs-attr">trigger:</span> <span class="hljs-string">auto</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span><br>      <span class="hljs-attr">prefix:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">00</span><span class="hljs-bullet">-</span><br><span class="hljs-attr">stages:</span> <span class="hljs-comment"># stages</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">stage-592913d5</span><br>    <span class="hljs-attr">strategy:</span> <span class="hljs-string">fast</span><br>    <span class="hljs-attr">trigger:</span> <span class="hljs-string">auto</span><br>    <span class="hljs-attr">executor:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mikeygitee</span><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@gcc</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_gcc</span><br>        <span class="hljs-attr">runner:</span> <span class="hljs-string">mac-arm64</span> <span class="hljs-comment"># 通过label指定runner节点运行</span><br>        <span class="hljs-attr">run-on:</span> <span class="hljs-string">self-host</span> <span class="hljs-comment"># 指定宿主机运行还是容器：self-host和container</span><br>        <span class="hljs-attr">gccVersion:</span> <span class="hljs-string">&#x27;9.4&#x27;</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 新建build目录，切换到build目录&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;mkdir build &amp;&amp; cd build &#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 生成Unix平台的makefiles文件并执行构建&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">cmake</span> <span class="hljs-string">-G</span> <span class="hljs-string">&#x27;Unix Makefiles&#x27;</span> <span class="hljs-string">../</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">make</span> <span class="hljs-string">-j</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./bin</span><br>        <span class="hljs-attr">caches:</span> []<br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@docker</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_docker</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">镜像构建</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">cert</span><br>        <span class="hljs-attr">certificate:</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">tag:</span> <span class="hljs-string">$&#123;GITEE_PIPELINE_BUILD_NUMBER&#125;</span><br>        <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">./Dockerfile</span><br>        <span class="hljs-attr">context:</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">artifacts:</span> []<br>        <span class="hljs-attr">isCache:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">parameter:</span> &#123;&#125;<br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@ruby</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_ruby</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Ruby</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">rubyVersion:</span> <span class="hljs-number">3.0</span><span class="hljs-number">.2</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">bundle</span> <span class="hljs-string">install</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">-R</span> <span class="hljs-string">bin</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">bin/rails</span> <span class="hljs-string">webpacker:install</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">bin/rails</span> <span class="hljs-string">db:migrate</span> <span class="hljs-string">RAILS_ENV=test</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">bin/rails</span> <span class="hljs-string">test</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">RAILS_ENV=production</span> <span class="hljs-string">bin/rails</span> <span class="hljs-string">assets:precompile</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;&#x27;</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@php</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_php</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">PHP</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">phpVersion:</span> <span class="hljs-string">&#x27;8.0&#x27;</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 设置全局composer依赖仓库地址&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">composer</span> <span class="hljs-string">config</span> <span class="hljs-string">-g</span> <span class="hljs-string">secure-http</span> <span class="hljs-literal">false</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">composer</span> <span class="hljs-string">config</span> <span class="hljs-string">-g</span> <span class="hljs-string">repo.packagist</span> <span class="hljs-string">composer</span> <span class="hljs-string">https://mirrors.aliyun.com/composer/</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">composer</span> <span class="hljs-string">install</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">php</span> <span class="hljs-string">-v</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./</span><br>        <span class="hljs-attr">caches:</span> []<br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@python</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_python</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Python</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">pythonVersion:</span> <span class="hljs-string">&#x27;3.9&#x27;</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">pip</span> <span class="hljs-string">config</span> <span class="hljs-string">set</span> <span class="hljs-string">global.index-url</span> <span class="hljs-string">https://pypi.tuna.tsinghua.edu.cn/simple</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 可以使用pip下载依赖&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# pip install --user -r requirements.txt&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">python</span> <span class="hljs-string">--version</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./</span><br>        <span class="hljs-attr">caches:</span> []<br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@golang</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_golang</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Golang</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">golangVersion:</span> <span class="hljs-string">&#x27;1.12&#x27;</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 默认使用goproxy.cn&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">export</span> <span class="hljs-string">GOPROXY=https://goproxy.cn</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 输入你的构建命令&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">make</span> <span class="hljs-string">build</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./output</span><br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">/go/pkg/mod</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@gradle</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_gradle</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Gradle</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">jdkVersion:</span> <span class="hljs-string">&#x27;8&#x27;</span><br>        <span class="hljs-attr">gradleVersion:</span> <span class="hljs-string">&#x27;4.4&#x27;</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# Gradle默认构建命令&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">./gradlew</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">./gradlew</span> <span class="hljs-string">build</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./target</span><br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">~/.gradle/caches</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@maven</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_maven</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Maven</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">jdkVersion:</span> <span class="hljs-string">&#x27;8&#x27;</span><br>        <span class="hljs-attr">mavenVersion:</span> <span class="hljs-number">3.3</span><span class="hljs-number">.9</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 功能：打包&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 参数说明：&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;#    -Dmaven.test.skip=true：跳过单元测试&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;#    -U：每次构建检查依赖更新，可避免缓存中快照版本依赖不更新问题，但会牺牲部分性能&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;#    -e -X ：打印调试信息，定位疑难构建问题时建议使用此参数构建&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;#    -B：以batch模式运行，可避免日志打印时出现ArrayIndexOutOfBoundsException异常&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 使用场景：打包项目且不需要执行单元测试时使用&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">mvn</span> <span class="hljs-string">clean</span> <span class="hljs-string">package</span> <span class="hljs-string">-Dmaven.test.skip=true</span> <span class="hljs-string">-U</span> <span class="hljs-string">-e</span> <span class="hljs-string">-X</span> <span class="hljs-string">-B</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 功能：自定义settings配置&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 使用场景：如需手工指定settings.xml，可使用如下方式&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 注意事项：如无需自定义settings配置且需要私有依赖仓库，可在该任务配置《私有仓库》处添加私有依赖&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# mvn -U clean package -s ./settings.xml&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./target</span><br>        <span class="hljs-attr">settings:</span> []<br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">~/.m2</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">build@nodejs</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">build_nodejs</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Nodejs</span> <span class="hljs-string">构建</span><br>        <span class="hljs-attr">nodeVersion:</span> <span class="hljs-number">14.16</span><span class="hljs-number">.0</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 设置NPM源，提升安装速度&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">npm</span> <span class="hljs-string">config</span> <span class="hljs-string">set</span> <span class="hljs-string">registry</span> <span class="hljs-string">https://registry.npmmirror.com</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 执行编译命令&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span><br>        <span class="hljs-attr">artifacts:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>            <span class="hljs-attr">path:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">./dist</span><br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">~/.npm</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">~/.yarn</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">stage-ae79d813</span><br>    <span class="hljs-attr">displayName:</span> <span class="hljs-string">未命名</span><br>    <span class="hljs-attr">strategy:</span> <span class="hljs-string">naturally</span><br>    <span class="hljs-attr">trigger:</span> <span class="hljs-string">auto</span><br>    <span class="hljs-attr">executor:</span> []<br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">ut@maven</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">unit_test_maven</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">Maven</span> <span class="hljs-string">单元测试</span><br>        <span class="hljs-attr">jdkVersion:</span> <span class="hljs-string">&#x27;8&#x27;</span><br>        <span class="hljs-attr">mavenVersion:</span> <span class="hljs-number">3.3</span><span class="hljs-number">.9</span><br>        <span class="hljs-attr">commands:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# Maven单元测试默认命令&#x27;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">mvn</span> <span class="hljs-string">-B</span> <span class="hljs-string">test</span> <span class="hljs-string">-Dmaven.test.failure.ignore=true</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">mvn</span> <span class="hljs-string">surefire-report:report-only</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">mvn</span> <span class="hljs-string">site</span> <span class="hljs-string">-DgenerateReports=false</span><br>        <span class="hljs-attr">report:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">./target/site</span><br>          <span class="hljs-attr">index:</span> <span class="hljs-string">surefire-report.html</span><br>        <span class="hljs-attr">checkpoints:</span> []<br>        <span class="hljs-attr">settings:</span> []<br>        <span class="hljs-attr">caches:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">~/.m2</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">stage-374ffefd</span><br>    <span class="hljs-attr">displayName:</span> <span class="hljs-string">未命名</span><br>    <span class="hljs-attr">strategy:</span> <span class="hljs-string">naturally</span><br>    <span class="hljs-attr">trigger:</span> <span class="hljs-string">auto</span><br>    <span class="hljs-attr">executor:</span> []<br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">deploy@k8s</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">deploy_k8s</span><br>        <span class="hljs-attr">displayName:</span> <span class="hljs-string">K8S部署</span><br>        <span class="hljs-attr">version:</span> <span class="hljs-string">v1.16.4</span><br>        <span class="hljs-attr">certificate:</span> <span class="hljs-string">&#x27;&#x27;</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br>        <span class="hljs-attr">yaml:</span> <span class="hljs-string">./deployment.yaml</span><br>        <span class="hljs-attr">isReplace:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">skiptls:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">params:</span> <span class="hljs-literal">null</span><br>        <span class="hljs-attr">notify:</span> []<br>        <span class="hljs-attr">strategy:</span><br>          <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br></code></pre></td></tr></table></figure>

<p>代码实现</p>
<p>待解决的问题：</p>
<ol>
<li><del>如何实现实时日志：发布订阅模式，与前端使用websocket方式，服务端与runner使用grpc。</del></li>
<li><del>如何实现内置功能：不采用github actions 适配难点大、后期在考虑兼容。</del></li>
<li><del>run-on的选择是针对整条流水线还是stage还是step，参考jenkins和github action。</del></li>
</ol>
<p>一共三种粒度：</p>
<blockquote>
<ol>
<li>流水线级别的粒度：最粗粒度，无法满足在一条流水线中不同环境的step运行，如果需要不同环境只能新建流水线选择对应的机器环境。</li>
<li>stage级别的粒度：中等粒度，介于1、3之间两者的利弊都没有完全解决，不采用该方式。</li>
<li>step级别的粒度：最细粒度，可为每个step显示指定节点运行环境，能够精确把控每个step，会带来产物同步的高效性降低，因为只能通过OSS方式共享。</li>
</ol>
</blockquote>
<ol start="4">
<li><del>run-on的环境支持镜像和宿主机，如果在宿主机如何保证安全问题。</del><blockquote>
<p>默认认为环境是安全的且构建机器不会存储任何秘钥</p>
</blockquote>
</li>
</ol>
<p>run-on运行环境选择机制：</p>
<ol>
<li>不指定的话使用当前负载最低的节点运行Pipeline。</li>
<li>指定的话则根据指定的label来选择对应的机器。</li>
</ol>
<p>支持三种环境运行step：</p>
<ol>
<li>裸机运行</li>
<li>容器运行（默认）</li>
<li>自定义镜像运行</li>
</ol>
<p>每个step需要做的工作：</p>
<ol>
<li>运行前环境准备</li>
<li>运行用户输入的command</li>
<li>构建后产物存储</li>
<li>缓存构建</li>
<li>实时日志同步给客户端</li>
</ol>
<h5 id="日志服务"><a href="#日志服务" class="headerlink" title="日志服务"></a>日志服务</h5><p>在执行任务过程中需要实时传输日志给前端进行展示，采用websocket方式进行实时传输（实时运行状态），如果是已经完成的</p>
<ol>
<li>在执行命令时还需要读取 命令执行后返回的流数据进行回显</li>
<li>秘钥类型的数据使用 **** 来代替显示。</li>
<li>基于发布订阅模块进行日志传输。</li>
</ol>
<h5 id="Step-生命周期"><a href="#Step-生命周期" class="headerlink" title="Step 生命周期"></a>Step 生命周期</h5><ol>
<li>实例化：根据 yaml 定义文件反序列化其到step配置实例。</li>
<li>前置准备：根据 yaml 定义的环境准备对应的执行环境，如主机、容器（默认为容器），注入环境变量和秘钥。</li>
<li>执行 step：根据 指定的step去执行特定操作、command等。</li>
<li>释放资源：释放容器和清理执行step过程中worksapce产生的内容。</li>
<li>存储结果：将执行结果状态、记录进行存储（人工卡点是需要进行介入的）。</li>
</ol>
<h5 id="Step-可视化编辑"><a href="#Step-可视化编辑" class="headerlink" title="Step 可视化编辑"></a>Step 可视化编辑</h5><p>流程：</p>
<ol>
<li>从后端获取step列表</li>
<li>选择 step 去后端请求 该 step 的表单配置（使用该step需要那些输入配置供前端进行展示），根据step的配置进行数据渲染（后端）再返回给前端</li>
<li>前端拿到step的配置后进行渲染表单</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1696650884546-166a3116-8992-4dc3-9da1-245f3a36b9ca.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>配置的定义：</p>
<blockquote>
<p>该定义位于step的记录中（content字段）主要是记录使用该节点需要用户进行输入那些数据项，在用户进行选择该s</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">items:</span> <span class="hljs-comment"># 表单项</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <br>   <span class="hljs-attr">desc:</span> <span class="hljs-comment"># 描述</span><br>   <span class="hljs-attr">type:</span> <span class="hljs-string">select</span> <span class="hljs-comment">#表单项类型</span><br>   <span class="hljs-attr">rules:</span> <br>     <span class="hljs-bullet">-</span> <span class="hljs-attr">require:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#是否必填</span><br>   <span class="hljs-attr">values:</span> <br>   <br>    <span class="hljs-attr">datasource:</span> <span class="hljs-comment">#数据源</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">value</span> <span class="hljs-comment"># value表示直接可用 remote 表示需要请求接口获取</span><br></code></pre></td></tr></table></figure>

<p>以golang构建为案例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#常规配置： go版本、构建命令、构建产物（路径&amp;名称）</span><br><span class="hljs-attr">fields:</span><br><span class="hljs-comment">#go版本</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">golang-version</span><br>    <span class="hljs-attr">label:</span> <span class="hljs-string">Golang版本</span> <span class="hljs-comment"># 表单展示label</span><br>    <span class="hljs-attr">desc:</span>  <span class="hljs-comment"># 详细描述</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">select</span> <span class="hljs-comment">#下拉框类型</span><br>    <span class="hljs-attr">rules:</span> <span class="hljs-comment"># 验证规则</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">require:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#是否必填</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">go1.20.4</span> <span class="hljs-comment"># 选中值</span><br>    <span class="hljs-attr">datasource:</span> <span class="hljs-comment">#数据源</span><br>      <span class="hljs-attr">type:</span> <span class="hljs-string">value</span> <span class="hljs-comment"># value表示直接可用 remote 表示需要请求接口获取</span><br>      <span class="hljs-attr">values:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">label:</span> <span class="hljs-string">go1.20.4（稳定版）</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">go1.20.4</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">label:</span> <span class="hljs-string">go1.18.1</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">go1.18.1</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">label:</span> <span class="hljs-string">go1.16.6（稳定版）</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">go1.16.6</span><br><span class="hljs-comment">#构建命令</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build-command</span> <span class="hljs-comment"># 命令组件</span><br>    <span class="hljs-attr">label:</span> <span class="hljs-string">构建命令</span> <span class="hljs-comment"># 表单展示label</span><br>    <span class="hljs-attr">desc:</span>  <span class="hljs-comment"># 详细描述</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">code</span> <span class="hljs-comment">#代码块类型</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      # 默认使用goproxy.cn</span><br><span class="hljs-string">      export GOPROXY=https://goproxy.cn</span><br><span class="hljs-string">      # 输入你的构建命令</span><br><span class="hljs-string">      make build</span><br><span class="hljs-string"></span>    <span class="hljs-attr">rules:</span> <br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">require:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#是否必填</span><br><span class="hljs-comment">#构建产物（路径&amp;名称）</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build-artifacts</span> <span class="hljs-comment"># 命令组件</span><br>    <span class="hljs-attr">label:</span> <span class="hljs-string">构建产物</span> <span class="hljs-comment"># 表单展示label</span><br>    <span class="hljs-attr">desc:</span>  <span class="hljs-comment"># 详细描述</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">collapse</span> <span class="hljs-comment">#折叠输入框组类型（name: xxx,path:[]）</span><br>    <span class="hljs-attr">spce:</span> <span class="hljs-comment"># </span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>      <span class="hljs-attr">label:</span> <span class="hljs-string">&#x27;暂存构建物添加&#x27;</span><br>      <span class="hljs-attr">limit:</span> <span class="hljs-number">0</span> <span class="hljs-comment">#group数量限制</span><br>      <span class="hljs-attr">child:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">name</span><br>          <span class="hljs-attr">label:</span> <span class="hljs-string">构建物唯一标识</span><br>          <span class="hljs-attr">desc:</span> <span class="hljs-string">支持数字、字母、下划线等，最大32个字符，在下游可以通过$&#123;BUILD_ARTIFACT&#125;方式引用来获取构建物</span><br>          <span class="hljs-attr">type:</span> <span class="hljs-string">input</span><br>          <span class="hljs-attr">rules:</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">require:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#是否必填</span><br><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">path</span><br>          <span class="hljs-attr">label:</span> <span class="hljs-string">构建物唯一标识</span><br>          <span class="hljs-attr">desc:</span> <span class="hljs-string">不限制字符格式，最大256个字符</span><br>          <span class="hljs-attr">type:</span> <span class="hljs-string">input-rows</span> <span class="hljs-comment"># 多行输入</span><br>          <span class="hljs-attr">rules:</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">require:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#是否必填</span><br>    <span class="hljs-attr">rules:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">require:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#是否必填</span><br><br><span class="hljs-comment">#高级配置： 缓存路径、消息通知(成功、失败、超时等状态)、超时配置、运行方式(容器运行||主机运行)</span><br><br><span class="hljs-comment"># 高级配置为固定配置无需动态渲染</span><br><br><span class="hljs-comment"># 运行的节点</span><br><span class="hljs-attr">runOn:</span> <span class="hljs-string">random</span><br><span class="hljs-comment"># 运行环境（主机运行|容器运行）</span><br><span class="hljs-attr">runWay:</span> <span class="hljs-string">container</span><br><br><span class="hljs-comment"># 消息通知</span><br><span class="hljs-attr">notify:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">certificate:</span> <span class="hljs-string">a31b3cb0-4731-013c-aedc-4e84687c3eef</span><br>    <span class="hljs-attr">events:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">fail</span><br>    <span class="hljs-attr">content:</span> <span class="hljs-string">|</span><br><span class="hljs-string">      pipeline $&#123;name&#125; run fail at $&#123;time.Now()&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-comment"># 超时配置</span><br><span class="hljs-attr">strategy:</span><br>  <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;5&#x27;</span><br>  <span class="hljs-attr">timeout:</span> <span class="hljs-number">5</span> <span class="hljs-comment"># </span><br><br><br><span class="hljs-comment"># 缓存路径</span><br><span class="hljs-attr">caches:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">/go/pkg/mod</span><br></code></pre></td></tr></table></figure>

<ol>
<li>在可视化视图编辑时需要将表单数据进行转为yaml数据提交给服务器。</li>
<li>在切换图形视图和代码视图的tab中能将其数据进行转换。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">triggers：</span><br>	<span class="hljs-attr">cron:</span> <span class="hljs-number">10</span> <span class="hljs-number">18</span> <span class="hljs-string">*</span> <span class="hljs-string">*</span> <span class="hljs-string">*</span> <span class="hljs-comment">#cron触发</span><br>	<span class="hljs-attr">webhook:</span> <span class="hljs-literal">true</span>			<span class="hljs-comment">#webhook触发</span><br>	<span class="hljs-comment">#推送触发</span><br>	<span class="hljs-attr">push:</span><br>  	<span class="hljs-attr">branch:</span> <span class="hljs-comment">#分支触发</span><br>    	<span class="hljs-attr">include:</span> <span class="hljs-comment">#包含 </span><br>      	<span class="hljs-bullet">-</span> <span class="hljs-string">master</span><br>      	<span class="hljs-bullet">-</span> <span class="hljs-string">release</span><br>      	<span class="hljs-bullet">-</span> <span class="hljs-string">main</span><br>      <span class="hljs-attr">precise:</span> <span class="hljs-comment">#精确匹配</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">dfgsd</span><br>      <span class="hljs-attr">prefix:</span> <span class="hljs-comment">#前缀匹配</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">dfgsd</span><br>        <br>  	<span class="hljs-attr">tag:</span> <span class="hljs-comment">#打tag标签触发</span><br>    	<span class="hljs-comment"># 同上</span><br>  	<span class="hljs-attr">commit:</span> <span class="hljs-comment">#关键字触发</span><br>    	<span class="hljs-comment"># 同上</span><br></code></pre></td></tr></table></figure>


<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">steps:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">step:</span> <span class="hljs-string">TASK_GO_BUILD_UPLOAD</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">TASK_GO_BUILD_UPLOAD</span><br>    <span class="hljs-attr">displayName:</span> <span class="hljs-string">Golang</span> <span class="hljs-string">构建</span><br>    <span class="hljs-attr">golangVersion:</span> <span class="hljs-string">&#x27;1.12&#x27;</span><br>    <span class="hljs-attr">commands:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 默认使用goproxy.cn&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">export</span> <span class="hljs-string">GOPROXY=https://goproxy.cn</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;# 输入你的构建命令&#x27;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">make</span> <span class="hljs-string">build</span><br>    <span class="hljs-attr">artifacts:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>        <span class="hljs-attr">path:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">./output</span><br>    <span class="hljs-attr">caches:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/go/pkg/mod</span><br>    <span class="hljs-attr">notify:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">certificate:</span> <span class="hljs-string">a31b3cb0-4731-013c-aedc-4e84687c3eef</span><br>        <span class="hljs-attr">events:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">fail</span><br>        <span class="hljs-attr">content:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">repository</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">pipeline</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">stage</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">task</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">operator</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">branch</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">detail</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">dingtalk</span><br>    <span class="hljs-attr">strategy:</span><br>      <span class="hljs-attr">retry:</span> <span class="hljs-string">&#x27;0&#x27;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">artifacts:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BUILD_ARTIFACT</span><br>     <span class="hljs-attr">path:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-string">./target</span><br></code></pre></td></tr></table></figure>


<h4 id="server"><a href="#server" class="headerlink" title="server"></a>server</h4><p>server端负责进行pipeline基础管理，通过rpc通信派发流水线给runner进行执行，同时将日志从runner转发给前端和存储到日志中心。</p>
<h4 id="runner"><a href="#runner" class="headerlink" title="runner"></a>runner</h4><p>runners 的设计原理主要包含以下几个方面:</p>
<ol>
<li><p>基于客户端-服务器架构：Runner 作为客户端,连接到 devops-platform 服务端。客户端轮询请求服务器获取任务,然后在本地执行,并将结果返回给服务器。</p>
</li>
<li><p>用 Docker 隔离执行环境：Runner 在 Docker 容器内执行任务,实现了执行环境的隔离。默认的虚拟环境保证了每个步骤的一致性。</p>
</li>
<li><p>支持跨平台：Runner 支持 Linux、Windows 和 macOS,可以使工作流跨平台执行。</p>
</li>
<li><p>高度可扩展：Runner 支持横向扩展,可以根据需要增加运行实例的数量。</p>
</li>
<li><p>状态共享：Runner 和服务端通信可以共享状态,如工作流的当前进度。</p>
</li>
<li><p>事件驱动subtotal更新：Runner 将在配置发生变化时从服务端获取更新,确保工作流是最新的。</p>
</li>
</ol>
<p>8.安全加密通信：Runner 和服务端之间的通信是通过安全的 TLS 加密的。</p>
<p>必填参数：</p>
<ol>
<li>label用于server运行step时可选择节点。</li>
</ol>
<p>启动可选参数：</p>
<ol>
<li>服务端 Endpoint。</li>
<li>工作目录 workspace（部分任务需要在主机上运行）。</li>
</ol>
<p>Docker API ：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/api/v1.43/">https://docs.docker.com/engine/api/v1.43/</a></p>
<p>执行任务的详细流程</p>
<p>启动时对环境工具进行检查，必需工具链不存在不给予运行</p>
<h5 id="缓存机制"><a href="#缓存机制" class="headerlink" title="缓存机制"></a>缓存机制</h5><p>部分step的运行可能每次需要下载很多依赖，例如 npm 的 node-module ，maven的jar文件等等，如果每次都重新下载的话效率低下，如果能将其进行缓存起来则可以加快构建的速度。</p>
<h5 id="runner-选择算法"><a href="#runner-选择算法" class="headerlink" title="runner 选择算法"></a>runner 选择算法</h5><ol>
<li>按照label选择runner。</li>
<li>同label下多个节点，选择负载最低的runner。</li>
</ol>
<h5 id="状态上报"><a href="#状态上报" class="headerlink" title="状态上报"></a>状态上报</h5><ol>
<li>定时向服务端上报当前runner的负载情况，健康状态等必要信息</li>
</ol>
<h4 id="images"><a href="#images" class="headerlink" title="images"></a>images</h4><p>基础镜像库，在运行job是依赖于一些基础工具链的，这些工具会被打包进镜像里面，如git、maven、golang等。</p>
<h4 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h4><h5 id="容器方式运行"><a href="#容器方式运行" class="headerlink" title="容器方式运行"></a>容器方式运行</h5><p>将当前step必备的组件通过-v进行挂载到容器中去，缓存的实现也是一样</p>
<ol>
<li>日志实时读取</li>
<li>格式化日志（带上时间）</li>
<li>日志驱动</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1698286168968-1e38f4f6-f535-4e0b-960c-432653c459e4.png#averageHue=%23fbfbfb&clientId=uea787277-4226-4&from=paste&height=789&id=u59b15cef&originHeight=789&originWidth=1020&originalType=binary&ratio=1&rotation=0&showTitle=false&size=154804&status=done&style=none&taskId=ubcbc5ed2-6a32-4eca-922f-2cedcc6ff92&title=&width=1020" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>项目构建的时候需要拉取依赖（多个私服仓库依赖），如果是那种私服的仓库如何配置权限 ？</p>
<ol>
<li>从代码源中获取配置的access token来访问但是这个token的权限级别特别高，存在用户破坏数据的可能性。</li>
<li>通过保存代码源的时候去创建一个仅仅带有只读权限的access token，在拉取代码的时候注入这个token，因为只有只读权限，还是比较安全的。</li>
<li>基于2如果还要更加精细的控制权限，可以拿到当前仓库用户的 access token（没有则创建）可以进一步进行管控。</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1698310284136-e4dc8821-b2e2-4698-a878-c56cf09bc103.png#averageHue=%23454242&clientId=uea787277-4226-4&from=paste&height=391&id=ucfffb390&originHeight=391&originWidth=1011&originalType=binary&ratio=1&rotation=0&showTitle=false&size=109593&status=done&style=none&taskId=u9247ac16-9429-4f9e-afdd-f2a39e1db34&title=&width=1011" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>gitee的实现方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">49] Stage [2/2] Starting to download code ... <br>[2023-10-26 09:29:52] <span class="hljs-built_in">export</span> LC_ALL=en_US.UTF-8 &amp;&amp; <span class="hljs-built_in">rm</span> -rf /root/workspace/mikeygitee/COLA &amp;&amp; <span class="hljs-built_in">mkdir</span> -p /root/workspace/mikeygitee/COLA &amp;&amp; <span class="hljs-built_in">cd</span> /root/workspace/mikeygitee/COLA &amp;&amp; git config --global user.name pipeline-temp &amp;&amp; git config --global user.email pipeline-temp &amp;&amp; git config --global http.postBuffer 1048576000 &amp;&amp; git config --global http.lowSpeedLimit 0 &amp;&amp; git config --global http.lowSpeedTime 999999 &amp;&amp; git config --global core.compression -1 &amp;&amp; git config --global ssh.postBuffer 1024M &amp;&amp; git config --global ssh.maxRequsetBuffer 1024M &amp;&amp; git <span class="hljs-built_in">clone</span>  https://mikeygitee:************@gitee.com/mikeygitee/COLA.git -b master . &amp;&amp; git reset --hard 0dc56d7eef08c9136f196a2bff3273fce83f4116 || (git pull --unshallow &amp;&amp; git reset --hard 0dc56d7eef08c9136f196a2bff3273fce83f4116)<br>[2023-10-26 09:29:52] Cloning into <span class="hljs-string">&#x27;.&#x27;</span>...<br>[2023-10-26 09:29:52] <br></code></pre></td></tr></table></figure>

<p>上面的问题其实本质上就是credential的设计问题</p>
<h6 id="秘钥模块设计"><a href="#秘钥模块设计" class="headerlink" title="秘钥模块设计"></a>秘钥模块设计</h6><ol>
<li>在脚本中能使用秘钥，但是打印出来的是 ‘******’</li>
</ol>
<blockquote>
<p>直接在控制台输出的日志进行过滤，如果存在则替换成  ‘******’，但是正在方式如果通过</p>
</blockquote>
<p>github测试获取秘钥<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1698319825446-b3a54be3-2e7c-4ebf-96ee-106b0b5e54af.png#averageHue=%23fefefe&clientId=uea787277-4226-4&from=paste&height=320&id=ua0ad18da&originHeight=545&originWidth=1159&originalType=binary&ratio=1&rotation=0&showTitle=false&size=70344&status=done&style=none&taskId=uc999e4bc-1cfa-451b-8f40-1a2713a8ff6&title=&width=681" srcset="/img/loading.gif" lazyload alt="image.png"><br>可以拿到数据<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1698319786089-232aec8b-a25e-4999-ad10-8da72d2a6e51.png#averageHue=%23fbfbf0&clientId=uea787277-4226-4&from=paste&height=310&id=u35534cd1&originHeight=504&originWidth=1110&originalType=binary&ratio=1&rotation=0&showTitle=false&size=85761&status=done&style=none&taskId=u7508aad7-e836-48ea-85cc-151b0d3ba30&title=&width=683" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>实时证明，只是屏蔽掉返回给前端 秘钥 使用 ”****“ 代替</p>
<h5 id="主机方式运行"><a href="#主机方式运行" class="headerlink" title="主机方式运行"></a>主机方式运行</h5><p>主机运行方式可以通过对不同的step设置所需的环境变量来配置对应的工具版本</p>
<h5 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h5><blockquote>
<p>以act为例：</p>
</blockquote>
<ol>
<li>将命令直接复制到容器里面</li>
<li><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1698405717836-1a2a510d-7425-49ad-a121-4104faf1f01b.png#averageHue=%232f2d2c&clientId=u61a00340-62f8-4&from=paste&height=496&id=u0c248a83&originHeight=496&originWidth=1508&originalType=binary&ratio=1&rotation=0&showTitle=false&size=145239&status=done&style=none&taskId=u3e2c0659-4712-429c-b549-0b3c0a150c2&title=&width=1508" srcset="/img/loading.gif" lazyload alt="image.png"></li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1698405696730-714ab801-cbdd-45fe-b504-5fe764a75e68.png#averageHue=%23ffffff&clientId=u61a00340-62f8-4&from=paste&height=206&id=u7da4aea2&originHeight=206&originWidth=456&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26874&status=done&style=none&taskId=u98559e18-1384-41fa-9ab1-d0a8de473d8&title=&width=456" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go">BASH_FUNC_STEP_EXEC() &#123;<br>    $@ <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> | tee -a /tmp/buildlog | while IFS= read -r line || [[ -n $&#123;line&#125; ]]; do<br>        <span class="hljs-keyword">if</span> [[ $&#123;line&#125; = \+* ]]; then<br>            echo -e <span class="hljs-string">&quot;\033[1;36m[$(date &#x27;+%H:%M:%S&#x27;)] [User Command] $line\033[0m&quot;</span><br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">if</span> [[ $&#123;line&#125; = \[ERROR\]* ]]; then<br>                echo -e <span class="hljs-string">&quot;\u001b[91m[$(date &#x27;+%H:%M:%S&#x27;)] $line\033[0m&quot;</span><br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-keyword">if</span> [[ $&#123;line&#125; = \[WARNING\]* ]]; then<br>                    echo -e <span class="hljs-string">&quot;\u001b[33m[$(date &#x27;+%H:%M:%S&#x27;)] $line\033[0m&quot;</span><br>                <span class="hljs-keyword">else</span><br>                    <span class="hljs-keyword">if</span> [[ $&#123;line&#125; = \[SUCCESS\]* ]]; then<br>                        echo -e <span class="hljs-string">&quot;\u001b[92m[$(date &#x27;+%H:%M:%S&#x27;)] $line\033[0m&quot;</span><br>                    <span class="hljs-keyword">else</span><br>                        echo <span class="hljs-string">&quot;[$(date &#x27;+%H:%M:%S&#x27;)] $line&quot;</span><br>                    fi<br>                fi<br>            fi<br>        fi<br>    done<br>    <span class="hljs-keyword">return</span> $&#123;PIPESTATUS[<span class="hljs-number">0</span>]&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>我们要的效果：<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1701863790830-bd4c67cc-fe32-4194-8dc9-3951ba8edf5b.png#averageHue=%23353535&clientId=udc08328e-9409-4&from=paste&height=110&id=u3bb1a621&originHeight=220&originWidth=727&originalType=binary&ratio=2&rotation=0&showTitle=false&size=37485&status=done&style=none&taskId=u49453499-3a04-40b1-8a00-45c03cf02fe&title=&width=363.5" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Action实现"><a href="#Action实现" class="headerlink" title="Action实现"></a>Action实现</h3><h4 id="Checkout-Action"><a href="#Checkout-Action" class="headerlink" title="Checkout Action"></a>Checkout Action</h4><ol>
<li>在主机模式下如何能做到不污染其他pipeline拉取</li>
</ol>
<h4 id="Exec-Action"><a href="#Exec-Action" class="headerlink" title="Exec Action"></a>Exec Action</h4><h3 id="通信协议"><a href="#通信协议" class="headerlink" title="通信协议"></a>通信协议</h3><p><a target="_blank" rel="noopener" href="https://docs.gitea.com/zh-cn/usage/actions/design">https://docs.gitea.com/zh-cn/usage/actions/design</a><br><a target="_blank" rel="noopener" href="https://gitea.com/gitea/actions-proto-def/src/branch/main/proto">https://gitea.com/gitea/actions-proto-def/src/branch/main/proto</a><br><a target="_blank" rel="noopener" href="https://gitea.com/gitea/actions-proto-go/src/branch/main/runner/v1/messages.pb.go">https://gitea.com/gitea/actions-proto-go/src/branch/main/runner/v1/messages.pb.go</a></p>
<h1 id="落地"><a href="#落地" class="headerlink" title="落地"></a>落地</h1><blockquote>
<p>记录系统开发落地过程中的问题记录</p>
</blockquote>
<ol>
<li><p>mac下docker启动 Ubuntu </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker pull --platform=linux/amd64 ubuntu:20.04<br>docker run -d -i -t --name ubuntu ubuntu:20.04<br><br>-i：这个参数是<span class="hljs-string">&quot;interactive&quot;</span>的简写，意味着即使没有附加到容器，仍保持STDIN开启。<br></code></pre></td></tr></table></figure>
</li>
<li><p>安装 git、nvm</p>
</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;object_kind&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;push&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;event_name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;push&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;before&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2665aa7038cbf03f04fce0d33655cbe540ebbce9&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;after&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;777bde1a94d576320170b41dc7ff65d430ed4e33&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;ref&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;refs/heads/main&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;ref_protected&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;checkout_sha&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;777bde1a94d576320170b41dc7ff65d430ed4e33&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">59</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_username&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_avatar&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/uploads/-/system/user/avatar/59/avatar.png&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;project_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">833</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;project&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">833</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;用于测试创建应用&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;web_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;avatar_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@git.makeblock.com:makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;namespace&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Makeblock-common&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;visibility_level&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;path_with_namespace&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;makeblock-common/demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;default_branch&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;main&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;ci_config_path&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;homepage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@git.makeblock.com:makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@git.makeblock.com:makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo.git&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;commits&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;777bde1a94d576320170b41dc7ff65d430ed4e33&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: deploy\n&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: deploy&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2023-09-01T11:27:36+08:00&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo/-/commit/777bde1a94d576320170b41dc7ff65d430ed4e33&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao@makeblock.com&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;added&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;modified&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Makefile&quot;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;removed&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;cb7a65632d97b53dbba566607281215ab26146f5&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: 适配生产环境发布\n&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: 适配生产环境发布&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2023-08-31T16:59:28+08:00&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo/-/commit/cb7a65632d97b53dbba566607281215ab26146f5&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao@makeblock.com&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;added&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;modified&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Jenkinsfile&quot;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;removed&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2665aa7038cbf03f04fce0d33655cbe540ebbce9&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: 适配生产环境发布\n&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: 适配生产环境发布&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2023-08-31T16:53:22+08:00&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo/-/commit/2665aa7038cbf03f04fce0d33655cbe540ebbce9&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao@makeblock.com&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;added&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;modified&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Jenkinsfile&quot;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;removed&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;total_commits_count&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;push_options&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;repository&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@git.makeblock.com:makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;用于测试创建应用&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;homepage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@git.makeblock.com:makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;visibility_level&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;object_kind&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;push&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;event_name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;push&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;before&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2665aa7038cbf03f04fce0d33655cbe540ebbce9&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;after&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;777bde1a94d576320170b41dc7ff65d430ed4e33&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;ref&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;refs/heads/main&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;ref_protected&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;checkout_sha&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;777bde1a94d576320170b41dc7ff65d430ed4e33&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">59</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_username&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;user_avatar&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/uploads/-/system/user/avatar/59/avatar.png&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;project_id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">833</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;project&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">833</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;用于测试创建应用&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;web_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;avatar_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@git.makeblock.com:makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;namespace&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;Makeblock-common&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;visibility_level&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;path_with_namespace&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;makeblock-common/demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;default_branch&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;main&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;ci_config_path&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;homepage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@git.makeblock.com:makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@git.makeblock.com:makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo.git&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;commits&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;777bde1a94d576320170b41dc7ff65d430ed4e33&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: deploy\n&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: deploy&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2023-09-01T11:27:36+08:00&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo/-/commit/777bde1a94d576320170b41dc7ff65d430ed4e33&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao@makeblock.com&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;added&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;modified&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Makefile&quot;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;removed&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;cb7a65632d97b53dbba566607281215ab26146f5&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: 适配生产环境发布\n&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: 适配生产环境发布&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2023-08-31T16:59:28+08:00&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo/-/commit/cb7a65632d97b53dbba566607281215ab26146f5&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao@makeblock.com&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;added&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;modified&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Jenkinsfile&quot;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;removed&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2665aa7038cbf03f04fce0d33655cbe540ebbce9&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: 适配生产环境发布\n&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;feat: 适配生产环境发布&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2023-08-31T16:53:22+08:00&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo/-/commit/2665aa7038cbf03f04fce0d33655cbe540ebbce9&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;yangbiao@makeblock.com&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;added&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;modified&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br>                <span class="hljs-string">&quot;Jenkinsfile&quot;</span><br>            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;removed&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><br><br>            <span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;total_commits_count&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;push_options&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;repository&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@git.makeblock.com:makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;用于测试创建应用&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;homepage&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_http_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;https://git.makeblock.com/makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;git_ssh_url&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;git@git.makeblock.com:makeblock-common/demo.git&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;visibility_level&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>可以通过这种方式来实现表头</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ENTRYPOINT <span class="hljs-built_in">ls</span> buildkit-bollard.txt<br></code></pre></td></tr></table></figure>





<p>step日志：</p>
<blockquote>
<p>总共两种状态进行查询日志：1.任务运行中  2.任务已完成</p>
</blockquote>
<ol>
<li><p>step运行中：</p>
<ol>
<li>客户端获取当前step的执行日志group状态，发送 <strong>执行记录uuid</strong>+**step定位三件套 **到服务端，服务端返回该step的执行步骤group（日志组），前端进行展示。</li>
<li>客户端获取具体的日志信息，点击具体的group再将其传递给后端进行获取实时的日志信息（第一次打开使用首个group去获取）</li>
</ol>
</li>
<li><p>step运行已完成：</p>
<ol>
<li>获取的状态都是已经完成，无需缓存websocket，直接返回全部group的最终执行状态。</li>
<li>客户端获取具体的日志信息，点击具体的group再将其传递给后端进行获取已经记录下的数据。</li>
</ol>
</li>
</ol>
<p>问题：</p>
<ol>
<li>在哪里存储 action  呢 ？step 配置里 ？</li>
</ol>
<p>actions 存储在 step 实现里，Action 作为 step更加细化的动作，step只是负责装配action，当step在runner启动时先将所有actions的状态回传给server</p>
<p>runner响应的信息类型</p>
<ol>
<li>step执行action状态更新（成功、失败）</li>
<li>action日志（追加）</li>
<li>step执行结果数据(状态&amp;数据)</li>
</ol>
<p>如何确定代码源分支：</p>
<ol>
<li>gitee/github是基于gitops将配置文件放到指定的分支的，也就是说一个分支一个Pipeline。</li>
<li>云效的方式是在任务编排的时候提供一个代码源的选择，指定分支。</li>
</ol>
<p>先来看看需要在线上跑的场景</p>
<ol>
<li>针对于toc项目一般都是线上环境是单个分支，比如说是release分支。</li>
<li>一下tob项目可能会多个线上版本（本质上不是线上是交付给B端的版本，但是开发环境是需要多个）</li>
</ol>
<p>最好的方案是：</p>
<ol>
<li>支持多个开发环境的部署</li>
<li></li>
</ol>
<h2 id="实现跳过-取消Step的方案"><a href="#实现跳过-取消Step的方案" class="headerlink" title="实现跳过/取消Step的方案"></a>实现跳过/取消Step的方案</h2><ol>
<li>step可能处于的状态，因为前端控制只能是跳过已经在运行中的step，所以可以确定是处于”运行中状态”</li>
</ol>
<p>跳过当前step直接执行下一个step，如果没有step直接结束当前row</p>
<ol>
<li>使用context进行分发子context来维护各个执行路径，可以统一控制结束（中断）</li>
</ol>
<p>在进行跳过和取消时需要注意并发取消的情况</p>
<h2 id="实现人工卡点的方案"><a href="#实现人工卡点的方案" class="headerlink" title="实现人工卡点的方案"></a>实现人工卡点的方案</h2><ol>
<li>要求指定用户点击通过后才能继续往下执行</li>
<li>不能一直驻留内存占用资源和worker</li>
</ol>
<p>实现方案：</p>
<ol>
<li>在遇到人工卡点的step时先驻留内存一段时间（具体再定），当超过该时间时，将当前的Pipeline的状态进行持久化。</li>
<li>用户点击通过或者不通过时，先判断当前的pipelin是否驻留在内存中，如果在内存中则直接进行继续调度，如果不在说明Pipeline已经超时被挂起，需要从持久化的Pipeline中重新load到内存中进行执行。</li>
</ol>
<p>在对人工卡点超时的情况下，进行存储状态到数据库需要保证：</p>
<ol>
<li><p>可执行节点已经执行完成了，如果还有可执行节点正在执行中需要等待其执行完在进行持久化，那么如何判断可执行节点是否已经都执行完</p>
<ol>
<li>对waitGroup进行判断，如果剩下1则表示只剩当前这个”人工卡点“的节点未执行完，但是如果同一个stage存在多个”人工卡点“则不能使用这种方法判断了。</li>
<li>在执行时遇到人工卡点的step、记录人工卡点的坐标和个数，当执行到人工卡点step时进行判断，如果当前只剩下人工卡点待执行且到达超时时间则直接进行存储。超时时间应该以最后一个人工卡点计算。</li>
</ol>
</li>
</ol>
<p>进阶设计：</p>
<ol>
<li>可选触发人</li>
<li>触发人and/or的实现</li>
<li>已审批过的人disable掉审批按钮</li>
</ol>
<h2 id="失败策略的实现"><a href="#失败策略的实现" class="headerlink" title="失败策略的实现"></a>失败策略的实现</h2><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">// 快速失败：在同一stage中的并行任务一但有一个<span class="hljs-keyword">step</span>失败其他也会停止执行<br>// 自然失败：在同一stage中的并行任务一但有一个<span class="hljs-keyword">step</span>失败其他<span class="hljs-keyword">step</span>不会停止执行，互不影响<br></code></pre></td></tr></table></figure>
<p> </p>
<ol>
<li>快速失败：当一个step执行失败时，通过context通知其他</li>
</ol>
<h2 id="Agent的实现"><a href="#Agent的实现" class="headerlink" title="Agent的实现"></a>Agent的实现</h2><p>因为需要支持主机运行和容器运行的工作方式，所以我们需要抽象一个Agent接口，下面由 HostAgent 和 containerAgent 来进行具体的实现</p>
<p>Agent 接口的能力</p>
<ol>
<li>创建实例（工作空间、镜像容器）</li>
<li>拉取代码</li>
<li>EXEC</li>
<li>OSS上传构建产物</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1700704002371-b9d4f349-378b-4407-a42b-c8a7b51e28c6.jpeg" srcset="/img/loading.gif" lazyload></p>
<h3 id="clone代码的实现"><a href="#clone代码的实现" class="headerlink" title="clone代码的实现"></a>clone代码的实现</h3><ol>
<li>由于有的项目代码量比较大，如果每次都重新拉取代码会导致构建速度低下且做的是没有意义的操作，所以直接第一次构建后将代码在宿主机缓存起来，每当触发流水线时执行 pull &amp; checkout commit id，无需每次都全量拉取文件。</li>
</ol>
<p>如果是容器方式运行则将其挂载进容器中</p>
<p>并发执行问题：多个step同时在公用一个代码文件情况，各自checkout的commit id不一样，有可能在一个step执行过程中另一个就将其切换了。</p>
<p>每次执行pull后不直接使用该代码仓库文件，而是将其复制到自己的工作空间进行处理。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1700810537479-497852af-780a-4c17-88f1-f84ba9107e09.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>覆盖的流程</p>
<ol>
<li>第一次拉取代码，</li>
<li>第 &gt; 1 次拉取代码</li>
</ol>
<h2 id="镜像构建节点的设计"><a href="#镜像构建节点的设计" class="headerlink" title="镜像构建节点的设计"></a>镜像构建节点的设计</h2><p>使用buildkit来进行构建镜像：<a target="_blank" rel="noopener" href="https://github.com/moby/buildkit">https://github.com/moby/buildkit</a></p>
<ol>
<li>创建容器设置容器镜像仓库的访问秘钥</li>
<li>将构建产物下载到容器工作目录下</li>
<li>调用buildkit打包镜像</li>
<li>推送到镜像仓库</li>
</ol>
<p>是API控制构建还是 CTL ？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] [INFO] USER_REGISTRY=registry.cn-shenzhen.aliyuncs.com<br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] [INFO]镜像构建将使用 buildkit<br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] cp: ‘Dockerfile’ and ‘/root/workspace/spring-boot_If45/Dockerfile’ are the same file<br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] buildctl github.com/moby/buildkit v0<span class="hljs-number">.8</span><span class="hljs-number">.0</span> <span class="hljs-number">73</span>fe4736135645a342abc7b587bba0994cccf0f9<br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] [INFO] buildkit ready.<br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] docker login --username=<span class="hljs-number">18276297824</span> --password=****** registry.cn-shenzhen.aliyuncs.com<br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] WARNING! Using --password via the CLI is insecure. Use --password-stdin.<br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] WARNING! Your password will be stored unencrypted in /root/.docker/config.json.<br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] Configure a credential helper to remove this warning. See<br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] https:<span class="hljs-comment">//docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] <br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] Login Succeeded<br>[<span class="hljs-number">17</span>:<span class="hljs-number">47</span>:<span class="hljs-number">39</span>] buildctl build --frontend dockerfile.v0 --local context=/root/workspace/spring-boot_If45 --local dockerfile=/root/workspace/spring-boot_If45  --output <span class="hljs-keyword">type</span>=image,name=registry.cn-shenzhen.aliyuncs.com/mikey/app:<span class="hljs-number">2023</span><span class="hljs-number">-12</span><span class="hljs-number">-01</span><span class="hljs-number">-17</span><span class="hljs-number">-47</span><span class="hljs-number">-19</span>,push=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>docker buildx基本上支持buildctl的所有功能。Docker Buildx是Docker的一种新特性，它实际上是在buildctl基础上进行了扩展，提供了更多与Docker集成的功能。<br>Docker buildx具有以下特性：</p>
<ul>
<li>使用BuildKit构建引擎，这是buildctl的核心特性。</li>
<li>支持在同一命令中构建多个平台的镜像，这是buildctl不具备的功能。</li>
<li>支持使用Dockerfile和Docker Compose文件进行构建，这也是buildctl不具备的功能。</li>
<li>提供了更丰富的输出格式选项，包括Docker镜像，本地文件系统，tar包等。</li>
<li>支持将构建缓存导出到远程存储，这是buildctl的一个重要特性。<br>总的来说，docker buildx不仅支持buildctl的所有功能，还提供了更多的功能和更好的集成性，使得用户可以更方便地使用Docker进行镜像构建。</li>
</ul>
<h2 id="Runner工作目录"><a href="#Runner工作目录" class="headerlink" title="Runner工作目录"></a>Runner工作目录</h2><p>//工作目录：<br>//workspace/txUUID/step/stepIdx/代码库（当前step的代码块）<br>//workspace/txUUID/代码库（当前pipeline的代码块，未受污染）<br>//workspace/txUUID/构建产物</p>
<p>下载构建物优先判断当前runner工作空间下是否已经存在，如果存在则直接复制到自己工作空间下使用，否则去OSS获取</p>
<p>如何清理pipeline工作空间呢？<br> </p>
<h2 id="Runner领域设计"><a href="#Runner领域设计" class="headerlink" title="Runner领域设计"></a>Runner领域设计</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1701766366752-af274142-3584-475e-8eb0-882df29c25cc.jpeg" srcset="/img/loading.gif" lazyload></p>
<h2 id="私服代码依赖问题"><a href="#私服代码依赖问题" class="headerlink" title="私服代码依赖问题"></a>私服代码依赖问题</h2><ol>
<li><p>一些二方包是存放在内部的git仓库中，在进行构建的时候需要有能正确的访问其资源，如：golang的二方包、java的maven仓库，npm仓库等等。需要提前设置这些资源的访问权限。</p>
</li>
<li><p>多任务并行在同一台runner上以主机的方式进行执行时，如果采用直接设置的方式，会相互影响。如：A项目设置了token=a然后去下载依赖，在A为完成时B任务启动设置了token=B然后去下载依赖，导致A出现异常，本质上其实就是环境不隔离产生的问题</p>
</li>
</ol>
<p>解决方法：</p>
<ol>
<li>针对 golang 应用，其二方包是直接在git仓库中，需要配置好访问代码仓库的权限才能进行 拉取依赖<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">go mod tidy<br></code></pre></td></tr></table></figure>
<img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1702111851244-30b30d96-32a0-45e3-9d42-82d4fb8e5445.png#averageHue=%23fcfcfc&clientId=ucf584530-f0f4-4&from=paste&height=197&id=u443dc00c&originHeight=394&originWidth=1262&originalType=binary&ratio=2&rotation=0&showTitle=false&size=38658&status=done&style=none&taskId=uf6f8817f-f9f2-451e-a00e-88c84287141&title=&width=631" srcset="/img/loading.gif" lazyload alt="image.png"></li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json">git config --global url.<span class="hljs-string">&quot;https://$&#123;GIT_USERNAME&#125;:$&#123;GIT_PASSWORD&#125;@git.makeblock.com&quot;</span>.insteadOf <span class="hljs-string">&quot;https://git.makeblock.com&quot;</span><br><br>git config --global url.<span class="hljs-string">&quot;git@git.makeblock.com:&quot;</span>.insteadOf <span class="hljs-string">&quot;https://git.makeblock.com/&quot;</span><br></code></pre></td></tr></table></figure>

<p>–local 和 –global 是 Git 命令中用于设置配置的选项，它们之间有以下区别：</p>
<ol>
<li>–local：使用 –local 选项设置的配置仅对当前 Git 仓库有效。这意味着配置仅适用于当前项目，并且会保存在项目的 .git/config 文件中。其他项目不会受到影响，每个项目都可以有自己独立的配置。</li>
<li>–global：使用 –global 选项设置的配置对当前用户的所有 Git 仓库都有效。这意味着配置会保存在用户的全局配置文件中（通常是 ~/.gitconfig 或 %USERPROFILE%.gitconfig）。所有项目都会共享这些全局配置。</li>
</ol>
<ol start="2">
<li><p>针对 npm 应用，只需要配置好registry地址即可，在发包时需要配置用户名和密码，这个凭证供用户进行选择</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">npm config set registry=http<span class="hljs-punctuation">:</span><span class="hljs-comment">//repository.makeblock.com/repository/npm-group/</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>针对 Java 应用，其二方包一把发布在 maven 仓库中，但是访问需要配置好 setting.xml 文件（用户名密码访问endpoint等）</p>
</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1702111525349-6f29759f-0972-4652-accf-7165ed9633e6.png#averageHue=%23fbfbfb&clientId=ucf584530-f0f4-4&from=paste&height=191&id=u063fc75b&originHeight=382&originWidth=1247&originalType=binary&ratio=2&rotation=0&showTitle=false&size=36401&status=done&style=none&taskId=uf81df78b-65b1-41fa-8ed5-7ef3e0eb33d&title=&width=623.5" srcset="/img/loading.gif" lazyload alt="image.png"><br>在项目中的settings.xml文件，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs json">&lt;servers&gt;<br>  &lt;server&gt;<br>    &lt;id&gt;rdc-releases&lt;/id&gt;<br>    &lt;username&gt;$<span class="hljs-punctuation">&#123;</span>MVN_USERNAME<span class="hljs-punctuation">&#125;</span>&lt;/username&gt;<br>    &lt;password&gt;$<span class="hljs-punctuation">&#123;</span>MVN_PASSWORD<span class="hljs-punctuation">&#125;</span>&lt;/password&gt;<br>  &lt;/server&gt;<br>  &lt;server&gt;<br>    &lt;id&gt;rdc-snapshots&lt;/id&gt;<br>    &lt;username&gt;$<span class="hljs-punctuation">&#123;</span>MVN_USERNAME<span class="hljs-punctuation">&#125;</span>&lt;/username&gt;<br>    &lt;password&gt;$<span class="hljs-punctuation">&#123;</span>MVN_PASSWORD<span class="hljs-punctuation">&#125;</span>&lt;/password&gt;<br>  &lt;/server&gt;<br>&lt;/servers&gt;<br><br>&lt;profiles&gt;<br>  &lt;profile&gt;<br>    &lt;activation&gt;<br>      &lt;activeByDefault&gt;<span class="hljs-literal"><span class="hljs-keyword">true</span></span>&lt;/activeByDefault&gt;<br>    &lt;/activation&gt;<br>    &lt;id&gt;rdc-private-repo&lt;/id&gt;<br>    &lt;repositories&gt;<br>      &lt;repository&gt;<br>        &lt;id&gt;rdc-releases&lt;/id&gt;<br>        &lt;url&gt;https<span class="hljs-punctuation">:</span><span class="hljs-comment">//packages.xxxx.com/maven/repository/release/&lt;/url&gt;</span><br>      &lt;/repository&gt;<br>      &lt;repository&gt;<br>        &lt;id&gt;rdc-snapshots&lt;/id&gt;<br>        &lt;url&gt;https<span class="hljs-punctuation">:</span><span class="hljs-comment">//packages.xxxx.com/maven/repository/release/&lt;/url&gt;</span><br>      &lt;/repository&gt;<br>    &lt;/repositories&gt;<br>  &lt;/profile&gt;<br>&lt;/profiles&gt;<br></code></pre></td></tr></table></figure>
<p>在使用</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">mvn -B -U -s setting.xml install<br></code></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/202386.html?spm=a2cl9.flow_devops2020_goldlog_detail.0.0.1a3324aeOGZ8TN">https://help.aliyun.com/document_detail/202386.html?spm=a2cl9.flow_devops2020_goldlog_detail.0.0.1a3324aeOGZ8TN</a></p>
<h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ol>
<li>连接线上gitlab打通整套流程</li>
</ol>
<p>是每个环境的部署一条流水线还是说是类似Jenkins每个应用一条流水线呢</p>
<p>一个应用单条流水线实现多环境的部署</p>
<ol>
<li>管理简单，只需要维护一条流水线</li>
<li>实现逻辑复杂，需要在单条流水线中提供编辑每个stage、step的触发条件，运行时进行判断，</li>
<li>每次</li>
</ol>
<p>一个应用多条流水线实现不同环境的部署</p>
<ol>
<li>流程清晰，可以由不同的角色（如测试）进行控制不同的环境部署上线</li>
<li>单个应用流水线数量会比较多，（开发环境、测试环境、预发布环境、生产环境）</li>
<li>考虑多分支并行开发问题，这种粒度可以实现多分支环境部署</li>
</ol>
<p>k8s配置文件存放问题</p>
<ol>
<li>集中管理变更时容易，权限管控到位，但是如何在部署的时候获取呢，如何进行更新镜像版本部署呢</li>
</ol>
<p>适配现有的环境进行传递如下参数</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">ENV_APP_NAME = d2v-service（可以通过app对象拿到）<br>#镜像版本<br>ENV_APP_VERSION = <span class="hljs-number">1.1</span><span class="hljs-number">.6</span>（可以通过上传构建产物在后续节点package.json获取）<br>#部署环境：开发、测试、预发布、生产<br>ENV_CD_ENV = deploy-dev（需要用户选择）<br>#<br>ENV_GIT_COMMIT = <span class="hljs-number">4</span>a02ca48d527661cf76dd8f7b7fbaea6641532df（可以通过checkout对象拿到）<br>#当前部署项目的配置文件<br>ENV_APP_PATH = makeblock-store/d2v-service（可以通过app对象拿到）<br></code></pre></td></tr></table></figure>
<p>需要先使用 kustomize 进行镜像更新，再使用 kubectl 进行部署</p>
<p>如何传递参数给 <strong>部署的step</strong> 呢</p>
<blockquote>
<p>通过构建产物输出</p>
</blockquote>
<p>流程的规范化问题</p>
<ol>
<li>开发环境：开发触发和执行</li>
<li>测试环境：开发触发，提供测试人员执行确认的功能（是否提测交由测试人员决定）</li>
<li>预发布环境：</li>
<li>生产环境：d</li>
</ol>
<p>开发进行提测（比如类似现在的推送到release分支），测试进行确认通过，执行测试cicd流水线，</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1702288989218-7ddb3c2d-6769-41bd-bf48-f239d6c74c82.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>当流程稳定后，无需运维的介入，转变为</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1702290800543-16973a04-c609-4d0b-98cd-30e12d0e187d.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>针对数据</p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><ol>
<li>docker api ：<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/api/v1.43/">https://docs.docker.com/engine/api/v1.43/</a></li>
<li>act ： <a target="_blank" rel="noopener" href="https://github.com/nektos/act">https://github.com/nektos/act</a></li>
<li>github action runner：<a target="_blank" rel="noopener" href="https://github.com/actions/runner">https://github.com/actions/runner</a></li>
<li>actions-runner-controller ：<a target="_blank" rel="noopener" href="https://github.com/actions/actions-runner-controller">https://github.com/actions/actions-runner-controller</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/actions/checkout">https://github.com/actions/checkout</a></li>
</ol>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD/" class="category-chain-item">基础设施</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/CI-CD/">#CI/CD</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CI/CD平台的探索与实践</div>
      <div>https://mikeygithub.github.io/2023/08/21/yuque/smvgphsynqgypg9u/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Mikey</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年8月21日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/03/09/yuque/fqkp3r1netzt9hod/" title="云原生-Istio 性能测试">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">云原生-Istio 性能测试</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/05/09/yuque/sk7iwsaphdt260gp/" title="基准测试工具-wrk / wrk2 / ab">
                        <span class="hidden-mobile">基准测试工具-wrk / wrk2 / ab</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'mikeygithub/commit-utterance');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.13.10/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});
  });
</script>




  <!-- Custom -->
  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="https://octodex.github.com/images/jetpacktocat.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       Copyright © 麦奇 Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> and <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> core on github page 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      桂ICP备2020009931号-1
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=2020009931"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>桂公网安备2020009931号</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?74301a15e5497361e93588eeee69f4b2";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'G-NCN3Z5PSLJ', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        MathJax = {
          tex    : {
            inlineMath: { '[+]': [['$', '$']] }
          },
          loader : {
            load: ['ui/lazy']
          },
          options: {
            renderActions: {
              findScript    : [10, doc => {
                document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                  const display = !!node.type.match(/; *mode=display/);
                  const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                  const text = document.createTextNode('');
                  node.parentNode.replaceChild(text, node);
                  math.start = { node: text, delim: '', n: 0 };
                  math.end = { node: text, delim: '', n: 0 };
                  doc.math.push(math);
                });
              }, '', false],
              insertedScript: [200, () => {
                document.querySelectorAll('mjx-container').forEach(node => {
                  let target = node.parentNode;
                  if (target.nodeName.toLowerCase() === 'li') {
                    target.parentNode.classList.add('has-jax');
                  }
                });
              }, '', false]
            }
          }
        };
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.0/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
