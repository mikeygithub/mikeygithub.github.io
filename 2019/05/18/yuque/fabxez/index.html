

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer"/>
  <link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/favicon.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Mikey">
  <meta name="keywords" content="">
  
    <meta name="description" content="本篇主要记录学习Golang过程的笔记  简介Go语言（或 Golang）起源于 2007 年，并在 2009 年正式对外发布。Go 是非常年轻的一门语言，它的主要目标是“兼具 Python 等动态语言的开发速度和 C&#x2F;C++ 等编译型语言的性能与安全性”。 Go语言是编程语言设计的又一次尝试，是对类C语言的重大改进，它不但能让你访问底层操作系统，还提供了强大的网络编程和并发编程支持。Go语言">
<meta property="og:type" content="article">
<meta property="og:title" content="Golang篇-Golang学习笔记">
<meta property="og:url" content="https://mikeygithub.github.io/2019/05/18/yuque/fabxez/index.html">
<meta property="og:site_name" content="麦奇">
<meta property="og:description" content="本篇主要记录学习Golang过程的笔记  简介Go语言（或 Golang）起源于 2007 年，并在 2009 年正式对外发布。Go 是非常年轻的一门语言，它的主要目标是“兼具 Python 等动态语言的开发速度和 C&#x2F;C++ 等编译型语言的性能与安全性”。 Go语言是编程语言设计的又一次尝试，是对类C语言的重大改进，它不但能让你访问底层操作系统，还提供了强大的网络编程和并发编程支持。Go语言">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/2630542/1664417011590-443526ec-7e21-472c-bb9c-4544499a80f4.png">
<meta property="article:published_time" content="2019-05-18T02:53:06.000Z">
<meta property="article:modified_time" content="2023-03-04T13:27:45.275Z">
<meta property="article:author" content="Mikey">
<meta property="article:tag" content="Golang">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2022/png/2630542/1664417011590-443526ec-7e21-472c-bb9c-4544499a80f4.png">
  
  
<!--    <meta name="referrer" content="no-referrer-when-downgrade">-->
  
  
  <title>Golang篇-Golang学习笔记 - 麦奇</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"mikeygithub.github.io","root":"/","version":"1.9.1","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":200}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"74301a15e5497361e93588eeee69f4b2","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="麦奇" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>麦奇</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/photo/">
                <i class="iconfont icon-image"></i>
                照片
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/music/">
                <i class="iconfont icon-music"></i>
                音乐
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                RSS
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Golang篇-Golang学习笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Mikey
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2019-05-18 10:53" pubdate>
          2019年5月18日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          84k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          698 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Golang篇-Golang学习笔记</h1>
            
            <div class="markdown-body">
              
              <p><img src="https://cdn.nlark.com/yuque/0/2022/png/2630542/1664417011590-443526ec-7e21-472c-bb9c-4544499a80f4.png#averageHue=%2375cbdb&clientId=ub9c41f95-4337-4&errorMessage=unknown%20error&from=paste&height=355&id=u6745a559&name=image.png&originHeight=710&originWidth=1280&originalType=binary&ratio=1&rotation=0&showTitle=false&size=325247&status=error&style=none&taskId=uc479f079-28de-4cbc-aa38-b3ad28080e1&title=&width=640" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>本篇主要记录学习Golang过程的笔记</p>
</blockquote>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Go语言（或 Golang）起源于 2007 年，并在 2009 年正式对外发布。Go 是非常年轻的一门语言，它的主要目标是“兼具 Python 等动态语言的开发速度和 C/C++ 等编译型语言的性能与安全性”。</p>
<p>Go语言是编程语言设计的又一次尝试，是对类C语言的重大改进，它不但能让你访问底层操作系统，还提供了强大的网络编程和并发编程支持。Go语言的用途众多，可以进行网络编程、系统编程、并发编程、分布式编程。</p>
<p>Go语言的推出，旨在不损失应用程序性能的情况下降低代码的复杂性，具有“部署简单、并发性好、语言设计良好、执行性能好”等优势，目前国内诸多 IT 公司均已采用Go语言开发项目。</p>
<p>Go语言有时候被描述为“C 类似语言”，或者是“21 世纪的C语言”。Go 从C语言继承了相似的表达式语法、控制流结构、基础数据类型、调用参数传值、指针等很多思想，还有C语言一直所看中的编译后机器码的运行效率以及和现有操作系统的无缝适配。</p>
<p>因为Go语言没有类和继承的概念，所以它和 Java 或 C++ 看起来并不相同。但是它通过接口（interface）的概念来实现多态性。Go语言有一个清晰易懂的轻量级类型系统，在类型之间也没有层级之说。因此可以说Go语言是一门混合型的语言。</p>
<p>此外，很多重要的开源项目都是使用Go语言开发的，其中包括 Docker、Go-Ethereum、Thrraform 和 Kubernetes。</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>1.下载安装包</p>
<p><a target="_blank" rel="noopener" href="https://go.dev/doc/install">https://go.dev/doc/install</a> </p>
<p>2.查看版本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">go version<br></code></pre></td></tr></table></figure>


<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><h2 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h2><table>
<thead>
<tr>
<th>break</th>
<th>常用于跳出循环，switch</th>
<th>default</th>
<th>配合switch、select</th>
<th>func</th>
<th>定义函数</th>
<th>interface</th>
<th>接口</th>
<th>select</th>
<th>选择流程</th>
</tr>
</thead>
<tbody><tr>
<td>case</td>
<td>配合switch</td>
<td>defer</td>
<td>后置处理</td>
<td>go</td>
<td>并行</td>
<td>map</td>
<td>字典</td>
<td>struct</td>
<td>结构体</td>
</tr>
<tr>
<td>chan</td>
<td>管道</td>
<td>else</td>
<td>否则</td>
<td>goto</td>
<td>跳到某个代码块</td>
<td>package</td>
<td>包</td>
<td>switch</td>
<td>分支</td>
</tr>
<tr>
<td>const</td>
<td>常量</td>
<td>fallthrough</td>
<td>搭配switch</td>
<td>if</td>
<td>判断</td>
<td>range</td>
<td>范围</td>
<td>type</td>
<td>类型声明</td>
</tr>
<tr>
<td>continue</td>
<td>结束一次循环</td>
<td>for</td>
<td>循环</td>
<td>import</td>
<td>导包</td>
<td>return</td>
<td>返回</td>
<td>var</td>
<td>定义变量</td>
</tr>
</tbody></table>
<h2 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h2><p>Go语言的基本类型有：</p>
<ul>
<li>bool</li>
<li>string</li>
<li>int、int8、int16、int32、int64</li>
<li>uint、uint8、uint16、uint32、uint64、uintptr</li>
<li>byte // uint8 的别名</li>
<li>rune // int32 的别名 代表一个 Unicode 码</li>
<li>float32、float64</li>
<li>complex64、complex128（复数）</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th><strong>整数类型</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>有符号 | int | 所占用的字节数与运行机器的CPU相关。在32位机器中，大小为4字节；在64位机器中，大小为8字节 |<br>|  | int8 | 占用一个字节存储（8位），范围是-128 ~ 127 |<br>|  | int16 | 占用两个字节存储（16位），范围是-32768 ~ 32767 |<br>|  | int32 | 占用四个字节存储（32位），范围是-2147483648 ~ 2147483647 |<br>|  | int64 | 占用八个字节存储（64位），范围是-9223372036854775808 ~ 9223372036854775807 |<br>| </p>
<p>无符号 | uint | 所占用的字节数与运行机器的CPU相关。在32位机器中，大小为4字节；在64位机器中，大小为8字节 |<br>|  | uint8 | 占用一个字节存储（即8位），范围是0 ~ 255  |<br>|  | uint16 | 占用两个字节存储（16位），范围是0 ~ 65535 |<br>|  | uint32 | 占用四个字节存储（32位），范围是0 ~ 4294967295 |<br>|  | uint64 | 占用八个字节存储（64位），范围是0 ~ 18446744073709551615 |<br>|  | uintptr | 一个无符号整数类型 |<br>|  | byte | byte类型是uint8的别名 |</p>
<h2 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h2><p>在go中是区分大小写的，属性首字母大写表示公开，小写表示私有</p>
<h2 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h2><p>变量的命名规则遵循骆驼命名法，即首个单词小写，每个新单词的首字母大写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">var</span> name type<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">name := method or ...<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">var</span> a,b = <span class="hljs-number">1</span>,<span class="hljs-number">2</span><br><span class="hljs-keyword">var</span> (<br>	a <span class="hljs-type">int</span><br>	b string<br>	c []float32<br>	d <span class="hljs-title function_">func</span><span class="hljs-params">()</span> bool<br>	e struct &#123;<br>		x <span class="hljs-type">int</span><br>	&#125;<br>)<br></code></pre></td></tr></table></figure>



<h2 id="函数声明"><a href="#函数声明" class="headerlink" title="函数声明"></a>函数声明</h2><p><img src="https://cdn.nlark.com/yuque/0/2022/png/2630542/1664190750876-88fe622f-bbd7-4dac-9dee-a256adb00145.png#averageHue=%23f1f1f1&clientId=ud43e1dd8-a112-4&errorMessage=unknown%20error&from=paste&height=82&id=u5dcb9e8a&name=image.png&originHeight=164&originWidth=589&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17508&status=error&style=none&taskId=u900413d3-7184-4253-84c4-b1dc66fd80a&title=&width=294.5" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">func <span class="hljs-title function_">Hello</span><span class="hljs-params">(name string)</span> string &#123;<br>	<span class="hljs-comment">// Return a greeting that embeds the name in a message.</span><br>	message := fmt.Sprintf(<span class="hljs-string">&quot;Hi, %v. Welcome!&quot;</span>, name)<br>	<span class="hljs-keyword">return</span> message<br>&#125;<br><span class="hljs-comment">//注意 golang支持返回多个结果</span><br>func <span class="hljs-title function_">moreRet</span><span class="hljs-params">(s string)</span> (string,string) &#123;<br>	<span class="hljs-keyword">return</span> s,s<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">声明时赋值<br>a:=<span class="hljs-number">100</span><br><span class="hljs-type">var</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure>
<p>变量交换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">var</span> <span class="hljs-type">a</span> <span class="hljs-variable">int</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span><br><span class="hljs-keyword">var</span> <span class="hljs-type">b</span> <span class="hljs-variable">int</span> <span class="hljs-operator">=</span> <span class="hljs-number">200</span><br>b, a = a, b<br>fmt.Println(a, b)<br></code></pre></td></tr></table></figure>

<h2 id="匿名变量"><a href="#匿名变量" class="headerlink" title="匿名变量"></a>匿名变量</h2><p>在golang中<code>_</code>表示空白标识符</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">func <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>	a,_:=m()<br>	fmt.Println(a)<br>	_,b:=m()<br>	fmt.Println(b)<br>&#125;<br><br>func <span class="hljs-title function_">m</span><span class="hljs-params">()</span> (<span class="hljs-type">int</span>, <span class="hljs-type">int</span>) &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">func <span class="hljs-title function_">m</span><span class="hljs-params">()</span> (<span class="hljs-type">int</span>, <span class="hljs-type">int</span>) &#123;<br>	a:=<span class="hljs-number">1000</span><br>	b:=string(a)<br>	fmt.Println(b)<br>	c:=<span class="hljs-type">int</span>(b[<span class="hljs-number">0</span>])<br>	fmt.Println(c)<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span><br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="指针类型"><a href="#指针类型" class="headerlink" title="指针类型"></a>指针类型</h2><p>1.创建指针</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">func <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-type">var</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span><br>	fmt.Printf(<span class="hljs-string">&quot;s=%s\n&quot;</span>, s)<br>	ptr:=&amp;s<span class="hljs-comment">//方式1</span><br>	fmt.Printf(<span class="hljs-string">&quot;ptr type=%T\n&quot;</span>, ptr)<br>	fmt.Printf(<span class="hljs-string">&quot;ptr=%p\n&quot;</span>, ptr)<br>	val := *ptr<br>	fmt.Println(val)<br><br>    ptr2 := <span class="hljs-keyword">new</span>(string)<span class="hljs-comment">//方式二</span><br>	*ptr2 = <span class="hljs-string">&quot;hello&quot;</span><br>	fmt.Printf(<span class="hljs-string">&quot;ptr2 type=%T\n&quot;</span>, ptr2)<br>	fmt.Println(<span class="hljs-string">&quot;ptr2 value=&quot;</span>,*ptr2)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a>逃逸分析</h2><p>todo</p>
<h2 id="定义常量"><a href="#定义常量" class="headerlink" title="定义常量"></a>定义常量</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">const</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mike&quot;</span><br>name = <span class="hljs-string">&quot;hello&quot;</span><span class="hljs-comment">//cannot assign to name (untyped string constant &quot;mike&quot;)</span><br>const <span class="hljs-type">intro</span> <span class="hljs-variable">string</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ffffff&quot;</span><br>const (<br>		s = <span class="hljs-string">&#x27;a&#x27;</span><br>		<span class="hljs-type">f</span> <span class="hljs-variable">float32</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>	)<br></code></pre></td></tr></table></figure>


<h2 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">type Car struct &#123;<br>	No string<br>	Intro string<br>	driver string<br>&#125;<br><br><span class="hljs-type">type</span> <span class="hljs-variable">Bus</span> <span class="hljs-operator">=</span> Car<br><br>bus := Bus&#123;<br>	No:    <span class="hljs-string">&quot;粤B&quot;</span>,<br>	Intro: <span class="hljs-string">&quot;abc&quot;</span>,<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="注释使用"><a href="#注释使用" class="headerlink" title="注释使用"></a>注释使用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//单行</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">多行</span><br><span class="hljs-comment">*/</span><br><br></code></pre></td></tr></table></figure>
<p>godoc 工具</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> get golang.org/x/tools/cmd/godoc<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go">Usage of [<span class="hljs-keyword">go</span>] doc:<br>        <span class="hljs-keyword">go</span> doc<br>        <span class="hljs-keyword">go</span> doc &lt;pkg&gt;<br>        <span class="hljs-keyword">go</span> doc &lt;sym&gt;[.&lt;methodOrField&gt;]<br>        <span class="hljs-keyword">go</span> doc [&lt;pkg&gt;.]&lt;sym&gt;[.&lt;methodOrField&gt;]<br>        <span class="hljs-keyword">go</span> doc [&lt;pkg&gt;.][&lt;sym&gt;.]&lt;methodOrField&gt;<br>        <span class="hljs-keyword">go</span> doc &lt;pkg&gt; &lt;sym&gt;[.&lt;methodOrField&gt;]<br>For more information run<br>        <span class="hljs-keyword">go</span> help doc<br><br>Flags:<br>  -all<br>        show all documentation <span class="hljs-keyword">for</span> <span class="hljs-keyword">package</span><br>  -c    symbol matching honors <span class="hljs-keyword">case</span> (paths not affected)<br>  -cmd<br>        show symbols with <span class="hljs-keyword">package</span> docs even <span class="hljs-keyword">if</span> <span class="hljs-keyword">package</span> is a command<br>  -short<br>        one-line representation <span class="hljs-keyword">for</span> each symbol<br>  -src<br>        show source code <span class="hljs-keyword">for</span> symbol<br>  -u    show unexported symbols as well as exported<br></code></pre></td></tr></table></figure>

<h2 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h2><p>go使用的是go mod进行依赖管理</p>
<blockquote>
<p>Modules 是相关 Go 包的集合，是源代码交换和版本控制的单元。Go语言命令直接支持使用 Modules，包括记录和解析对其他模块的依赖性，Modules 替换旧的基于 GOPATH 的方法，来指定使用哪些源文件。</p>
</blockquote>
<p>开启</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">export GO111MODULE=on 或者 export GO111MODULE=auto<br></code></pre></td></tr></table></figure>
<p>详解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">Go mod provides access to operations on modules.<br><br>Note that support <span class="hljs-keyword">for</span> modules is built into all the go commands,<br>not just <span class="hljs-string">&#x27;go mod&#x27;</span>. For example, day-to-day adding, removing, upgrading,<br>and downgrading of dependencies should be done using <span class="hljs-string">&#x27;go get&#x27;</span>.<br>See <span class="hljs-string">&#x27;go help modules&#x27;</span> <span class="hljs-keyword">for</span> an overview of <span class="hljs-keyword">module</span> functionality.<br><br>Usage:<br><br>        go mod &lt;command&gt; [arguments]<br><br>The commands are:<br><br>        download    download modules to local cache<br>        edit        edit go.mod from tools or scripts<br>        graph       print <span class="hljs-keyword">module</span> requirement graph<br>        init        initialize <span class="hljs-keyword">new</span> <span class="hljs-title class_">module</span> in current directory<br>        tidy        add missing and remove unused modules<br>        vendor      make vendored copy of dependencies<br>        verify      verify dependencies have expected content<br>        why         explain why packages or modules are needed<br><br>Use <span class="hljs-string">&quot;go help mod &lt;command&gt;&quot;</span> <span class="hljs-keyword">for</span> more information about a command.<br></code></pre></td></tr></table></figure>


<h2 id="分配内存"><a href="#分配内存" class="headerlink" title="分配内存"></a>分配内存</h2><p><img src="https://cdn.nlark.com/yuque/0/2022/png/2630542/1664513400027-add36d60-ccf5-4391-8869-bd6a8d0f4347.png#averageHue=%23e7c695&clientId=ub9c41f95-4337-4&errorMessage=unknown%20error&from=paste&height=74&id=u1bce9aa0&name=image.png&originHeight=148&originWidth=767&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18133&status=error&style=none&taskId=u528249e9-33aa-404c-b3bc-7b6a88b7d4d&title=&width=383.5" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h2><p>分支语句（if 和 switch）、循环（for）和跳转（goto）语句。另外，还有循环控制语句（break 和 continue），前者的功能是中断循环或者跳出 switch 判断，后者的功能是继续 for 的下一个循环</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">switch</span> 接口变量.(<span class="hljs-keyword">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> 类型<span class="hljs-number">1</span>:<br>        <span class="hljs-comment">// 变量是类型1时的处理</span><br>    <span class="hljs-keyword">case</span> 类型<span class="hljs-number">2</span>:<br>        <span class="hljs-comment">// 变量是类型2时的处理</span><br>    …<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-comment">// 变量不是所有case中列举的类型时的处理</span><br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	expr:=<span class="hljs-number">2000</span><br>	<span class="hljs-keyword">switch</span> expr &#123;<br>	<span class="hljs-keyword">case</span> <span class="hljs-number">100</span>:<br>		fmt.Println(<span class="hljs-number">1</span>)<br>		<span class="hljs-keyword">break</span><br>	<span class="hljs-keyword">case</span> <span class="hljs-number">200</span>:<br>		fmt.Println(<span class="hljs-number">2</span>)<br>		<span class="hljs-keyword">break</span><br>	<span class="hljs-keyword">default</span>:<br>		fmt.Println(<span class="hljs-string">&quot;default&quot;</span>)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fore</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>		fmt.Println(i)<br>	&#125;<br>	arr:=[]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>&#125;<br>	<span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> arr &#123;<br>		fmt.Println(i,v)<br>	&#125;<br>	i:=<span class="hljs-number">10</span><br>	<span class="hljs-keyword">for</span> i&gt;<span class="hljs-number">0</span> &#123;<br>		fmt.Println(i)<br>		i--<br>		<span class="hljs-keyword">if</span> i == <span class="hljs-number">7</span> &#123;<br>			<span class="hljs-keyword">continue</span><br>		&#125;<br>		<span class="hljs-keyword">if</span> i == <span class="hljs-number">5</span> &#123;<br>			<span class="hljs-keyword">break</span><br>		&#125;<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">branch</span><span class="hljs-params">()</span></span> &#123;<br>	a := <span class="hljs-number">100</span><br>	<span class="hljs-keyword">if</span> a == <span class="hljs-number">10</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;case1&quot;</span>)<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> a == <span class="hljs-number">20</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;case2&quot;</span>)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;case3&quot;</span>)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p>1.函数定义</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> 函数名<span class="hljs-params">(形式参数列表)</span></span>(返回值列表)&#123;<br>    函数体<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">m</span><span class="hljs-params">()</span></span> (<span class="hljs-type">int</span>, <span class="hljs-type">int</span>) &#123;<br>	a:=<span class="hljs-number">1000</span><br>	b:=<span class="hljs-type">string</span>(a)<br>	fmt.Println(b)<br>	c:=<span class="hljs-type">int</span>(b[<span class="hljs-number">0</span>])<br>	fmt.Println(c)<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">(i, j, k <span class="hljs-type">int</span>, s, t <span class="hljs-type">string</span>)</span></span> &#123; <span class="hljs-comment">/* ... */</span> &#125;<br><span class="hljs-comment">//等价于</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">f</span><span class="hljs-params">(i <span class="hljs-type">int</span>, j <span class="hljs-type">int</span>, k <span class="hljs-type">int</span>, s <span class="hljs-type">string</span>, t <span class="hljs-type">string</span>)</span></span> &#123; <span class="hljs-comment">/* ... */</span> &#125;<br></code></pre></td></tr></table></figure>
<p>2.函数返回值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">golang支持多返回值<br></code></pre></td></tr></table></figure>
<p>3.函数也可以作为参数传递</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	s := exec(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>		<span class="hljs-keyword">return</span> s+<span class="hljs-string">&quot; Mike&quot;</span><br>	&#125;,<span class="hljs-string">&quot;hello&quot;</span>)<br>	fmt.Println(s)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">exec</span><span class="hljs-params">(f <span class="hljs-keyword">func</span>(s <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span>,s <span class="hljs-type">string</span>) <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> f(s)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>4.带有变量名的返回值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">m2</span><span class="hljs-params">()</span></span> (a, b <span class="hljs-type">int</span>) &#123;<br>	a =<span class="hljs-number">1000</span><br>	b =<span class="hljs-number">200</span><br>	<span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">m3</span><span class="hljs-params">()</span></span> &#123;<br>	a,b := m2()<br>	fmt.Println(a,b)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>5.函数变量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> f <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span><br>	f = m<br>	f()<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">m</span><span class="hljs-params">()</span></span>&#123;<br>	fmt.Println(<span class="hljs-string">&quot;func&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>6.匿名函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(参数列表)</span></span>(返回参数列表)&#123;<br>    函数体<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	ret:=<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hi&quot;</span><br>	&#125;()<br>	fmt.Println(ret)<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	f := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hi&quot;</span><br>	&#125;<br>	ret := f()<br>	fmt.Println(ret)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>1.可变参数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">m</span><span class="hljs-params">(args... <span class="hljs-type">int</span>)</span></span> &#123;<br>	<span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> args &#123;<br>		fmt.Println(i,v)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><blockquote>
<p>函数 + 引用环境 = 闭包<br>闭包（Closure）在某些编程语言中也被称为 Lambda 表达式。</p>
</blockquote>
<p>定义：<strong>在函数内部引用了函数内部变量的函数</strong></p>
<p>闭包内修改变量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 准备一个字符串</span><br>	str := <span class="hljs-string">&quot;hello world&quot;</span><br>	<span class="hljs-comment">// 创建一个匿名函数</span><br>	foo := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-comment">// 匿名函数中访问str</span><br>		str = <span class="hljs-string">&quot;hello golang&quot;</span><br>	&#125;<br>	<span class="hljs-comment">// 调用匿名函数</span><br>	foo()<br>	fmt.Println(str)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>闭包的记忆</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 创建一个累加器, 初始值为1</span><br>	accumulator := acc(<span class="hljs-number">1</span>)<br>	<span class="hljs-comment">// 累加1并打印</span><br>	fmt.Println(accumulator())<br>	fmt.Println(accumulator())<br>	<span class="hljs-comment">// 打印累加器的函数地址</span><br>	fmt.Printf(<span class="hljs-string">&quot;%p\n&quot;</span>, &amp;accumulator)<br>	<span class="hljs-comment">// 创建一个累加器, 初始值为1</span><br>	accumulator2 := acc(<span class="hljs-number">10</span>)<br>	<span class="hljs-comment">// 累加1并打印</span><br>	fmt.Println(accumulator2())<br>	<span class="hljs-comment">// 打印累加器的函数地址</span><br>	fmt.Printf(<span class="hljs-string">&quot;%p\n&quot;</span>, &amp;accumulator2)<br>&#125;<br><br><span class="hljs-comment">// 提供一个值, 每次调用函数会指定对值进行累加</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">acc</span><span class="hljs-params">(value <span class="hljs-type">int</span>)</span></span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br>	<span class="hljs-comment">// 返回一个闭包</span><br>	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br>		<span class="hljs-comment">// 累加</span><br>		value++<br>		<span class="hljs-comment">// 返回一个累加值</span><br>		<span class="hljs-keyword">return</span> value<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>defer其实也是一种闭包</p>
<h2 id="后置"><a href="#后置" class="headerlink" title="后置"></a>后置</h2><p>defer关键字作为函数的后置执行，在return之前执行，主要用于释放资源</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">acc</span><span class="hljs-params">(args... <span class="hljs-type">int</span>)</span></span> &#123;<br>    <span class="hljs-comment">//多个def是按照栈的执行顺序</span><br>	<span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;defer&quot;</span>)<br>	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;后置函数&quot;</span>)<br>	&#125;()<br>	<span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> args &#123;<br>		fmt.Println(i,v)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h1><h2 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Hello</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-comment">//如果name为空串丢出错误</span><br>    <span class="hljs-keyword">if</span> name == <span class="hljs-string">&quot;&quot;</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, errors.New(<span class="hljs-string">&quot;empty name&quot;</span>)<br>    &#125;<br>    message := fmt.Sprintf(<span class="hljs-string">&quot;Hi, %v. Welcome!&quot;</span>, name)<br>    <span class="hljs-keyword">return</span> message, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    message, err := Hello(<span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-comment">//如果有错误err对象不为nil</span><br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>    &#125;<br>    fmt.Println(message)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>自定义错误</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	e := errors.New(<span class="hljs-string">&quot;xxxx&quot;</span>)<br>	fmt.Println(e)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Panic"><a href="#Panic" class="headerlink" title="Panic"></a>Panic</h2><blockquote>
<p>panic手动触发宕机，让程序崩溃，这样开发者可以及时地发现错误</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;宕机后要做的事情1&quot;</span>)<br>	<span class="hljs-keyword">defer</span> fmt.Println(<span class="hljs-string">&quot;宕机后要做的事情2&quot;</span>)<br>	<span class="hljs-keyword">var</span> s <span class="hljs-type">string</span><br>	<span class="hljs-keyword">if</span> s == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;s is nil&quot;</span>)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Recover"><a href="#Recover" class="headerlink" title="Recover"></a>Recover</h2><blockquote>
<p>让进入宕机流程中的 goroutine 恢复过来，recover 仅在延迟函数 defer 中有效，在正常的执行过程中，调用 recover 会返回 nil 并且没有其他任何效果，如果当前的 goroutine 陷入错误，调用 recover 可以捕获到 panic 的输入值，并且恢复正常的执行。</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">handlePanic</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">if</span> a := <span class="hljs-built_in">recover</span>(); a != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;RECOVER&quot;</span>, a)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">entry</span><span class="hljs-params">(lang *<span class="hljs-type">string</span>, name *<span class="hljs-type">string</span>)</span></span> &#123;<br>	<span class="hljs-keyword">defer</span> handlePanic()<br>	<span class="hljs-keyword">if</span> lang == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;Error: Language cannot be nil&quot;</span>)<br>	&#125;<br>	<span class="hljs-keyword">if</span> name == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;Error: Author name cannot be nil&quot;</span>)<br>	&#125;<br>	fmt.Printf(<span class="hljs-string">&quot;Author Language: %s \n Author Name: %s\n&quot;</span>, *lang, *name)<br>	fmt.Printf(<span class="hljs-string">&quot;Return successfully from the entry function&quot;</span>)<br>&#125;<br><br><span class="hljs-comment">// Main function</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	A_lang := <span class="hljs-string">&quot;GO Language&quot;</span><br>	entry(&amp;A_lang, <span class="hljs-literal">nil</span>)<br>	fmt.Printf(<span class="hljs-string">&quot;Return successfully from the main function&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h1><blockquote>
<p>结构体</p>
</blockquote>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> 类型名 <span class="hljs-keyword">struct</span> &#123;<br>    字段<span class="hljs-number">1</span> 字段<span class="hljs-number">1</span>类型<br>    字段<span class="hljs-number">2</span> 字段<span class="hljs-number">2</span>类型<br>    …<br>&#125;<br></code></pre></td></tr></table></figure>
<p>案例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>	Name <span class="hljs-type">string</span><span class="hljs-comment">//首字母大写表示public，小写表示private</span><br>	Sex <span class="hljs-type">int16</span><br>	Address,Phone <span class="hljs-type">string</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a>实例化</h2><p>1.实例化结构体类型</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> ins T<br><span class="hljs-comment">//or</span><br>ins := Struct&#123;<br>    XXX: XXX<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>
<p>案例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">p1 := Person&#123;<br>		Name: <span class="hljs-string">&quot;Mike&quot;</span>,<br>		Sex: <span class="hljs-number">1</span>,<br>		Address: <span class="hljs-string">&quot;Guangdong province&quot;</span>,<br>	&#125;<br></code></pre></td></tr></table></figure>
<p>2.创建指针类型</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">ns := <span class="hljs-built_in">new</span>(T)<br></code></pre></td></tr></table></figure>
<p>案例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>	Name <span class="hljs-type">string</span><br>	Sex <span class="hljs-type">int16</span><br>	Address,Phone <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	p2 := <span class="hljs-built_in">new</span>(Person)<br>	p2.Phone = <span class="hljs-string">&quot;122121&quot;</span><br>	p2.Sex = <span class="hljs-number">0</span><br>	p2.Name = <span class="hljs-string">&quot;Lily&quot;</span><br>	fmt.Printf(<span class="hljs-string">&quot;%p\n&quot;</span>,p2)<br>	fmt.Printf(<span class="hljs-string">&quot;%T\n&quot;</span>,p2)<br>	fmt.Printf(<span class="hljs-string">&quot;%v\n&quot;</span>,*p2)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>3.取结构体地址实例化</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">p3 := &amp;Person&#123;<br>	Name: <span class="hljs-string">&quot;Leo&quot;</span>,<br>	Phone: <span class="hljs-string">&quot;121212&quot;</span>,<br>	Sex: <span class="hljs-number">1</span>,<br>	Address: <span class="hljs-string">&quot;xxxxx&quot;</span>,<br>&#125;<br>fmt.Println(p3)<br></code></pre></td></tr></table></figure>

<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>	Name <span class="hljs-type">string</span><br>	Sex <span class="hljs-type">int16</span><br>	Address,Phone <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPersonName</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> *Person &#123;<br>	<span class="hljs-keyword">return</span> &amp;Person&#123;<br>		Name: name,<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPersonNameWithPhone</span><span class="hljs-params">(name ,phone <span class="hljs-type">string</span>)</span></span> *Person &#123;<br>	<span class="hljs-keyword">return</span> &amp;Person&#123;<br>		Name: name,<br>		Phone: phone,<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	p1:=NewPersonName(<span class="hljs-string">&quot;mike&quot;</span>)<br>	fmt.Println(p1)<br>	p2:=NewPersonNameWithPhone(<span class="hljs-string">&quot;Leo&quot;</span>,<span class="hljs-string">&quot;182121221&quot;</span>)<br>	fmt.Println(p2)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="匿名属性"><a href="#匿名属性" class="headerlink" title="匿名属性"></a>匿名属性</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>	Name <span class="hljs-type">string</span><br>	<span class="hljs-type">int16</span><span class="hljs-comment">//匿名字段，当前结构体有且只有一种同一匿名列席,赋值直接使用类型赋值</span><br>	Address,Phone <span class="hljs-type">string</span><br>	<span class="hljs-type">bool</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPersonNameWithPhone</span><span class="hljs-params">(name ,phone <span class="hljs-type">string</span>)</span></span> *Person &#123;<br>	<span class="hljs-keyword">return</span> &amp;Person&#123;<br>		Name: name,<br>		Phone: phone,<br>		<span class="hljs-type">int16</span>: <span class="hljs-number">1</span>,<br>		<span class="hljs-type">bool</span>:<span class="hljs-literal">false</span>,<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h1 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h1><h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> 数组变量名 [元素数量]Type<br><br><span class="hljs-keyword">var</span> arr [<span class="hljs-number">10</span>]<span class="hljs-type">int</span><br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">//定义</span><br>	<span class="hljs-keyword">var</span> arr [<span class="hljs-number">10</span>]<span class="hljs-type">int</span><br>	arr2 := [<span class="hljs-number">10</span>]<span class="hljs-type">int</span>&#123;<span class="hljs-number">10</span>,<span class="hljs-number">9</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">6</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>&#125;<br>	arr3 := [...]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>&#125;<br>	arr4 := []<span class="hljs-type">int</span>&#123;<span class="hljs-number">5</span>&#125;<br>    arr5 := [][]<span class="hljs-type">int</span>&#123;&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;,&#123;<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>&#125;&#125;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>		arr[i] = i<br>	&#125;<br>	<span class="hljs-comment">//遍历</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>		fmt.Print(arr[i])<br>	&#125;<br>	fmt.Println()<br>	<span class="hljs-keyword">for</span> i, v := <span class="hljs-keyword">range</span> arr &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;%d,%d\n&quot;</span>,i,v)<br>	&#125;<br>	fmt.Println()<br>	<span class="hljs-keyword">for</span> _, v := <span class="hljs-keyword">range</span> arr &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;%d\n&quot;</span>,v)<br>	&#125;<br>	<span class="hljs-comment">//比较(必须是长度一致)</span><br>	fmt.Println(arr == arr2,arr2 == arr3)<br>	fmt.Println(arr3 == arr4)<span class="hljs-comment">//Error:Invalid operation: arr3 == arr4 (mismatched types [10]int and []int)</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h2><p>Go 语言切片是对数组的抽象（基于数组）。<br>Go 数组的长度不可改变，在特定场景中这样的集合就不太适用，Go 中提供了一种灵活，功能强悍的内置类型切片(“动态数组”)，与数组相比切片的长度是不固定的，可以追加元素，在追加时可能使切片的容量增大。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">//定义一个切片</span><br>	arr := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>,<span class="hljs-number">10</span>)<br>	fmt.Println(arr)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>		arr[i] = i<br>	&#125;<br>	fmt.Println(<span class="hljs-built_in">len</span>(arr))<br>	fmt.Println(arr)<br>	array:=[]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>&#125;<br>	<span class="hljs-comment">//对数组进行切片</span><br>	fmt.Println(array[<span class="hljs-number">1</span>:<span class="hljs-number">4</span>])<br>&#125;<br></code></pre></td></tr></table></figure>
<p>追加切片</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">//定义一个切片</span><br>	arr := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>,<span class="hljs-number">10</span>)<br>	fmt.Println(arr)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++ &#123;<br>		  arr = <span class="hljs-built_in">append</span>(arr,i)<span class="hljs-comment">//追加</span><br>		  arr = <span class="hljs-built_in">append</span>(arr,[]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;...)<span class="hljs-comment">//追加切片</span><br>		  arr = <span class="hljs-built_in">append</span>(arr[:<span class="hljs-number">2</span>],[]<span class="hljs-type">int</span>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>&#125;...)<span class="hljs-comment">//指定位置追加</span><br>		  fmt.Printf(<span class="hljs-string">&quot;cap=%d\n&quot;</span>,<span class="hljs-built_in">cap</span>(arr))<br>		  fmt.Println(arr)<br>	&#125;<br>	fmt.Println(<span class="hljs-built_in">len</span>(arr))<br>	fmt.Println(arr)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>切片复制</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">//定义一个切片</span><br>	arr := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>,<span class="hljs-number">15</span>)<br>	cpy := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>,<span class="hljs-number">15</span>)<br>	fmt.Println(arr)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++ &#123;<br>		  arr[i] = i<br>	&#125;<br>	fmt.Println(<span class="hljs-built_in">len</span>(arr))<br>	fmt.Println(arr)<br>	<span class="hljs-comment">//全部复制</span><br>	<span class="hljs-built_in">copy</span>(cpy,arr)<br>	fmt.Println(<span class="hljs-built_in">len</span>(cpy))<br>	fmt.Println(cpy)<br>	<span class="hljs-comment">//指定范围复制</span><br>	rge := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>,<span class="hljs-number">15</span>)<br>	<span class="hljs-built_in">copy</span>(rge[<span class="hljs-number">3</span>:<span class="hljs-number">8</span>],arr[<span class="hljs-number">3</span>:<span class="hljs-number">8</span>])<br>	fmt.Println(<span class="hljs-built_in">len</span>(rge))<br>	fmt.Println(rge)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>删除切片</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">//定义一个切片</span><br>	arr := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>,<span class="hljs-number">15</span>)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++ &#123;<br>		arr[i] = i<br>	&#125;<br>	fmt.Printf(<span class="hljs-string">&quot;原始数据 arr=%v\n&quot;</span>,arr)<br>	<span class="hljs-comment">//头部删除</span><br>	arr = arr[<span class="hljs-number">3</span>:]<br>	fmt.Printf(<span class="hljs-string">&quot;头部删除 arr=%v\n&quot;</span>,arr)<br>	<span class="hljs-comment">//尾部删除</span><br>	arr = arr[:<span class="hljs-number">10</span>]<br>	fmt.Printf(<span class="hljs-string">&quot;尾部删除 arr=%v\n&quot;</span>,arr)<br>	<span class="hljs-comment">//中间删除</span><br>	arr = <span class="hljs-built_in">append</span>(arr[:<span class="hljs-number">4</span>],arr[<span class="hljs-number">6</span>:]...)<br>	fmt.Printf(<span class="hljs-string">&quot;中间删除 arr=%v\n&quot;</span>,arr)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> mapname <span class="hljs-keyword">map</span>[keytype]valuetype<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> m <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span><br>	m = <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>&#123;&#125;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">97</span>; i &lt; <span class="hljs-number">110</span>; i++ &#123;<br>		m[<span class="hljs-string">&quot;name&quot;</span>+<span class="hljs-type">string</span>(i)] = <span class="hljs-type">string</span>(i)<br>	&#125;<br>	fmt.Println(<span class="hljs-built_in">len</span>(m))<br>	fmt.Println(m)<br>	<span class="hljs-comment">//make</span><br>	m2 :=<span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)<br>	m3 :=<span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>,<span class="hljs-number">100</span>)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">97</span>; i &lt; <span class="hljs-number">110</span>; i++ &#123;<br>		m2[<span class="hljs-string">&quot;name&quot;</span>+<span class="hljs-type">string</span>(i)] = <span class="hljs-type">string</span>(i)<br>	&#125;<br>	fmt.Println(<span class="hljs-built_in">len</span>(m2))<br>	fmt.Println(m2)<br>	fmt.Println(m3)<br>    <span class="hljs-comment">//遍历</span><br>    <br>	<span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> m &#123;<br>		fmt.Println(k,v)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>判断是否存在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">func <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>	m := make(map[string]string)<br>	m[<span class="hljs-string">&quot;one&quot;</span>] = <span class="hljs-string">&quot;one&quot;</span><br>	fmt.Println(m)<br>	<span class="hljs-keyword">if</span> _,ok := m[<span class="hljs-string">&quot;one&quot;</span>];ok &#123;<br>		fmt.Println(<span class="hljs-string">&quot;have&quot;</span>)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;no have&quot;</span>)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>删除</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-built_in">delete</span>(<span class="hljs-keyword">map</span>, 键)<br><br></code></pre></td></tr></table></figure>
<p>并发map sync.Map</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> cm sync.Map<br>	cm.Store(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">100</span>)<br>	cm.Store(<span class="hljs-number">200</span>, <span class="hljs-string">&quot;100&quot;</span>)<br>	fmt.Println(cm)<br>	fmt.Println(cm.Load(<span class="hljs-string">&quot;a&quot;</span>))<br>	cm.Delete(<span class="hljs-number">200</span>)<br>	fmt.Println(cm)<br>	cm.Range(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key, value any)</span></span> <span class="hljs-type">bool</span> &#123;<br>		fmt.Println(key,value)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>	&#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	list := list.New()<br>	fmt.Println(list)<br>	list.PushFront(<span class="hljs-string">&quot;hello&quot;</span>)<br>	list.PushFront(<span class="hljs-string">&quot;Hi&quot;</span>)<br>	fmt.Println(list.Len())<br>	fmt.Println(list)<br>	fmt.Println(list.Front())<br>    <span class="hljs-comment">//遍历</span><br>	<span class="hljs-keyword">for</span> i := list.Front(); i != <span class="hljs-literal">nil</span>; i = i.Next() &#123;<br>		fmt.Println(i.Value)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><blockquote>
<p>golang 的sort包下提供一些排序的api提供给开发者使用</p>
</blockquote>
<p>1.简单排序</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	arr:=[]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>,<span class="hljs-string">&quot;f&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;z&quot;</span>,<span class="hljs-string">&quot;K&quot;</span>,<span class="hljs-string">&quot;e&quot;</span>&#125;<br>	fmt.Println(arr)<br>	sort.Strings(arr)<br>	fmt.Println(arr)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>2.自定义排序</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Interface <span class="hljs-keyword">interface</span> &#123;<br>	<span class="hljs-comment">// Len is the number of elements in the collection.</span><br>	Len() <span class="hljs-type">int</span><br><br>	<span class="hljs-comment">// Less reports whether the element with index i</span><br>	<span class="hljs-comment">// must sort before the element with index j.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// If both Less(i, j) and Less(j, i) are false,</span><br>	<span class="hljs-comment">// then the elements at index i and j are considered equal.</span><br>	<span class="hljs-comment">// Sort may place equal elements in any order in the final result,</span><br>	<span class="hljs-comment">// while Stable preserves the original input order of equal elements.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Less must describe a transitive ordering:</span><br>	<span class="hljs-comment">//  - if both Less(i, j) and Less(j, k) are true, then Less(i, k) must be true as well.</span><br>	<span class="hljs-comment">//  - if both Less(i, j) and Less(j, k) are false, then Less(i, k) must be false as well.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Note that floating-point comparison (the &lt; operator on float32 or float64 values)</span><br>	<span class="hljs-comment">// is not a transitive ordering when not-a-number (NaN) values are involved.</span><br>	<span class="hljs-comment">// See Float64Slice.Less for a correct implementation for floating-point values.</span><br>	Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span><br><br>	<span class="hljs-comment">// Swap swaps the elements with indexes i and j.</span><br>	Swap(i, j <span class="hljs-type">int</span>)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>案例</p>
<h1 id="包"><a href="#包" class="headerlink" title="包"></a>包</h1><p>在golang中的所有源文件都必须有所归属的包</p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>Go语言的包借助了目录树的组织形式，一般包的名称就是其源文件所在目录的名称，虽然Go语言没有强制要求包名必须和其所在的目录名同名，但还是建议包名和所在目录同名，这样结构更清晰。</p>
<h2 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> pacakgeName<br></code></pre></td></tr></table></figure>
<blockquote>
<p>只有在main包下的源文件才能独立运行</p>
</blockquote>
<h2 id="导包"><a href="#导包" class="headerlink" title="导包"></a>导包</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//单行导入</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;包 1 的路径&quot;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;包 2 的路径&quot;</span><br><span class="hljs-comment">//多行导入</span><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;包 1 的路径&quot;</span><br>    <span class="hljs-string">&quot;包 2 的路径&quot;</span><br>)<br><span class="hljs-comment">//匿名导入</span><br><span class="hljs-keyword">import</span> _ <span class="hljs-string">&quot;fmt&quot;</span><br></code></pre></td></tr></table></figure>

<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><h3 id="go-mod"><a href="#go-mod" class="headerlink" title="go mod"></a>go mod</h3><blockquote>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> mod tidy<br></code></pre></td></tr></table></figure>

<h3 id="govendor"><a href="#govendor" class="headerlink" title="govendor"></a>govendor</h3><blockquote>
<p>已废弃</p>
</blockquote>
<p>地址：github.com/kardianos/govendor</p>
<h2 id="常用"><a href="#常用" class="headerlink" title="常用"></a>常用</h2><h4 id="1-fmt"><a href="#1-fmt" class="headerlink" title="1) fmt"></a>1) fmt</h4><p>fmt 包实现了格式化的标准输入输出，这与C语言中的 printf 和 scanf 类似。其中的 fmt.Printf() 和 fmt.Println() 是开发者使用最为频繁的函数。</p>
<p>格式化短语派生于C语言，一些短语（%- 序列）是这样使用：</p>
<ul>
<li>%v：默认格式的值。当打印结构时，加号（%+v）会增加字段名；</li>
<li>%#v：Go样式的值表达；</li>
<li>%T：带有类型的 Go 样式的值表达。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 接受命令行输入, 不做任何事情</span><br><span class="hljs-keyword">var</span> input <span class="hljs-type">string</span><br>fmt.Scanln(&amp;input)<br></code></pre></td></tr></table></figure>


<h4 id="2-io"><a href="#2-io" class="headerlink" title="2) io"></a>2) io</h4><p>这个包提供了原始的 I/O 操作界面。它主要的任务是对 os 包这样的原始的 I/O 进行封装，增加一些其他相关，使其具有抽象功能用在公共的接口上。</p>
<h4 id="3-bufio"><a href="#3-bufio" class="headerlink" title="3) bufio"></a>3) bufio</h4><p>bufio 包通过对 io 包的封装，提供了数据缓冲功能，能够一定程度减少大块数据读写带来的开销。</p>
<p>在 bufio 各个组件内部都维护了一个缓冲区，数据读写操作都直接通过缓存区进行。当发起一次读写操作时，会首先尝试从缓冲区获取数据，只有当缓冲区没有数据时，才会从数据源获取数据更新缓冲。</p>
<h4 id="4-sort"><a href="#4-sort" class="headerlink" title="4) sort"></a>4) sort</h4><p>sort 包提供了用于对切片和用户定义的集合进行排序的功能。</p>
<h4 id="5-strconv"><a href="#5-strconv" class="headerlink" title="5) strconv"></a>5) strconv</h4><p>strconv 包提供了将字符串转换成基本数据类型，或者从基本数据类型转换为字符串的功能。</p>
<h4 id="6-os"><a href="#6-os" class="headerlink" title="6) os"></a>6) os</h4><p>os 包提供了不依赖平台的操作系统函数接口，设计像 Unix 风格，但错误处理是 go 风格，当 os 包使用时，如果失败后返回错误类型而不是错误数量。</p>
<h4 id="7-sync"><a href="#7-sync" class="headerlink" title="7) sync"></a>7) sync</h4><p>sync 包实现多线程中锁机制以及其他同步互斥机制。</p>
<h4 id="8-flag"><a href="#8-flag" class="headerlink" title="8) flag"></a>8) flag</h4><p>flag 包提供命令行参数的规则定义和传入参数解析的功能。绝大部分的命令行程序都需要用到这个包。</p>
<h4 id="9-encoding-json"><a href="#9-encoding-json" class="headerlink" title="9) encoding/json"></a>9) encoding/json</h4><p>JSON 目前广泛用做网络程序中的通信格式。encoding/json 包提供了对 JSON 的基本支持，比如从一个对象序列化为 JSON 字符串，或者从 JSON 字符串反序列化出一个具体的对象等。</p>
<h4 id="10-html-template"><a href="#10-html-template" class="headerlink" title="10) html/template"></a>10) html/template</h4><p>主要实现了 web 开发中生成 html 的 template 的一些函数。</p>
<h4 id="11-net-http"><a href="#11-net-http" class="headerlink" title="11) net/http"></a>11) net/http</h4><p>net/http 包提供 HTTP 相关服务，主要包括 http 请求、响应和 URL 的解析，以及基本的 http 客户端和扩展的 http 服务。</p>
<p>通过 net/http 包，只需要数行代码，即可实现一个爬虫或者一个 Web 服务器，这在传统语言中是无法想象的。</p>
<h4 id="12-reflect"><a href="#12-reflect" class="headerlink" title="12) reflect"></a>12) reflect</h4><p>reflect 包实现了运行时反射，允许程序通过抽象类型操作对象。通常用于处理静态类型 interface{} 的值，并且通过 Typeof 解析出其动态类型信息，通常会返回一个有接口类型 Type 的对象。</p>
<h4 id="13-os-exec"><a href="#13-os-exec" class="headerlink" title="13) os/exec"></a>13) os/exec</h4><p>os/exec 包提供了执行自定义 linux 命令的相关实现。</p>
<h4 id="14-strings"><a href="#14-strings" class="headerlink" title="14) strings"></a>14) strings</h4><p>strings 包主要是处理字符串的一些函数集合，包括合并、查找、分割、比较、后缀检查、索引、大小写处理等等。</p>
<p>strings 包与 bytes 包的函数接口功能基本一致。</p>
<h4 id="15-regexp"><a href="#15-regexp" class="headerlink" title="15) regexp"></a>15) regexp</h4><p>regexp包为正则表达式提供了官方支持，其采用 RE2 语法，除了\c、\C外，Go语言和 Perl、<a target="_blank" rel="noopener" href="http://c.biancheng.net/python/">Python</a> 等语言的正则基本一致。</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="16-bytes"><a href="#16-bytes" class="headerlink" title="16) bytes"></a>16) bytes</h4><p>bytes 包提供了对字节切片进行读写操作的一系列函数。字节切片处理的函数比较多，分为基本处理函数、比较函数、后缀检查函数、索引函数、分割函数、大小写处理函数和子切片处理函数等。</p>
<h4 id="17-log"><a href="#17-log" class="headerlink" title="17) log"></a>17) log</h4><p>log 包主要用于在程序中输出日志。</p>
<p>log 包中提供了三类日志输出接口，Print、Fatal 和 Panic。</p>
<ul>
<li>Print 是普通输出；</li>
<li>Fatal 是在执行完 Print 后，执行 os.Exit(1)；</li>
<li>Panic 是在执行完 Print 后调用 panic() 方法。</li>
</ul>
<h4 id="18-time"><a href="#18-time" class="headerlink" title="18) time"></a>18) time</h4><p>time包为时间相关api包</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    now := time.Now() <span class="hljs-comment">//获取当前时间</span><br>    fmt.Printf(<span class="hljs-string">&quot;current time:%v\n&quot;</span>, now)<br>    year := now.Year()     <span class="hljs-comment">//年</span><br>    month := now.Month()   <span class="hljs-comment">//月</span><br>    day := now.Day()       <span class="hljs-comment">//日</span><br>    hour := now.Hour()     <span class="hljs-comment">//小时</span><br>    minute := now.Minute() <span class="hljs-comment">//分钟</span><br>    second := now.Second() <span class="hljs-comment">//秒</span><br>    fmt.Printf(<span class="hljs-string">&quot;%d-%02d-%02d %02d:%02d:%02d\n&quot;</span>, year, month, day, hour, minute, second)<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="19-context"><a href="#19-context" class="headerlink" title="19) context"></a>19) context</h4><h1 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h1><h2 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> 接口类型名 <span class="hljs-keyword">interface</span>&#123;<br>    方法名<span class="hljs-number">1</span>( 参数列表<span class="hljs-number">1</span> ) 返回值列表<span class="hljs-number">1</span><br>    方法名<span class="hljs-number">2</span>( 参数列表<span class="hljs-number">2</span> ) 返回值列表<span class="hljs-number">2</span><br>    …<br>&#125;<br></code></pre></td></tr></table></figure>
<p>实例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Animal <span class="hljs-keyword">interface</span> &#123;<br>	sleep(t <span class="hljs-type">int</span>) <span class="hljs-type">bool</span><br>	walk(d <span class="hljs-type">int</span>) <span class="hljs-type">bool</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(实现类)</span></span> 方法名(参数) 返回类型 &#123;<br>	<span class="hljs-comment">//方法体</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>案例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-comment">//定义接口</span><br><span class="hljs-keyword">type</span> Animal <span class="hljs-keyword">interface</span> &#123;<br>	sleep(t <span class="hljs-type">int</span>) <span class="hljs-type">bool</span><br>	walk(d <span class="hljs-type">int</span>) <span class="hljs-type">bool</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> &#123;<br>	Name <span class="hljs-type">string</span><br>	Age <span class="hljs-type">int</span><br>&#125;<br><span class="hljs-comment">//为Dog类实现接口</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d Dog)</span></span> sleep(t <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123;<br>	fmt.Println(<span class="hljs-string">&quot;the dog sleep time = &quot;</span>,t)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d Dog)</span></span> walk(t <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> &#123;<br>	fmt.Println(<span class="hljs-string">&quot;the dog walk time = &quot;</span>,t)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> a1 Animal<br>	a1 = Dog&#123;<br>		Name: <span class="hljs-string">&quot;labuladuo&quot;</span>,<br>		Age: <span class="hljs-number">1</span>,<br>	&#125;<br>	a1.sleep(<span class="hljs-number">1</span>)<br>	a1.walk(<span class="hljs-number">1</span>)<br>	fmt.Println(a1)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="类型转换-1"><a href="#类型转换-1" class="headerlink" title="类型转换"></a>类型转换</h2><blockquote>
<p>Go语言中使用接口断言（type assertions）将接口转换成另外一个接口，也可以将接口转换为另外的类型</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">t := i.(T)<br>t,ok := i.(T)<br></code></pre></td></tr></table></figure>
<p>其中，i 代表接口变量，T 代表转换的目标类型，t 代表转换后的变量。</p>
<p>案例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Car <span class="hljs-keyword">interface</span> &#123;<br>	driver() <span class="hljs-type">bool</span><br>&#125;<br><span class="hljs-keyword">type</span> Animal <span class="hljs-keyword">interface</span> &#123;<br>	sleep(t <span class="hljs-type">int</span>) <span class="hljs-type">bool</span><br>	walk(d <span class="hljs-type">int</span>) <span class="hljs-type">bool</span><br>&#125;<br><span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> &#123;<br>	Name <span class="hljs-type">string</span><br>	Age <span class="hljs-type">int</span><br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> dog Animal<br>	dog=Dog&#123;Name: <span class="hljs-string">&quot;labuladuo&quot;</span>&#125;<br>	t,ok := dog.(Car)<br>	<span class="hljs-keyword">if</span> ok &#123;<br>		fmt.Println(<span class="hljs-string">&quot;转换成功&quot;</span>,t)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;类型不匹配&quot;</span>)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>关于接口的实现</p>
<ul>
<li>如果定义的是 (Type)Method，则该类型会隐式的声明一个 (*Type)Method；</li>
<li>如果定义的是 (*Type)Method ，则不会隐式什么一个 (Type)Method。</li>
</ul>
<p>如果接收者是指针类型，在函数内修改接收者是直接修改原始的变量的，如果是结构体类型因为传递的值拷贝，修改不会影响原始对象。</p>
<h1 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h1><p>golang</p>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><p>goroutine 是一种非常轻量级的实现，可在单个进程里执行成千上万的并发任务，它是Go语言并发设计的核心。</p>
<p>开启协程</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-comment">//....</span><br>&#125;()<br></code></pre></td></tr></table></figure>
<p>案例</p>
<h2 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h2><p>Channel 是 Golang 在语言级别提供的 goroutine 之间的通信方式，可以使用 channel 在两个或多个 goroutine 之间传递消息。Channel 是进程内的通信方式，因此通过 channel 传递对象的过程和调用函数时的参数传递行为比较一致，比如也可以传递指针等。使用通道发送和接收所需的共享资源，可以在 goroutine 之间消除竞争条件。<br>当一个资源需要在 goroutine 之间共享时，channel 在 goroutine 之间架起了一个管道，并提供了确保同步交换数据的机制。Channel 是类型相关的，也就是说，一个 channel 只能传递一种类型的值，这个类型需要在声明 channel 时指定。可以通过 channel 共享内置类型、命名类型、结构类型和引用类型的值或者指针。</p>
<h3 id="结构-1"><a href="#结构-1" class="headerlink" title="结构"></a>结构</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1672672034389-d2064f86-125a-43b8-ab5e-2078e86b06f4.png#averageHue=%23f3eadc&clientId=ua8cfc091-d022-4&from=paste&height=511&id=ud58cb78b&name=image.png&originHeight=1022&originWidth=1456&originalType=binary&ratio=1&rotation=0&showTitle=false&size=460923&status=done&style=none&taskId=ub88535e9-b764-4580-90d9-eae03c94016&title=&width=728" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> ChannelName <span class="hljs-keyword">chan</span> ElementType<br>ChannelName = <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ElementType,size)<br><span class="hljs-comment">//或者</span><br>ChannelName := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> ElementType,size)<br><span class="hljs-comment">//发送数据</span><br>ChannelName&lt;-ElementType<br><span class="hljs-comment">//获取数据</span><br>ret:=&lt;-ChannelName<br><span class="hljs-comment">//单通道channel</span><br><span class="hljs-keyword">var</span> 通道实例 <span class="hljs-keyword">chan</span>&lt;- 元素类型    <span class="hljs-comment">// 只能写入数据的通道</span><br><span class="hljs-keyword">var</span> 通道实例 &lt;-<span class="hljs-keyword">chan</span> 元素类型    <span class="hljs-comment">// 只能读取数据的通道</span><br></code></pre></td></tr></table></figure>
<p>案例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	fmt.Println(context.Background())<br>	ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>,<span class="hljs-number">3</span>)<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>			ch &lt;- i<br>			time.Sleep(<span class="hljs-number">1</span>*time.Second)<br>		&#125;<br>	&#125;()<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">for</span> <span class="hljs-literal">true</span> &#123;<br>			v:=&lt;-ch<br>			fmt.Println(v)<br>			time.Sleep(<span class="hljs-number">1</span>*time.Second)<br>		&#125;<br>	&#125;()<br>	time.Sleep(<span class="hljs-number">10</span>*time.Second)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><p>关闭channel</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br>	<span class="hljs-built_in">close</span>(ch)<br>	_,ok := &lt;-ch<br>	<span class="hljs-keyword">if</span> !ok &#123;<br>		fmt.Println(<span class="hljs-string">&quot;channel closed&quot;</span>)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="buffered-channel"><a href="#buffered-channel" class="headerlink" title="buffered channel"></a>buffered channel</h3><p>Go语言中有缓冲的通道（buffered channel）是一种在被接收前能存储一个或者多个值的通道。这种类型的通道并不强制要求 goroutine 之间必须同时完成发送和接收。通道会阻塞发送和接收动作的条件也会不同。只有在通道中没有要接收的值时，接收动作才会阻塞。只有在通道没有可用缓冲区容纳被发送的值时，发送动作才会阻塞。</p>
<blockquote>
<p>注意：如果在main线程中直接对无缓冲区chan操作时，会产生deadlock</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">通道实例 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> 通道类型, 缓冲大小)<br></code></pre></td></tr></table></figure>
<p>案例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>,<span class="hljs-number">100</span>)<br></code></pre></td></tr></table></figure>


<h3 id="unbuffered-channel"><a href="#unbuffered-channel" class="headerlink" title="unbuffered channel"></a>unbuffered channel</h3><p>无缓冲区是指在接收前没有能力保存任何值的通道。这种类型的通道要求发送 goroutine 和接收 goroutine 同时准备好，才能完成发送和接收操作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">通道实例 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> 通道类型)<br></code></pre></td></tr></table></figure>
<p>遍历chan</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>	ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">3</span>)<br>	<span class="hljs-keyword">for</span> &#123;<br>		fmt.Println(&lt;-ch)<br>	&#125;<br>&#125;()<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>, <span class="hljs-number">3</span>)<br>		ch &lt;- <span class="hljs-number">1</span><br>		ch &lt;- <span class="hljs-number">2</span><br>		ch &lt;- <span class="hljs-number">3</span><br>		cnt := <span class="hljs-number">1</span><br>		<span class="hljs-keyword">for</span> v := <span class="hljs-keyword">range</span> ch &#123;<br>			fmt.Println(v)<br>			cnt++<br>			<span class="hljs-keyword">if</span> cnt == <span class="hljs-number">3</span> &#123;<br>				<span class="hljs-built_in">close</span>(ch)<br>			&#125;<br>		&#125;<br>	&#125;()<br></code></pre></td></tr></table></figure>

<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> hchan <span class="hljs-keyword">struct</span> &#123;<br>    qcount   <span class="hljs-type">uint</span>           <span class="hljs-comment">// 当前队列中剩余元素个数</span><br>    dataqsiz <span class="hljs-type">uint</span>           <span class="hljs-comment">// 环形队列长度，即可以存放的元素个数</span><br>    buf      unsafe.Pointer <span class="hljs-comment">// 环形队列指针</span><br>    elemsize <span class="hljs-type">uint16</span>         <span class="hljs-comment">// 每个元素的大小</span><br>    closed   <span class="hljs-type">uint32</span>            <span class="hljs-comment">// 标识关闭状态</span><br>    elemtype *_type         <span class="hljs-comment">// 元素类型</span><br>    sendx    <span class="hljs-type">uint</span>           <span class="hljs-comment">// 队列下标，指示元素写入时存放到队列中的位置</span><br>    recvx    <span class="hljs-type">uint</span>           <span class="hljs-comment">// 队列下标，指示元素从队列的该位置读出</span><br>    recvq    waitq          <span class="hljs-comment">// 等待读消息的goroutine队列</span><br>    sendq    waitq          <span class="hljs-comment">// 等待写消息的goroutine队列</span><br>    lock mutex              <span class="hljs-comment">// 互斥锁，chan不允许并发读写</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><blockquote>
<p>又称上下文，golang 的 Context 包,是专门用来简化多个goroutine 之间传递数据、超时时间（deadline）、取消信号（cancellation signals）或者其他请求相关的信息</p>
</blockquote>
<p>比如有一个网络请求Request，每个Request都需要开启一个goroutine做一些事情，这些goroutine又可能会开启其他的goroutine。这样的话， 我们就可以通过Context，来跟踪这些goroutine，并且通过Context来控制他们的目的</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Context <span class="hljs-keyword">interface</span> &#123;<br>	Deadline() (deadline time.Time, ok <span class="hljs-type">bool</span>)<br>	Done() &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>	Err() <span class="hljs-type">error</span><br>	Value(key any) any<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>Deadline方法是获取设置的截止时间的意思，第一个返回式是截止时间，到了这个时间点，Context会自动发起取消请求；第二个返回值ok==false时表示没有设置截止时间，如果需要取消的话，需要调用取消函数进行取消。</li>
<li>Done方法返回一个只读的chan，类型为struct{}，我们在goroutine中，如果该方法返回的chan可以读取，则意味着parent context已经发起了取消请求，我们通过Done方法收到这个信号后，就应该做清理操作，然后退出goroutine，释放资源。之后，Err 方法会返回一个错误，告知为什么 Context 被取消。</li>
<li>Err方法返回取消的错误原因，因为什么Context被取消。</li>
<li>Value方法获取该Context上绑定的值，是一个键值对，所以要通过一个Key才可以获取对应的值，这个值一般是线程安全的。</li>
</ul>
<p>通过根Context派生出子Context</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithCancel</span><span class="hljs-params">(parent Context)</span></span> (ctx Context, cancel CancelFunc)<span class="hljs-comment">//返回一个字和函数该函数用于触发ctx的Done函数</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithDeadline</span><span class="hljs-params">(parent Context, d time.Time)</span></span> (Context, CancelFunc) <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithTimeout</span><span class="hljs-params">(parent Context, timeout time.Duration)</span></span> (Context, CancelFunc)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">WithValue</span><span class="hljs-params">(parent Context, key, val any)</span></span> Context<br></code></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">contextCancel</span><span class="hljs-params">()</span></span> &#123;<br>	ctx := context.Background()<br>	childCtx, CancelFunc := context.WithCancel(ctx)<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;<br>		<span class="hljs-keyword">for</span> &#123;<br>			<span class="hljs-keyword">select</span> &#123;<br>			<span class="hljs-keyword">case</span> &lt;-childCtx.Done():<br>				fmt.Println(<span class="hljs-string">&quot;触发Done&quot;</span>)<br>				<span class="hljs-keyword">return</span><br>				<span class="hljs-comment">//case xxx:</span><br>				<span class="hljs-comment">//	do something</span><br>			&#125;<br>		&#125;<br>	&#125;(childCtx)<br>	time.Sleep(time.Second)<br>	fmt.Println(<span class="hljs-string">&quot;主函数运行&quot;</span>)<br>	<span class="hljs-comment">//调用</span><br>	CancelFunc()<br>	fmt.Println(<span class="hljs-string">&quot;主函数完成&quot;</span>)<br>	time.Sleep(<span class="hljs-number">5</span> * time.Second)<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">contextDeadline</span><span class="hljs-params">()</span></span> &#123;<br>	ctx := context.Background()<br>	childCtx, CancelFunc := context.WithDeadline(ctx, time.Now().Add(<span class="hljs-number">3</span>*time.Second))<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;<br>		<span class="hljs-keyword">for</span> &#123;<br>			<span class="hljs-keyword">select</span> &#123;<br>			<span class="hljs-keyword">case</span> &lt;-childCtx.Done():<br>				fmt.Println(<span class="hljs-string">&quot;触发Done&quot;</span>)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>		&#125;<br>	&#125;(childCtx)<br>	time.Sleep(time.Second)<br>	fmt.Println(<span class="hljs-string">&quot;主函数运行&quot;</span>)<br>	<span class="hljs-comment">//也可以手动方式调用，不使用手动方式的话那就按照我们配置的时间</span><br>	CancelFunc()<br>	fmt.Println(<span class="hljs-string">&quot;主函数完成&quot;</span>)<br>	time.Sleep(<span class="hljs-number">5</span>*time.Second)<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">contextTimeout</span><span class="hljs-params">()</span></span> &#123;<br>	ctx := context.Background()<br>	childCtx, _ := context.WithTimeout(ctx, <span class="hljs-number">3</span>*time.Second)<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;<br>		<span class="hljs-keyword">for</span> &#123;<br>			<span class="hljs-keyword">select</span> &#123;<br>			<span class="hljs-keyword">case</span> &lt;-childCtx.Done():<br>				fmt.Println(<span class="hljs-string">&quot;触发Done&quot;</span>)<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>		&#125;<br>	&#125;(childCtx)<br>	time.Sleep(time.Second)<br>	fmt.Println(<span class="hljs-string">&quot;主函数运行&quot;</span>)<br>	<span class="hljs-comment">//手动方式调用，不使用手动方式的话那就按照我们配置的时间</span><br>	<span class="hljs-comment">//CancelFunc()</span><br>	fmt.Println(<span class="hljs-string">&quot;主函数完成&quot;</span>)<br>	time.Sleep(<span class="hljs-number">5</span> * time.Second)<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">contextValue</span><span class="hljs-params">()</span></span> &#123;<br>	ctx := context.Background()<br>	childCtx := context.WithValue(ctx, <span class="hljs-string">&quot;param&quot;</span>, <span class="hljs-string">&quot;Hello world&quot;</span>)<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> &#123;<br>		fmt.Println(ctx.Value(<span class="hljs-string">&quot;param&quot;</span>))<br>	&#125;(childCtx)<br>	time.Sleep(time.Second)<br>	fmt.Println(<span class="hljs-string">&quot;主函数完成&quot;</span>)<br>	time.Sleep(<span class="hljs-number">5</span> * time.Second)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h2><blockquote>
<p>select是go提供类似io多路复用的功能，有的类似Switch语句</p>
</blockquote>
<p>特点</p>
<ul>
<li>监听的case中,没有满足条件的就阻塞</li>
<li>多个满足条件的就任选一个执行</li>
<li>select本身不带循环,需要外层的for</li>
<li>default通常不用,会产生忙轮询</li>
<li>break只能跳出select中的一个case<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//select基本用法</span><br><span class="hljs-keyword">select</span> &#123;<br><span class="hljs-keyword">case</span> &lt;- chan1:<br><span class="hljs-comment">// 如果chan1成功读到数据，则进行该case处理语句</span><br><span class="hljs-keyword">case</span> chan2 &lt;- <span class="hljs-number">1</span>:<br><span class="hljs-comment">// 如果成功向chan2写入数据，则进行该case处理语句</span><br><span class="hljs-keyword">default</span>:<br><span class="hljs-comment">// 如果上面都没有成功，则进入default处理流程</span><br>&#125;<br></code></pre></td></tr></table></figure>
简单案例<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main9</span><span class="hljs-params">()</span></span> &#123;<br>	ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">for</span> &#123;<br>			<span class="hljs-keyword">select</span> &#123;<br>			<span class="hljs-keyword">case</span> v := &lt;-ch:<br>				fmt.Println(<span class="hljs-string">&quot;向ch读取数据:&quot;</span>, v)<br>			<span class="hljs-keyword">case</span> ch &lt;- <span class="hljs-number">0</span>:<br>				fmt.Println(<span class="hljs-string">&quot;向ch写入数据&quot;</span>)<br>			&#125;<br>		&#125;<br>	&#125;()<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>			ch &lt;- i<br>			fmt.Println(<span class="hljs-string">&quot;W&quot;</span>)<br>			time.Sleep(time.Second * <span class="hljs-number">2</span>)<br>		&#125;<br>	&#125;()<br>	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>			&lt;-ch<br>			time.Sleep(time.Second * <span class="hljs-number">2</span>)<br>		&#125;<br>	&#125;()<br>	time.Sleep(<span class="hljs-number">100</span> * time.Second)<br>&#125;<br></code></pre></td></tr></table></figure>
应用场景</li>
</ul>
<h2 id="锁-Lock"><a href="#锁-Lock" class="headerlink" title="锁 Lock"></a>锁 Lock</h2><blockquote>
<p>sync包下提供多种锁支持</p>
</blockquote>
<h3 id="Mutex锁"><a href="#Mutex锁" class="headerlink" title="Mutex 锁"></a>Mutex 锁</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> cnt <span class="hljs-type">int</span><br>	<span class="hljs-keyword">var</span> lock sync.Mutex<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>		idx:=i<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>			lock.Lock()<span class="hljs-comment">//加锁</span><br>			cnt++<br>			fmt.Println(<span class="hljs-string">&quot;协程:&quot;</span>, idx, <span class="hljs-string">&quot;修改cnt=&quot;</span>, cnt)<br>			time.Sleep(time.Second * <span class="hljs-number">1</span>)<br>			lock.Unlock()<span class="hljs-comment">//释放锁</span><br>		&#125;()<br>	&#125;<br>	time.Sleep(time.Second * <span class="hljs-number">10</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="RWMutex锁"><a href="#RWMutex锁" class="headerlink" title="RWMutex锁"></a>RWMutex锁</h3><blockquote>
<p>读写锁</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> cnt <span class="hljs-type">int</span><br>	rwl:=sync.RWMutex&#123;&#125;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>		idx:=i<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>			rwl.Lock()<span class="hljs-comment">//加锁</span><br>			cnt++<br>			fmt.Println(<span class="hljs-string">&quot;协程:&quot;</span>, idx, <span class="hljs-string">&quot;修改cnt=&quot;</span>, cnt)<br>			time.Sleep(time.Second * <span class="hljs-number">1</span>)<br>			rwl.Unlock()<span class="hljs-comment">//释放锁</span><br>		&#125;()<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>			rwl.RLock()<span class="hljs-comment">//加锁</span><br>			cnt++<br>			fmt.Println(<span class="hljs-string">&quot;协程:&quot;</span>, idx, <span class="hljs-string">&quot;读取cnt=&quot;</span>, cnt)<br>			time.Sleep(time.Second * <span class="hljs-number">1</span>)<br>			rwl.RUnlock()<span class="hljs-comment">//释放锁</span><br>		&#125;()<br>	&#125;<br>	time.Sleep(time.Second * <span class="hljs-number">10</span>)<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="WaitGroup"><a href="#WaitGroup" class="headerlink" title="WaitGroup"></a>WaitGroup</h2><p>类似于阻塞队列</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">group:=sync.WaitGroup&#123;&#125;<br>group.Add(<span class="hljs-number">1</span>)<span class="hljs-comment">//添加一个任务</span><br>group.Wait()<span class="hljs-comment">//等待所有任务完成</span><br></code></pre></td></tr></table></figure>
<p>案例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	group:=sync.WaitGroup&#123;&#125;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ &#123;<br>		group.Add(<span class="hljs-number">1</span>)<span class="hljs-comment">//添加一个任务</span><br>		idx:=i<br>		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>			<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>				fmt.Println(<span class="hljs-string">&quot;done&quot;</span>,idx)<br>				group.Done()<span class="hljs-comment">//完成一个任务</span><br>			&#125;()<br>			time.Sleep(time.Second)<br>		&#125;()<br>	&#125;<br>	group.Wait()<span class="hljs-comment">//等待所有任务完成</span><br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="GOMAXPROCS"><a href="#GOMAXPROCS" class="headerlink" title="GOMAXPROCS"></a>GOMAXPROCS</h2><p>调整并发的运行性能</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">runtime.GOMAXPROCS(逻辑CPU数量)<br></code></pre></td></tr></table></figure>
<p>查询</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	fmt.Println(runtime.GOMAXPROCS(runtime.NumCPU()))<br>&#125;<br></code></pre></td></tr></table></figure>


<h1 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h1><p>反射用于获取程序运行时的一些动态数据，解决golang是静态语言缺失动态性的问题，golang的反射相关api位于 reflect  包下</p>
<p>案例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> a <span class="hljs-type">int</span><br>	typeOfA := reflect.TypeOf(a)<br>	fmt.Println(typeOfA.Name(), typeOfA.Kind())<span class="hljs-comment">//类型和种类</span><br>	<span class="hljs-comment">//</span><br>	dog:=Animal&#123;<br>		name: <span class="hljs-string">&quot;labuladuo&quot;</span>,<br>	&#125;<br>	typeOf:=reflect.TypeOf(dog)<br>	fmt.Println(typeOf.Name(),typeOf.Kind())<br>	field := <span class="hljs-string">&quot;name&quot;</span><br>	name,ok:=typeOf.FieldByName(field)<br>	<span class="hljs-keyword">if</span> ok &#123;<br>		fmt.Println(name)<br>		fmt.Println(name.Type)<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		log.Fatal(<span class="hljs-string">&quot;could not found field&quot;</span>,field)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h1 id="I-O"><a href="#I-O" class="headerlink" title="I/O"></a>I/O</h1><p>golang的bufio 包中，实现了对数据 I/O 接口的缓冲功能</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bufio&quot;</span><br>	<span class="hljs-string">&quot;bytes&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	data := []<span class="hljs-type">byte</span>(<span class="hljs-string">&quot;Hi golang&quot;</span>)<br>	rd := bytes.NewReader(data)<br>	r := bufio.NewReader(rd)<br>	<span class="hljs-keyword">var</span> buf [<span class="hljs-number">128</span>]<span class="hljs-type">byte</span><br>	n, err := r.Read(buf[:])<br>	fmt.Println(<span class="hljs-type">string</span>(buf[:n]), n, err)<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h1><p>Go语言的 os 包下有一个 OpenFile 函数，其原型如下所示：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">OpenFile</span><span class="hljs-params">(name <span class="hljs-type">string</span>, flag <span class="hljs-type">int</span>, perm FileMode)</span></span> (file *File, err <span class="hljs-type">error</span>)<br></code></pre></td></tr></table></figure>
<p>其中 name 是文件的文件名，如果不是在当前路径下运行需要加上具体路径；flag 是文件的处理参数，为 int 类型，根据系统的不同具体值可能有所不同，但是作用是相同的。</p>
<p>下面列举了一些常用的 flag 文件处理参数：</p>
<ul>
<li>O_RDONLY：只读模式打开文件；</li>
<li>O_WRONLY：只写模式打开文件；</li>
<li>O_RDWR：读写模式打开文件；</li>
<li>O_APPEND：写操作时将数据附加到文件尾部（追加）；</li>
<li>O_CREATE：如果不存在将创建一个新文件；</li>
<li>O_EXCL：和 O_CREATE 配合使用，文件必须不存在，否则返回一个错误；</li>
<li>O_SYNC：当进行一系列写操作时，每次都要等待上次的 I/O 操作完成再进行；</li>
<li>O_TRUNC：如果可能，在打开时清空文件。</li>
</ul>
<h2 id="文本操作"><a href="#文本操作" class="headerlink" title="文本操作"></a>文本操作</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">////创建文件</span><br>	<span class="hljs-comment">//file,err:=os.Create(&quot;a.txt&quot;)</span><br>	<span class="hljs-comment">//if err!=nil &#123;</span><br>	<span class="hljs-comment">//	log.Fatal(&quot;创建失败&quot;,err)</span><br>	<span class="hljs-comment">//&#125;</span><br>	<span class="hljs-comment">//file.Write([]byte(&quot;hello world&quot;))</span><br>	<span class="hljs-comment">//读取文件</span><br>	file,err := os.Open(<span class="hljs-string">&quot;./a.txt&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Printf(<span class="hljs-string">&quot;文件打开失败 [Err:%s]\n&quot;</span>, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	reader := bufio.NewReader(file)<br>	<span class="hljs-keyword">for</span> &#123;<br>		str, err := reader.ReadString(<span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment">//读到一个换行就结束</span><br>		fmt.Println(str)<br>		<span class="hljs-keyword">if</span> err == io.EOF &#123;                  <span class="hljs-comment">//io.EOF 表示文件的末尾</span><br>			<span class="hljs-keyword">break</span><br>		&#125;<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;文件读取结束...&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="二进制操作"><a href="#二进制操作" class="headerlink" title="二进制操作"></a>二进制操作</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	info := <span class="hljs-string">&quot;hello world&quot;</span><br>	file, err := os.Create(<span class="hljs-string">&quot;./file.gob&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;文件创建失败&quot;</span>, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	encoder := gob.NewEncoder(file)<br>	err = encoder.Encode(info)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;编码错误&quot;</span>, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;编码成功&quot;</span>)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="压缩包操作"><a href="#压缩包操作" class="headerlink" title="压缩包操作"></a>压缩包操作</h2><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1676046368648-9cd017c6-69ab-42c6-8897-5c90e3b4acff.png#averageHue=%23f0f0f0&clientId=u086ec12a-749c-4&from=paste&height=204&id=u9bbc4506&name=image.png&originHeight=408&originWidth=1968&originalType=binary&ratio=2&rotation=0&showTitle=false&size=116740&status=done&style=none&taskId=uf4a32c71-b996-4f62-b08f-0d477affb37&title=&width=984" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>业务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">func <span class="hljs-title function_">Hello</span><span class="hljs-params">(name string)</span> <span class="hljs-type">int</span> &#123;<br>	<span class="hljs-comment">// Return a greeting that embeds the name in a message.</span><br>	message := fmt.Sprintf(<span class="hljs-string">&quot;Hi, %v. Welcome!&quot;</span>, name)<br>	<span class="hljs-keyword">return</span> message<br>&#125;<br></code></pre></td></tr></table></figure>
<p>测试类（注意类名：_test）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">func <span class="hljs-title function_">TestHello</span><span class="hljs-params">(t *testing.T)</span> &#123;<br>	<span class="hljs-comment">// Return a greeting that embeds the name in a message.</span><br>	ret:=Hello(<span class="hljs-string">&quot;mikey&quot;</span>)<br>    <span class="hljs-keyword">if</span> ret != <span class="hljs-number">0</span> &#123;<br>        t.Error(<span class="hljs-string">&quot;测试失败&quot;</span>)<br>    &#125;<br>	fmt.Println(ret)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">func <span class="hljs-title function_">GetArea</span><span class="hljs-params">(x,y <span class="hljs-type">int</span>)</span> <span class="hljs-type">int</span> &#123;<br>	<span class="hljs-keyword">return</span> x * y<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">func <span class="hljs-title function_">BenchmarkGetArea</span><span class="hljs-params">(t *testing.B)</span> &#123;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.N; i++ &#123;<br>		GetArea(<span class="hljs-number">40</span>, <span class="hljs-number">50</span>)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">go test -bench=<span class="hljs-string">&quot;.&quot;</span><br></code></pre></td></tr></table></figure>
<p>响应结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">biaoyang<span class="hljs-meta">@biaodeMacBook</span>-Pro test % go test -bench=<span class="hljs-string">&quot;.&quot;</span><br>goos: darwin<br>goarch: arm64<br>pkg: example/hello/test<br>BenchmarkGetArea-<span class="hljs-number">8</span>      <span class="hljs-number">1000000000</span>               <span class="hljs-number">0.4092</span> ns/op<br>PASS<br>ok      example/hello/test      <span class="hljs-number">0.</span>934s<br></code></pre></td></tr></table></figure>

<h2 id="覆盖率测试"><a href="#覆盖率测试" class="headerlink" title="覆盖率测试"></a>覆盖率测试</h2><p>测试覆盖率是指当运行测试用例时,代码(类,包,模块)中有多少被执行到。覆盖率通常用百分比来表示。例如当我们说一个包的覆盖率是85%的时候,就是说测试用例让包中85%的代码都运行过了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;testing&quot;</span><br><br>func <span class="hljs-title function_">BenchmarkGetArea</span><span class="hljs-params">(t *testing.B)</span> &#123;<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; t.N; i++ &#123;<br>		GetArea(<span class="hljs-number">40</span>, <span class="hljs-number">50</span>)<br>	&#125;<br>&#125;<br><br>func <span class="hljs-title function_">TestGetArea</span><span class="hljs-params">(t *testing.T)</span> &#123;<br>	ret:=GetArea(<span class="hljs-number">10</span>,<span class="hljs-number">10</span>)<br>	<span class="hljs-keyword">if</span> ret != <span class="hljs-number">100</span> &#123;<br>		t.Fail()<br>	&#125;<br>&#125;<br>func <span class="hljs-title function_">TestGetAreaError</span><span class="hljs-params">(t *testing.T)</span> &#123;<br>	ret:=GetArea(<span class="hljs-number">10</span>,<span class="hljs-number">10</span>)<br>	<span class="hljs-keyword">if</span> ret != <span class="hljs-number">10</span> &#123;<br>		t.Fail()<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">go test -cover<br></code></pre></td></tr></table></figure>
<p>响应结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">biaoyang<span class="hljs-meta">@biaodeMacBook</span>-Pro test % go test -cover<br>--- FAIL: TestGetAreaError (<span class="hljs-number">0.</span>00s)<br>FAIL<br>coverage: <span class="hljs-number">100.0</span>% of statements<br>exit status <span class="hljs-number">1</span><br>FAIL    example/hello/test      <span class="hljs-number">0.</span>091s<br></code></pre></td></tr></table></figure>
<p>帮助文档</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs go">biaoyang@biaodeMacBook-Pro ~ % <span class="hljs-keyword">go</span> help test<br>usage: <span class="hljs-keyword">go</span> test [build/test flags] [packages] [build/test flags &amp; test binary flags]<br><br><span class="hljs-string">&#x27;Go test&#x27;</span> automates testing the packages named by the <span class="hljs-keyword">import</span> paths.<br>It prints a summary of the test results in the format:<br><br>        ok   archive/tar   <span class="hljs-number">0.011</span>s<br>        FAIL archive/zip   <span class="hljs-number">0.022</span>s<br>        ok   compress/gzip <span class="hljs-number">0.033</span>s<br>        ...<br><br>followed by detailed output <span class="hljs-keyword">for</span> each failed <span class="hljs-keyword">package</span>.<br><br><span class="hljs-string">&#x27;Go test&#x27;</span> recompiles each <span class="hljs-keyword">package</span> along with any files with names matching<br>the file pattern <span class="hljs-string">&quot;*_test.go&quot;</span>.<br>These additional files can contain test functions, benchmark functions, fuzz<br>tests and example functions. See <span class="hljs-string">&#x27;go help testfunc&#x27;</span> <span class="hljs-keyword">for</span> more.<br>Each listed <span class="hljs-keyword">package</span> causes the execution of a separate test binary.<br>Files whose names begin with <span class="hljs-string">&quot;_&quot;</span> (including <span class="hljs-string">&quot;_test.go&quot;</span>) or <span class="hljs-string">&quot;.&quot;</span> are ignored.<br><br>Test files that declare a <span class="hljs-keyword">package</span> with the suffix <span class="hljs-string">&quot;_test&quot;</span> will be compiled as a<br>separate <span class="hljs-keyword">package</span>, and then linked and run with the main test binary.<br><br>The <span class="hljs-keyword">go</span> tool will ignore a directory named <span class="hljs-string">&quot;testdata&quot;</span>, making it available<br>to hold ancillary data needed by the tests.<br><br>As part of building a test binary, <span class="hljs-keyword">go</span> test runs <span class="hljs-keyword">go</span> vet on the <span class="hljs-keyword">package</span><br>and its test source files to identify significant problems. If <span class="hljs-keyword">go</span> vet<br>finds any problems, <span class="hljs-keyword">go</span> test reports those and does not run the test<br>binary. Only a high-confidence subset of the <span class="hljs-keyword">default</span> <span class="hljs-keyword">go</span> vet checks are<br>used. That subset is: <span class="hljs-string">&#x27;atomic&#x27;</span>, <span class="hljs-string">&#x27;bool&#x27;</span>, <span class="hljs-string">&#x27;buildtags&#x27;</span>, <span class="hljs-string">&#x27;errorsas&#x27;</span>,<br><span class="hljs-string">&#x27;ifaceassert&#x27;</span>, <span class="hljs-string">&#x27;nilfunc&#x27;</span>, <span class="hljs-string">&#x27;printf&#x27;</span>, and <span class="hljs-string">&#x27;stringintconv&#x27;</span>. You can see<br>the documentation <span class="hljs-keyword">for</span> these and other vet tests via <span class="hljs-string">&quot;go doc cmd/vet&quot;</span>.<br>To disable the running of <span class="hljs-keyword">go</span> vet, use the -vet=off flag. To run all<br>checks, use the -vet=all flag.<br><br>All test output and summary lines are printed to the <span class="hljs-keyword">go</span> command<span class="hljs-string">&#x27;s</span><br><span class="hljs-string">standard output, even if the test printed them to its own standard</span><br><span class="hljs-string">error. (The go command&#x27;</span>s standard <span class="hljs-type">error</span> is reserved <span class="hljs-keyword">for</span> printing<br>errors building the tests.)<br><br>Go test runs in two different modes:<br><br>The first, called local directory mode, occurs when <span class="hljs-keyword">go</span> test is<br>invoked with no <span class="hljs-keyword">package</span> arguments (<span class="hljs-keyword">for</span> example, <span class="hljs-string">&#x27;go test&#x27;</span> or <span class="hljs-string">&#x27;go</span><br><span class="hljs-string">test -v&#x27;</span>). In this mode, <span class="hljs-keyword">go</span> test compiles the <span class="hljs-keyword">package</span> sources and<br>tests found in the current directory and then runs the resulting<br>test binary. In this mode, caching (discussed below) is disabled.<br>After the <span class="hljs-keyword">package</span> test finishes, <span class="hljs-keyword">go</span> test prints a summary line<br>showing the test status (<span class="hljs-string">&#x27;ok&#x27;</span> or <span class="hljs-string">&#x27;FAIL&#x27;</span>), <span class="hljs-keyword">package</span> name, and elapsed<br>time.<br><br>The second, called <span class="hljs-keyword">package</span> list mode, occurs when <span class="hljs-keyword">go</span> test is invoked<br>with explicit <span class="hljs-keyword">package</span> arguments (<span class="hljs-keyword">for</span> example <span class="hljs-string">&#x27;go test math&#x27;</span>, <span class="hljs-string">&#x27;go</span><br><span class="hljs-string">test ./...&#x27;</span>, and even <span class="hljs-string">&#x27;go test .&#x27;</span>). In this mode, <span class="hljs-keyword">go</span> test compiles<br>and tests each of the packages listed on the command line. If a<br><span class="hljs-keyword">package</span> test passes, <span class="hljs-keyword">go</span> test prints only the final <span class="hljs-string">&#x27;ok&#x27;</span> summary<br>line. If a <span class="hljs-keyword">package</span> test fails, <span class="hljs-keyword">go</span> test prints the full test output.<br>If invoked with the -bench or -v flag, <span class="hljs-keyword">go</span> test prints the full<br>output even <span class="hljs-keyword">for</span> passing <span class="hljs-keyword">package</span> tests, in order to display the<br>requested benchmark results or verbose logging. After the <span class="hljs-keyword">package</span><br>tests <span class="hljs-keyword">for</span> all of the listed packages finish, and their output is<br>printed, <span class="hljs-keyword">go</span> test prints a final <span class="hljs-string">&#x27;FAIL&#x27;</span> status <span class="hljs-keyword">if</span> any <span class="hljs-keyword">package</span> test<br>has failed.<br><br>In <span class="hljs-keyword">package</span> list mode only, <span class="hljs-keyword">go</span> test caches successful <span class="hljs-keyword">package</span> test<br>results to avoid unnecessary repeated running of tests. When the<br>result of a test can be recovered from the cache, <span class="hljs-keyword">go</span> test will<br>redisplay the previous output instead of running the test binary<br>again. When this happens, <span class="hljs-keyword">go</span> test prints <span class="hljs-string">&#x27;(cached)&#x27;</span> in place of the<br>elapsed time in the summary line.<br><br>The rule <span class="hljs-keyword">for</span> a match in the cache is that the run involves the same<br>test binary and the flags on the command line come entirely from a<br>restricted set of <span class="hljs-string">&#x27;cacheable&#x27;</span> test flags, defined as -benchtime, -cpu,<br>-list, -parallel, -run, -short, -timeout, -failfast, and -v.<br>If a run of <span class="hljs-keyword">go</span> test has any test or non-test flags outside this set,<br>the result is not cached. To disable test caching, use any test flag<br>or argument other than the cacheable flags. The idiomatic way to disable<br>test caching explicitly is to use -count=<span class="hljs-number">1.</span> Tests that open files within<br>the <span class="hljs-keyword">package</span><span class="hljs-string">&#x27;s source root (usually $GOPATH) or that consult environment</span><br><span class="hljs-string">variables only match future runs in which the files and environment</span><br><span class="hljs-string">variables are unchanged. A cached test result is treated as executing</span><br><span class="hljs-string">in no time at all, so a successful package test result will be cached and</span><br><span class="hljs-string">reused regardless of -timeout setting.</span><br><span class="hljs-string"></span><br><span class="hljs-string">In addition to the build flags, the flags handled by &#x27;</span><span class="hljs-keyword">go</span> test<span class="hljs-string">&#x27; itself are:</span><br><span class="hljs-string"></span><br><span class="hljs-string">        -args</span><br><span class="hljs-string">            Pass the remainder of the command line (everything after -args)</span><br><span class="hljs-string">            to the test binary, uninterpreted and unchanged.</span><br><span class="hljs-string">            Because this flag consumes the remainder of the command line,</span><br><span class="hljs-string">            the package list (if present) must appear before this flag.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        -c</span><br><span class="hljs-string">            Compile the test binary to pkg.test but do not run it</span><br><span class="hljs-string">            (where pkg is the last element of the package&#x27;</span>s <span class="hljs-keyword">import</span> path).<br>            The file name can be changed with the -o flag.<br><br>        -exec xprog<br>            Run the test binary using xprog. The behavior is the same as<br>            in <span class="hljs-string">&#x27;go run&#x27;</span>. See <span class="hljs-string">&#x27;go help run&#x27;</span> <span class="hljs-keyword">for</span> details.<br><br>        -i<br>            Install packages that are dependencies of the test.<br>            Do not run the test.<br>            The -i flag is deprecated. Compiled packages are cached automatically.<br><br>        -json<br>            Convert test output to JSON suitable <span class="hljs-keyword">for</span> automated processing.<br>            See <span class="hljs-string">&#x27;go doc test2json&#x27;</span> <span class="hljs-keyword">for</span> the encoding details.<br><br>        -o file<br>            Compile the test binary to the named file.<br>            The test still runs (unless -c or -i is specified).<br><br>The test binary also accepts flags that control execution of the test; these<br>flags are also accessible by <span class="hljs-string">&#x27;go test&#x27;</span>. See <span class="hljs-string">&#x27;go help testflag&#x27;</span> <span class="hljs-keyword">for</span> details.<br><br>For more about build flags, see <span class="hljs-string">&#x27;go help build&#x27;</span>.<br>For more about specifying packages, see <span class="hljs-string">&#x27;go help packages&#x27;</span>.<br><br>See also: <span class="hljs-keyword">go</span> build, <span class="hljs-keyword">go</span> vet.<br></code></pre></td></tr></table></figure>

<h2 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h2><p>在Go语言中类型断言的语法格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">value, ok := x.(T)<br></code></pre></td></tr></table></figure>
<p>其中，x 表示一个接口的类型，T 表示一个具体的类型（也可为接口类型）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> x <span class="hljs-keyword">interface</span>&#123;&#125;<br>	x = <span class="hljs-number">10</span><br>	value, ok := x.(<span class="hljs-type">int</span>)<br>	fmt.Print(value, <span class="hljs-string">&quot;,&quot;</span>, ok)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>案例</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-keyword">type</span> Animal <span class="hljs-keyword">interface</span> &#123;<br>	walk(dist <span class="hljs-type">int</span>)<span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Dog <span class="hljs-keyword">struct</span> &#123;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(d Dog)</span></span> walk(dist <span class="hljs-type">int</span>)<span class="hljs-type">int</span>&#123;<br>	fmt.Println(<span class="hljs-string">&quot;walk dist&quot;</span>,dist)<br>	<span class="hljs-keyword">return</span> dist - <span class="hljs-number">1</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> x <span class="hljs-keyword">interface</span>&#123;&#125;<br>	x = Dog&#123;&#125;<br>	value, ok := x.(Animal)<span class="hljs-comment">//断言</span><br>	fmt.Print(value, <span class="hljs-string">&quot;,&quot;</span>, ok)<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="打桩"><a href="#打桩" class="headerlink" title="打桩"></a>打桩</h2><p>打桩是一种在单元测试中替换外部依赖关系的技术。它允许您测试代码而不必使用实际的依赖项，例如数据库、网络服务等。<br>打桩通常是模拟依赖项的行为，例如返回预定义的数据或抛出特定的错误。这可以帮助测试代码的正确性，并且还可以使测试更快、更可靠。<br>使用打桩的好处是：</p>
<ul>
<li>可以使用预定义的数据和错误进行测试，而不必使用真实的依赖项。</li>
<li>可以在测试中更好地控制依赖项的行为，以验证代码的正确性。</li>
<li>可以提高测试的速度和可靠性。<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;io/ioutil&quot;</span><br>    <span class="hljs-string">&quot;net/http&quot;</span><br>    <span class="hljs-string">&quot;strings&quot;</span><br>    <span class="hljs-string">&quot;testing&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGet</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>    <span class="hljs-comment">// 设置打桩</span><br>    http.DefaultClient.Transport = &amp;stubTransport&#123;&#125;<br><br>    resp, err := http.Get(<span class="hljs-string">&quot;https://www.baidu.com&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        t.Fatal(err)<br>    &#125;<br><br>    <span class="hljs-keyword">defer</span> resp.Body.Close()<br>    body, err := ioutil.ReadAll(resp.Body)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        t.Fatal(err)<br>    &#125;<br><br>    fmt.Println(<span class="hljs-type">string</span>(body))<br>&#125;<br><br><span class="hljs-comment">// 打桩实现</span><br><span class="hljs-keyword">type</span> stubTransport <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *stubTransport)</span></span> RoundTrip(req *http.Request) (*http.Response, <span class="hljs-type">error</span>) &#123;<br>    <span class="hljs-keyword">return</span> &amp;http.Response&#123;<br>        StatusCode: <span class="hljs-number">200</span>,<br>        Body:       ioutil.NopCloser(strings.NewReader(<span class="hljs-string">&quot;Hello, world!&quot;</span>)),<br>    &#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;testing&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> stubDB <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(db *stubDB)</span></span> Get(key <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetData</span><span class="hljs-params">(db *stubDB, key <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">return</span> db.Get(key)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestGetData</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	<span class="hljs-comment">// 设置打桩</span><br>	db := &amp;stubDB&#123;&#125;<br><br>	data, err := GetData(db, <span class="hljs-string">&quot;key&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		t.Fatal(err)<br>	&#125;<br>	fmt.Println(data)<br>&#125;<br></code></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Mock"><a href="#Mock" class="headerlink" title="Mock"></a>Mock</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> test<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;testing&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fetchData</span><span class="hljs-params">(url <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	resp, err := http.Get(url)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, err<br>	&#125;<br>	<span class="hljs-keyword">defer</span> resp.Body.Close()<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;data&quot;</span>, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-keyword">type</span> mockHTTPClient <span class="hljs-keyword">struct</span>&#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *mockHTTPClient)</span></span> RoundTrip(r *http.Request) (*http.Response, <span class="hljs-type">error</span>) &#123;<br>	<span class="hljs-keyword">if</span> r.URL.String() == <span class="hljs-string">&quot;https://example.com/data&quot;</span> &#123;<br>		<span class="hljs-keyword">return</span> &amp;http.Response&#123;<br>			StatusCode: http.StatusOK,<br>		&#125;, <span class="hljs-literal">nil</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;Invalid URL&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestFetchData</span><span class="hljs-params">(t *testing.T)</span></span> &#123;<br>	<span class="hljs-comment">// Replace the actual http.Get with our mockHTTPClient</span><br>	http.DefaultClient = &amp;http.Client&#123;<br>		Transport: &amp;mockHTTPClient&#123;&#125;,<br>	&#125;<br><br>	data, err := fetchData(<span class="hljs-string">&quot;https://example.com/data&quot;</span>)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		t.Errorf(<span class="hljs-string">&quot;fetchData returned error: %v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">if</span> data != <span class="hljs-string">&quot;data&quot;</span> &#123;<br>		t.Errorf(<span class="hljs-string">&quot;fetchData returned incorrect data: %s&quot;</span>, data)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>相关mock库：<a target="_blank" rel="noopener" href="https://github.com/golang/mock">https://github.com/golang/mock</a></p>
<p>Mock 和打桩在测试中是指用来替代实际对象的虚拟对象，用于在测试环境中达到测试目的。</p>
<ul>
<li><p>打桩（stubbing）是指创建一个模拟对象，<strong>该对象返回固定的数据，这些数据在测试过程中是固定不变的</strong>。打桩主要用于<strong>模拟依赖项</strong>，在测试代码中为这些依赖项提供一组固定的数据，以保证测试代码在独立于其依赖项的情况下正常工作。</p>
</li>
<li><p>模拟（mocking）是指创建一个模拟对象，<strong>该对象可以根据测试需要提供不同的数据</strong>，以验证测试代码的正确性。模拟的目的是测试代码的行为，它允许您验证测试代码是否正确地使用了它的依赖项。</p>
</li>
</ul>
<p>因此，打桩和模拟是测试中不同的技术，但它们都用于代替实际对象，以帮助开发人员在测试环境中测试代码。</p>
<h1 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h1><h1 id="垃圾"><a href="#垃圾" class="headerlink" title="垃圾"></a>垃圾</h1><blockquote>
<p>垃圾回收</p>
</blockquote>
<ul>
<li>Go1.3采用标记清除法。</li>
<li>Go1.5采用三色标记法。</li>
<li>Go1.8采用三色标记法+混合写屏障。</li>
</ul>
<p><strong>根对象</strong>:根对象是指赋值器不需要通过其他对象就可以直接访问到的对象，通过Root对象, 可以追踪到其他存活的对象。常见的root对象有：</p>
<ul>
<li><strong>全局变量</strong>：程序在编译期就能确定的那些存在于程序整个生命周期的变量。</li>
<li><strong>执行栈</strong>：每个 goroutine (包括main函数)都拥有自己的执行栈，这些执行栈上包含<strong>栈上的变量及堆内存指针</strong>。（堆内存指针即在gorouine中申请或者引用了在堆内存的变量）</li>
</ul>
<h2 id="v1-3-标记清除法"><a href="#v1-3-标记清除法" class="headerlink" title="v1.3 标记清除法"></a>v1.3 标记清除法</h2><p>分为两个阶段：标记和清除<br>标记阶段：从根对象出发寻找并标记所有存活的对象。<br>清除阶段：遍历堆中的对象，回收未标记的对象，并加入空闲链表。</p>
<p>缺点是整个过程都需要暂停程序STW。</p>
<p>因为如果不进行STW的话，会出现已经被标记的对象A，引用了新的未被标记的对象B，但由于对象A已经标记过了，不会再重新扫描A对B的可达性，从而将B对象当做垃圾回收掉。（<strong>白色对象引用黑色对象的情况</strong>）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1672671321547-eb1b931a-2c0e-4006-8854-a8251118949d.jpeg" srcset="/img/loading.gif" lazyload></p>
<h2 id="v1-5-三色标记法"><a href="#v1-5-三色标记法" class="headerlink" title="v1.5 三色标记法"></a>v1.5 三色标记法</h2><p>将对象标记为白色，灰色或黑色。</p>
<ul>
<li>白色：不确定对象（默认色）；</li>
<li>黑色：存活对象。</li>
<li>灰色：存活对象，子对象待处理。</li>
</ul>
<p>标记开始时，先将所有对象加入白色集合（需要STW）。首先将根对象标记为灰色，然后将一个对象从灰色集合取出，遍历其子对象，放入灰色集合。同时将取出的对象放入黑色集合，直到灰色集合为空。最后的白色集合对象就是需要清理的对象。</p>
<blockquote>
<p>这种方法有一个缺陷，如果对象的引用被用户修改了，那么之前的标记就无效了。因此Go采用了写屏障技术，当对象新增或者更新会将其着色为灰色。</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1672673475311-69a0002f-a7c9-44be-89e9-095deb5a09a9.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>上述的三色标记仍然需要stop the world，如果不STW在标记过程中，如对象6引用了对象5，由于对象6已经扫描过，不会再次扫描，此时对象5仍会被GC掉。</p>
<p>在三色标记法的过程中对象丢失，需要同时满足下面两个条件：</p>
<ul>
<li>条件一：<strong>白色对象被黑色对象引用</strong></li>
<li>条件二：<strong>灰色对象与白色对象之间的可达关系遭到破坏</strong></li>
</ul>
<p>看来只要把上面两个条件破坏掉一个，就可以保证对象不丢失，所以golang团队就提出了两种破坏条件的方式：<strong>强三色不变式</strong>和<strong>弱三色不变式</strong>。</p>
<h4 id="强三色不变式"><a href="#强三色不变式" class="headerlink" title="强三色不变式"></a>强三色不变式</h4><p>规则：<strong>不允许黑色对象引用白色对象</strong><br>原理：如果一个黑色对象不直接引用白色对象，那么就不会出现白色对象扫描不到，从而被当做垃圾回收掉的情况。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1672674325676-e4de4e51-05a5-43b3-aedf-bb6856f75106.jpeg" srcset="/img/loading.gif" lazyload></p>
<h4 id="弱三色不变式"><a href="#弱三色不变式" class="headerlink" title="弱三色不变式"></a>弱三色不变式</h4><p>规则：<strong>黑色对象可以引用白色对象，但是白色对象的上游必须存在灰色对象</strong><br>原理： 如果一个白色对象的上游有灰色对象，则这个白色对象一定可以扫描到，从而不被回收。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1672674437426-938e4ca8-16d3-4555-8e47-6e62c53eaba0.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>基于上述两种不变式提到的原则，分别提出了两种实现机制：<strong>插入写屏障和删除写屏障</strong>。</p>
<h4 id="插入写屏障"><a href="#插入写屏障" class="headerlink" title="插入写屏障"></a>插入写屏障</h4><p>规则：当一个对象引用另外一个对象时，将另外一个对象标记为灰色。<br>满足：强三色不变式。不会存在黑色对象引用白色对象</p>
<p>插入写屏障只会发生在堆区，栈区的对象分配操作十分频繁，如果进行写屏障会有性能问题<br><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1672675298644-f2d07855-7bc0-4308-aeb2-294abf5a7ae7.jpeg" srcset="/img/loading.gif" lazyload><br>由于栈上的对像没有插入写机制，在扫描完成后，仍然可能存在栈上的白色对象被黑色对象引用，所以在最后需要对栈上的空间进行STW，防止对象误删除。</p>
<p>写屏障最大的弊端就是，在一次正常的三色标记流程结束后，需要对栈上重新进行一次stw，然后再rescan一次。</p>
<h4 id="删除写屏障"><a href="#删除写屏障" class="headerlink" title="删除写屏障"></a><strong>删除写屏障</strong></h4><p><strong>规则</strong>：在删除引用时，如果被删除引用的对象自身为灰色或者白色，那么被标记为灰色。满足弱三色不变式。灰色对象到白色对象的路径不会断<br><strong>解释</strong>：白色对象始终会被灰色对象保护</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1672675339842-fbb2cf06-ea3e-4b7e-b926-b22815a25e1c.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>删除写屏障的缺点是当我们对一个对象取消引用后，其没有任何引用也会存活到下一次GC，可能会堆积很多垃圾</p>
<p>1.5采用了插入写屏障</p>
<h2 id="v1-8-三色标记法-混合写屏障"><a href="#v1-8-三色标记法-混合写屏障" class="headerlink" title="v1.8 三色标记法+混合写屏障"></a>v1.8 三色标记法+混合写屏障</h2><p>基于上述两种的写屏障的机制进行优化，取长补短，1.8采用了混合写屏障的方式来进行标记</p>
<ul>
<li><p><strong>GC刚开始的时候，会将栈上的可达对象全部标记为黑色</strong>。</p>
</li>
<li><p><strong>GC期间，任何在栈上新创建的对象，均为黑色</strong>。</p>
<blockquote>
<p>上面两点只有一个目的，将栈上的可达对象全部标黑，最后无需对栈进行STW，就可以保证栈上的对象不会丢失。有人说，一直是黑色的对象，那么不就永远清除不掉了么，这里强调一下，标记为黑色的是可达对象，不可达的对象一直会是白色，直到最后被回收。</p>
</blockquote>
</li>
<li><p><strong>堆上被删除的对象标记为灰色</strong></p>
</li>
<li><p><strong>堆上新添加的对象标记为灰色</strong></p>
</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1672676331171-333999da-d91d-4d7d-af90-5245f2319f08.jpeg" srcset="/img/loading.gif" lazyload></p>
<p><strong>混合写屏障，其</strong>屏障限制只在堆内存中生效，<strong>无需二次扫描栈，</strong>提升了GC效率</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>1.隐式调用</p>
<blockquote>
<p>go会通过独立的进程扫描已经不再使用的变量，进程gc</p>
</blockquote>
<p>2.显式调用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">runtime.GC()<br></code></pre></td></tr></table></figure>
<p>3.SetFinalizer</p>
<blockquote>
<p>在对象被收集前会调用该对象配置的SetFinalizer</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Person <span class="hljs-keyword">struct</span> &#123;<br>	Name <span class="hljs-type">string</span><br>	Address <span class="hljs-type">string</span><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	p:=Person&#123;<br>		Name:    <span class="hljs-string">&quot;Leo&quot;</span>,<br>		Address: <span class="hljs-string">&quot;182121221&quot;</span>,<br>	&#125;<br>	fmt.Println(p)<br>	f:=<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(p *Person)</span></span> &#123;<br>		fmt.Println(<span class="hljs-string">&quot;调用p2设置的SetFinalizer方法:&quot;</span>,p)<br>	&#125;<br>	runtime.SetFinalizer(&amp;p, f)<br>	runtime.GC()<br>	time.Sleep(<span class="hljs-number">3000</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Golang中垃圾回收支持三种模式：<br>（1）gcBackgroundMode，默认模式，标记与清扫过程都是并发执行的；<br>（2）gcForceMode，只在清扫阶段支持并发；<br>（3）gcForceBlockMode，GC全程需要STW。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// gcMode indicates how concurrent a GC cycle should be.</span><br><span class="hljs-keyword">type</span> gcMode <span class="hljs-type">int</span><br><br><span class="hljs-keyword">const</span> (<br>	gcBackgroundMode gcMode = <span class="hljs-literal">iota</span> <span class="hljs-comment">// concurrent GC and sweep</span><br>	gcForceMode                    <span class="hljs-comment">// stop-the-world GC now, concurrent sweep</span><br>	gcForceBlockMode               <span class="hljs-comment">// stop-the-world GC now and STW sweep (forced by user)</span><br>)<br></code></pre></td></tr></table></figure>

<p>1.执行GC函数</p>
<blockquote>
<p>src/runtime/mgc.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// GC runs a garbage collection and blocks the caller until the</span><br><span class="hljs-comment">// garbage collection is complete. It may also block the entire</span><br><span class="hljs-comment">// program.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GC</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// We consider a cycle to be: sweep termination, mark, mark</span><br>	<span class="hljs-comment">// termination, and sweep. This function shouldn&#x27;t return</span><br>	<span class="hljs-comment">// until a full cycle has been completed, from beginning to</span><br>	<span class="hljs-comment">// end. Hence, we always want to finish up the current cycle</span><br>	<span class="hljs-comment">// and start a new one. That means:</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// 1. In sweep termination, mark, or mark termination of cycle</span><br>	<span class="hljs-comment">// N, wait until mark termination N completes and transitions</span><br>	<span class="hljs-comment">// to sweep N.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// 2. In sweep N, help with sweep N.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// At this point we can begin a full cycle N+1.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// 3. Trigger cycle N+1 by starting sweep termination N+1.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// 4. Wait for mark termination N+1 to complete.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// 5. Help with sweep N+1 until it&#x27;s done.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// This all has to be written to deal with the fact that the</span><br>	<span class="hljs-comment">// GC may move ahead on its own. For example, when we block</span><br>	<span class="hljs-comment">// until mark termination N, we may wake up in cycle N+2.</span><br><br>	<span class="hljs-comment">// Wait until the current sweep termination, mark, and mark</span><br>	<span class="hljs-comment">// termination complete.</span><br>	n := atomic.Load(&amp;work.cycles)<br>    <span class="hljs-comment">//gc标记</span><br>	gcWaitOnMark(n)<br><br>	<span class="hljs-comment">// We&#x27;re now in sweep N or later. Trigger GC cycle N+1, which</span><br>	<span class="hljs-comment">// will first finish sweep N if necessary and then enter sweep</span><br>	<span class="hljs-comment">// termination N+1.</span><br>    <span class="hljs-comment">// 开始收集</span><br>	gcStart(gcTrigger&#123;kind: gcTriggerCycle, n: n + <span class="hljs-number">1</span>&#125;)<br><br>	<span class="hljs-comment">// Wait for mark termination N+1 to complete.</span><br>	gcWaitOnMark(n + <span class="hljs-number">1</span>)<br><br>	<span class="hljs-comment">// Finish sweep N+1 before returning. We do this both to</span><br>	<span class="hljs-comment">// complete the cycle and because runtime.GC() is often used</span><br>	<span class="hljs-comment">// as part of tests and benchmarks to get the system into a</span><br>	<span class="hljs-comment">// relatively stable and isolated state.</span><br>	<span class="hljs-keyword">for</span> atomic.Load(&amp;work.cycles) == n+<span class="hljs-number">1</span> &amp;&amp; sweepone() != ^<span class="hljs-type">uintptr</span>(<span class="hljs-number">0</span>) &#123;<br>		sweep.nbgsweep++<br>		Gosched()<br>	&#125;<br><br>	<span class="hljs-comment">// Callers may assume that the heap profile reflects the</span><br>	<span class="hljs-comment">// just-completed cycle when this returns (historically this</span><br>	<span class="hljs-comment">// happened because this was a STW GC), but right now the</span><br>	<span class="hljs-comment">// profile still reflects mark termination N, not N+1.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// As soon as all of the sweep frees from cycle N+1 are done,</span><br>	<span class="hljs-comment">// we can go ahead and publish the heap profile.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// First, wait for sweeping to finish. (We know there are no</span><br>	<span class="hljs-comment">// more spans on the sweep queue, but we may be concurrently</span><br>	<span class="hljs-comment">// sweeping spans, so we have to wait.)</span><br>	<span class="hljs-keyword">for</span> atomic.Load(&amp;work.cycles) == n+<span class="hljs-number">1</span> &amp;&amp; !isSweepDone() &#123;<br>		Gosched()<br>	&#125;<br><br>	<span class="hljs-comment">// Now we&#x27;re really done with sweeping, so we can publish the</span><br>	<span class="hljs-comment">// stable heap profile. Only do this if we haven&#x27;t already hit</span><br>	<span class="hljs-comment">// another mark termination.</span><br>	mp := acquirem()<br>	cycle := atomic.Load(&amp;work.cycles)<br>	<span class="hljs-keyword">if</span> cycle == n+<span class="hljs-number">1</span> || (gcphase == _GCmark &amp;&amp; cycle == n+<span class="hljs-number">2</span>) &#123;<br>		mProf_PostSweep()<br>	&#125;<br>	releasem(mp)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>2.垃圾标记</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><br><span class="hljs-comment">// gcWaitOnMark blocks until GC finishes the Nth mark phase. If GC has</span><br><span class="hljs-comment">// already completed this mark phase, it returns immediately.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gcWaitOnMark</span><span class="hljs-params">(n <span class="hljs-type">uint32</span>)</span></span> &#123;<br>	<span class="hljs-keyword">for</span> &#123;<br>		<span class="hljs-comment">// Disable phase transitions.</span><br>		lock(&amp;work.sweepWaiters.lock)<br>		nMarks := atomic.Load(&amp;work.cycles)<br>		<span class="hljs-keyword">if</span> gcphase != _GCmark &#123;<br>			<span class="hljs-comment">// We&#x27;ve already completed this cycle&#x27;s mark.</span><br>			nMarks++<br>		&#125;<br>		<span class="hljs-keyword">if</span> nMarks &gt; n &#123;<br>			<span class="hljs-comment">// We&#x27;re done.</span><br>			unlock(&amp;work.sweepWaiters.lock)<br>			<span class="hljs-keyword">return</span><br>		&#125;<br>		<span class="hljs-comment">// Wait until sweep termination, mark, and mark</span><br>		<span class="hljs-comment">// termination of cycle N complete.</span><br>		work.sweepWaiters.list.push(getg())<br>		goparkunlock(&amp;work.sweepWaiters.lock, waitReasonWaitForGCCycle, traceEvGoBlock, <span class="hljs-number">1</span>)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>3.执行垃圾收集</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// gcStart starts the GC. It transitions from _GCoff to _GCmark (if</span><br><span class="hljs-comment">// debug.gcstoptheworld == 0) or performs all of GC (if</span><br><span class="hljs-comment">// debug.gcstoptheworld != 0).</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// This may return without performing this transition in some cases,</span><br><span class="hljs-comment">// such as when called on a system stack or with locks held.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">gcStart</span><span class="hljs-params">(trigger gcTrigger)</span></span> &#123;<br>	<span class="hljs-comment">// Since this is called from malloc and malloc is called in</span><br>	<span class="hljs-comment">// the guts of a number of libraries that might be holding</span><br>	<span class="hljs-comment">// locks, don&#x27;t attempt to start GC in non-preemptible or</span><br>	<span class="hljs-comment">// potentially unstable situations.</span><br>	mp := acquirem()<br>	<span class="hljs-keyword">if</span> gp := getg(); gp == mp.g0 || mp.locks &gt; <span class="hljs-number">1</span> || mp.preemptoff != <span class="hljs-string">&quot;&quot;</span> &#123;<br>		releasem(mp)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	releasem(mp)<br>	mp = <span class="hljs-literal">nil</span><br><br>	<span class="hljs-comment">// Pick up the remaining unswept/not being swept spans concurrently</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// This shouldn&#x27;t happen if we&#x27;re being invoked in background</span><br>	<span class="hljs-comment">// mode since proportional sweep should have just finished</span><br>	<span class="hljs-comment">// sweeping everything, but rounding errors, etc, may leave a</span><br>	<span class="hljs-comment">// few spans unswept. In forced mode, this is necessary since</span><br>	<span class="hljs-comment">// GC can be forced at any point in the sweeping cycle.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// We check the transition condition continuously here in case</span><br>	<span class="hljs-comment">// this G gets delayed in to the next GC cycle.</span><br>	<span class="hljs-keyword">for</span> trigger.test() &amp;&amp; sweepone() != ^<span class="hljs-type">uintptr</span>(<span class="hljs-number">0</span>) &#123;<br>		sweep.nbgsweep++<br>	&#125;<br><br>	<span class="hljs-comment">// Perform GC initialization and the sweep termination</span><br>	<span class="hljs-comment">// transition.</span><br>	semacquire(&amp;work.startSema)<br>	<span class="hljs-comment">// Re-check transition condition under transition lock.</span><br>	<span class="hljs-keyword">if</span> !trigger.test() &#123;<br>		semrelease(&amp;work.startSema)<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	<span class="hljs-comment">// For stats, check if this GC was forced by the user.</span><br>	work.userForced = trigger.kind == gcTriggerCycle<br><br>	<span class="hljs-comment">// In gcstoptheworld debug mode, upgrade the mode accordingly.</span><br>	<span class="hljs-comment">// We do this after re-checking the transition condition so</span><br>	<span class="hljs-comment">// that multiple goroutines that detect the heap trigger don&#x27;t</span><br>	<span class="hljs-comment">// start multiple STW GCs.</span><br>	mode := gcBackgroundMode<br>	<span class="hljs-keyword">if</span> debug.gcstoptheworld == <span class="hljs-number">1</span> &#123;<br>		mode = gcForceMode<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> debug.gcstoptheworld == <span class="hljs-number">2</span> &#123;<br>		mode = gcForceBlockMode<br>	&#125;<br><br>	<span class="hljs-comment">// Ok, we&#x27;re doing it! Stop everybody else</span><br>	semacquire(&amp;gcsema)<br>	semacquire(&amp;worldsema)<br><br>	<span class="hljs-keyword">if</span> trace.enabled &#123;<br>		traceGCStart()<br>	&#125;<br><br>	<span class="hljs-comment">// Check that all Ps have finished deferred mcache flushes.</span><br>	<span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> allp &#123;<br>		<span class="hljs-keyword">if</span> fg := atomic.Load(&amp;p.mcache.flushGen); fg != mheap_.sweepgen &#123;<br>			<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;runtime: p&quot;</span>, p.id, <span class="hljs-string">&quot;flushGen&quot;</span>, fg, <span class="hljs-string">&quot;!= sweepgen&quot;</span>, mheap_.sweepgen)<br>			throw(<span class="hljs-string">&quot;p mcache not flushed&quot;</span>)<br>		&#125;<br>	&#125;<br><br>	gcBgMarkStartWorkers()<br><br>	systemstack(gcResetMarkState)<br><br>	work.stwprocs, work.maxprocs = gomaxprocs, gomaxprocs<br>	<span class="hljs-keyword">if</span> work.stwprocs &gt; ncpu &#123;<br>		<span class="hljs-comment">// This is used to compute CPU time of the STW phases,</span><br>		<span class="hljs-comment">// so it can&#x27;t be more than ncpu, even if GOMAXPROCS is.</span><br>		work.stwprocs = ncpu<br>	&#125;<br>	work.heap0 = atomic.Load64(&amp;gcController.heapLive)<br>	work.pauseNS = <span class="hljs-number">0</span><br>	work.mode = mode<br><br>	now := nanotime()<br>	work.tSweepTerm = now<br>	work.pauseStart = now<br>	<span class="hljs-keyword">if</span> trace.enabled &#123;<br>		traceGCSTWStart(<span class="hljs-number">1</span>)<br>	&#125;<br>	systemstack(stopTheWorldWithSema)<br>	<span class="hljs-comment">// Finish sweep before we start concurrent scan.</span><br>	systemstack(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		finishsweep_m()<br>	&#125;)<br><br>	<span class="hljs-comment">// clearpools before we start the GC. If we wait they memory will not be</span><br>	<span class="hljs-comment">// reclaimed until the next GC cycle.</span><br>	clearpools()<br><br>	work.cycles++<br><br>	<span class="hljs-comment">// Assists and workers can start the moment we start</span><br>	<span class="hljs-comment">// the world.</span><br>	gcController.startCycle(now, <span class="hljs-type">int</span>(gomaxprocs), trigger)<br><br>	<span class="hljs-comment">// Notify the CPU limiter that assists may begin.</span><br>	gcCPULimiter.startGCTransition(<span class="hljs-literal">true</span>, now)<br><br>	<span class="hljs-comment">// In STW mode, disable scheduling of user Gs. This may also</span><br>	<span class="hljs-comment">// disable scheduling of this goroutine, so it may block as</span><br>	<span class="hljs-comment">// soon as we start the world again.</span><br>	<span class="hljs-keyword">if</span> mode != gcBackgroundMode &#123;<br>		schedEnableUser(<span class="hljs-literal">false</span>)<br>	&#125;<br><br>	<span class="hljs-comment">// Enter concurrent mark phase and enable</span><br>	<span class="hljs-comment">// write barriers.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Because the world is stopped, all Ps will</span><br>	<span class="hljs-comment">// observe that write barriers are enabled by</span><br>	<span class="hljs-comment">// the time we start the world and begin</span><br>	<span class="hljs-comment">// scanning.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Write barriers must be enabled before assists are</span><br>	<span class="hljs-comment">// enabled because they must be enabled before</span><br>	<span class="hljs-comment">// any non-leaf heap objects are marked. Since</span><br>	<span class="hljs-comment">// allocations are blocked until assists can</span><br>	<span class="hljs-comment">// happen, we want enable assists as early as</span><br>	<span class="hljs-comment">// possible.</span><br>	setGCPhase(_GCmark)<br><br>	gcBgMarkPrepare() <span class="hljs-comment">// Must happen before assist enable.</span><br>	gcMarkRootPrepare()<br><br>	<span class="hljs-comment">// Mark all active tinyalloc blocks. Since we&#x27;re</span><br>	<span class="hljs-comment">// allocating from these, they need to be black like</span><br>	<span class="hljs-comment">// other allocations. The alternative is to blacken</span><br>	<span class="hljs-comment">// the tiny block on every allocation from it, which</span><br>	<span class="hljs-comment">// would slow down the tiny allocator.</span><br>	gcMarkTinyAllocs()<br><br>	<span class="hljs-comment">// At this point all Ps have enabled the write</span><br>	<span class="hljs-comment">// barrier, thus maintaining the no white to</span><br>	<span class="hljs-comment">// black invariant. Enable mutator assists to</span><br>	<span class="hljs-comment">// put back-pressure on fast allocating</span><br>	<span class="hljs-comment">// mutators.</span><br>	atomic.Store(&amp;gcBlackenEnabled, <span class="hljs-number">1</span>)<br><br>	<span class="hljs-comment">// In STW mode, we could block the instant systemstack</span><br>	<span class="hljs-comment">// returns, so make sure we&#x27;re not preemptible.</span><br>	mp = acquirem()<br><br>	<span class="hljs-comment">// Concurrent mark.</span><br>	systemstack(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>		now = startTheWorldWithSema(trace.enabled)<br>		work.pauseNS += now - work.pauseStart<br>		work.tMark = now<br>		memstats.gcPauseDist.record(now - work.pauseStart)<br><br>		<span class="hljs-comment">// Release the CPU limiter.</span><br>		gcCPULimiter.finishGCTransition(now)<br>	&#125;)<br><br>	<span class="hljs-comment">// Release the world sema before Gosched() in STW mode</span><br>	<span class="hljs-comment">// because we will need to reacquire it later but before</span><br>	<span class="hljs-comment">// this goroutine becomes runnable again, and we could</span><br>	<span class="hljs-comment">// self-deadlock otherwise.</span><br>	semrelease(&amp;worldsema)<br>	releasem(mp)<br><br>	<span class="hljs-comment">// Make sure we block instead of returning to user code</span><br>	<span class="hljs-comment">// in STW mode.</span><br>	<span class="hljs-keyword">if</span> mode != gcBackgroundMode &#123;<br>		Gosched()<br>	&#125;<br><br>	semrelease(&amp;work.startSema)<br>&#125;<br></code></pre></td></tr></table></figure>


<h1 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h1><blockquote>
<p>Go语言的内存管理是基于TCMalloc (Thread-Caching Malloc) 模型设计的，TCMalloc是一种典型的分级、多链表内存管理模型，可以很好的应对碎片化内存。</p>
</blockquote>
<h2 id="内存组成组件"><a href="#内存组成组件" class="headerlink" title="内存组成组件"></a>内存组成组件</h2><p>go实现了自己的内存分配器，维护一个大的全局内存，每个线程（Golang中为P）维护一个小的私有内存，私有内存不足再从全局申请。为了方便自主管理内存，做法便是先向系统申请一块内存，然后将内存切割成小块，通过一定的内存分配算法管理内存。以64位系统为例，Golang程序启动时会向系统申请的内存如下图所示：<br><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/2630542/1672490486907-f3b4eb9c-3a80-4fda-b916-beee64cc0a4f.jpeg" srcset="/img/loading.gif" lazyload><br>预申请的内存划分为spans、bitmap、arena三部分。其中arena即为所谓的堆区，应用中需要的内存从这里分配。其中spans和bitmap是为了管理arena区而存在的。</p>
<ul>
<li>arena的大小为512G，为了方便管理把arena区域划分成一个个的page，每个page为8KB,一共有512GB/8KB个页；</li>
<li>spans区域存放span的指针，每个指针对应一个page，所以span区域的大小为(512GB/8KB)*指针大小8byte = 512M</li>
<li>bitmap区域大小也是通过arena计算出来，主要用于GC。</li>
</ul>
<h3 id="arean"><a href="#arean" class="headerlink" title="arean"></a>arean</h3><h3 id="spans"><a href="#spans" class="headerlink" title="spans"></a>spans</h3><blockquote>
<p>该内存区域主要存放内存管理单元mspan指针，每个指针对于1或N个page，512MB = 512GB/8KB(页大小)*8B(指针大小)</p>
</blockquote>
<p>为了解决内存碎片化带了的分配问题（查找空闲内存时间复杂度增加），golang中划分出67种内存块（span），8b-32k范围，组成空闲链表，提高分配效率</p>
<ul>
<li>class： class ID，每个span结构中都有一个class ID, 表示该span可处理的对象类型</li>
<li>bytes /obj：该class代表对象的字节数</li>
<li>bytes/span：每个span占用堆的字节数，也即页数*页大小</li>
<li>objects: 每个span可分配的对象个数，也即（bytes/spans）/（bytes/obj）</li>
<li>waste bytes: 每个span产生的内存碎片，也即（bytes/spans）%（bytes/obj）<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// class  bytes/obj  bytes/span  objects  tail waste  max waste  min align</span><br><span class="hljs-comment">//     1          8        8192     1024           0     87.50%          8</span><br><span class="hljs-comment">//     2         16        8192      512           0     43.75%         16</span><br><span class="hljs-comment">//     3         24        8192      341           8     29.24%          8</span><br><span class="hljs-comment">//     4         32        8192      256           0     21.88%         32</span><br><span class="hljs-comment">//     5         48        8192      170          32     31.52%         16</span><br><span class="hljs-comment">//     6         64        8192      128           0     23.44%         64</span><br><span class="hljs-comment">//     7         80        8192      102          32     19.07%         16</span><br><span class="hljs-comment">//     8         96        8192       85          32     15.95%         32</span><br><span class="hljs-comment">//     9        112        8192       73          16     13.56%         16</span><br><span class="hljs-comment">//    10        128        8192       64           0     11.72%        128</span><br><span class="hljs-comment">//    11        144        8192       56         128     11.82%         16</span><br><span class="hljs-comment">//    12        160        8192       51          32      9.73%         32</span><br><span class="hljs-comment">//    13        176        8192       46          96      9.59%         16</span><br><span class="hljs-comment">//    14        192        8192       42         128      9.25%         64</span><br><span class="hljs-comment">//    15        208        8192       39          80      8.12%         16</span><br><span class="hljs-comment">//    16        224        8192       36         128      8.15%         32</span><br><span class="hljs-comment">//    17        240        8192       34          32      6.62%         16</span><br><span class="hljs-comment">//    18        256        8192       32           0      5.86%        256</span><br><span class="hljs-comment">//    19        288        8192       28         128     12.16%         32</span><br><span class="hljs-comment">//    20        320        8192       25         192     11.80%         64</span><br><span class="hljs-comment">//    21        352        8192       23          96      9.88%         32</span><br><span class="hljs-comment">//    22        384        8192       21         128      9.51%        128</span><br><span class="hljs-comment">//    23        416        8192       19         288     10.71%         32</span><br><span class="hljs-comment">//    24        448        8192       18         128      8.37%         64</span><br><span class="hljs-comment">//    25        480        8192       17          32      6.82%         32</span><br><span class="hljs-comment">//    26        512        8192       16           0      6.05%        512</span><br><span class="hljs-comment">//    27        576        8192       14         128     12.33%         64</span><br><span class="hljs-comment">//    28        640        8192       12         512     15.48%        128</span><br><span class="hljs-comment">//    29        704        8192       11         448     13.93%         64</span><br><span class="hljs-comment">//    30        768        8192       10         512     13.94%        256</span><br><span class="hljs-comment">//    31        896        8192        9         128     15.52%        128</span><br><span class="hljs-comment">//    32       1024        8192        8           0     12.40%       1024</span><br><span class="hljs-comment">//    33       1152        8192        7         128     12.41%        128</span><br><span class="hljs-comment">//    34       1280        8192        6         512     15.55%        256</span><br><span class="hljs-comment">//    35       1408       16384       11         896     14.00%        128</span><br><span class="hljs-comment">//    36       1536        8192        5         512     14.00%        512</span><br><span class="hljs-comment">//    37       1792       16384        9         256     15.57%        256</span><br><span class="hljs-comment">//    38       2048        8192        4           0     12.45%       2048</span><br><span class="hljs-comment">//    39       2304       16384        7         256     12.46%        256</span><br><span class="hljs-comment">//    40       2688        8192        3         128     15.59%        128</span><br><span class="hljs-comment">//    41       3072       24576        8           0     12.47%       1024</span><br><span class="hljs-comment">//    42       3200       16384        5         384      6.22%        128</span><br><span class="hljs-comment">//    43       3456       24576        7         384      8.83%        128</span><br><span class="hljs-comment">//    44       4096        8192        2           0     15.60%       4096</span><br><span class="hljs-comment">//    45       4864       24576        5         256     16.65%        256</span><br><span class="hljs-comment">//    46       5376       16384        3         256     10.92%        256</span><br><span class="hljs-comment">//    47       6144       24576        4           0     12.48%       2048</span><br><span class="hljs-comment">//    48       6528       32768        5         128      6.23%        128</span><br><span class="hljs-comment">//    49       6784       40960        6         256      4.36%        128</span><br><span class="hljs-comment">//    50       6912       49152        7         768      3.37%        256</span><br><span class="hljs-comment">//    51       8192        8192        1           0     15.61%       8192</span><br><span class="hljs-comment">//    52       9472       57344        6         512     14.28%        256</span><br><span class="hljs-comment">//    53       9728       49152        5         512      3.64%        512</span><br><span class="hljs-comment">//    54      10240       40960        4           0      4.99%       2048</span><br><span class="hljs-comment">//    55      10880       32768        3         128      6.24%        128</span><br><span class="hljs-comment">//    56      12288       24576        2           0     11.45%       4096</span><br><span class="hljs-comment">//    57      13568       40960        3         256      9.99%        256</span><br><span class="hljs-comment">//    58      14336       57344        4           0      5.35%       2048</span><br><span class="hljs-comment">//    59      16384       16384        1           0     12.49%       8192</span><br><span class="hljs-comment">//    60      18432       73728        4           0     11.11%       2048</span><br><span class="hljs-comment">//    61      19072       57344        3         128      3.57%        128</span><br><span class="hljs-comment">//    62      20480       40960        2           0      6.87%       4096</span><br><span class="hljs-comment">//    63      21760       65536        3         256      6.25%        256</span><br><span class="hljs-comment">//    64      24576       24576        1           0     11.45%       8192</span><br><span class="hljs-comment">//    65      27264       81920        3         128     10.00%        128</span><br><span class="hljs-comment">//    66      28672       57344        2           0      4.91%       4096</span><br><span class="hljs-comment">//    67      32768       32768        1           0     12.50%       8192</span><br><br><span class="hljs-comment">// alignment  bits  min obj size</span><br><span class="hljs-comment">//         8     3             8</span><br><span class="hljs-comment">//        16     4            32</span><br><span class="hljs-comment">//        32     5           256</span><br><span class="hljs-comment">//        64     6           512</span><br><span class="hljs-comment">//       128     7           768</span><br><span class="hljs-comment">//      4096    12         28672</span><br><span class="hljs-comment">//      8192    13         32768</span><br><br><span class="hljs-keyword">const</span> (<br>	_MaxSmallSize   = <span class="hljs-number">32768</span><br>	smallSizeDiv    = <span class="hljs-number">8</span><br>	smallSizeMax    = <span class="hljs-number">1024</span><br>	largeSizeDiv    = <span class="hljs-number">128</span><br>	_NumSizeClasses = <span class="hljs-number">68</span><br>	_PageShift      = <span class="hljs-number">13</span><br>)<br><br><span class="hljs-keyword">var</span> class_to_size = [_NumSizeClasses]<span class="hljs-type">uint16</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">24</span>, <span class="hljs-number">32</span>, <span class="hljs-number">48</span>, <span class="hljs-number">64</span>, <span class="hljs-number">80</span>, <span class="hljs-number">96</span>, <span class="hljs-number">112</span>, <span class="hljs-number">128</span>, <span class="hljs-number">144</span>, <span class="hljs-number">160</span>, <span class="hljs-number">176</span>, <span class="hljs-number">192</span>, <span class="hljs-number">208</span>, <span class="hljs-number">224</span>, <span class="hljs-number">240</span>, <span class="hljs-number">256</span>, <span class="hljs-number">288</span>, <span class="hljs-number">320</span>, <span class="hljs-number">352</span>, <span class="hljs-number">384</span>, <span class="hljs-number">416</span>, <span class="hljs-number">448</span>, <span class="hljs-number">480</span>, <span class="hljs-number">512</span>, <span class="hljs-number">576</span>, <span class="hljs-number">640</span>, <span class="hljs-number">704</span>, <span class="hljs-number">768</span>, <span class="hljs-number">896</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1152</span>, <span class="hljs-number">1280</span>, <span class="hljs-number">1408</span>, <span class="hljs-number">1536</span>, <span class="hljs-number">1792</span>, <span class="hljs-number">2048</span>, <span class="hljs-number">2304</span>, <span class="hljs-number">2688</span>, <span class="hljs-number">3072</span>, <span class="hljs-number">3200</span>, <span class="hljs-number">3456</span>, <span class="hljs-number">4096</span>, <span class="hljs-number">4864</span>, <span class="hljs-number">5376</span>, <span class="hljs-number">6144</span>, <span class="hljs-number">6528</span>, <span class="hljs-number">6784</span>, <span class="hljs-number">6912</span>, <span class="hljs-number">8192</span>, <span class="hljs-number">9472</span>, <span class="hljs-number">9728</span>, <span class="hljs-number">10240</span>, <span class="hljs-number">10880</span>, <span class="hljs-number">12288</span>, <span class="hljs-number">13568</span>, <span class="hljs-number">14336</span>, <span class="hljs-number">16384</span>, <span class="hljs-number">18432</span>, <span class="hljs-number">19072</span>, <span class="hljs-number">20480</span>, <span class="hljs-number">21760</span>, <span class="hljs-number">24576</span>, <span class="hljs-number">27264</span>, <span class="hljs-number">28672</span>, <span class="hljs-number">32768</span>&#125;<br><span class="hljs-keyword">var</span> class_to_allocnpages = [_NumSizeClasses]<span class="hljs-type">uint8</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">9</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">3</span>, <span class="hljs-number">10</span>, <span class="hljs-number">7</span>, <span class="hljs-number">4</span>&#125;<br><span class="hljs-keyword">var</span> class_to_divmagic = [_NumSizeClasses]<span class="hljs-type">uint32</span>&#123;<span class="hljs-number">0</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">8</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">16</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">24</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">32</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">48</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">64</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">80</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">96</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">112</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">128</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">144</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">160</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">176</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">192</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">208</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">224</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">240</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">256</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">288</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">320</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">352</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">384</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">416</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">448</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">480</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">512</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">576</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">640</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">704</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">768</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">896</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">1024</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">1152</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">1280</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">1408</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">1536</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">1792</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">2048</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">2304</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">2688</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">3072</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">3200</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">3456</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">4096</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">4864</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">5376</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">6144</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">6528</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">6784</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">6912</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">8192</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">9472</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">9728</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">10240</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">10880</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">12288</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">13568</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">14336</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">16384</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">18432</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">19072</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">20480</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">21760</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">24576</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">27264</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">28672</span> + <span class="hljs-number">1</span>, ^<span class="hljs-type">uint32</span>(<span class="hljs-number">0</span>)/<span class="hljs-number">32768</span> + <span class="hljs-number">1</span>&#125;<br><span class="hljs-keyword">var</span> size_to_class8 = [smallSizeMax/smallSizeDiv + <span class="hljs-number">1</span>]<span class="hljs-type">uint8</span>&#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">19</span>, <span class="hljs-number">19</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">21</span>, <span class="hljs-number">21</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">22</span>, <span class="hljs-number">22</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">23</span>, <span class="hljs-number">24</span>, <span class="hljs-number">24</span>, <span class="hljs-number">24</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">25</span>, <span class="hljs-number">25</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">26</span>, <span class="hljs-number">26</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">27</span>, <span class="hljs-number">27</span>, <span class="hljs-number">27</span>, <span class="hljs-number">27</span>, <span class="hljs-number">27</span>, <span class="hljs-number">27</span>, <span class="hljs-number">27</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>, <span class="hljs-number">29</span>, <span class="hljs-number">29</span>, <span class="hljs-number">29</span>, <span class="hljs-number">29</span>, <span class="hljs-number">29</span>, <span class="hljs-number">29</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">31</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>&#125;<br><span class="hljs-keyword">var</span> size_to_class128 = [(_MaxSmallSize-smallSizeMax)/largeSizeDiv + <span class="hljs-number">1</span>]<span class="hljs-type">uint8</span>&#123;<span class="hljs-number">32</span>, <span class="hljs-number">33</span>, <span class="hljs-number">34</span>, <span class="hljs-number">35</span>, <span class="hljs-number">36</span>, <span class="hljs-number">37</span>, <span class="hljs-number">37</span>, <span class="hljs-number">38</span>, <span class="hljs-number">38</span>, <span class="hljs-number">39</span>, <span class="hljs-number">39</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>, <span class="hljs-number">40</span>, <span class="hljs-number">41</span>, <span class="hljs-number">41</span>, <span class="hljs-number">41</span>, <span class="hljs-number">42</span>, <span class="hljs-number">43</span>, <span class="hljs-number">43</span>, <span class="hljs-number">44</span>, <span class="hljs-number">44</span>, <span class="hljs-number">44</span>, <span class="hljs-number">44</span>, <span class="hljs-number">44</span>, <span class="hljs-number">45</span>, <span class="hljs-number">45</span>, <span class="hljs-number">45</span>, <span class="hljs-number">45</span>, <span class="hljs-number">45</span>, <span class="hljs-number">45</span>, <span class="hljs-number">46</span>, <span class="hljs-number">46</span>, <span class="hljs-number">46</span>, <span class="hljs-number">46</span>, <span class="hljs-number">47</span>, <span class="hljs-number">47</span>, <span class="hljs-number">47</span>, <span class="hljs-number">47</span>, <span class="hljs-number">47</span>, <span class="hljs-number">47</span>, <span class="hljs-number">48</span>, <span class="hljs-number">48</span>, <span class="hljs-number">48</span>, <span class="hljs-number">49</span>, <span class="hljs-number">49</span>, <span class="hljs-number">50</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">52</span>, <span class="hljs-number">52</span>, <span class="hljs-number">52</span>, <span class="hljs-number">52</span>, <span class="hljs-number">52</span>, <span class="hljs-number">52</span>, <span class="hljs-number">52</span>, <span class="hljs-number">52</span>, <span class="hljs-number">52</span>, <span class="hljs-number">52</span>, <span class="hljs-number">53</span>, <span class="hljs-number">53</span>, <span class="hljs-number">54</span>, <span class="hljs-number">54</span>, <span class="hljs-number">54</span>, <span class="hljs-number">54</span>, <span class="hljs-number">55</span>, <span class="hljs-number">55</span>, <span class="hljs-number">55</span>, <span class="hljs-number">55</span>, <span class="hljs-number">55</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">56</span>, <span class="hljs-number">57</span>, <span class="hljs-number">57</span>, <span class="hljs-number">57</span>, <span class="hljs-number">57</span>, <span class="hljs-number">57</span>, <span class="hljs-number">57</span>, <span class="hljs-number">57</span>, <span class="hljs-number">57</span>, <span class="hljs-number">57</span>, <span class="hljs-number">57</span>, <span class="hljs-number">58</span>, <span class="hljs-number">58</span>, <span class="hljs-number">58</span>, <span class="hljs-number">58</span>, <span class="hljs-number">58</span>, <span class="hljs-number">58</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">59</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>, <span class="hljs-number">61</span>, <span class="hljs-number">61</span>, <span class="hljs-number">61</span>, <span class="hljs-number">61</span>, <span class="hljs-number">61</span>, <span class="hljs-number">62</span>, <span class="hljs-number">62</span>, <span class="hljs-number">62</span>, <span class="hljs-number">62</span>, <span class="hljs-number">62</span>, <span class="hljs-number">62</span>, <span class="hljs-number">62</span>, <span class="hljs-number">62</span>, <span class="hljs-number">62</span>, <span class="hljs-number">62</span>, <span class="hljs-number">62</span>, <span class="hljs-number">63</span>, <span class="hljs-number">63</span>, <span class="hljs-number">63</span>, <span class="hljs-number">63</span>, <span class="hljs-number">63</span>, <span class="hljs-number">63</span>, <span class="hljs-number">63</span>, <span class="hljs-number">63</span>, <span class="hljs-number">63</span>, <span class="hljs-number">63</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">64</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">65</span>, <span class="hljs-number">66</span>, <span class="hljs-number">66</span>, <span class="hljs-number">66</span>, <span class="hljs-number">66</span>, <span class="hljs-number">66</span>, <span class="hljs-number">66</span>, <span class="hljs-number">66</span>, <span class="hljs-number">66</span>, <span class="hljs-number">66</span>, <span class="hljs-number">66</span>, <span class="hljs-number">66</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">67</span>&#125;<br></code></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="bitmap"><a href="#bitmap" class="headerlink" title="bitmap"></a>bitmap</h3><ul>
<li>每个字节都会表示 arena 区域中的 32 字节是否空闲</li>
<li>主要用于gc</li>
<li>16G = 512GB/32B*1B</li>
</ul>
<h2 id="内存管理组件"><a href="#内存管理组件" class="headerlink" title="内存管理组件"></a>内存管理组件</h2><p>go的内存管理组件主要有：mspan、mcache、mcentral和mheap、heapArena</p>
<ul>
<li>mspan：为内存管理的基础单元，直接存储数据的地方。</li>
<li>mcache：每个运行期的goroutine都会绑定的一个mcache(具体来讲是绑定的GMP并发模型中的P，所以可以无锁分配mspan)，mcache会分配goroutine运行中所需要的内存空间(即mspan)。</li>
<li>mcentral：为所有mcache切分好后备的mspan</li>
<li>mheap：代表Go程序持有的所有堆空间。还会管理闲置的span，需要时向操作系统申请新内存。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/jpeg/2630542/1672544062665-83dd4440-eab3-403e-a2cd-16ca72459bb7.jpeg" srcset="/img/loading.gif" lazyload></p>
<h3 id="mcache"><a href="#mcache" class="headerlink" title="mcache"></a>mcache</h3><p>在GPM关系中，会在每个 <strong>P</strong> 下都有一个 mcache 字段，用来表示内存信息。在 Go 1.2 版本以前调度器使用的是 GM 模型，将 mcache 放在了 M 里，但发现存在诸多问题，其中对于内存这一块存在着巨大的浪费。每个 M 都持有 mcache 和 stack alloc，但只有在 M 运行 Go 代码时才需要使用内存(每个 mcache 可以高达2mb)，当 M 在处于 syscall 或 网络请求 的时候是不需要内存的，再加上 M 又是允许创建多个的，这就造成了内存的很大浪费。所以从go 1.3版本开始使用了GPM模型，这样在高并发状态下，每个G只有在运行的时候才会使用到内存，而每个 G 会绑定一个P，所以它们在运行只占用一份 mcache，对于 mcache 的数量就是P 的数量，同时并发访问时也不会产生锁。</p>
<p>对于 GM 模型除了上面提供到内存浪费的问题，还有其它问题，如单一全局锁sched.Lock、goroutine 传递问题和内存局部性等。在 P 中，一个 mcache 除了可以用来缓存小对象外，还包含一些本地分配统计信息。由于在每个P下面都存在一个mcache ，所以多个 goroutine 并发请求内存时是无锁的。</p>
<p>在mcache中默认会有alloc  = 136个span空间提供给当前P使用</p>
<p>源码</p>
<blockquote>
<p>src/runtime/mheap.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Per-thread (in Go, per-P) cache for small objects.</span><br><span class="hljs-comment">// This includes a small object cache and local allocation stats.</span><br><span class="hljs-comment">// No locking needed because it is per-thread (per-P).</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// mcaches are allocated from non-GC&#x27;d memory, so any heap pointers</span><br><span class="hljs-comment">// must be specially handled.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//go:notinheap</span><br><span class="hljs-keyword">type</span> mcache <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">// The following members are accessed on every malloc,</span><br>    <span class="hljs-comment">// so they are grouped here for better caching.</span><br>    nextSample <span class="hljs-type">uintptr</span> <span class="hljs-comment">// trigger heap sample after allocating this many bytes</span><br>    scanAlloc  <span class="hljs-type">uintptr</span> <span class="hljs-comment">// bytes of scannable heap allocated</span><br><br>    <span class="hljs-comment">// Allocator cache for tiny objects w/o pointers.</span><br>    <span class="hljs-comment">// See &quot;Tiny allocator&quot; comment in malloc.go.</span><br><br>    <span class="hljs-comment">// tiny points to the beginning of the current tiny block, or</span><br>    <span class="hljs-comment">// nil if there is no current tiny block.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// tiny is a heap pointer. Since mcache is in non-GC&#x27;d memory,</span><br>    <span class="hljs-comment">// we handle it by clearing it in releaseAll during mark</span><br>    <span class="hljs-comment">// termination.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// tinyAllocs is the number of tiny allocations performed</span><br>    <span class="hljs-comment">// by the P that owns this mcache.</span><br>    <span class="hljs-comment">// 微对象分配器</span><br>    tiny       <span class="hljs-type">uintptr</span><span class="hljs-comment">//tiny对象基地址</span><br>    tinyoffset <span class="hljs-type">uintptr</span><span class="hljs-comment">//下一个空闲内存所在偏移量</span><br>    tinyAllocs <span class="hljs-type">uintptr</span><span class="hljs-comment">//tiny对象分配个数</span><br><br>    <span class="hljs-comment">// The rest is not accessed on every malloc.</span><br>    <span class="hljs-comment">// numSpanClasses = 68 &lt;&lt; 1 = 136</span><br>    <span class="hljs-comment">// 小对象分配器</span><br>    alloc [numSpanClasses]*mspan <span class="hljs-comment">// spans to allocate from, indexed by spanClass</span><br>    <span class="hljs-comment">//按class分组的mspan列表</span><br><br>    stackcache [_NumStackOrders]stackfreelist<br>    <span class="hljs-comment">//栈缓存</span><br><br>    <span class="hljs-comment">// flushGen indicates the sweepgen during which this mcache</span><br>    <span class="hljs-comment">// was last flushed. If flushGen != mheap_.sweepgen, the spans</span><br>    <span class="hljs-comment">// in this mcache are stale and need to the flushed so they</span><br>    <span class="hljs-comment">// can be swept. This is done in acquirep.</span><br>    flushGen <span class="hljs-type">uint32</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="mspan"><a href="#mspan" class="headerlink" title="mspan"></a>mspan</h3><blockquote>
<p>双向链表结构</p>
</blockquote>
<p>mspan 是分配内存时的基本单元。当分配内存时，会在mcache中查找适合规格的可用 mspan，此时不需要加锁，因此分配效率极高。</p>
<p>如上面提到的，Go将内存块分为大小不同的 67 种，然后再把这 67 种大内存块，逐个分为小块(可以近似理解为大小不同的相当于page)称之为span(连续的page)</p>
<p>源码</p>
<blockquote>
<p>src/runtime/mheap.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//go:notinheap</span><br><span class="hljs-keyword">type</span> mspan <span class="hljs-keyword">struct</span> &#123;<br>    <span class="hljs-comment">//下一个span</span><br>	next *mspan     <span class="hljs-comment">// next span in list, or nil if none</span><br>	prev *mspan     <span class="hljs-comment">// previous span in list, or nil if none</span><br>	list *mSpanList <span class="hljs-comment">// For debugging. <span class="hljs-doctag">TODO:</span> Remove.</span><br>    <span class="hljs-comment">//指向链表的指针</span><br><br>	startAddr <span class="hljs-type">uintptr</span> <span class="hljs-comment">// address of first byte of span aka s.base()</span><br>    <span class="hljs-comment">//开始地址</span><br>	npages    <span class="hljs-type">uintptr</span> <span class="hljs-comment">// number of pages in span</span><br>    <span class="hljs-comment">//span中的页数（一个span 是由多个page组成的）</span><br><br>	manualFreeList gclinkptr <span class="hljs-comment">// list of free objects in mSpanManual spans</span><br><br>	<span class="hljs-comment">// freeindex is the slot index between 0 and nelems at which to begin scanning</span><br>	<span class="hljs-comment">// for the next free object in this span.</span><br>	<span class="hljs-comment">// Each allocation scans allocBits starting at freeindex until it encounters a 0</span><br>	<span class="hljs-comment">// indicating a free object. freeindex is then adjusted so that subsequent scans begin</span><br>	<span class="hljs-comment">// just past the newly discovered free object.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// If freeindex == nelem, this span has no free objects.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// allocBits is a bitmap of objects in this span.</span><br>	<span class="hljs-comment">// If n &gt;= freeindex and allocBits[n/8] &amp; (1&lt;&lt;(n%8)) is 0</span><br>	<span class="hljs-comment">// then object n is free;</span><br>	<span class="hljs-comment">// otherwise, object n is allocated. Bits starting at nelem are</span><br>	<span class="hljs-comment">// undefined and should never be referenced.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Object n starts at address n*elemsize + (start &lt;&lt; pageShift).</span><br>	freeindex <span class="hljs-type">uintptr</span><br>	<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Look up nelems from sizeclass and remove this field if it</span><br>	<span class="hljs-comment">// helps performance.</span><br>	nelems <span class="hljs-type">uintptr</span> <span class="hljs-comment">// number of object in the span.</span><br><br>	<span class="hljs-comment">// Cache of the allocBits at freeindex. allocCache is shifted</span><br>	<span class="hljs-comment">// such that the lowest bit corresponds to the bit freeindex.</span><br>	<span class="hljs-comment">// allocCache holds the complement of allocBits, thus allowing</span><br>	<span class="hljs-comment">// ctz (count trailing zero) to use it directly.</span><br>	<span class="hljs-comment">// allocCache may contain bits beyond s.nelems; the caller must ignore</span><br>	<span class="hljs-comment">// these.</span><br>	allocCache <span class="hljs-type">uint64</span><br><br>	<span class="hljs-comment">// allocBits and gcmarkBits hold pointers to a span&#x27;s mark and</span><br>	<span class="hljs-comment">// allocation bits. The pointers are 8 byte aligned.</span><br>	<span class="hljs-comment">// There are three arenas where this data is held.</span><br>	<span class="hljs-comment">// free: Dirty arenas that are no longer accessed</span><br>	<span class="hljs-comment">//       and can be reused.</span><br>	<span class="hljs-comment">// next: Holds information to be used in the next GC cycle.</span><br>	<span class="hljs-comment">// current: Information being used during this GC cycle.</span><br>	<span class="hljs-comment">// previous: Information being used during the last GC cycle.</span><br>	<span class="hljs-comment">// A new GC cycle starts with the call to finishsweep_m.</span><br>	<span class="hljs-comment">// finishsweep_m moves the previous arena to the free arena,</span><br>	<span class="hljs-comment">// the current arena to the previous arena, and</span><br>	<span class="hljs-comment">// the next arena to the current arena.</span><br>	<span class="hljs-comment">// The next arena is populated as the spans request</span><br>	<span class="hljs-comment">// memory to hold gcmarkBits for the next GC cycle as well</span><br>	<span class="hljs-comment">// as allocBits for newly allocated spans.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// The pointer arithmetic is done &quot;by hand&quot; instead of using</span><br>	<span class="hljs-comment">// arrays to avoid bounds checks along critical performance</span><br>	<span class="hljs-comment">// paths.</span><br>	<span class="hljs-comment">// The sweep will free the old allocBits and set allocBits to the</span><br>	<span class="hljs-comment">// gcmarkBits. The gcmarkBits are replaced with a fresh zeroed</span><br>	<span class="hljs-comment">// out memory.</span><br>	allocBits  *gcBits<br>	gcmarkBits *gcBits<span class="hljs-comment">// gc 三色位图</span><br><br>	<span class="hljs-comment">// sweep generation:</span><br>	<span class="hljs-comment">// if sweepgen == h-&gt;sweepgen - 2, the span needs sweeping</span><br>	<span class="hljs-comment">// if sweepgen == h-&gt;sweepgen - 1, the span is currently being swept</span><br>	<span class="hljs-comment">// if sweepgen == h-&gt;sweepgen, the span is swept and ready to use</span><br>	<span class="hljs-comment">// if sweepgen == h-&gt;sweepgen + 1, the span was cached before sweep began and is still cached, and needs sweeping</span><br>	<span class="hljs-comment">// if sweepgen == h-&gt;sweepgen + 3, the span was swept and then cached and is still cached</span><br>	<span class="hljs-comment">// h-&gt;sweepgen is incremented by 2 after every GC</span><br><br>	sweepgen              <span class="hljs-type">uint32</span><br>	divMul                <span class="hljs-type">uint32</span>        <span class="hljs-comment">// for divide by elemsize</span><br>	allocCount            <span class="hljs-type">uint16</span>        <span class="hljs-comment">// number of allocated objects</span><br>	spanclass             spanClass     <span class="hljs-comment">// size class and noscan (uint8)</span><br>	state                 mSpanStateBox <span class="hljs-comment">// mSpanInUse etc; accessed atomically (get/set methods)</span><br>	needzero              <span class="hljs-type">uint8</span>         <span class="hljs-comment">// needs to be zeroed before allocation</span><br>	allocCountBeforeCache <span class="hljs-type">uint16</span>        <span class="hljs-comment">// a copy of allocCount that is stored just before this span is cached</span><br>	elemsize              <span class="hljs-type">uintptr</span>       <span class="hljs-comment">// computed from sizeclass or from npages</span><br>	limit                 <span class="hljs-type">uintptr</span>       <span class="hljs-comment">// end of data in span</span><br>	speciallock           mutex         <span class="hljs-comment">// guards specials list</span><br>	specials              *special      <span class="hljs-comment">// linked list of special records sorted by offset.</span><br><br>	<span class="hljs-comment">// freeIndexForScan is like freeindex, except that freeindex is</span><br>	<span class="hljs-comment">// used by the allocator whereas freeIndexForScan is used by the</span><br>	<span class="hljs-comment">// GC scanner. They are two fields so that the GC sees the object</span><br>	<span class="hljs-comment">// is allocated only when the object and the heap bits are</span><br>	<span class="hljs-comment">// initialized (see also the assignment of freeIndexForScan in</span><br>	<span class="hljs-comment">// mallocgc, and issue 54596).</span><br>	freeIndexForScan <span class="hljs-type">uintptr</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="mcentral"><a href="#mcentral" class="headerlink" title="mcentral"></a>mcentral</h3><p>两个包含/不包含空闲对象的mspan列表，mspan列表多线程共享,使用互斥锁保护</p>
<p>源码</p>
<blockquote>
<p>src/runtime/mspanset.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Central list of free objects of a given size.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//go:notinheap</span><br><span class="hljs-keyword">type</span> mcentral <span class="hljs-keyword">struct</span> &#123;<br>	spanclass spanClass<br><br>	<span class="hljs-comment">// partial and full contain two mspan sets: one of swept in-use</span><br>	<span class="hljs-comment">// spans, and one of unswept in-use spans. These two trade</span><br>	<span class="hljs-comment">// roles on each GC cycle. The unswept set is drained either by</span><br>	<span class="hljs-comment">// allocation or by the background sweeper in every GC cycle,</span><br>	<span class="hljs-comment">// so only two roles are necessary.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// sweepgen is increased by 2 on each GC cycle, so the swept</span><br>	<span class="hljs-comment">// spans are in partial[sweepgen/2%2] and the unswept spans are in</span><br>	<span class="hljs-comment">// partial[1-sweepgen/2%2]. Sweeping pops spans from the</span><br>	<span class="hljs-comment">// unswept set and pushes spans that are still in-use on the</span><br>	<span class="hljs-comment">// swept set. Likewise, allocating an in-use span pushes it</span><br>	<span class="hljs-comment">// on the swept set.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Some parts of the sweeper can sweep arbitrary spans, and hence</span><br>	<span class="hljs-comment">// can&#x27;t remove them from the unswept set, but will add the span</span><br>	<span class="hljs-comment">// to the appropriate swept list. As a result, the parts of the</span><br>	<span class="hljs-comment">// sweeper and mcentral that do consume from the unswept list may</span><br>	<span class="hljs-comment">// encounter swept spans, and these should be ignored.</span><br>	partial [<span class="hljs-number">2</span>]spanSet <span class="hljs-comment">// list of spans with a free object</span><br>	full    [<span class="hljs-number">2</span>]spanSet <span class="hljs-comment">// list of spans with no free objects</span><br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// A spanSet is a set of *mspans.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// spanSet is safe for concurrent push and pop operations.</span><br><span class="hljs-keyword">type</span> spanSet <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// A spanSet is a two-level data structure consisting of a</span><br>	<span class="hljs-comment">// growable spine that points to fixed-sized blocks. The spine</span><br>	<span class="hljs-comment">// can be accessed without locks, but adding a block or</span><br>	<span class="hljs-comment">// growing it requires taking the spine lock.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Because each mspan covers at least 8K of heap and takes at</span><br>	<span class="hljs-comment">// most 8 bytes in the spanSet, the growth of the spine is</span><br>	<span class="hljs-comment">// quite limited.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// The spine and all blocks are allocated off-heap, which</span><br>	<span class="hljs-comment">// allows this to be used in the memory manager and avoids the</span><br>	<span class="hljs-comment">// need for write barriers on all of these. spanSetBlocks are</span><br>	<span class="hljs-comment">// managed in a pool, though never freed back to the operating</span><br>	<span class="hljs-comment">// system. We never release spine memory because there could be</span><br>	<span class="hljs-comment">// concurrent lock-free access and we&#x27;re likely to reuse it</span><br>	<span class="hljs-comment">// anyway. (In principle, we could do this during STW.)</span><br><br>	spineLock mutex<br>	spine     unsafe.Pointer <span class="hljs-comment">// *[N]*spanSetBlock, accessed atomically</span><br>	spineLen  <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// Spine array length, accessed atomically</span><br>	spineCap  <span class="hljs-type">uintptr</span>        <span class="hljs-comment">// Spine array cap, accessed under lock</span><br><br>	<span class="hljs-comment">// index is the head and tail of the spanSet in a single field.</span><br>	<span class="hljs-comment">// The head and the tail both represent an index into the logical</span><br>	<span class="hljs-comment">// concatenation of all blocks, with the head always behind or</span><br>	<span class="hljs-comment">// equal to the tail (indicating an empty set). This field is</span><br>	<span class="hljs-comment">// always accessed atomically.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// The head and the tail are only 32 bits wide, which means we</span><br>	<span class="hljs-comment">// can only support up to 2^32 pushes before a reset. If every</span><br>	<span class="hljs-comment">// span in the heap were stored in this set, and each span were</span><br>	<span class="hljs-comment">// the minimum size (1 runtime page, 8 KiB), then roughly the</span><br>	<span class="hljs-comment">// smallest heap which would be unrepresentable is 32 TiB in size.</span><br>	index headTailIndex<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="mheap"><a href="#mheap" class="headerlink" title="mheap"></a>mheap</h3><blockquote>
<p>mheap即是我们说的堆区</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Main malloc heap.</span><br><span class="hljs-comment">// The heap itself is the &quot;free&quot; and &quot;scav&quot; treaps,</span><br><span class="hljs-comment">// but all the other global data is here too.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// mheap must not be heap-allocated because it contains mSpanLists,</span><br><span class="hljs-comment">// which must not be heap-allocated.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//go:notinheap</span><br><span class="hljs-keyword">type</span> mheap <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// lock must only be acquired on the system stack, otherwise a g</span><br>	<span class="hljs-comment">// could self-deadlock if its stack grows with the lock held.</span><br>	lock mutex<br><br>	_ <span class="hljs-type">uint32</span> <span class="hljs-comment">// 8-byte align pages so its alignment is consistent with tests.</span><br><br>	pages pageAlloc <span class="hljs-comment">// page allocation data structure</span><br><br>	sweepgen <span class="hljs-type">uint32</span> <span class="hljs-comment">// sweep generation, see comment in mspan; written during STW</span><br><br>	<span class="hljs-comment">// allspans is a slice of all mspans ever created. Each mspan</span><br>	<span class="hljs-comment">// appears exactly once.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// The memory for allspans is manually managed and can be</span><br>	<span class="hljs-comment">// reallocated and move as the heap grows.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// In general, allspans is protected by mheap_.lock, which</span><br>	<span class="hljs-comment">// prevents concurrent access as well as freeing the backing</span><br>	<span class="hljs-comment">// store. Accesses during STW might not hold the lock, but</span><br>	<span class="hljs-comment">// must ensure that allocation cannot happen around the</span><br>	<span class="hljs-comment">// access (since that may free the backing store).</span><br>	allspans []*mspan <span class="hljs-comment">// all spans out there</span><br><br>	<span class="hljs-comment">// _ uint32 // align uint64 fields on 32-bit for atomics</span><br><br>	<span class="hljs-comment">// Proportional sweep</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// These parameters represent a linear function from gcController.heapLive</span><br>	<span class="hljs-comment">// to page sweep count. The proportional sweep system works to</span><br>	<span class="hljs-comment">// stay in the black by keeping the current page sweep count</span><br>	<span class="hljs-comment">// above this line at the current gcController.heapLive.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// The line has slope sweepPagesPerByte and passes through a</span><br>	<span class="hljs-comment">// basis point at (sweepHeapLiveBasis, pagesSweptBasis). At</span><br>	<span class="hljs-comment">// any given time, the system is at (gcController.heapLive,</span><br>	<span class="hljs-comment">// pagesSwept) in this space.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// It is important that the line pass through a point we</span><br>	<span class="hljs-comment">// control rather than simply starting at a 0,0 origin</span><br>	<span class="hljs-comment">// because that lets us adjust sweep pacing at any time while</span><br>	<span class="hljs-comment">// accounting for current progress. If we could only adjust</span><br>	<span class="hljs-comment">// the slope, it would create a discontinuity in debt if any</span><br>	<span class="hljs-comment">// progress has already been made.</span><br>	pagesInUse         atomic.Uint64 <span class="hljs-comment">// pages of spans in stats mSpanInUse</span><br>	pagesSwept         atomic.Uint64 <span class="hljs-comment">// pages swept this cycle</span><br>	pagesSweptBasis    atomic.Uint64 <span class="hljs-comment">// pagesSwept to use as the origin of the sweep ratio</span><br>	sweepHeapLiveBasis <span class="hljs-type">uint64</span>        <span class="hljs-comment">// value of gcController.heapLive to use as the origin of sweep ratio; written with lock, read without</span><br>	sweepPagesPerByte  <span class="hljs-type">float64</span>       <span class="hljs-comment">// proportional sweep ratio; written with lock, read without</span><br>	<span class="hljs-comment">// TODO(austin): pagesInUse should be a uintptr, but the 386</span><br>	<span class="hljs-comment">// compiler can&#x27;t 8-byte align fields.</span><br><br>	<span class="hljs-comment">// Page reclaimer state</span><br><br>	<span class="hljs-comment">// reclaimIndex is the page index in allArenas of next page to</span><br>	<span class="hljs-comment">// reclaim. Specifically, it refers to page (i %</span><br>	<span class="hljs-comment">// pagesPerArena) of arena allArenas[i / pagesPerArena].</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// If this is &gt;= 1&lt;&lt;63, the page reclaimer is done scanning</span><br>	<span class="hljs-comment">// the page marks.</span><br>	reclaimIndex atomic.Uint64<br><br>	<span class="hljs-comment">// reclaimCredit is spare credit for extra pages swept. Since</span><br>	<span class="hljs-comment">// the page reclaimer works in large chunks, it may reclaim</span><br>	<span class="hljs-comment">// more than requested. Any spare pages released go to this</span><br>	<span class="hljs-comment">// credit pool.</span><br>	reclaimCredit atomic.Uintptr<br><br>	<span class="hljs-comment">// arenas is the heap arena map. It points to the metadata for</span><br>	<span class="hljs-comment">// the heap for every arena frame of the entire usable virtual</span><br>	<span class="hljs-comment">// address space.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Use arenaIndex to compute indexes into this array.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// For regions of the address space that are not backed by the</span><br>	<span class="hljs-comment">// Go heap, the arena map contains nil.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Modifications are protected by mheap_.lock. Reads can be</span><br>	<span class="hljs-comment">// performed without locking; however, a given entry can</span><br>	<span class="hljs-comment">// transition from nil to non-nil at any time when the lock</span><br>	<span class="hljs-comment">// isn&#x27;t held. (Entries never transitions back to nil.)</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// In general, this is a two-level mapping consisting of an L1</span><br>	<span class="hljs-comment">// map and possibly many L2 maps. This saves space when there</span><br>	<span class="hljs-comment">// are a huge number of arena frames. However, on many</span><br>	<span class="hljs-comment">// platforms (even 64-bit), arenaL1Bits is 0, making this</span><br>	<span class="hljs-comment">// effectively a single-level map. In this case, arenas[0]</span><br>	<span class="hljs-comment">// will never be nil.</span><br>	arenas [<span class="hljs-number">1</span> &lt;&lt; arenaL1Bits]*[<span class="hljs-number">1</span> &lt;&lt; arenaL2Bits]*heapArena<br><br>	<span class="hljs-comment">// heapArenaAlloc is pre-reserved space for allocating heapArena</span><br>	<span class="hljs-comment">// objects. This is only used on 32-bit, where we pre-reserve</span><br>	<span class="hljs-comment">// this space to avoid interleaving it with the heap itself.</span><br>	heapArenaAlloc linearAlloc<br><br>	<span class="hljs-comment">// arenaHints is a list of addresses at which to attempt to</span><br>	<span class="hljs-comment">// add more heap arenas. This is initially populated with a</span><br>	<span class="hljs-comment">// set of general hint addresses, and grown with the bounds of</span><br>	<span class="hljs-comment">// actual heap arena ranges.</span><br>	arenaHints *arenaHint<br><br>	<span class="hljs-comment">// arena is a pre-reserved space for allocating heap arenas</span><br>	<span class="hljs-comment">// (the actual arenas). This is only used on 32-bit.</span><br>	arena linearAlloc<br><br>	<span class="hljs-comment">// allArenas is the arenaIndex of every mapped arena. This can</span><br>	<span class="hljs-comment">// be used to iterate through the address space.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Access is protected by mheap_.lock. However, since this is</span><br>	<span class="hljs-comment">// append-only and old backing arrays are never freed, it is</span><br>	<span class="hljs-comment">// safe to acquire mheap_.lock, copy the slice header, and</span><br>	<span class="hljs-comment">// then release mheap_.lock.</span><br>	allArenas []arenaIdx<br><br>	<span class="hljs-comment">// sweepArenas is a snapshot of allArenas taken at the</span><br>	<span class="hljs-comment">// beginning of the sweep cycle. This can be read safely by</span><br>	<span class="hljs-comment">// simply blocking GC (by disabling preemption).</span><br>	sweepArenas []arenaIdx<br><br>	<span class="hljs-comment">// markArenas is a snapshot of allArenas taken at the beginning</span><br>	<span class="hljs-comment">// of the mark cycle. Because allArenas is append-only, neither</span><br>	<span class="hljs-comment">// this slice nor its contents will change during the mark, so</span><br>	<span class="hljs-comment">// it can be read safely.</span><br>	markArenas []arenaIdx<br><br>	<span class="hljs-comment">// curArena is the arena that the heap is currently growing</span><br>	<span class="hljs-comment">// into. This should always be physPageSize-aligned.</span><br>	curArena <span class="hljs-keyword">struct</span> &#123;<br>		base, end <span class="hljs-type">uintptr</span><br>	&#125;<br><br>	_ <span class="hljs-type">uint32</span> <span class="hljs-comment">// ensure 64-bit alignment of central</span><br><br>	<span class="hljs-comment">// central free lists for small size classes.</span><br>	<span class="hljs-comment">// the padding makes sure that the mcentrals are</span><br>	<span class="hljs-comment">// spaced CacheLinePadSize bytes apart, so that each mcentral.lock</span><br>	<span class="hljs-comment">// gets its own cache line.</span><br>	<span class="hljs-comment">// central is indexed by spanClass.</span><br>	central [numSpanClasses]<span class="hljs-keyword">struct</span> &#123;<br>		mcentral mcentral<br>		pad      [cpu.CacheLinePadSize - unsafe.Sizeof(mcentral&#123;&#125;)%cpu.CacheLinePadSize]<span class="hljs-type">byte</span><br>	&#125;<br><br>	spanalloc             fixalloc <span class="hljs-comment">// allocator for span*</span><br>	cachealloc            fixalloc <span class="hljs-comment">// allocator for mcache*</span><br>	specialfinalizeralloc fixalloc <span class="hljs-comment">// allocator for specialfinalizer*</span><br>	specialprofilealloc   fixalloc <span class="hljs-comment">// allocator for specialprofile*</span><br>	specialReachableAlloc fixalloc <span class="hljs-comment">// allocator for specialReachable</span><br>	speciallock           mutex    <span class="hljs-comment">// lock for special record allocators.</span><br>	arenaHintAlloc        fixalloc <span class="hljs-comment">// allocator for arenaHints</span><br><br>	unused *specialfinalizer <span class="hljs-comment">// never set, just here to force the specialfinalizer type into DWARF</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>heapArena</strong><br>g1.11版本以及之后引入二维稀疏内存</p>
<blockquote>
<p>[l1][l2]heapArena</p>
</blockquote>
<ul>
<li>Linux x86-64架构 l1=1 l2=4194304 32MB = 4194304*8B(指针大小) ,每个heapArena可以管理64MB内存</li>
<li>4M*64MB = 256TB内存<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// A heapArena stores metadata for a heap arena. heapArenas are stored</span><br><span class="hljs-comment">// outside of the Go heap and accessed via the mheap_.arenas index.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//go:notinheap</span><br><span class="hljs-keyword">type</span> heapArena <span class="hljs-keyword">struct</span> &#123;<br>	<span class="hljs-comment">// bitmap stores the pointer/scalar bitmap for the words in</span><br>	<span class="hljs-comment">// this arena. See mbitmap.go for a description. Use the</span><br>	<span class="hljs-comment">// heapBits type to access this.</span><br>	bitmap [heapArenaBitmapBytes]<span class="hljs-type">byte</span><br>    <span class="hljs-comment">// 标记内内存是否使用</span><br><br>	<span class="hljs-comment">// spans maps from virtual address page ID within this arena to *mspan.</span><br>	<span class="hljs-comment">// For allocated spans, their pages map to the span itself.</span><br>	<span class="hljs-comment">// For free spans, only the lowest and highest pages map to the span itself.</span><br>	<span class="hljs-comment">// Internal pages map to an arbitrary span.</span><br>	<span class="hljs-comment">// For pages that have never been allocated, spans entries are nil.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Modifications are protected by mheap.lock. Reads can be</span><br>	<span class="hljs-comment">// performed without locking, but ONLY from indexes that are</span><br>	<span class="hljs-comment">// known to contain in-use or stack spans. This means there</span><br>	<span class="hljs-comment">// must not be a safe-point between establishing that an</span><br>	<span class="hljs-comment">// address is live and looking it up in the spans array.</span><br>	spans [pagesPerArena]*mspan<br>    <span class="hljs-comment">//对应的mspan管理器</span><br><br>	<span class="hljs-comment">// pageInUse is a bitmap that indicates which spans are in</span><br>	<span class="hljs-comment">// state mSpanInUse. This bitmap is indexed by page number,</span><br>	<span class="hljs-comment">// but only the bit corresponding to the first page in each</span><br>	<span class="hljs-comment">// span is used.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Reads and writes are atomic.</span><br>	pageInUse [pagesPerArena / <span class="hljs-number">8</span>]<span class="hljs-type">uint8</span><br><br>	<span class="hljs-comment">// pageMarks is a bitmap that indicates which spans have any</span><br>	<span class="hljs-comment">// marked objects on them. Like pageInUse, only the bit</span><br>	<span class="hljs-comment">// corresponding to the first page in each span is used.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Writes are done atomically during marking. Reads are</span><br>	<span class="hljs-comment">// non-atomic and lock-free since they only occur during</span><br>	<span class="hljs-comment">// sweeping (and hence never race with writes).</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// This is used to quickly find whole spans that can be freed.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// TODO(austin): It would be nice if this was uint64 for</span><br>	<span class="hljs-comment">// faster scanning, but we don&#x27;t have 64-bit atomic bit</span><br>	<span class="hljs-comment">// operations.</span><br>	pageMarks [pagesPerArena / <span class="hljs-number">8</span>]<span class="hljs-type">uint8</span><br><br>	<span class="hljs-comment">// pageSpecials is a bitmap that indicates which spans have</span><br>	<span class="hljs-comment">// specials (finalizers or other). Like pageInUse, only the bit</span><br>	<span class="hljs-comment">// corresponding to the first page in each span is used.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Writes are done atomically whenever a special is added to</span><br>	<span class="hljs-comment">// a span and whenever the last special is removed from a span.</span><br>	<span class="hljs-comment">// Reads are done atomically to find spans containing specials</span><br>	<span class="hljs-comment">// during marking.</span><br>	pageSpecials [pagesPerArena / <span class="hljs-number">8</span>]<span class="hljs-type">uint8</span><br><br>	<span class="hljs-comment">// checkmarks stores the debug.gccheckmark state. It is only</span><br>	<span class="hljs-comment">// used if debug.gccheckmark &gt; 0.</span><br>	checkmarks *checkmarksMap<br><br>	<span class="hljs-comment">// zeroedBase marks the first byte of the first page in this</span><br>	<span class="hljs-comment">// arena which hasn&#x27;t been used yet and is therefore already</span><br>	<span class="hljs-comment">// zero. zeroedBase is relative to the arena base.</span><br>	<span class="hljs-comment">// Increases monotonically until it hits heapArenaBytes.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// This field is sufficient to determine if an allocation</span><br>	<span class="hljs-comment">// needs to be zeroed because the page allocator follows an</span><br>	<span class="hljs-comment">// address-ordered first-fit policy.</span><br>	<span class="hljs-comment">//</span><br>	<span class="hljs-comment">// Read atomically and written with an atomic CAS.</span><br>	zeroedBase <span class="hljs-type">uintptr</span><br>    <span class="hljs-comment">//内存管理基地址</span><br>&#125;<br></code></pre></td></tr></table></figure>


</li>
</ul>
<h2 id="内存分配策略"><a href="#内存分配策略" class="headerlink" title="内存分配策略"></a>内存分配策略</h2><h3 id="总体过程"><a href="#总体过程" class="headerlink" title="总体过程"></a>总体过程</h3><p>1.new,make最祭调用mallocac<br>2.大于32KB对象，直接从mheap中分配，构成一个span<br>3.小于16byte且无指针(noscan)，使用tiny分配器，合并分配<br>4.小于16byte有指针或16byte-32KB，如果mcache中有对应class的空闲mspan，则直接从该mspan中分配一个slot.<br>5. (mcentral.cachespan) mcache没有对应的空余span,则从对应mcentral中申请一个有空余slot的span到mcache中再进行分配<br>6. ( mcentral.grow)对应mcentral没有空余span,则向(mheap(mheap_alloc)中申请一个span，能sweep出span则返回，否则看mheap的sfree mTreap能否分配最大于该size的连续页，能则分配，多的页放回<br>7.mheap的free mTreap无可用，则源用sysAlloc(mmap)向系统申请.<br>8.6,7步中获得的内存构进成span，返回给mcache,分配对象。</p>
<h3 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h3><blockquote>
<p>src/runtime/malloc.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// Allocate an object of size bytes.</span><br><span class="hljs-comment">// Small objects are allocated from the per-P cache&#x27;s free lists.</span><br><span class="hljs-comment">// Large objects (&gt; 32 kB) are allocated straight from the heap.</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">mallocgc</span><span class="hljs-params">(size <span class="hljs-type">uintptr</span>, typ *_type, needzero <span class="hljs-type">bool</span>)</span></span> unsafe.Pointer &#123;<br>	<span class="hljs-keyword">if</span> gcphase == _GCmarktermination &#123;<br>		throw(<span class="hljs-string">&quot;mallocgc called with gcphase == _GCmarktermination&quot;</span>)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> size == <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-keyword">return</span> unsafe.Pointer(&amp;zerobase)<br>	&#125;<br>	userSize := size<br>	<span class="hljs-keyword">if</span> asanenabled &#123;<br>		<span class="hljs-comment">// Refer to ASAN runtime library, the malloc() function allocates extra memory,</span><br>		<span class="hljs-comment">// the redzone, around the user requested memory region. And the redzones are marked</span><br>		<span class="hljs-comment">// as unaddressable. We perform the same operations in Go to detect the overflows or</span><br>		<span class="hljs-comment">// underflows.</span><br>		size += computeRZlog(size)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> debug.malloc &#123;<br>		<span class="hljs-keyword">if</span> debug.sbrk != <span class="hljs-number">0</span> &#123;<br>			align := <span class="hljs-type">uintptr</span>(<span class="hljs-number">16</span>)<br>			<span class="hljs-keyword">if</span> typ != <span class="hljs-literal">nil</span> &#123;<br>				<span class="hljs-comment">// TODO(austin): This should be just</span><br>				<span class="hljs-comment">//   align = uintptr(typ.align)</span><br>				<span class="hljs-comment">// but that&#x27;s only 4 on 32-bit platforms,</span><br>				<span class="hljs-comment">// even if there&#x27;s a uint64 field in typ (see #599).</span><br>				<span class="hljs-comment">// This causes 64-bit atomic accesses to panic.</span><br>				<span class="hljs-comment">// Hence, we use stricter alignment that matches</span><br>				<span class="hljs-comment">// the normal allocator better.</span><br>				<span class="hljs-keyword">if</span> size&amp;<span class="hljs-number">7</span> == <span class="hljs-number">0</span> &#123;<br>					align = <span class="hljs-number">8</span><br>				&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> size&amp;<span class="hljs-number">3</span> == <span class="hljs-number">0</span> &#123;<br>					align = <span class="hljs-number">4</span><br>				&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> size&amp;<span class="hljs-number">1</span> == <span class="hljs-number">0</span> &#123;<br>					align = <span class="hljs-number">2</span><br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					align = <span class="hljs-number">1</span><br>				&#125;<br>			&#125;<br>			<span class="hljs-keyword">return</span> persistentalloc(size, align, &amp;memstats.other_sys)<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> inittrace.active &amp;&amp; inittrace.id == getg().goid &#123;<br>			<span class="hljs-comment">// Init functions are executed sequentially in a single goroutine.</span><br>			inittrace.allocs += <span class="hljs-number">1</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// assistG is the G to charge for this allocation, or nil if</span><br>	<span class="hljs-comment">// GC is not currently active.</span><br>	<span class="hljs-keyword">var</span> assistG *g<br>	<span class="hljs-keyword">if</span> gcBlackenEnabled != <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// Charge the current user G for this allocation.</span><br>		assistG = getg()<br>		<span class="hljs-keyword">if</span> assistG.m.curg != <span class="hljs-literal">nil</span> &#123;<br>			assistG = assistG.m.curg<br>		&#125;<br>		<span class="hljs-comment">// Charge the allocation against the G. We&#x27;ll account</span><br>		<span class="hljs-comment">// for internal fragmentation at the end of mallocgc.</span><br>		assistG.gcAssistBytes -= <span class="hljs-type">int64</span>(size)<br><br>		<span class="hljs-keyword">if</span> assistG.gcAssistBytes &lt; <span class="hljs-number">0</span> &#123;<br>			<span class="hljs-comment">// This G is in debt. Assist the GC to correct</span><br>			<span class="hljs-comment">// this before allocating. This must happen</span><br>			<span class="hljs-comment">// before disabling preemption.</span><br>			gcAssistAlloc(assistG)<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// Set mp.mallocing to keep from being preempted by GC.</span><br>	mp := acquirem()<br>	<span class="hljs-keyword">if</span> mp.mallocing != <span class="hljs-number">0</span> &#123;<br>		throw(<span class="hljs-string">&quot;malloc deadlock&quot;</span>)<br>	&#125;<br>	<span class="hljs-keyword">if</span> mp.gsignal == getg() &#123;<br>		throw(<span class="hljs-string">&quot;malloc during signal&quot;</span>)<br>	&#125;<br>	mp.mallocing = <span class="hljs-number">1</span><br><br>	shouldhelpgc := <span class="hljs-literal">false</span><br>	dataSize := userSize<br>	c := getMCache(mp)<br>	<span class="hljs-keyword">if</span> c == <span class="hljs-literal">nil</span> &#123;<br>		throw(<span class="hljs-string">&quot;mallocgc called without a P or outside bootstrapping&quot;</span>)<br>	&#125;<br>	<span class="hljs-keyword">var</span> span *mspan<br>	<span class="hljs-keyword">var</span> x unsafe.Pointer<br>	noscan := typ == <span class="hljs-literal">nil</span> || typ.ptrdata == <span class="hljs-number">0</span><br>	<span class="hljs-comment">// In some cases block zeroing can profitably (for latency reduction purposes)</span><br>	<span class="hljs-comment">// be delayed till preemption is possible; delayedZeroing tracks that state.</span><br>	delayedZeroing := <span class="hljs-literal">false</span><br>	<span class="hljs-keyword">if</span> size &lt;= maxSmallSize &#123;<br>		<span class="hljs-keyword">if</span> noscan &amp;&amp; size &lt; maxTinySize &#123;<br>			<span class="hljs-comment">// Tiny allocator.</span><br>			<span class="hljs-comment">//</span><br>			<span class="hljs-comment">// Tiny allocator combines several tiny allocation requests</span><br>			<span class="hljs-comment">// into a single memory block. The resulting memory block</span><br>			<span class="hljs-comment">// is freed when all subobjects are unreachable. The subobjects</span><br>			<span class="hljs-comment">// must be noscan (don&#x27;t have pointers), this ensures that</span><br>			<span class="hljs-comment">// the amount of potentially wasted memory is bounded.</span><br>			<span class="hljs-comment">//</span><br>			<span class="hljs-comment">// Size of the memory block used for combining (maxTinySize) is tunable.</span><br>			<span class="hljs-comment">// Current setting is 16 bytes, which relates to 2x worst case memory</span><br>			<span class="hljs-comment">// wastage (when all but one subobjects are unreachable).</span><br>			<span class="hljs-comment">// 8 bytes would result in no wastage at all, but provides less</span><br>			<span class="hljs-comment">// opportunities for combining.</span><br>			<span class="hljs-comment">// 32 bytes provides more opportunities for combining,</span><br>			<span class="hljs-comment">// but can lead to 4x worst case wastage.</span><br>			<span class="hljs-comment">// The best case winning is 8x regardless of block size.</span><br>			<span class="hljs-comment">//</span><br>			<span class="hljs-comment">// Objects obtained from tiny allocator must not be freed explicitly.</span><br>			<span class="hljs-comment">// So when an object will be freed explicitly, we ensure that</span><br>			<span class="hljs-comment">// its size &gt;= maxTinySize.</span><br>			<span class="hljs-comment">//</span><br>			<span class="hljs-comment">// SetFinalizer has a special case for objects potentially coming</span><br>			<span class="hljs-comment">// from tiny allocator, it such case it allows to set finalizers</span><br>			<span class="hljs-comment">// for an inner byte of a memory block.</span><br>			<span class="hljs-comment">//</span><br>			<span class="hljs-comment">// The main targets of tiny allocator are small strings and</span><br>			<span class="hljs-comment">// standalone escaping variables. On a json benchmark</span><br>			<span class="hljs-comment">// the allocator reduces number of allocations by ~12% and</span><br>			<span class="hljs-comment">// reduces heap size by ~20%.</span><br>			off := c.tinyoffset<br>			<span class="hljs-comment">// Align tiny pointer for required (conservative) alignment.</span><br>			<span class="hljs-keyword">if</span> size&amp;<span class="hljs-number">7</span> == <span class="hljs-number">0</span> &#123;<br>				off = alignUp(off, <span class="hljs-number">8</span>)<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> goarch.PtrSize == <span class="hljs-number">4</span> &amp;&amp; size == <span class="hljs-number">12</span> &#123;<br>				<span class="hljs-comment">// Conservatively align 12-byte objects to 8 bytes on 32-bit</span><br>				<span class="hljs-comment">// systems so that objects whose first field is a 64-bit</span><br>				<span class="hljs-comment">// value is aligned to 8 bytes and does not cause a fault on</span><br>				<span class="hljs-comment">// atomic access. See issue 37262.</span><br>				<span class="hljs-comment">// TODO(mknyszek): Remove this workaround if/when issue 36606</span><br>				<span class="hljs-comment">// is resolved.</span><br>				off = alignUp(off, <span class="hljs-number">8</span>)<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> size&amp;<span class="hljs-number">3</span> == <span class="hljs-number">0</span> &#123;<br>				off = alignUp(off, <span class="hljs-number">4</span>)<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> size&amp;<span class="hljs-number">1</span> == <span class="hljs-number">0</span> &#123;<br>				off = alignUp(off, <span class="hljs-number">2</span>)<br>			&#125;<br>			<span class="hljs-keyword">if</span> off+size &lt;= maxTinySize &amp;&amp; c.tiny != <span class="hljs-number">0</span> &#123;<br>				<span class="hljs-comment">// The object fits into existing tiny block.</span><br>				x = unsafe.Pointer(c.tiny + off)<br>				c.tinyoffset = off + size<br>				c.tinyAllocs++<br>				mp.mallocing = <span class="hljs-number">0</span><br>				releasem(mp)<br>				<span class="hljs-keyword">return</span> x<br>			&#125;<br>			<span class="hljs-comment">// Allocate a new maxTinySize block.</span><br>			span = c.alloc[tinySpanClass]<br>			v := nextFreeFast(span)<br>			<span class="hljs-keyword">if</span> v == <span class="hljs-number">0</span> &#123;<br>				v, span, shouldhelpgc = c.nextFree(tinySpanClass)<br>			&#125;<br>			x = unsafe.Pointer(v)<br>			(*[<span class="hljs-number">2</span>]<span class="hljs-type">uint64</span>)(x)[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span><br>			(*[<span class="hljs-number">2</span>]<span class="hljs-type">uint64</span>)(x)[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span><br>			<span class="hljs-comment">// See if we need to replace the existing tiny block with the new one</span><br>			<span class="hljs-comment">// based on amount of remaining free space.</span><br>			<span class="hljs-keyword">if</span> !raceenabled &amp;&amp; (size &lt; c.tinyoffset || c.tiny == <span class="hljs-number">0</span>) &#123;<br>				<span class="hljs-comment">// Note: disabled when race detector is on, see comment near end of this function.</span><br>				c.tiny = <span class="hljs-type">uintptr</span>(x)<br>				c.tinyoffset = size<br>			&#125;<br>			size = maxTinySize<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">var</span> sizeclass <span class="hljs-type">uint8</span><br>			<span class="hljs-keyword">if</span> size &lt;= smallSizeMax<span class="hljs-number">-8</span> &#123;<br>				sizeclass = size_to_class8[divRoundUp(size, smallSizeDiv)]<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				sizeclass = size_to_class128[divRoundUp(size-smallSizeMax, largeSizeDiv)]<br>			&#125;<br>			size = <span class="hljs-type">uintptr</span>(class_to_size[sizeclass])<br>			spc := makeSpanClass(sizeclass, noscan)<br>			span = c.alloc[spc]<br>			v := nextFreeFast(span)<br>			<span class="hljs-keyword">if</span> v == <span class="hljs-number">0</span> &#123;<br>				v, span, shouldhelpgc = c.nextFree(spc)<br>			&#125;<br>			x = unsafe.Pointer(v)<br>			<span class="hljs-keyword">if</span> needzero &amp;&amp; span.needzero != <span class="hljs-number">0</span> &#123;<br>				memclrNoHeapPointers(unsafe.Pointer(v), size)<br>			&#125;<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		shouldhelpgc = <span class="hljs-literal">true</span><br>		<span class="hljs-comment">// For large allocations, keep track of zeroed state so that</span><br>		<span class="hljs-comment">// bulk zeroing can be happen later in a preemptible context.</span><br>		span = c.allocLarge(size, noscan)<br>		span.freeindex = <span class="hljs-number">1</span><br>		span.allocCount = <span class="hljs-number">1</span><br>		size = span.elemsize<br>		x = unsafe.Pointer(span.base())<br>		<span class="hljs-keyword">if</span> needzero &amp;&amp; span.needzero != <span class="hljs-number">0</span> &#123;<br>			<span class="hljs-keyword">if</span> noscan &#123;<br>				delayedZeroing = <span class="hljs-literal">true</span><br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				memclrNoHeapPointers(x, size)<br>				<span class="hljs-comment">// We&#x27;ve in theory cleared almost the whole span here,</span><br>				<span class="hljs-comment">// and could take the extra step of actually clearing</span><br>				<span class="hljs-comment">// the whole thing. However, don&#x27;t. Any GC bits for the</span><br>				<span class="hljs-comment">// uncleared parts will be zero, and it&#x27;s just going to</span><br>				<span class="hljs-comment">// be needzero = 1 once freed anyway.</span><br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">var</span> scanSize <span class="hljs-type">uintptr</span><br>	<span class="hljs-keyword">if</span> !noscan &#123;<br>		heapBitsSetType(<span class="hljs-type">uintptr</span>(x), size, dataSize, typ)<br>		<span class="hljs-keyword">if</span> dataSize &gt; typ.size &#123;<br>			<span class="hljs-comment">// Array allocation. If there are any</span><br>			<span class="hljs-comment">// pointers, GC has to scan to the last</span><br>			<span class="hljs-comment">// element.</span><br>			<span class="hljs-keyword">if</span> typ.ptrdata != <span class="hljs-number">0</span> &#123;<br>				scanSize = dataSize - typ.size + typ.ptrdata<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			scanSize = typ.ptrdata<br>		&#125;<br>		c.scanAlloc += scanSize<br>	&#125;<br><br>	<span class="hljs-comment">// Ensure that the stores above that initialize x to</span><br>	<span class="hljs-comment">// type-safe memory and set the heap bits occur before</span><br>	<span class="hljs-comment">// the caller can make x observable to the garbage</span><br>	<span class="hljs-comment">// collector. Otherwise, on weakly ordered machines,</span><br>	<span class="hljs-comment">// the garbage collector could follow a pointer to x,</span><br>	<span class="hljs-comment">// but see uninitialized memory or stale heap bits.</span><br>	publicationBarrier()<br>	<span class="hljs-comment">// As x and the heap bits are initialized, update</span><br>	<span class="hljs-comment">// freeIndexForScan now so x is seen by the GC</span><br>	<span class="hljs-comment">// (including convervative scan) as an allocated object.</span><br>	<span class="hljs-comment">// While this pointer can&#x27;t escape into user code as a</span><br>	<span class="hljs-comment">// _live_ pointer until we return, conservative scanning</span><br>	<span class="hljs-comment">// may find a dead pointer that happens to point into this</span><br>	<span class="hljs-comment">// object. Delaying this update until now ensures that</span><br>	<span class="hljs-comment">// conservative scanning considers this pointer dead until</span><br>	<span class="hljs-comment">// this point.</span><br>	span.freeIndexForScan = span.freeindex<br><br>	<span class="hljs-comment">// Allocate black during GC.</span><br>	<span class="hljs-comment">// All slots hold nil so no scanning is needed.</span><br>	<span class="hljs-comment">// This may be racing with GC so do it atomically if there can be</span><br>	<span class="hljs-comment">// a race marking the bit.</span><br>	<span class="hljs-keyword">if</span> gcphase != _GCoff &#123;<br>		gcmarknewobject(span, <span class="hljs-type">uintptr</span>(x), size, scanSize)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> raceenabled &#123;<br>		racemalloc(x, size)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> msanenabled &#123;<br>		msanmalloc(x, size)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> asanenabled &#123;<br>		<span class="hljs-comment">// We should only read/write the memory with the size asked by the user.</span><br>		<span class="hljs-comment">// The rest of the allocated memory should be poisoned, so that we can report</span><br>		<span class="hljs-comment">// errors when accessing poisoned memory.</span><br>		<span class="hljs-comment">// The allocated memory is larger than required userSize, it will also include</span><br>		<span class="hljs-comment">// redzone and some other padding bytes.</span><br>		rzBeg := unsafe.Add(x, userSize)<br>		asanpoison(rzBeg, size-userSize)<br>		asanunpoison(x, userSize)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> rate := MemProfileRate; rate &gt; <span class="hljs-number">0</span> &#123;<br>		<span class="hljs-comment">// Note cache c only valid while m acquired; see #47302</span><br>		<span class="hljs-keyword">if</span> rate != <span class="hljs-number">1</span> &amp;&amp; size &lt; c.nextSample &#123;<br>			c.nextSample -= size<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			profilealloc(mp, x, size)<br>		&#125;<br>	&#125;<br>	mp.mallocing = <span class="hljs-number">0</span><br>	releasem(mp)<br><br>	<span class="hljs-comment">// Pointerfree data can be zeroed late in a context where preemption can occur.</span><br>	<span class="hljs-comment">// x will keep the memory alive.</span><br>	<span class="hljs-keyword">if</span> delayedZeroing &#123;<br>		<span class="hljs-keyword">if</span> !noscan &#123;<br>			throw(<span class="hljs-string">&quot;delayed zeroing on data that may contain pointers&quot;</span>)<br>		&#125;<br>		memclrNoHeapPointersChunked(size, x) <span class="hljs-comment">// This is a possible preemption point: see #47302</span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> debug.malloc &#123;<br>		<span class="hljs-keyword">if</span> debug.allocfreetrace != <span class="hljs-number">0</span> &#123;<br>			tracealloc(x, size, typ)<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> inittrace.active &amp;&amp; inittrace.id == getg().goid &#123;<br>			<span class="hljs-comment">// Init functions are executed sequentially in a single goroutine.</span><br>			inittrace.bytes += <span class="hljs-type">uint64</span>(size)<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> assistG != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-comment">// Account for internal fragmentation in the assist</span><br>		<span class="hljs-comment">// debt now that we know it.</span><br>		assistG.gcAssistBytes -= <span class="hljs-type">int64</span>(size - dataSize)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> shouldhelpgc &#123;<br>		<span class="hljs-keyword">if</span> t := (gcTrigger&#123;kind: gcTriggerHeap&#125;); t.test() &#123;<br>			gcStart(t)<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> raceenabled &amp;&amp; noscan &amp;&amp; dataSize &lt; maxTinySize &#123;<br>		<span class="hljs-comment">// Pad tinysize allocations so they are aligned with the end</span><br>		<span class="hljs-comment">// of the tinyalloc region. This ensures that any arithmetic</span><br>		<span class="hljs-comment">// that goes off the top end of the object will be detectable</span><br>		<span class="hljs-comment">// by checkptr (issue 38872).</span><br>		<span class="hljs-comment">// Note that we disable tinyalloc when raceenabled for this to work.</span><br>		<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> This padding is only performed when the race detector</span><br>		<span class="hljs-comment">// is enabled. It would be nice to enable it if any package</span><br>		<span class="hljs-comment">// was compiled with checkptr, but there&#x27;s no easy way to</span><br>		<span class="hljs-comment">// detect that (especially at compile time).</span><br>		<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> enable this padding for all allocations, not just</span><br>		<span class="hljs-comment">// tinyalloc ones. It&#x27;s tricky because of pointer maps.</span><br>		<span class="hljs-comment">// Maybe just all noscan objects?</span><br>		x = add(x, size-dataSize)<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> x<br>&#125;<br></code></pre></td></tr></table></figure>


<h1 id="工具-1"><a href="#工具-1" class="headerlink" title="工具"></a>工具</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs go">Go is a tool <span class="hljs-keyword">for</span> managing Go source code.<br><br>Usage:<br><br>        <span class="hljs-keyword">go</span> &lt;command&gt; [arguments]<br><br>The commands are:<br><br>        bug         start a bug report<br>        build       compile packages and dependencies<br>        clean       remove object files and cached files<br>        doc         show documentation <span class="hljs-keyword">for</span> <span class="hljs-keyword">package</span> or symbol<br>        env         <span class="hljs-built_in">print</span> Go environment information<br>        fix         update packages to use <span class="hljs-built_in">new</span> APIs<br>        fmt         gofmt (reformat) <span class="hljs-keyword">package</span> sources<br>        generate    generate Go files by processing source<br>        get         add dependencies to current module and install them<br>        install     compile and install packages and dependencies<br>        list        list packages or modules<br>        mod         module maintenance<br>        work        workspace maintenance<br>        run         compile and run Go program<br>        test        test packages<br>        tool        run specified <span class="hljs-keyword">go</span> tool<br>        version     <span class="hljs-built_in">print</span> Go version<br>        vet         report likely mistakes in packages<br><br>Use <span class="hljs-string">&quot;go help &lt;command&gt;&quot;</span> <span class="hljs-keyword">for</span> more information about a command.<br><br>Additional help topics:<br><br>        buildconstraint build constraints<br>        buildmode       build modes<br>        c               calling between Go and C<br>        cache           build and test caching<br>        environment     environment variables<br>        filetype        file types<br>        <span class="hljs-keyword">go</span>.mod          the <span class="hljs-keyword">go</span>.mod file<br>        gopath          GOPATH environment variable<br>        gopath-get      legacy GOPATH <span class="hljs-keyword">go</span> get<br>        goproxy         module proxy protocol<br>        importpath      <span class="hljs-keyword">import</span> path syntax<br>        modules         modules, module versions, and more<br>        module-get      module-aware <span class="hljs-keyword">go</span> get<br>        module-auth     module authentication using <span class="hljs-keyword">go</span>.sum<br>        packages        <span class="hljs-keyword">package</span> lists and patterns<br>        private         configuration <span class="hljs-keyword">for</span> downloading non-public code<br>        testflag        testing flags<br>        testfunc        testing functions<br>        vcs             controlling version control with GOVCS<br><br>Use <span class="hljs-string">&quot;go help &lt;topic&gt;&quot;</span> <span class="hljs-keyword">for</span> more information about that topic.<br></code></pre></td></tr></table></figure>


<h2 id="go-build-命令"><a href="#go-build-命令" class="headerlink" title="go build 命令"></a>go build 命令</h2><h2 id="go-clean-命令"><a href="#go-clean-命令" class="headerlink" title="go clean 命令"></a>go clean 命令</h2><h2 id="go-run-命令"><a href="#go-run-命令" class="headerlink" title="go run 命令"></a>go run 命令</h2><h2 id="go-fmt-命令"><a href="#go-fmt-命令" class="headerlink" title="go fmt 命令"></a>go fmt 命令</h2><h2 id="go-install-命令"><a href="#go-install-命令" class="headerlink" title="go install 命令"></a>go install 命令</h2><h2 id="go-get-命令"><a href="#go-get-命令" class="headerlink" title="go get 命令"></a>go get 命令</h2><h2 id="go-generate-命令"><a href="#go-generate-命令" class="headerlink" title="go generate 命令"></a>go generate 命令</h2><h2 id="go-test-命令"><a href="#go-test-命令" class="headerlink" title="go test 命令"></a>go test 命令</h2><h2 id="go-pprof-命令"><a href="#go-pprof-命令" class="headerlink" title="go pprof 命令"></a>go pprof 命令</h2><p>参考：<a target="_blank" rel="noopener" href="https://www.yuque.com/aichihongdouheyumi/blog/serwt6h1lv6wlv86">https://www.yuque.com/aichihongdouheyumi/blog/serwt6h1lv6wlv86</a></p>
<h2 id="go-tool-命令"><a href="#go-tool-命令" class="headerlink" title="go tool 命令"></a>go tool 命令</h2><blockquote>
<p>展示出go相关工具</p>
</blockquote>
<ol>
<li><strong>addr2line</strong></li>
</ol>
<ol start="2">
<li><strong>asm</strong></li>
</ol>
<ol start="3">
<li><strong>buildid</strong></li>
</ol>
<ol start="4">
<li><strong>cgo</strong></li>
</ol>
<ol start="5">
<li><p><strong>compile</strong></p>
</li>
<li><p><strong>cover</strong></p>
</li>
</ol>
<ol start="7">
<li><strong>dist</strong></li>
</ol>
<ol start="8">
<li><strong>doc</strong></li>
</ol>
<ol start="9">
<li><strong>fix</strong></li>
</ol>
<ol start="10">
<li><strong>link</strong></li>
</ol>
<ol start="11">
<li><strong>nm</strong></li>
</ol>
<ol start="12">
<li><p><strong>objdump 反编译工具</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> tool objdump -S main.<span class="hljs-keyword">go</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>pack</strong></p>
</li>
</ol>
<ol start="14">
<li><strong>pprof</strong></li>
</ol>
<ol start="15">
<li><strong>test2json</strong></li>
</ol>
<ol start="16">
<li><strong>trace</strong></li>
</ol>
<ol start="17">
<li><strong>vet</strong></li>
</ol>
<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><blockquote>
<p>通过go mod来管理依赖和创建项目</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">go mod init example/godemo<br></code></pre></td></tr></table></figure>


<h2 id="简单输出"><a href="#简单输出" class="headerlink" title="简单输出"></a>简单输出</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> main<span class="hljs-comment">//必须是main包下才能执行main方法</span><br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;fmt&quot;</span><br><br>func <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>	fmt.Println(<span class="hljs-string">&quot;hello&quot;</span>)<br>&#125;<br><br></code></pre></td></tr></table></figure>


<h2 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">go mod tidy<br></code></pre></td></tr></table></figure>
<p>下载失败配置代理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">go env -w GO111MODULE=<span class="hljs-string">&quot;on&quot;</span><br>go env -w GOPROXY=https:<span class="hljs-comment">//goproxy.cn,direct</span><br></code></pre></td></tr></table></figure>


<h2 id="计算函数运行时间"><a href="#计算函数运行时间" class="headerlink" title="计算函数运行时间"></a>计算函数运行时间</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span> &#123;<br>	start := time.Now() <span class="hljs-comment">// 获取当前时间</span><br>	sum := <span class="hljs-number">0</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000000</span>; i++ &#123;<br>		sum++<br>	&#125;<br>	elapsed := time.Since(start)<br>	fmt.Println(<span class="hljs-string">&quot;该函数执行完成耗时：&quot;</span>, elapsed)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	test()<br>&#125;<br></code></pre></td></tr></table></figure>


<h1 id="规范"><a href="#规范" class="headerlink" title="规范"></a>规范</h1><p><a target="_blank" rel="noopener" href="https://github.com/xxjwxc/uber_go_guide_cn">https://github.com/xxjwxc/uber_go_guide_cn</a></p>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p>安装：<a target="_blank" rel="noopener" href="https://go.dev/doc/install">https://go.dev/doc/install</a><br>教程：<a target="_blank" rel="noopener" href="http://c.biancheng.net/golang/">http://c.biancheng.net/golang/</a><br>教程：<a target="_blank" rel="noopener" href="https://pkg.go.dev/">https://pkg.go.dev/</a></p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Golang/" class="category-chain-item">Golang</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Golang/">#Golang</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Golang篇-Golang学习笔记</div>
      <div>https://mikeygithub.github.io/2019/05/18/yuque/fabxez/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Mikey</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2019年5月18日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/05/23/yuque/qu0uv5/" title="Golang篇-Gin学习笔记">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Golang篇-Gin学习笔记</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/07/05/yuque/sgxgae/" title="Linux篇-Centos安装图形化界面">
                        <span class="hidden-mobile">Linux篇-Centos安装图形化界面</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'mikeygithub/commit-utterance');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.13.10/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});
  });
</script>




  <!-- Custom -->
  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="https://octodex.github.com/images/jetpacktocat.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       Copyright © 麦奇 Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> and <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> core on github page 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      桂ICP备2020009931号-1
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=2020009931"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>桂公网安备2020009931号</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?74301a15e5497361e93588eeee69f4b2";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        MathJax = {
          tex    : {
            inlineMath: { '[+]': [['$', '$']] }
          },
          loader : {
            load: ['ui/lazy']
          },
          options: {
            renderActions: {
              findScript    : [10, doc => {
                document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                  const display = !!node.type.match(/; *mode=display/);
                  const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                  const text = document.createTextNode('');
                  node.parentNode.replaceChild(text, node);
                  math.start = { node: text, delim: '', n: 0 };
                  math.end = { node: text, delim: '', n: 0 };
                  doc.math.push(math);
                });
              }, '', false],
              insertedScript: [200, () => {
                document.querySelectorAll('mjx-container').forEach(node => {
                  let target = node.parentNode;
                  if (target.nodeName.toLowerCase() === 'li') {
                    target.parentNode.classList.add('has-jax');
                  }
                });
              }, '', false]
            }
          }
        };
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.0/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
