

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer"/>
  <link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/favicon.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Mikey">
  <meta name="keywords" content="">
  
    <meta name="description" content="简介 spring 是一款轻量级的框架，主要包含的功能有AOP、IOC（DI），包含的模块如下  123456789101112131415161718spring├── aopalliance-1.0.jar├── commons-logging-1.2.jar├── spring-aop-5.2.3.RELEASE.jar├── spring-aspects-5.2.3.RELEASE.ja">
<meta property="og:type" content="article">
<meta property="og:title" content="源码学习-Spring 源码分析">
<meta property="og:url" content="https://mikeygithub.github.io/2022/02/28/yuque/gx3k97/index.html">
<meta property="og:site_name" content="麦奇">
<meta property="og:description" content="简介 spring 是一款轻量级的框架，主要包含的功能有AOP、IOC（DI），包含的模块如下  123456789101112131415161718spring├── aopalliance-1.0.jar├── commons-logging-1.2.jar├── spring-aop-5.2.3.RELEASE.jar├── spring-aspects-5.2.3.RELEASE.ja">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/2630542/1650552752267-0706aaa5-ca4c-4138-ac9e-090cf4ba73c8.png">
<meta property="article:published_time" content="2022-02-28T09:24:22.000Z">
<meta property="article:modified_time" content="2023-02-14T12:53:19.641Z">
<meta property="article:author" content="Mikey">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2022/png/2630542/1650552752267-0706aaa5-ca4c-4138-ac9e-090cf4ba73c8.png">
  
  
<!--    <meta name="referrer" content="no-referrer-when-downgrade">-->
  
  
  <title>源码学习-Spring 源码分析 - 麦奇</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"mikeygithub.github.io","root":"/","version":"1.9.1","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":200}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"74301a15e5497361e93588eeee69f4b2","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="麦奇" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>麦奇</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/photo/">
                <i class="iconfont icon-image"></i>
                照片
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/music/">
                <i class="iconfont icon-music"></i>
                音乐
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                RSS
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="源码学习-Spring 源码分析"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Mikey
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-02-28 17:24" pubdate>
          2022年2月28日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          78k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          647 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">源码学习-Spring 源码分析</h1>
            
            <div class="markdown-body">
              
              <p><img src="https://cdn.nlark.com/yuque/0/2022/png/2630542/1650552752267-0706aaa5-ca4c-4138-ac9e-090cf4ba73c8.png#clientId=uc6afc5ff-1c44-4&errorMessage=unknown%20error&from=paste&height=199&id=ud3a6f044&name=image.png&originHeight=397&originWidth=750&originalType=binary&ratio=1&rotation=0&showTitle=false&size=56032&status=error&style=none&taskId=u0562a7bc-a768-439d-a09c-dbfa5995235&title=&width=375" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote>
<p>spring 是一款轻量级的框架，主要包含的功能有AOP、IOC（DI），包含的模块如下</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs stylus">spring<br>├── aopalliance-<span class="hljs-number">1.0</span><span class="hljs-selector-class">.jar</span><br>├── commons-logging-<span class="hljs-number">1.2</span><span class="hljs-selector-class">.jar</span><br>├── spring-aop-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-aspects-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-beans-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-context-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-context-support-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-core-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-expression-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-instrument-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-jdbc-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-jms-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-messaging-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-orm-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-oxm-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>├── spring-test-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span><span class="hljs-selector-class">.jar</span><br>└── spring-tx-<span class="hljs-number">5.2</span>.<span class="hljs-number">3</span><span class="hljs-selector-class">.RELEASE</span>.jar<br></code></pre></td></tr></table></figure>

<h1 id="加载流程分析"><a href="#加载流程分析" class="headerlink" title="加载流程分析"></a>加载流程分析</h1><h2 id="1-1-新建立maven项目"><a href="#1-1-新建立maven项目" class="headerlink" title="1.1 新建立maven项目"></a>1.1 新建立maven项目</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">beans</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;messageService&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.analyxe.service.impl.MessageServiceImpl&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MessageService</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MessageService</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;get message ......&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;MESSAGE&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">//上下文</span><br>        ClassPathXmlApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">&quot;classpath:applicationContext.xml&quot;</span>);<br>        <span class="hljs-comment">//获取bean</span><br>        MessageService messageService = (MessageService) context.getBean(<span class="hljs-string">&quot;messageService&quot;</span>);<br>        <span class="hljs-comment">//bean调用</span><br>        String message = messageService.getMessage();<br>        System.out.println(message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/__mermaid_v3/fb63c83efea5ec798ea0d21329da802a.svg#lake_card_v2=eyJ0eXBlIjoibWVybWFpZCIsImNvZGUiOiJncmFwaCBCVDtcbkEoRmlsZVN5c3RlbVhtbEFwcGxpY2F0aW9uQ29udGV4dCktLT5DXG5CKEZpbGVTeXN0ZW1YbWxBcHBsaWNhdGlvbkNvbnRleHQpLS0-QyhBYnN0cmFjdFhtbEFwcGxpY2F0aW9uQ29udGV4dClcbkMtLT5EKEFic3RyYWN0UmVmcmVzaGFibGVDb25maWdBcHBsaWNhdGlvbkNvbnRleHQpXG5FKEFubm90YXRpb25Db25maWdBcHBsaWNhdGlvbkNvbnRleHQpLS0-RihHZW5lcmljQXBwbGljYXRpb25DY250ZXh0KVxuRC0tPkcoQWJzdHJhY3RSZWZyZXNoYWJsZUFwcGxpY2F0aW9uQ29udGV4dClcbkctLT5IXG5GLS0-SChBYnN0cmFjdEFwcGxpY2F0aW9uQ29udGV4dClcbkgtLT5JKENvbmZpZ3VyYWJsZUFwcGxpY2F0aW9uQ29udGV4dOaOpeWPoylcbkktLT5KKEFwcGxpY2F0aW9uQ29udGV4dOaOpeWPoylcblxuc3R5bGUgSiBmaWxsOiBncmVlbiwgc3Ryb2tlOiAjMzMzLCBzdHJva2Utd2lkdGg6IDRweDtcbnN0eWxlIEkgZmlsbDogZ3JlZW4sIHN0cm9rZTogIzMzMywgc3Ryb2tlLXdpZHRoOiA0cHg7IiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fbWVybWFpZF92My9mYjYzYzgzZWZlYTVlYzc5OGVhMGQyMTMyOWRhODAyYS5zdmciLCJpZCI6IjM2M2E0ZTllIiwiY2FyZCI6ImRpYWdyYW0ifQ==" srcset="/img/loading.gif" lazyload></p>
<h2 id="1-2-代码跟踪"><a href="#1-2-代码跟踪" class="headerlink" title="1.2 代码跟踪"></a>1.2 代码跟踪</h2><p>下面我们一步一步来代码跟踪</p>
<h3 id="1-2-1-调用应用上下文构造方法"><a href="#1-2-1-调用应用上下文构造方法" class="headerlink" title="1.2.1 调用应用上下文构造方法"></a>1.2.1 调用应用上下文构造方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//因为我们使用的是xml方式加载bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassPathXmlApplicationContext</span><span class="hljs-params">(String configLocation)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>    <span class="hljs-comment">//调用构造器初始化</span><br>    <span class="hljs-keyword">this</span>(<span class="hljs-keyword">new</span> String[]&#123;configLocation&#125;, <span class="hljs-keyword">true</span>, (ApplicationContext)<span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-2-2-构造方法"><a href="#1-2-2-构造方法" class="headerlink" title="1.2.2 构造方法"></a>1.2.2 构造方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//构造方法</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassPathXmlApplicationContext</span><span class="hljs-params">(String[] configLocations, <span class="hljs-keyword">boolean</span> refresh, <span class="hljs-meta">@Nullable</span> ApplicationContext parent)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>    <span class="hljs-keyword">super</span>(parent);<span class="hljs-comment">//1.调用父类AbstractXmlApplicationContext(看上图)构造方法</span><br>    <span class="hljs-keyword">this</span>.setConfigLocations(configLocations);<span class="hljs-comment">//2.设置配置文件位置</span><br>    <span class="hljs-keyword">if</span> (refresh) &#123;<span class="hljs-comment">//是否刷新容器，默认传进来为true</span><br>        <span class="hljs-keyword">this</span>.refresh();<span class="hljs-comment">//3.刷新容器(核心方法这个很重要下面会详细讲)</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>3.再看看其调用ClassPathXmlApplicationContext父类构造方法具体是什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractXmlApplicationContext</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ApplicationContext parent)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>(parent);<span class="hljs-comment">//调用父类AbstractRefreshableConfigApplicationContext(看上图)构造方法</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>4.再看看其调用AbstractXmlApplicationContext父类构造方法具体是什么，它又调用父类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractRefreshableApplicationContext</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ApplicationContext parent)</span> </span>&#123;<br>    <span class="hljs-keyword">super</span>(parent);<span class="hljs-comment">//调用父类AbstractApplicationContext(看上图)构造方法</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>5.我们瞧瞧这个AbstractApplicationContext的构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractApplicationContext</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ApplicationContext parent)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>();<span class="hljs-comment">//构造方法设置资源模式解析器</span><br>    <span class="hljs-keyword">this</span>.setParent(parent);<span class="hljs-comment">//设置ApplicationContext(顶层接口)</span><br>&#125;<br><span class="hljs-comment">//设置资源模式解析器</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractApplicationContext</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">this</span>.resourcePatternResolver = getResourcePatternResolver();<br>&#125;<br><span class="hljs-comment">//返回设置资源模式解析器PathMatchingResourcePatternResolver</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> ResourcePatternResolver <span class="hljs-title">getResourcePatternResolver</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> PathMatchingResourcePatternResolver(<span class="hljs-keyword">this</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>6.设置AbstractApplicationContext环境配置信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setParent</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ApplicationContext parent)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.parent = parent;<span class="hljs-comment">//设置ApplicationContext</span><br>    <span class="hljs-keyword">if</span> (parent != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//如果父级ApplicationContext为空则</span><br>        Environment parentEnvironment = parent.getEnvironment();<span class="hljs-comment">//获取父级环境</span><br>        <span class="hljs-keyword">if</span> (parentEnvironment <span class="hljs-keyword">instanceof</span> ConfigurableEnvironment) &#123;<span class="hljs-comment">//如果父级环境是ConfigurableEnvironment类型</span><br>            <span class="hljs-keyword">this</span>.getEnvironment().merge((ConfigurableEnvironment)parentEnvironment);<span class="hljs-comment">//合并配置信息到子类环境</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-2-7-设置加载配置文件"><a href="#1-2-7-设置加载配置文件" class="headerlink" title="1.2.7 设置加载配置文件"></a>1.2.7 设置加载配置文件</h3><blockquote>
<p>处理加载配置文件路径，见1.2.2中的2</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setConfigLocations</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String... locations)</span> </span>&#123;<span class="hljs-comment">//可配置多个路径</span><br>	<span class="hljs-keyword">if</span> (locations != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//如果不为空则进行加载</span><br>		Assert.noNullElements(locations, <span class="hljs-string">&quot;Config locations must not be null&quot;</span>);<br>		<span class="hljs-keyword">this</span>.configLocations = <span class="hljs-keyword">new</span> String[locations.length];<br>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; locations.length; i++) &#123;<br>			<span class="hljs-keyword">this</span>.configLocations[i] = resolvePath(locations[i]).trim();<span class="hljs-comment">//</span><br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">this</span>.configLocations = <span class="hljs-keyword">null</span>;<br>	&#125;<br>&#125;<br><span class="hljs-comment">//处理路径</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">resolvePath</span><span class="hljs-params">(String path)</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> getEnvironment().resolveRequiredPlaceholders(path);<span class="hljs-comment">//主要是对输入的路径进行验证和替换$&#123;&#125;占位符等</span><br>&#125;<br><span class="hljs-comment">//获取配置的环境信息</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> ConfigurableEnvironment <span class="hljs-title">getEnvironment</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.environment == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//如果没有进行配置则默认创建一个StandardEnvironment</span><br>		<span class="hljs-keyword">this</span>.environment = createEnvironment();<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.environment;<br>&#125;<br><span class="hljs-comment">//默认创建一个StandardEnvironment</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> ConfigurableEnvironment <span class="hljs-title">createEnvironment</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> StandardEnvironment();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-2-8-刷新容器（核心）"><a href="#1-2-8-刷新容器（核心）" class="headerlink" title="1.2.8 刷新容器（核心）"></a>1.2.8 刷新容器（核心）</h3><blockquote>
<p>判断是否需要刷新容器，见1.2.2中的 3</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException </span>&#123;<br>	<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.startupShutdownMonitor) &#123;<span class="hljs-comment">//加锁包装单一线程执行</span><br>		<span class="hljs-comment">// 1.准备刷新容器</span><br>		prepareRefresh();<br>		<span class="hljs-comment">// 2.告诉子类刷新内部beanFactory（创建beanfactory）</span><br>		ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();<br>		<span class="hljs-comment">// 3.准备beanFactory以便在容器中使用。</span><br>		prepareBeanFactory(beanFactory);<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-comment">// 4.Allows post-processing of the bean factory in context subclasses.</span><br>			postProcessBeanFactory(beanFactory);<br>			<span class="hljs-comment">// 5.Invoke factory processors registered as beans in the context.</span><br>			invokeBeanFactoryPostProcessors(beanFactory);<br>			<span class="hljs-comment">// 6.Register bean processors that intercept bean creation.</span><br>			registerBeanPostProcessors(beanFactory);<br>			<span class="hljs-comment">// 7.Initialize message source for this context.</span><br>			initMessageSource();<br>			<span class="hljs-comment">// 8.Initialize event multicaster for this context.</span><br>			initApplicationEventMulticaster();<br>			<span class="hljs-comment">// 9.初始化特定容器子类中的其他特殊bean.</span><br>			onRefresh();<br>			<span class="hljs-comment">// 10.检查监听器并注册</span><br>			registerListeners();<br>			<span class="hljs-comment">// 11.实例化所有的 singletons bean (除了lazy-init外).</span><br>			finishBeanFactoryInitialization(beanFactory);<br>			<span class="hljs-comment">// 12.最后容器构造完成发布其事件</span><br>			finishRefresh();<br>		&#125;<span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>			<span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;<br>				logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - cancelling refresh attempt: &quot;</span> + ex);<br>			&#125;<br>			<span class="hljs-comment">// Destroy already created singletons to avoid dangling resources.</span><br>			destroyBeans();<br>			<span class="hljs-comment">// Reset &#x27;active&#x27; flag.</span><br>			cancelRefresh(ex);<br>			<span class="hljs-comment">// Propagate exception to caller.</span><br>			<span class="hljs-keyword">throw</span> ex;<br>		&#125;<br>		<span class="hljs-keyword">finally</span> &#123;<br>			<span class="hljs-comment">// Reset common introspection caches in Spring&#x27;s core, since we</span><br>			<span class="hljs-comment">// might not ever need metadata for singleton beans anymore...</span><br>			resetCommonCaches();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-1-prepareRefresh-（预刷新处理）"><a href="#1-2-8-1-prepareRefresh-（预刷新处理）" class="headerlink" title="1.2.8.1 prepareRefresh （预刷新处理）"></a>1.2.8.1 prepareRefresh （预刷新处理）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareRefresh</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-comment">// 切换到激活状态</span><br>	<span class="hljs-keyword">this</span>.startupDate = System.currentTimeMillis();<br>	<span class="hljs-keyword">this</span>.closed.set(<span class="hljs-keyword">false</span>);<br>	<span class="hljs-keyword">this</span>.active.set(<span class="hljs-keyword">true</span>);<br>	<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>			logger.trace(<span class="hljs-string">&quot;Refreshing &quot;</span> + <span class="hljs-keyword">this</span>);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			logger.debug(<span class="hljs-string">&quot;Refreshing &quot;</span> + getDisplayName());<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 在上下文环境中初始化任何占位符属性源。(默认不做操作，只有在web环境下更新环境)</span><br>	initPropertySources();<br>	<span class="hljs-comment">//验证所有标记为需要的属性是否可解决</span><br>	getEnvironment().validateRequiredProperties();<br>	<span class="hljs-comment">// 存储预刷新应用程序侦听器</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.earlyApplicationListeners == <span class="hljs-keyword">null</span>) &#123;<br>		<span class="hljs-keyword">this</span>.earlyApplicationListeners = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(<span class="hljs-keyword">this</span>.applicationListeners);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">// 将本地应用程序侦听器重置为预刷新状态</span><br>		<span class="hljs-keyword">this</span>.applicationListeners.clear();<br>		<span class="hljs-keyword">this</span>.applicationListeners.addAll(<span class="hljs-keyword">this</span>.earlyApplicationListeners);<br>	&#125;<br>	<span class="hljs-comment">//允许收集早期应用程序事件，将在multicaster可用后发布</span><br>	<span class="hljs-keyword">this</span>.earlyApplicationEvents = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-2-obtainFreshBeanFactory-（获取最新BeanFactory）"><a href="#1-2-8-2-obtainFreshBeanFactory-（获取最新BeanFactory）" class="headerlink" title="1.2.8.2 obtainFreshBeanFactory  （获取最新BeanFactory）"></a>1.2.8.2 obtainFreshBeanFactory  （获取最新BeanFactory）</h4><blockquote>
<p>1.刷新bean工厂   2.返回bean工厂</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> ConfigurableListableBeanFactory <span class="hljs-title">obtainFreshBeanFactory</span><span class="hljs-params">()</span> </span>&#123;<br>	refreshBeanFactory();<span class="hljs-comment">//1.刷新bean工厂</span><br>	<span class="hljs-keyword">return</span> getBeanFactory();<span class="hljs-comment">//2.返回bean工厂</span><br>&#125;<br><span class="hljs-comment">//1.刷新bean工厂</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refreshBeanFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>	<span class="hljs-keyword">if</span> (hasBeanFactory()) &#123;<span class="hljs-comment">//如果已经存在bean工厂则进行关闭</span><br>		destroyBeans();<span class="hljs-comment">//销毁beans</span><br>		closeBeanFactory();<span class="hljs-comment">//关闭bean工厂</span><br>	&#125;<br>	<span class="hljs-keyword">try</span> &#123;<br>		DefaultListableBeanFactory beanFactory = createBeanFactory();<span class="hljs-comment">//创建bean工厂</span><br>		beanFactory.setSerializationId(getId());<span class="hljs-comment">//设置beanFactory序列化id</span><br>		customizeBeanFactory(beanFactory);<span class="hljs-comment">//自定义bean工厂</span><br>		loadBeanDefinitions(beanFactory);<span class="hljs-comment">//加载bean定义</span><br>		<span class="hljs-keyword">this</span>.beanFactory = beanFactory;<span class="hljs-comment">//设置最新bean工厂到当前上下文</span><br>	&#125;<br>	<span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationContextException(<span class="hljs-string">&quot;I/O error parsing bean definition source for &quot;</span> + getDisplayName(), ex);<br>	&#125;<br>&#125;<br><span class="hljs-comment">//2.返回bean工厂</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ConfigurableListableBeanFactory <span class="hljs-title">getBeanFactory</span><span class="hljs-params">()</span> </span>&#123;<br>	DefaultListableBeanFactory beanFactory = <span class="hljs-keyword">this</span>.beanFactory;<br>	<span class="hljs-keyword">if</span> (beanFactory == <span class="hljs-keyword">null</span>) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;BeanFactory not initialized or already closed - call &#x27;refresh&#x27; before accessing beans via the ApplicationContext&quot;</span>);<br>	&#125;<br>	<span class="hljs-keyword">return</span> beanFactory;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>1.刷新bean工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refreshBeanFactory</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>	<span class="hljs-keyword">if</span> (hasBeanFactory()) &#123;<span class="hljs-comment">//如果已经存在bean工厂则进行关闭</span><br>		destroyBeans();<span class="hljs-comment">//销毁beans</span><br>		closeBeanFactory();<span class="hljs-comment">//关闭bean工厂</span><br>	&#125;<br>	<span class="hljs-keyword">try</span> &#123;<br>		<span class="hljs-comment">//为此上下文创建一个内部bean工厂。</span><br>		<span class="hljs-comment">//为每次refresh尝试调用。</span><br>		<span class="hljs-comment">//&lt;默认实现会创建一个org.springframework.beans.factory.support.DefaultListableBeanFactory</span><br>		<span class="hljs-comment">//使用getInternalParentBeanFactory</span><br>		<span class="hljs-comment">//上下文的父对象作为父bean工厂。可以在子类中重写，</span><br>		<span class="hljs-comment">//例如，自定义DefaultListableBeanFactory的设置。</span><br>		<span class="hljs-comment">//返回此上下文的bean工厂</span><br>		DefaultListableBeanFactory beanFactory = createBeanFactory();<span class="hljs-comment">//创建bean工厂</span><br>		beanFactory.setSerializationId(getId());<span class="hljs-comment">//设置beanFactory序列化id</span><br>		customizeBeanFactory(beanFactory);<span class="hljs-comment">//自定义bean工厂</span><br>		loadBeanDefinitions(beanFactory);<span class="hljs-comment">//加载bean定义</span><br>		<span class="hljs-keyword">this</span>.beanFactory = beanFactory;<span class="hljs-comment">//设置最新bean工厂到当前上下文</span><br>	&#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ApplicationContextException(<span class="hljs-string">&quot;I/O error parsing bean definition source for &quot;</span> + getDisplayName(), ex);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>创建默认的bean工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> DefaultListableBeanFactory <span class="hljs-title">createBeanFactory</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultListableBeanFactory(getInternalParentBeanFactory());<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">protected</span> BeanFactory <span class="hljs-title">getInternalParentBeanFactory</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> (getParent() <span class="hljs-keyword">instanceof</span> ConfigurableApplicationContext ? ((ConfigurableApplicationContext) getParent()).getBeanFactory() : getParent());<br>&#125;<br></code></pre></td></tr></table></figure>
<p>默认beanFactory（DefaultListableBeanFactory）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//构造方法</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DefaultListableBeanFactory</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> BeanFactory parentBeanFactory)</span> </span>&#123;<br>	<span class="hljs-keyword">super</span>(parentBeanFactory);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>设置排查自动注入的接口和实例生成策略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractAutowireCapableBeanFactory</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> BeanFactory parentBeanFactory)</span> </span>&#123;<br>	<span class="hljs-keyword">this</span>();<br>	setParentBeanFactory(parentBeanFactory);<br>&#125;<br><span class="hljs-comment">//构造器</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractAutowireCapableBeanFactory</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-keyword">super</span>();<br>    <span class="hljs-comment">//忽略自动关联的给定依赖接口。通常会被应用程序上下文用来注册通过其他方式解决的依赖关系，如BeanFactory通过BeanFactoryAware或ApplicationContext通过ApplicationContextAware。</span><br>    <span class="hljs-comment">//默认情况下，仅忽略BeanFactoryAware接口。对于要忽略的其他类型，请为每个类型调用此方法。</span><br>	ignoreDependencyInterface(BeanNameAware.class);<br>	ignoreDependencyInterface(BeanFactoryAware.class);<br>	ignoreDependencyInterface(BeanClassLoaderAware.class);<br>    <span class="hljs-comment">//设置实例化策略</span><br>	<span class="hljs-keyword">if</span> (NativeDetector.inNativeImage()) &#123;<br>		<span class="hljs-keyword">this</span>.instantiationStrategy = <span class="hljs-keyword">new</span> SimpleInstantiationStrategy();<span class="hljs-comment">//简单实例化策略</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">this</span>.instantiationStrategy = <span class="hljs-keyword">new</span> CglibSubclassingInstantiationStrategy();<span class="hljs-comment">//使用cglib子类实例化策略</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/2630542/1650716998753-420acd24-36cd-4608-b10c-2f69c16d5215.png#clientId=ue9cf72ab-590b-4&errorMessage=unknown%20error&from=paste&height=917&id=u51035d76&name=image.png&originHeight=1834&originWidth=3024&originalType=binary&ratio=1&rotation=0&showTitle=false&size=349831&status=error&style=none&taskId=u570cfb2d-ef43-441e-9282-37caf4e2241&title=&width=1512" srcset="/img/loading.gif" lazyload alt="image.png"><br>设置父类bean工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setParentBeanFactory</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> BeanFactory parentBeanFactory)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.parentBeanFactory != <span class="hljs-keyword">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.parentBeanFactory != parentBeanFactory) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Already associated with parent BeanFactory: &quot;</span> + <span class="hljs-keyword">this</span>.parentBeanFactory);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == parentBeanFactory) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Cannot set parent bean factory to self&quot;</span>);<br>	&#125;<br>	<span class="hljs-keyword">this</span>.parentBeanFactory = parentBeanFactory;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>此时beanFactory完成初始化</p>
<h4 id="1-2-8-3-customizeBeanFactory（自定义bean工厂）"><a href="#1-2-8-3-customizeBeanFactory（自定义bean工厂）" class="headerlink" title="1.2.8.3 customizeBeanFactory（自定义bean工厂）"></a>1.2.8.3 customizeBeanFactory（自定义bean工厂）</h4><blockquote>
<p>在Spring中支持我们自定义beanFactory</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">customizeBeanFactory</span><span class="hljs-params">(DefaultListableBeanFactory beanFactory)</span> </span>&#123;<br>    <span class="hljs-comment">//是否允许覆盖</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.allowBeanDefinitionOverriding != <span class="hljs-keyword">null</span>) &#123;<br>		beanFactory.setAllowBeanDefinitionOverriding(<span class="hljs-keyword">this</span>.allowBeanDefinitionOverriding);<br>	&#125;<br>    <span class="hljs-comment">//设置允许循环引用</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.allowCircularReferences != <span class="hljs-keyword">null</span>) &#123;<br>		beanFactory.setAllowCircularReferences(<span class="hljs-keyword">this</span>.allowCircularReferences);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-4-loadBeanDefinitions（加载bean定义）"><a href="#1-2-8-4-loadBeanDefinitions（加载bean定义）" class="headerlink" title="1.2.8.4 loadBeanDefinitions（加载bean定义）"></a>1.2.8.4 loadBeanDefinitions（加载bean定义）</h4><blockquote>
<p>1.当前我们使用的是xml的方式在类路径下加载，所以会使用的加载器是 </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">loadBeanDefinitions</span><span class="hljs-params">(DefaultListableBeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException, IOException </span>&#123;<br>	<span class="hljs-comment">// 为给定BeanFactory创建新的XmlBeanDefinitionReader。</span><br>	XmlBeanDefinitionReader beanDefinitionReader = <span class="hljs-keyword">new</span> XmlBeanDefinitionReader(beanFactory);<br>    <span class="hljs-comment">//使用此上下文的资源加载环境</span><br>	beanDefinitionReader.setEnvironment(<span class="hljs-keyword">this</span>.getEnvironment());<br>	beanDefinitionReader.setResourceLoader(<span class="hljs-keyword">this</span>);<br>	beanDefinitionReader.setEntityResolver(<span class="hljs-keyword">new</span> ResourceEntityResolver(<span class="hljs-keyword">this</span>));<br>	<span class="hljs-comment">//允许子类提供读取器的自定义初始化，然后继续加载bean定义。</span><br>	initBeanDefinitionReader(beanDefinitionReader);<br>    <span class="hljs-comment">//加载bean定义方法（核心）</span><br>	loadBeanDefinitions(beanDefinitionReader);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>2.使用给定的XmlBeanDefinitionReader加载bean定义。bean工厂的生命周期由refreshBeanFactory处理方法；因此，这个方法应该只是加载和/或注册bean定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">loadBeanDefinitions</span><span class="hljs-params">(XmlBeanDefinitionReader reader)</span> <span class="hljs-keyword">throws</span> BeansException, IOException </span>&#123;<br>	Resource[] configResources = getConfigResources();<br>	<span class="hljs-keyword">if</span> (configResources != <span class="hljs-keyword">null</span>) &#123;<br>		reader.loadBeanDefinitions(configResources);<span class="hljs-comment">//通过Resource加载（本次没有配置Resource）</span><br>	&#125;<br>	String[] configLocations = getConfigLocations();<span class="hljs-comment">//通过配置的路径加载（我们配置的是classpath:applicationContext.xml）</span><br>	<span class="hljs-keyword">if</span> (configLocations != <span class="hljs-keyword">null</span>) &#123;<br>		reader.loadBeanDefinitions(configLocations);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>3.加载配置的文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">loadBeanDefinitions</span><span class="hljs-params">(String... locations)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>&#123;<br>	Assert.notNull(locations, <span class="hljs-string">&quot;Location array must not be null&quot;</span>);<br>	<span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span> (String location : locations) &#123;<br>		count += loadBeanDefinitions(location);<span class="hljs-comment">//加载配置的文件</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> count;<br>&#125;<br><span class="hljs-comment">//实际调用</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">loadBeanDefinitions</span><span class="hljs-params">(String location)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>&#123;<br>	<span class="hljs-keyword">return</span> loadBeanDefinitions(location, <span class="hljs-keyword">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>4.根据resourceLoader匹配加载的路径（类路径和绝对路径）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">loadBeanDefinitions</span><span class="hljs-params">(String location, <span class="hljs-meta">@Nullable</span> Set&lt;Resource&gt; actualResources)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>&#123;<br>		ResourceLoader resourceLoader = getResourceLoader();<br>		<span class="hljs-keyword">if</span> (resourceLoader == <span class="hljs-keyword">null</span>) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(<br>					<span class="hljs-string">&quot;Cannot load bean definitions from location [&quot;</span> + location + <span class="hljs-string">&quot;]: no ResourceLoader available&quot;</span>);<br>		&#125;<br>		<span class="hljs-keyword">if</span> (resourceLoader <span class="hljs-keyword">instanceof</span> ResourcePatternResolver) &#123;<span class="hljs-comment">//类路径下的加载器</span><br>			<span class="hljs-comment">// 资源模式匹配可用</span><br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-comment">//1.加载器的加载方法方法 AbstractApplicationContext、GenericApplicationContext、StubWebApplicationContext、</span><br>				Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location);<br>                <span class="hljs-comment">//2.通过resources进行加载bean</span><br>				<span class="hljs-keyword">int</span> count = loadBeanDefinitions(resources);<br>				<span class="hljs-keyword">if</span> (actualResources != <span class="hljs-keyword">null</span>) &#123;<br>					Collections.addAll(actualResources, resources);<br>				&#125;<br>				<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>					logger.trace(<span class="hljs-string">&quot;Loaded &quot;</span> + count + <span class="hljs-string">&quot; bean definitions from location pattern [&quot;</span> + location + <span class="hljs-string">&quot;]&quot;</span>);<br>				&#125;<br>				<span class="hljs-keyword">return</span> count;<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(<span class="hljs-string">&quot;Could not resolve bean definition resource pattern [&quot;</span> + location + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// 绝对路径加载</span><br>			Resource resource = resourceLoader.getResource(location);<br>			<span class="hljs-keyword">int</span> count = loadBeanDefinitions(resource);<br>			<span class="hljs-keyword">if</span> (actualResources != <span class="hljs-keyword">null</span>) &#123;<br>				actualResources.add(resource);<br>			&#125;<br>			<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>				logger.trace(<span class="hljs-string">&quot;Loaded &quot;</span> + count + <span class="hljs-string">&quot; bean definitions from location [&quot;</span> + location + <span class="hljs-string">&quot;]&quot;</span>);<br>			&#125;<br>			<span class="hljs-keyword">return</span> count;<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>
<p>5.根据输入的路径进行匹配加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Resource[] getResources(String locationPattern) <span class="hljs-keyword">throws</span> IOException &#123;<br>	Assert.notNull(locationPattern, <span class="hljs-string">&quot;Location pattern must not be null&quot;</span>);<br>	<span class="hljs-keyword">if</span> (locationPattern.startsWith(CLASSPATH_ALL_URL_PREFIX)) &#123;<span class="hljs-comment">//&quot;classpath*:&quot;开头（所有类路径下）</span><br>		<span class="hljs-comment">// a class path resource (multiple resources for same name possible)</span><br>		<span class="hljs-keyword">if</span> (getPathMatcher().isPattern(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()))) &#123;<br>			<span class="hljs-comment">// 类路径资源模式</span><br>			<span class="hljs-keyword">return</span> findPathMatchingResources(locationPattern);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// 具有给定名称的所有类路径资源</span><br>			<span class="hljs-keyword">return</span> findAllClassPathResources(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()));<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//否则是指的类路径</span><br>		<span class="hljs-comment">//通常只在这里的前缀后面寻找模式，在Tomcat上只在其“war:”协议的“*/”分隔符后面寻找模式。</span><br>		<span class="hljs-keyword">int</span> prefixEnd = (locationPattern.startsWith(<span class="hljs-string">&quot;war:&quot;</span>) ? locationPattern.indexOf(<span class="hljs-string">&quot;*/&quot;</span>) + <span class="hljs-number">1</span> : locationPattern.indexOf(<span class="hljs-string">&#x27;:&#x27;</span>) + <span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">if</span> (getPathMatcher().isPattern(locationPattern.substring(prefixEnd))) &#123;<br>			<span class="hljs-comment">// 文件格式</span><br>			<span class="hljs-keyword">return</span> findPathMatchingResources(locationPattern);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// 具有给定名称的单个资源</span><br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Resource[] &#123;getResourceLoader().getResource(locationPattern)&#125;;<span class="hljs-comment">//chi&#x27;s</span><br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>6.通过ResourceLoader进行getResource加载资源（注意这里只是根据传入的路径进行构造ClassPathResource对象）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CLASSPATH_URL_PREFIX = <span class="hljs-string">&quot;classpath:&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String FILE_URL_PREFIX = <span class="hljs-string">&quot;file:&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String JAR_URL_PREFIX = <span class="hljs-string">&quot;jar:&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String WAR_URL_PREFIX = <span class="hljs-string">&quot;war:&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_PROTOCOL_FILE = <span class="hljs-string">&quot;file&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_PROTOCOL_JAR = <span class="hljs-string">&quot;jar&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_PROTOCOL_WAR = <span class="hljs-string">&quot;war&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_PROTOCOL_ZIP = <span class="hljs-string">&quot;zip&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_PROTOCOL_WSJAR = <span class="hljs-string">&quot;wsjar&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_PROTOCOL_VFSZIP = <span class="hljs-string">&quot;vfszip&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_PROTOCOL_VFSFILE = <span class="hljs-string">&quot;vfsfile&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_PROTOCOL_VFS = <span class="hljs-string">&quot;vfs&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String JAR_FILE_EXTENSION = <span class="hljs-string">&quot;.jar&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String JAR_URL_SEPARATOR = <span class="hljs-string">&quot;!/&quot;</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String WAR_URL_SEPARATOR = <span class="hljs-string">&quot;*/&quot;</span>;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Resource <span class="hljs-title">getResource</span><span class="hljs-params">(String location)</span> </span>&#123;<span class="hljs-comment">//classpath:applicationContext.xml</span><br>	Assert.notNull(location, <span class="hljs-string">&quot;Location must not be null&quot;</span>);<br>	<span class="hljs-comment">//尝试遍历协议获取</span><br>	<span class="hljs-keyword">for</span> (ProtocolResolver protocolResolver : getProtocolResolvers()) &#123;<br>		Resource resource = protocolResolver.resolve(location, <span class="hljs-keyword">this</span>);<br>		<span class="hljs-keyword">if</span> (resource != <span class="hljs-keyword">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> resource;<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">//否则在本地查找</span><br>	<span class="hljs-keyword">if</span> (location.startsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<span class="hljs-comment">//是否以/开头</span><br>		<span class="hljs-keyword">return</span> getResourceByPath(location);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (location.startsWith(CLASSPATH_URL_PREFIX)) &#123;<span class="hljs-comment">//是否以&quot;classpath:&quot;开头，是则去掉classpath:直接进行加载</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ClassPathResource(location.substring(CLASSPATH_URL_PREFIX.length()), getClassLoader());<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-comment">// Try to parse the location as a URL...</span><br>			URL url = <span class="hljs-keyword">new</span> URL(location);<br>			<span class="hljs-keyword">return</span> (ResourceUtils.isFileURL(url) ? <span class="hljs-keyword">new</span> FileUrlResource(url) : <span class="hljs-keyword">new</span> UrlResource(url));<br>		&#125; <span class="hljs-keyword">catch</span> (MalformedURLException ex) &#123;<br>			<span class="hljs-comment">// No URL -&gt; resolve as resource path.</span><br>			<span class="hljs-keyword">return</span> getResourceByPath(location);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>7.构造的ClassPathResource对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClassPathResource</span><span class="hljs-params">(String path, <span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span> </span>&#123;<br>		Assert.notNull(path, <span class="hljs-string">&quot;Path must not be null&quot;</span>);<br>		String pathToUse = StringUtils.cleanPath(path);<br>		<span class="hljs-keyword">if</span> (pathToUse.startsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<span class="hljs-comment">//去除</span><br>			pathToUse = pathToUse.substring(<span class="hljs-number">1</span>);<br>		&#125;<br>		<span class="hljs-keyword">this</span>.path = pathToUse;<br>		<span class="hljs-keyword">this</span>.classLoader = (classLoader != <span class="hljs-keyword">null</span> ? classLoader : ClassUtils.getDefaultClassLoader());<br>	&#125;<br></code></pre></td></tr></table></figure>
<p>8.回到4-2中通过获取回来的Resource加载bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">loadBeanDefinitions</span><span class="hljs-params">(Resource... resources)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>&#123;<br>	Assert.notNull(resources, <span class="hljs-string">&quot;Resource array must not be null&quot;</span>);<br>	<span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span> (Resource resource : resources) &#123;<br>		count += loadBeanDefinitions(resource);<span class="hljs-comment">//开始加载</span><br>	&#125;<br>	<span class="hljs-keyword">return</span> count;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//我们使用的bean配置方式通过xml配置，所以会使用XmlBeanDefinitionReader来加载</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">loadBeanDefinitions</span><span class="hljs-params">(Resource resource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>&#123;<br>	<span class="hljs-keyword">return</span> loadBeanDefinitions(<span class="hljs-keyword">new</span> EncodedResource(resource));<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">loadBeanDefinitions</span><span class="hljs-params">(EncodedResource encodedResource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>&#123;<br>	Assert.notNull(encodedResource, <span class="hljs-string">&quot;EncodedResource must not be null&quot;</span>);<br>	<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>		logger.trace(<span class="hljs-string">&quot;Loading XML bean definitions from &quot;</span> + encodedResource);<br>	&#125;<br>	<span class="hljs-comment">//通过ThreadLocal获取当前正在加载的资源</span><br>	Set&lt;EncodedResource&gt; currentResources = <span class="hljs-keyword">this</span>.resourcesCurrentlyBeingLoaded.get();<br>    <span class="hljs-comment">//把当前需要加载的Resource加入判断是否已经加载过，如果加载过抛出异常</span><br>	<span class="hljs-keyword">if</span> (!currentResources.add(encodedResource)) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(<span class="hljs-string">&quot;Detected cyclic loading of &quot;</span> + encodedResource + <span class="hljs-string">&quot; - check your import definitions!&quot;</span>);<br>	&#125;<br>	<span class="hljs-comment">//获取文件的输入流</span><br>	<span class="hljs-keyword">try</span> (InputStream inputStream = encodedResource.getResource().getInputStream()) &#123;<br>		InputSource inputSource = <span class="hljs-keyword">new</span> InputSource(inputStream);<br>		<span class="hljs-keyword">if</span> (encodedResource.getEncoding() != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//设置编码</span><br>			inputSource.setEncoding(encodedResource.getEncoding());<br>		&#125;<br>		<span class="hljs-comment">//核心方法（加载bean定义）</span><br>		<span class="hljs-keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());<br>	&#125;<br>	<span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(<span class="hljs-string">&quot;IOException parsing XML document from &quot;</span> + encodedResource.getResource(), ex);<br>	&#125; <span class="hljs-keyword">finally</span> &#123;<br>		currentResources.remove(encodedResource);<br>		<span class="hljs-keyword">if</span> (currentResources.isEmpty()) &#123;<br>			<span class="hljs-keyword">this</span>.resourcesCurrentlyBeingLoaded.remove();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>9.SAX解析XML文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-title">doLoadBeanDefinitions</span><span class="hljs-params">(InputSource inputSource, Resource resource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>&#123;<br>	<span class="hljs-keyword">try</span> &#123;<br>		<span class="hljs-comment">//1.核心方法（SAX进行解析XML）</span><br>		Document doc = doLoadDocument(inputSource, resource);<br>		<span class="hljs-comment">//2.核心方法（注册bean）</span><br>		<span class="hljs-keyword">int</span> count = registerBeanDefinitions(doc, resource);<br>		<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>			logger.debug(<span class="hljs-string">&quot;Loaded &quot;</span> + count + <span class="hljs-string">&quot; bean definitions from &quot;</span> + resource);<br>		&#125;<br>		<span class="hljs-keyword">return</span> count;<br>	&#125; <span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br>		<span class="hljs-keyword">throw</span> ex;<br>	&#125; <span class="hljs-keyword">catch</span> (SAXParseException ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> XmlBeanDefinitionStoreException(resource.getDescription(), <span class="hljs-string">&quot;Line &quot;</span> + ex.getLineNumber() + <span class="hljs-string">&quot; in XML document from &quot;</span> + resource + <span class="hljs-string">&quot; is invalid&quot;</span>, ex);<br>	&#125; <span class="hljs-keyword">catch</span> (SAXException ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> XmlBeanDefinitionStoreException(resource.getDescription(), <span class="hljs-string">&quot;XML document from &quot;</span> + resource + <span class="hljs-string">&quot; is invalid&quot;</span>, ex);<br>	&#125; <span class="hljs-keyword">catch</span> (ParserConfigurationException ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(resource.getDescription(), <span class="hljs-string">&quot;Parser configuration exception parsing XML from &quot;</span> + resource, ex);<br>	&#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(resource.getDescription(), <span class="hljs-string">&quot;IOException parsing XML document from &quot;</span> + resource, ex);<br>	&#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(resource.getDescription(), <span class="hljs-string">&quot;Unexpected exception parsing XML document from &quot;</span> + resource, ex);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>10.注册Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">registerBeanDefinitions</span><span class="hljs-params">(Document doc, Resource resource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>&#123;<br>	BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();<br>	<span class="hljs-keyword">int</span> countBefore = getRegistry().getBeanDefinitionCount();<br>    <span class="hljs-comment">//核心方法（注册bean）</span><br>	documentReader.registerBeanDefinitions(doc, createReaderContext(resource));<br>	<span class="hljs-keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanDefinitions</span><span class="hljs-params">(Document doc, XmlReaderContext readerContext)</span> </span>&#123;<br>	<span class="hljs-keyword">this</span>.readerContext = readerContext;<br>    <span class="hljs-comment">//注册bean定义</span><br>	doRegisterBeanDefinitions(doc.getDocumentElement());<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doRegisterBeanDefinitions</span><span class="hljs-params">(Element root)</span> </span>&#123;<br>	<span class="hljs-comment">// Any nested &lt;beans&gt; elements will cause recursion in this method. In</span><br>	<span class="hljs-comment">// order to propagate and preserve &lt;beans&gt; default-* attributes correctly,</span><br>	<span class="hljs-comment">// keep track of the current (parent) delegate, which may be null. Create</span><br>	<span class="hljs-comment">// the new (child) delegate with a reference to the parent for fallback purposes,</span><br>	<span class="hljs-comment">// then ultimately reset this.delegate back to its original (parent) reference.</span><br>	<span class="hljs-comment">// this behavior emulates a stack of delegates without actually necessitating one.</span><br>	BeanDefinitionParserDelegate parent = <span class="hljs-keyword">this</span>.delegate;<br>    <span class="hljs-comment">//创建一个Bean定义解析器委托</span><br>	<span class="hljs-keyword">this</span>.delegate = createDelegate(getReaderContext(), root, parent);<br>    <span class="hljs-comment">//确定给定节点是否指示默认名称空间</span><br>    <span class="hljs-comment">//主要判断xml文件是否符号 SPR-12458 规范</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.delegate.isDefaultNamespace(root)) &#123;<br>		String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);<br>		<span class="hljs-keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;<br>			String[] specifiedProfiles = StringUtils.tokenizeToStringArray(profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);<br>			<span class="hljs-comment">// We cannot use Profiles.of(...) since profile expressions are not supported</span><br>			<span class="hljs-comment">// in XML config. See SPR-12458 for details.</span><br>			<span class="hljs-keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;<br>				<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>					logger.debug(<span class="hljs-string">&quot;Skipped XML bean definition file due to specified profiles [&quot;</span> + profileSpec + <span class="hljs-string">&quot;] not matching: &quot;</span> + getReaderContext().getResource());<br>				&#125;<br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>		&#125;<br>	&#125;<br>	preProcessXml(root);<span class="hljs-comment">//前置处理xml（在DefaultBeanDefinitionDocumentReader）默认不做什么操作</span><br>	parseBeanDefinitions(root, <span class="hljs-keyword">this</span>.delegate);<span class="hljs-comment">//解析bean定义（核心方法）</span><br>	postProcessXml(root);<span class="hljs-comment">//后置处理xml（在DefaultBeanDefinitionDocumentReader）默认不做什么操作</span><br>	<span class="hljs-keyword">this</span>.delegate = parent;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>11.解析xml配置的bean类型</p>
<blockquote>
<p>根据xml配置的类型进行区分加载</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//	public static final String NESTED_BEANS_ELEMENT = &quot;beans&quot;;</span><br><span class="hljs-comment">//	public static final String ALIAS_ELEMENT = &quot;alias&quot;;</span><br><span class="hljs-comment">//	public static final String NAME_ATTRIBUTE = &quot;name&quot;;</span><br><span class="hljs-comment">//	public static final String ALIAS_ATTRIBUTE = &quot;alias&quot;;</span><br><span class="hljs-comment">//	public static final String IMPORT_ELEMENT = &quot;import&quot;;</span><br><span class="hljs-comment">//	public static final String RESOURCE_ATTRIBUTE = &quot;resource&quot;;</span><br><span class="hljs-comment">//	public static final String PROFILE_ATTRIBUTE = &quot;profile&quot;;</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseDefaultElement</span><span class="hljs-params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;<br>		importBeanDefinitionResource(ele);<span class="hljs-comment">//导入类型</span><br>	&#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;<br>		processAliasRegistration(ele);<span class="hljs-comment">//别名类型</span><br>	&#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;<br>        <span class="hljs-comment">//我们设置的配置文件是bean类型所以进这个方法</span><br>		processBeanDefinition(ele, delegate);<span class="hljs-comment">//bean类型</span><br>	&#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;<br>		doRegisterBeanDefinitions(ele);<span class="hljs-comment">//嵌套bean类型</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>12.处理bean定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Process the given bean element, parsing the bean definition and registering it with the registry.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processBeanDefinition</span><span class="hljs-params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;<br>    <span class="hljs-comment">//解析bean定义持有对象</span><br>	BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);<br>	<span class="hljs-keyword">if</span> (bdHolder != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">//装饰bean定义</span><br>		bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-comment">//注册最后实例</span><br>			BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br>			getReaderContext().error(<span class="hljs-string">&quot;Failed to register bean definition with name &#x27;&quot;</span> + bdHolder.getBeanName() + <span class="hljs-string">&quot;&#x27;&quot;</span>, ele, ex);<br>		&#125;<br>		<span class="hljs-comment">// 发送bean注册事件</span><br>		getReaderContext().fireComponentRegistered(<span class="hljs-keyword">new</span> BeanComponentDefinition(bdHolder));<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanDefinition</span><span class="hljs-params">(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>&#123;<br>	<span class="hljs-comment">// 获取beanName</span><br>	String beanName = definitionHolder.getBeanName();<br>       <span class="hljs-comment">//</span><br>	registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());<br>	<span class="hljs-comment">// 获取别名，如果存在则进行注册</span><br>	String[] aliases = definitionHolder.getAliases();<br>	<span class="hljs-keyword">if</span> (aliases != <span class="hljs-keyword">null</span>) &#123;<br>		<span class="hljs-keyword">for</span> (String alias : aliases) &#123;<br>			registry.registerAlias(beanName, alias);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>13.这一步主要是为了将bean定义加入到缓存中去beanDefinitionMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanDefinition</span><span class="hljs-params">(String beanName, BeanDefinition beanDefinition)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>&#123;<br><br>	Assert.hasText(beanName, <span class="hljs-string">&quot;Bean name must not be empty&quot;</span>);<br>	Assert.notNull(beanDefinition, <span class="hljs-string">&quot;BeanDefinition must not be null&quot;</span>);<br><br>	<span class="hljs-keyword">if</span> (beanDefinition <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition) &#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			((AbstractBeanDefinition) beanDefinition).validate();<span class="hljs-comment">//验证bean是否有覆盖方法</span><br>		&#125; <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,<span class="hljs-string">&quot;Validation of bean definition failed&quot;</span>, ex);<br>		&#125;<br>	&#125;<br>    <span class="hljs-comment">//尝试从beanDefinitionMap获取当前要注册的bean</span><br>	BeanDefinition existingDefinition = <span class="hljs-keyword">this</span>.beanDefinitionMap.get(beanName);<br>    <span class="hljs-comment">//已经存在当前bean定义</span><br>	<span class="hljs-keyword">if</span> (existingDefinition != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//如果beanDefinitionMap已经存在该bean定义判断是否可以覆盖，如果不可以覆盖抛出异常</span><br>		<span class="hljs-keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionOverrideException(beanName, beanDefinition, existingDefinition);<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (existingDefinition.getRole() &lt; beanDefinition.getRole()) &#123;<br>			<span class="hljs-comment">// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span><br>			<span class="hljs-keyword">if</span> (logger.isInfoEnabled()) &#123;<br>				logger.info(<span class="hljs-string">&quot;Overriding user-defined bean definition for bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; with a framework-generated bean definition: replacing [&quot;</span> + existingDefinition + <span class="hljs-string">&quot;] with [&quot;</span> + beanDefinition + <span class="hljs-string">&quot;]&quot;</span>);<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!beanDefinition.equals(existingDefinition)) &#123;<span class="hljs-comment">//bean定义不一致</span><br>			<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>				logger.debug(<span class="hljs-string">&quot;Overriding bean definition for bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; with a different definition: replacing [&quot;</span> + existingDefinition + <span class="hljs-string">&quot;] with [&quot;</span> + beanDefinition + <span class="hljs-string">&quot;]&quot;</span>);<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>				logger.trace(<span class="hljs-string">&quot;Overriding bean definition for bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; with an equivalent definition: replacing [&quot;</span> + existingDefinition +	<span class="hljs-string">&quot;] with [&quot;</span> + beanDefinition + <span class="hljs-string">&quot;]&quot;</span>);<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);<span class="hljs-comment">//加入beanDefinitionMap中</span><br>	&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//否则未存在</span><br>        <span class="hljs-keyword">if</span> (hasBeanCreationStarted()) &#123;<span class="hljs-comment">//判断bean是否已经被创建</span><br>			<span class="hljs-comment">// 无法再修改启动时间集合元素（用于稳定迭代）</span><br>			<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.beanDefinitionMap) &#123;<span class="hljs-comment">//对beanDefinitionMap进行加锁做更新处理</span><br>				<span class="hljs-keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);<br>				List&lt;String&gt; updatedDefinitions = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(<span class="hljs-keyword">this</span>.beanDefinitionNames.size() + <span class="hljs-number">1</span>);<br>				updatedDefinitions.addAll(<span class="hljs-keyword">this</span>.beanDefinitionNames);<br>				updatedDefinitions.add(beanName);<br>				<span class="hljs-keyword">this</span>.beanDefinitionNames = updatedDefinitions;<span class="hljs-comment">//更新缓存</span><br>				removeManualSingletonName(beanName);<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//否则直接添加即可</span><br>			<span class="hljs-comment">// 仍处于启动注册阶段</span><br>			<span class="hljs-keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);<br>			<span class="hljs-keyword">this</span>.beanDefinitionNames.add(beanName);<br>			removeManualSingletonName(beanName);<br>		&#125;<br>        <span class="hljs-comment">//清除在冻结配置的情况下缓存bean定义名称数组</span><br>		<span class="hljs-keyword">this</span>.frozenBeanDefinitionNames = <span class="hljs-keyword">null</span>;<br>	&#125;<br>    <span class="hljs-comment">//如果已经存在bean定义或者单例缓存中已经存在</span><br>	<span class="hljs-keyword">if</span> (existingDefinition != <span class="hljs-keyword">null</span> || containsSingleton(beanName)) &#123;<br>		resetBeanDefinition(beanName);<span class="hljs-comment">//重置bean定义</span><br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isConfigurationFrozen()) &#123;<br>		clearByTypeCache();<span class="hljs-comment">//删除关于按类型映射的任何假设</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>14.发送bean注册事件</p>
<blockquote>
<p>fireComponentRegistered</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">getReaderContext().fireComponentRegistered(<span class="hljs-keyword">new</span> BeanComponentDefinition(bdHolder));<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//为给定bean创建一个新的BeanComponentDefinition。</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BeanComponentDefinition</span><span class="hljs-params">(BeanDefinitionHolder beanDefinitionHolder)</span> </span>&#123;<br>	<span class="hljs-keyword">super</span>(beanDefinitionHolder);<br>	List&lt;BeanDefinition&gt; innerBeans = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>	List&lt;BeanReference&gt; references = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>	PropertyValues propertyValues = beanDefinitionHolder.getBeanDefinition().getPropertyValues();<br>	<span class="hljs-keyword">for</span> (PropertyValue propertyValue : propertyValues.getPropertyValues()) &#123;<span class="hljs-comment">//遍历所有的属性</span><br>		Object value = propertyValue.getValue();<br>		<span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> BeanDefinitionHolder) &#123;<span class="hljs-comment">//如果是Bean定义持有对象</span><br>			innerBeans.add(((BeanDefinitionHolder) value).getBeanDefinition());<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> BeanDefinition) &#123;<span class="hljs-comment">//如果是Bean定义类型</span><br>			innerBeans.add((BeanDefinition) value);<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> BeanReference) &#123;<span class="hljs-comment">//如果是引用类型</span><br>			references.add((BeanReference) value);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">this</span>.innerBeanDefinitions = innerBeans.toArray(<span class="hljs-keyword">new</span> BeanDefinition[<span class="hljs-number">0</span>]);<br>	<span class="hljs-keyword">this</span>.beanReferences = references.toArray(<span class="hljs-keyword">new</span> BeanReference[<span class="hljs-number">0</span>]);<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">fireComponentRegistered</span><span class="hljs-params">(ComponentDefinition componentDefinition)</span> </span>&#123;<br>	<span class="hljs-keyword">this</span>.eventListener.componentRegistered(componentDefinition);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-5-prepareBeanFactory-beanFactory"><a href="#1-2-8-5-prepareBeanFactory-beanFactory" class="headerlink" title="1.2.8.5 prepareBeanFactory(beanFactory)"></a>1.2.8.5 prepareBeanFactory(beanFactory)</h4><blockquote>
<p>准备bean工厂，以便在本文中使用</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;<br>	<span class="hljs-comment">// 告诉内部bean工厂使用上下文的类加载器等。</span><br>	beanFactory.setBeanClassLoader(getClassLoader());<br>	<span class="hljs-keyword">if</span> (!shouldIgnoreSpel) &#123;<br>		beanFactory.setBeanExpressionResolver(<span class="hljs-keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));<br>	&#125;<br>	beanFactory.addPropertyEditorRegistrar(<span class="hljs-keyword">new</span> ResourceEditorRegistrar(<span class="hljs-keyword">this</span>, getEnvironment()));<br>	<span class="hljs-comment">// 使用上下文回调配置bean工厂</span><br>	beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> ApplicationContextAwareProcessor(<span class="hljs-keyword">this</span>));<br>	beanFactory.ignoreDependencyInterface(EnvironmentAware.class);<br>	beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);<br>	beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);<br>	beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);<br>	beanFactory.ignoreDependencyInterface(MessageSourceAware.class);<br>	beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);<br>	beanFactory.ignoreDependencyInterface(ApplicationStartupAware.class);<br>	<span class="hljs-comment">//BeanFactory接口未在普通工厂中注册为可解析类型。</span><br>	<span class="hljs-comment">//MessageSource作为bean注册（并找到自动连接）。</span><br>	beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);<br>	beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="hljs-keyword">this</span>);<br>	beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="hljs-keyword">this</span>);<br>	beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="hljs-keyword">this</span>);<br>	<span class="hljs-comment">// 将用于检测内部bean的早期后处理器注册为ApplicationListener。</span><br>	beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> ApplicationListenerDetector(<span class="hljs-keyword">this</span>));<br>	<span class="hljs-comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span><br>	<span class="hljs-comment">// 检测LoadTimeWeaver并准备编织（如果发现）</span><br>	<span class="hljs-keyword">if</span> (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;<br>		beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));<br>		<span class="hljs-comment">// 为类型匹配设置临时类加载器</span><br>		beanFactory.setTempClassLoader(<span class="hljs-keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));<br>	&#125;<br>	<span class="hljs-comment">// 注册默认的环境bean</span><br>	<span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;<br>		beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());<br>	&#125;<br>	<span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;<br>		beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());<br>	&#125;<br>	<span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;<br>		beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());<br>	&#125;<br>	<span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(APPLICATION_STARTUP_BEAN_NAME)) &#123;<br>		beanFactory.registerSingleton(APPLICATION_STARTUP_BEAN_NAME, getApplicationStartup());<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-6-postProcessBeanFactory-beanFactory"><a href="#1-2-8-6-postProcessBeanFactory-beanFactory" class="headerlink" title="1.2.8.6 postProcessBeanFactory(beanFactory)"></a>1.2.8.6 postProcessBeanFactory(beanFactory)</h4><blockquote>
<p>允许在上下文子类中对bean工厂进行后处理。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//在当前普通应用没做任何处理，如果是web应用设置servletContext相关内容</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;<br>    <span class="hljs-comment">//empty</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-7-invokeBeanFactoryPostProcessors-beanFactory"><a href="#1-2-8-7-invokeBeanFactoryPostProcessors-beanFactory" class="headerlink" title="1.2.8.7 invokeBeanFactoryPostProcessors(beanFactory)"></a>1.2.8.7 invokeBeanFactoryPostProcessors(beanFactory)</h4><blockquote>
<p>调用在上下文中注册为bean的工厂处理器</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;<br>	<span class="hljs-comment">//调用bean工厂后置处理器</span><br>	PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());<br>	<span class="hljs-comment">//检测LoadTimeWeaver并准备编织（如果存在）（例如，通过ConfigurationClassPostProcessor注册的@Bean方法）</span><br>	<span class="hljs-keyword">if</span> (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.getTempClassLoader() == <span class="hljs-keyword">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;<br>		beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));<br>		beanFactory.setTempClassLoader(<span class="hljs-keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p> 调用bean工厂后置处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> </span>&#123;<br>		<span class="hljs-comment">// 如果有，首先调用BeanDefinitionRegistryPostProcessors</span><br>		Set&lt;String&gt; processedBeans = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();<br>		<span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistry registry) &#123;<br>			List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>			List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>			<span class="hljs-keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) &#123;<br>				<span class="hljs-keyword">if</span> (postProcessor <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistryPostProcessor registryProcessor) &#123;<br>					registryProcessor.postProcessBeanDefinitionRegistry(registry);<br>					registryProcessors.add(registryProcessor);<br>				&#125; <span class="hljs-keyword">else</span> &#123;<br>					regularPostProcessors.add(postProcessor);<br>				&#125;<br>			&#125;<br>			<span class="hljs-comment">//不要在这里初始化FactoryBean：我们需要保留所有常规Bean未初始化，让bean factory后处理器应用于它们！在实现优先顺序，以及其他。</span><br>			List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>			<span class="hljs-comment">// 首先，调用实现PriorityOrdered的BeanDefinitionRegistryPostProcessor。</span><br>			String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>			<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>				<span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>					currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>					processedBeans.add(ppName);<br>				&#125;<br>			&#125;<br>			sortPostProcessors(currentRegistryProcessors, beanFactory);<br>			registryProcessors.addAll(currentRegistryProcessors);<br>			invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());<br>			currentRegistryProcessors.clear();<br>			<span class="hljs-comment">// 接下来，调用实现Ordered的BeanDefinitionRegistryPostProcessor。</span><br>			postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>			<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>				<span class="hljs-keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>					currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>					processedBeans.add(ppName);<br>				&#125;<br>			&#125;<br>			sortPostProcessors(currentRegistryProcessors, beanFactory);<br>			registryProcessors.addAll(currentRegistryProcessors);<br>			invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());<br>			currentRegistryProcessors.clear();<br>			<span class="hljs-comment">// 最后，调用所有其他BeanDefinitionRegistryPostProcessor，直到不再出现其他BeanDefinitionRegistryPostProcessor。</span><br>			<span class="hljs-keyword">boolean</span> reiterate = <span class="hljs-keyword">true</span>;<br>			<span class="hljs-keyword">while</span> (reiterate) &#123;<br>				reiterate = <span class="hljs-keyword">false</span>;<br>				postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>				<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>					<span class="hljs-keyword">if</span> (!processedBeans.contains(ppName)) &#123;<br>						currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));<br>						processedBeans.add(ppName);<br>						reiterate = <span class="hljs-keyword">true</span>;<br>					&#125;<br>				&#125;<br>				sortPostProcessors(currentRegistryProcessors, beanFactory);<br>				registryProcessors.addAll(currentRegistryProcessors);<br>				invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());<br>				currentRegistryProcessors.clear();<br>			&#125;<br>			<span class="hljs-comment">// 现在，调用到目前为止处理的所有处理器的postProcessBeanFactory回调。</span><br>			invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);<br>			invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// 调用在上下文实例中注册的工厂处理器。</span><br>			invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);<br>		&#125;<br>		<span class="hljs-comment">// 不要在这里初始化FactoryBean：我们需要保留所有常规Bean未初始化，让bean factory后处理器应用于它们！</span><br>		String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>		<span class="hljs-comment">// 将实现PriorityOrdered、Ordered和其他功能的BeanFactory后处理器分开。</span><br>		List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>		List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>		List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>		<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>			<span class="hljs-keyword">if</span> (processedBeans.contains(ppName)) &#123;<br>				<span class="hljs-comment">// 跳过-已在上述第一阶段处理</span><br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>				priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>				orderedPostProcessorNames.add(ppName);<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				nonOrderedPostProcessorNames.add(ppName);<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// 首先，调用实现PriorityOrdered的BeanFactory后处理器。</span><br>		sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br>		invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);<br>		<span class="hljs-comment">// 接下来，调用实现Ordered的BeanFactory后处理器。</span><br>		List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());<br>		<span class="hljs-keyword">for</span> (String postProcessorName : orderedPostProcessorNames) &#123;<br>			orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>		&#125;<br>		<span class="hljs-comment">//排序处理</span><br>		sortPostProcessors(orderedPostProcessors, beanFactory);<br>		invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);<br>		<span class="hljs-comment">// 最后，调用所有其他BeanFactory后处理器。</span><br>		List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());<br>		<span class="hljs-keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) &#123;<br>			nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));<br>		&#125;<br>		<span class="hljs-comment">//调用非排序的bean工厂后置处理器</span><br>		invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);<br>		<span class="hljs-comment">//清除缓存的合并bean定义，因为后处理器可能修改了原始元数据，例如替换值中的占位符</span><br>		beanFactory.clearMetadataCache();<br>	&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-8-registerBeanPostProcessors-beanFactory"><a href="#1-2-8-8-registerBeanPostProcessors-beanFactory" class="headerlink" title="1.2.8.8 registerBeanPostProcessors(beanFactory)"></a>1.2.8.8 registerBeanPostProcessors(beanFactory)</h4><blockquote>
<p>注册拦截bean创建的bean处理器。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanPostProcessors</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory, AbstractApplicationContext applicationContext)</span> </span>&#123;<br>	String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>	<span class="hljs-comment">//注册BeanPostProcessorChecker，在bean是在BeanPostProcessor实例化期间创建的，即一个bean没有资格被所有BeanPostProcessor处理。</span><br>	<span class="hljs-keyword">int</span> beanProcessorTargetCount = beanFactory.getBeanPostProcessorCount() + <span class="hljs-number">1</span> + postProcessorNames.length;<br>	beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> BeanPostProcessorChecker(beanFactory, beanProcessorTargetCount));<br>	<span class="hljs-comment">// 将实现PriorityOrdered、Ordered和其他功能的BeanPostProcessor分开。</span><br>	List&lt;BeanPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>	List&lt;BeanPostProcessor&gt; internalPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>	List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>	List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>	<span class="hljs-keyword">for</span> (String ppName : postProcessorNames) &#123;<br>		<span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) &#123;<br>			BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);<br>			priorityOrderedPostProcessors.add(pp);<br>			<span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>				internalPostProcessors.add(pp);<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) &#123;<br>			orderedPostProcessorNames.add(ppName);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			nonOrderedPostProcessorNames.add(ppName);<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">// 首先，注册实现PriorityOrdered的BeanPostProcessor。</span><br>	sortPostProcessors(priorityOrderedPostProcessors, beanFactory);<br>	registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors);<br>	<span class="hljs-comment">// 接下来，注册实现Ordered的BeanPostProcessor。</span><br>	List&lt;BeanPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(orderedPostProcessorNames.size());<br>	<span class="hljs-keyword">for</span> (String ppName : orderedPostProcessorNames) &#123;<br>		BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);<br>		orderedPostProcessors.add(pp);<br>		<span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>			internalPostProcessors.add(pp);<br>		&#125;<br>	&#125;<br>	sortPostProcessors(orderedPostProcessors, beanFactory);<br>	registerBeanPostProcessors(beanFactory, orderedPostProcessors);<br>	<span class="hljs-comment">// 现在，注册所有常规BeanPostProcessor。</span><br>	List&lt;BeanPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(nonOrderedPostProcessorNames.size());<br>	<span class="hljs-keyword">for</span> (String ppName : nonOrderedPostProcessorNames) &#123;<br>		BeanPostProcessor pp = beanFactory.getBean(ppName, BeanPostProcessor.class);<br>		nonOrderedPostProcessors.add(pp);<br>		<span class="hljs-keyword">if</span> (pp <span class="hljs-keyword">instanceof</span> MergedBeanDefinitionPostProcessor) &#123;<br>			internalPostProcessors.add(pp);<br>		&#125;<br>	&#125;<br>	registerBeanPostProcessors(beanFactory, nonOrderedPostProcessors);<br>	<span class="hljs-comment">// 最后，重新注册所有内部BeanPostProcessor。</span><br>	sortPostProcessors(internalPostProcessors, beanFactory);<br>	registerBeanPostProcessors(beanFactory, internalPostProcessors);<br>	<span class="hljs-comment">// 将用于检测内部bean的后处理器重新注册为ApplicationListener，将其移动到处理器链的末端（用于获取代理等）。</span><br>	beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> ApplicationListenerDetector(applicationContext));<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-9-beanPostProcess-end"><a href="#1-2-8-9-beanPostProcess-end" class="headerlink" title="1.2.8.9 beanPostProcess.end()"></a>1.2.8.9 beanPostProcess.end()</h4><blockquote>
<p>默认空实现，记录步骤的状态，以及可能的其他指标，如执行时间。一旦结束，不允许更改步骤状态。</p>
</blockquote>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>1.2.8.10 initMessageSource()</p>
<blockquote>
<p>初始化国际化信息源，这里先不展开</p>
</blockquote>
<h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><p>1.2.8.11 initApplicationEventMulticaster()</p>
<blockquote>
<p>为此上下文初始化事件广播</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initApplicationEventMulticaster</span><span class="hljs-params">()</span> </span>&#123;<br>	ConfigurableListableBeanFactory beanFactory = getBeanFactory();<br>	<span class="hljs-comment">//判断当前容器是否存在applicationEventMulticaster</span><br>	<span class="hljs-keyword">if</span> (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME)) &#123;<br>		<span class="hljs-keyword">this</span>.applicationEventMulticaster = beanFactory.getBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class);<br>		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>			logger.trace(<span class="hljs-string">&quot;Using ApplicationEventMulticaster [&quot;</span> + <span class="hljs-keyword">this</span>.applicationEventMulticaster + <span class="hljs-string">&quot;]&quot;</span>);<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//不存在则默认使用SimpleApplicationEventMulticaster</span><br>		<span class="hljs-keyword">this</span>.applicationEventMulticaster = <span class="hljs-keyword">new</span> SimpleApplicationEventMulticaster(beanFactory);<br>        <span class="hljs-comment">//注册到容器中</span><br>		beanFactory.registerSingleton(APPLICATION_EVENT_MULTICASTER_BEAN_NAME, <span class="hljs-keyword">this</span>.applicationEventMulticaster);<br>		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>			logger.trace(<span class="hljs-string">&quot;No &#x27;&quot;</span> + APPLICATION_EVENT_MULTICASTER_BEAN_NAME + <span class="hljs-string">&quot;&#x27; bean, using &quot;</span> + <span class="hljs-string">&quot;[&quot;</span> + <span class="hljs-keyword">this</span>.applicationEventMulticaster.getClass().getSimpleName() + <span class="hljs-string">&quot;]&quot;</span>);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-12-onRefresh"><a href="#1-2-8-12-onRefresh" class="headerlink" title="1.2.8.12 onRefresh()"></a>1.2.8.12 onRefresh()</h4><blockquote>
<p>初始化特定上下文子类中的其他特殊bean（默认空实现）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRefresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>	<span class="hljs-comment">// For subclasses: do nothing by default.</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-13-registerListeners"><a href="#1-2-8-13-registerListeners" class="headerlink" title="1.2.8.13 registerListeners()"></a>1.2.8.13 registerListeners()</h4><blockquote>
<p>检查侦听器bean并注册它们</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerListeners</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-comment">// 首先注册静态指定的侦听器</span><br>	<span class="hljs-keyword">for</span> (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) &#123;<br>		getApplicationEventMulticaster().addApplicationListener(listener);<br>	&#125;<br>	<span class="hljs-comment">// 不要在这里初始化FactoryBean：我们需要保留所有常规Bean 未初始化以允许后处理器应用于它们！</span><br>	String[] listenerBeanNames = getBeanNamesForType(ApplicationListener.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);<br>	<span class="hljs-keyword">for</span> (String listenerBeanName : listenerBeanNames) &#123;<br>		getApplicationEventMulticaster().addApplicationListenerBean(listenerBeanName);<br>	&#125;<br>	<span class="hljs-comment">// 发布早期应用程序事件</span><br>    <span class="hljs-comment">// 现在我们终于有了一个multicaster</span><br>	Set&lt;ApplicationEvent&gt; earlyEventsToProcess = <span class="hljs-keyword">this</span>.earlyApplicationEvents;<br>	<span class="hljs-keyword">this</span>.earlyApplicationEvents = <span class="hljs-keyword">null</span>;<br>	<span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(earlyEventsToProcess)) &#123;<br>		<span class="hljs-keyword">for</span> (ApplicationEvent earlyEvent : earlyEventsToProcess) &#123;<br>			getApplicationEventMulticaster().multicastEvent(earlyEvent);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-2-8-14-finishBeanFactoryInitialization-beanFactory"><a href="#1-2-8-14-finishBeanFactoryInitialization-beanFactory" class="headerlink" title="1.2.8.14 finishBeanFactoryInitialization(beanFactory)"></a>1.2.8.14 finishBeanFactoryInitialization(beanFactory)</h4><blockquote>
<p>实例化所有剩余的（非懒加载初始化）单例</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finishBeanFactoryInitialization</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;<br>	<span class="hljs-comment">// 初始化 conversion service 在当前容器中（上下文）</span><br>	<span class="hljs-keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp; beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;<br>		beanFactory.setConversionService(beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));<br>	&#125;<br>	<span class="hljs-comment">//如果没有BeanFactoryPostProcessor，请注册默认嵌入值解析器</span><br>	<span class="hljs-comment">//（例如PropertySourcesPlaceholderConfigurer bean）在以下任何时间之前注册：</span><br>	<span class="hljs-comment">//此时，主要用于注解属性值中的分辨率。</span><br>	<span class="hljs-keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;<br>		beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));<br>	&#125;<br>	<span class="hljs-comment">// 尽早初始化LoadTimeWeaverAware bean，以便尽早注册它们的转换器。</span><br>	String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br>	<span class="hljs-keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;<br>		getBean(weaverAwareName);<br>	&#125;<br>	<span class="hljs-comment">// 停止使用临时类加载器进行类型匹配。</span><br>	beanFactory.setTempClassLoader(<span class="hljs-keyword">null</span>);<br>	<span class="hljs-comment">// 允许缓存所有bean定义元数据，不需要进一步更改。</span><br>	beanFactory.freezeConfiguration();<br>	<span class="hljs-comment">// 实例化所有剩余的（非懒加载初始化）单例。</span><br>	beanFactory.preInstantiateSingletons();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>实例化所有的 singletons bean (除了lazy-init外)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">preInstantiateSingletons</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>   <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>      logger.trace(<span class="hljs-string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="hljs-keyword">this</span>);<br>   &#125;<br>   <span class="hljs-comment">// 获取所有的beanDefinitionNames</span><br>   List&lt;String&gt; beanNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(<span class="hljs-keyword">this</span>.beanDefinitionNames);<br>   <span class="hljs-comment">// 触发所有非懒加载单例bean的初始化</span><br>   <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br>      <span class="hljs-comment">//获取RootBeanDefinition</span><br>      RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);<br>      <span class="hljs-keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;<span class="hljs-comment">//非抽象且单例且非懒加载</span><br>         <span class="hljs-keyword">if</span> (isFactoryBean(beanName)) &#123;<span class="hljs-comment">//如果是FactoryBean</span><br>            <span class="hljs-comment">//FactoryBean:由BeanFactory中使用的对象实现的接口它们本身就是单个对象的工厂。</span><br>            <span class="hljs-comment">//如果bean实现了这一点接口，它被用作对象暴露的工厂，而不是直接作为bean实例，该实例将自身公开。</span><br>            <span class="hljs-comment">//在获取bean前在beanName加上&#x27;&amp;&#x27;前缀</span><br>            Object bean = getBean(FACTORY_BEAN_PREFIX + beanName);<br>            <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> FactoryBean) &#123;<br>               <span class="hljs-keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;<br>               <span class="hljs-keyword">boolean</span> isEagerInit;<br>               <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-keyword">null</span> &amp;&amp; factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean) &#123;<br>                  isEagerInit = AccessController.doPrivileged((PrivilegedAction&lt;Boolean&gt;) ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,getAccessControlContext());<br>               &#125; <span class="hljs-keyword">else</span> &#123;<br>                  isEagerInit = (factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean &amp;&amp; ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());<br>               &#125;<br>               <span class="hljs-keyword">if</span> (isEagerInit) &#123;<span class="hljs-comment">//获取该bean</span><br>                  getBean(beanName);<span class="hljs-comment">//核心方法</span><br>               &#125;<br>            &#125;<br>         &#125; <span class="hljs-keyword">else</span> &#123;<br>            getBean(beanName);<span class="hljs-comment">//核心方法</span><br>         &#125;<br>      &#125;<br>   &#125;<br>   <span class="hljs-comment">// 触发所有适用bean的初始化后回调 如果我们定义的 bean 是实现了 SmartInitializingSingleton 接口的，那么在这里得到回调</span><br>   <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br>        <span class="hljs-comment">//通过beanname获取bean</span><br>		Object singletonInstance = getSingleton(beanName);<br>		<span class="hljs-keyword">if</span> (singletonInstance <span class="hljs-keyword">instanceof</span> SmartInitializingSingleton smartSingleton) &#123;<br>			StartupStep smartInitialize = <span class="hljs-keyword">this</span>.getApplicationStartup().start(<span class="hljs-string">&quot;spring.beans.smart-initialize&quot;</span>).tag(<span class="hljs-string">&quot;beanName&quot;</span>, beanName);<br>			<span class="hljs-comment">//后置处理</span><br>            smartSingleton.afterSingletonsInstantiated();<br>			smartInitialize.end();<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>获取单例bean的核心方法getBean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getBean</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>	<span class="hljs-keyword">return</span> doGetBean(name, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>doGetBean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">doGetBean</span><span class="hljs-params">(String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-keyword">boolean</span> typeCheckOnly)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;<br>    <span class="hljs-comment">// 转换beanName判断是否以&amp;开头的FactoryBean</span><br>    String beanName = transformedBeanName(name);<br>    Object beanInstance;<span class="hljs-comment">//bean实例（最终返回）</span><br>    <span class="hljs-comment">// 检查单例缓存中手动注册的单例（用于判断是否已经创建过）</span><br>    Object sharedInstance = getSingleton(beanName);<br>    <span class="hljs-comment">//当args不为空将创建bean</span><br>    <span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-keyword">null</span> &amp;&amp; args == <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>            <span class="hljs-comment">//判断指定的单例bean当前是否正在创建中</span><br>            <span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;<br>                logger.trace(<span class="hljs-string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                logger.trace(<span class="hljs-string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 获取给定bean实例的对象，可以是bean实例本身，也可以是FactoryBean中创建的对象。</span><br>        beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="hljs-keyword">null</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//如果我们已经在创建这个bean的Prototype类型实例，则抛出异常：</span><br>        <span class="hljs-comment">//往往是因为陷入了循环引用</span><br>        <span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName);<br>        &#125;<br>        <span class="hljs-comment">// 检查 bean definition 是否存在当前容器中</span><br>        BeanFactory parentBeanFactory = getParentBeanFactory();<br>        <span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;<br>            <span class="hljs-comment">// 当前容器未找到向父容器查找</span><br>            String nameToLookup = originalBeanName(name);<br>            <span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory abf) &#123;<br>                <span class="hljs-keyword">return</span> abf.doGetBean(nameToLookup, requiredType, args, typeCheckOnly);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-comment">// Delegation to parent with explicit args.</span><br>                <span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-comment">// No args -&gt; delegate to standard getBean method.</span><br>                <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//如果bean能够正常创建 添加进alreadyCreated缓存</span><br>        <span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;<br>            markBeanAsCreated(beanName);<br>        &#125;<br>        <span class="hljs-comment">//</span><br>        StartupStep beanCreation = <span class="hljs-keyword">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.beans.instantiate&quot;</span>).tag(<span class="hljs-string">&quot;beanName&quot;</span>, name);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//bean的所需类型</span><br>            <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-keyword">null</span>) &#123;<br>                beanCreation.tag(<span class="hljs-string">&quot;beanType&quot;</span>, requiredType::toString);<br>            &#125;<br>            RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);<br>            checkMergedBeanDefinition(mbd, beanName, args);<br>            <br>            <span class="hljs-comment">// 保证当前bean所依赖的bean的初始化</span><br>            String[] dependsOn = mbd.getDependsOn();<br>            <span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">for</span> (String dep : dependsOn) &#123;<br>                    <span class="hljs-comment">//确定指定的依赖bean是否已注册为依赖于给定bean或其任何可传递依赖项，否则抛出循环依赖</span><br>                    <span class="hljs-keyword">if</span> (isDependent(beanName, dep)) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                    &#125;<br>                    <span class="hljs-comment">//注册依赖的bean</span><br>                    registerDependentBean(dep, beanName);<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">//尝试获取依赖bean，如果还获取不到则抛出异常</span><br>                        getBean(dep);<br>                    &#125; <span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;&#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// 如果bean的作用域是single类型</span><br>            <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>                sharedInstance = getSingleton(beanName, () -&gt; &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">//（核心方法）创建bean</span><br>                        <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>                    &#125; <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>                        <span class="hljs-comment">//出现异常销毁bean</span><br>                        destroySingleton(beanName);<br>                        <span class="hljs-keyword">throw</span> ex;<br>                    &#125;<br>                &#125;);<br>                <span class="hljs-comment">//否则</span><br>                beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>            &#125;<br>            <span class="hljs-comment">//如果bean的作用域是Prototype类型</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;<br>                <span class="hljs-comment">// It&#x27;s a prototype -&gt; create a new instance.</span><br>                Object prototypeInstance = <span class="hljs-keyword">null</span>;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    beforePrototypeCreation(beanName);<br>                    prototypeInstance = createBean(beanName, mbd, args);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    afterPrototypeCreation(beanName);<br>                &#125;<br>                beanInstance = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);<br>            &#125;<br>            <span class="hljs-comment">//否则根据bean的作用域进行创建</span><br>            <span class="hljs-keyword">else</span> &#123;<br>                String scopeName = mbd.getScope();<br>                <span class="hljs-keyword">if</span> (!StringUtils.hasLength(scopeName)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;No scope name defined for bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br>                Scope scope = <span class="hljs-keyword">this</span>.scopes.get(scopeName);<br>                <span class="hljs-keyword">if</span> (scope == <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Object scopedInstance = scope.get(beanName, () -&gt; &#123;<br>                        <span class="hljs-comment">//加入正在创建中缓存</span><br>                        beforePrototypeCreation(beanName);<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-comment">//开始创建</span><br>                            <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>                        &#125; <span class="hljs-keyword">finally</span> &#123;<br>                            <span class="hljs-comment">//移除正在创建中缓存</span><br>                            afterPrototypeCreation(beanName);<br>                        &#125;<br>                    &#125;);<br>                    beanInstance = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);<br>                &#125; <span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ScopeNotActiveException(beanName, scopeName, ex);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>            beanCreation.tag(<span class="hljs-string">&quot;exception&quot;</span>, ex.getClass().toString());<br>            beanCreation.tag(<span class="hljs-string">&quot;message&quot;</span>, String.valueOf(ex.getMessage()));<br>            cleanupAfterBeanCreationFailure(beanName);<br>            <span class="hljs-keyword">throw</span> ex;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            beanCreation.end();<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 对bean类型进行检查</span><br>    <span class="hljs-keyword">return</span> adaptBeanInstance(name, beanInstance, requiredType);<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>createBean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">createBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> <span class="hljs-keyword">throws</span> BeanCreationException </span>&#123;<br><br>	<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>		logger.trace(<span class="hljs-string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>	&#125;<br>	RootBeanDefinition mbdToUse = mbd;<br><br>	<span class="hljs-comment">// 确保bean 字节码在这一点上得到了解决</span><br>	<span class="hljs-comment">// 如果是动态解析的类，请克隆bean定义</span><br>	<span class="hljs-comment">// 不能存储在共享合并bean定义中。</span><br>	Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);<br>	<span class="hljs-keyword">if</span> (resolvedClass != <span class="hljs-keyword">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="hljs-keyword">null</span>) &#123;<br>		mbdToUse = <span class="hljs-keyword">new</span> RootBeanDefinition(mbd);<br>		mbdToUse.setBeanClass(resolvedClass);<br>	&#125;<br>	<span class="hljs-comment">// 准备方法重写</span><br>	<span class="hljs-keyword">try</span> &#123;<br>		mbdToUse.prepareMethodOverrides();<br>	&#125; <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(mbdToUse.getResourceDescription(), beanName, <span class="hljs-string">&quot;Validation of method overrides failed&quot;</span>, ex);<br>	&#125;<br><br>	<span class="hljs-keyword">try</span> &#123;<br>		<span class="hljs-comment">//让BeanPostProcessors有机会返回代理，而不是目标bean实例。</span><br>		Object bean = resolveBeforeInstantiation(beanName, mbdToUse);<br>		<span class="hljs-keyword">if</span> (bean != <span class="hljs-keyword">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> bean;<br>		&#125;<br>	&#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbdToUse.getResourceDescription(), beanName, <span class="hljs-string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);<br>	&#125;<br>	<span class="hljs-comment">// 开始创建实例</span><br>	<span class="hljs-keyword">try</span> &#123;<br>		<span class="hljs-comment">//创建bean（核心方法）</span><br>		Object beanInstance = doCreateBean(beanName, mbdToUse, args);<br>		<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>			logger.trace(<span class="hljs-string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>		&#125;<br>		<span class="hljs-keyword">return</span> beanInstance;<br>	&#125; <span class="hljs-keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;<br>		<span class="hljs-comment">// A previously detected exception with proper bean creation context already,</span><br>		<span class="hljs-comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span><br>		<span class="hljs-keyword">throw</span> ex;<br>	&#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbdToUse.getResourceDescription(), beanName, <span class="hljs-string">&quot;Unexpected exception during bean creation&quot;</span>, ex);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> <span class="hljs-keyword">throws</span> BeanCreationException </span>&#123;<br>		<span class="hljs-comment">// Instantiate the bean.</span><br>		BeanWrapper instanceWrapper = <span class="hljs-keyword">null</span>;<br>		<span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<span class="hljs-comment">//如果是single类型将其</span><br>			instanceWrapper = <span class="hljs-keyword">this</span>.factoryBeanInstanceCache.remove(beanName);<br>		&#125;<br>		<span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//不是factoryBean，创建bean实例</span><br>			<span class="hljs-comment">//重点关注</span><br>			instanceWrapper = createBeanInstance(beanName, mbd, args);<br>		&#125;<br>		Object bean = instanceWrapper.getWrappedInstance();<br>		Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br>		<span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>			mbd.resolvedTargetType = beanType;<br>		&#125;<br>		<span class="hljs-comment">// 允许后处理器修改合并的bean定义</span><br>		<span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;<br>			<span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;<br>				<span class="hljs-keyword">try</span> &#123;<br>					applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);<br>				&#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);<br>				&#125;<br>				mbd.postProcessed = <span class="hljs-keyword">true</span>;<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">//预先地缓存单例，以便能够解析循环引用（bean的提前曝光）</span><br>		<span class="hljs-comment">//即使是由BeanFactoryAware等生命周期接口触发。</span><br>		<span class="hljs-keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="hljs-keyword">this</span>.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName));<br>		<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>			<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>				logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>			&#125;<br>			addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));<br>		&#125;<br>        <span class="hljs-comment">//当前bean的曝光实例</span><br>		Object exposedObject = bean;<br>		<span class="hljs-comment">// 初始化bean实例</span><br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-comment">//装配bean的属性</span><br>			populateBean(beanName, mbd, instanceWrapper);<br>			<span class="hljs-comment">//处理bean的创建完成的回调</span><br>			exposedObject = initializeBean(beanName, exposedObject, mbd);<br>		&#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>			<span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;<br>				<span class="hljs-keyword">throw</span> (BeanCreationException) ex;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Initialization of bean failed&quot;</span>, ex);<br>			&#125;<br>		&#125;<br>        <span class="hljs-comment">//如果是早期曝光</span><br>		<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>            <span class="hljs-comment">//尝试从一级缓存中获取</span><br>			Object earlySingletonReference = getSingleton(beanName, <span class="hljs-keyword">false</span>);<br>            <span class="hljs-comment">//如果缓存中获取成功，说明已经初始化好，可直接返回</span><br>			<span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-keyword">null</span>) &#123;<br>				<span class="hljs-keyword">if</span> (exposedObject == bean) &#123;<br>					exposedObject = earlySingletonReference;<br>				&#125;<br>                <span class="hljs-comment">//否则如果当前bean还有依赖的bean则进行获取并</span><br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;<br>					String[] dependentBeans = getDependentBeans(beanName);<br>                    <span class="hljs-comment">//实际依赖的bean如果创建好了就注入</span><br>					Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);<br>					<span class="hljs-keyword">for</span> (String dependentBean : dependentBeans) &#123;<br>						<span class="hljs-keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;<br>							actualDependentBeans.add(dependentBean);<br>						&#125;<br>					&#125;<br>					<span class="hljs-keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;<br>						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName,<br>								<span class="hljs-string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; has been injected into other beans [&quot;</span> +<br>								StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +<br>								<span class="hljs-string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +<br>								<span class="hljs-string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +<br>								<span class="hljs-string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +<br>								<span class="hljs-string">&quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// 注册bean的disposable回调</span><br>		<span class="hljs-keyword">try</span> &#123;<br>			registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>		&#125; <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, ex);<br>		&#125;<br>		<span class="hljs-keyword">return</span> exposedObject;<br>	&#125;<br><br></code></pre></td></tr></table></figure>

<p>创建bean实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title">createBeanInstance</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> </span>&#123;<br>	<span class="hljs-comment">// 确保已加载了该class</span><br>	Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);<br>	<span class="hljs-comment">//检查类的访问权限</span><br>	<span class="hljs-keyword">if</span> (beanClass != <span class="hljs-keyword">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot;</span> + beanClass.getName());<br>	&#125;<br>	<span class="hljs-comment">//有指定的实例提供者</span><br>	Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();<br>	<span class="hljs-keyword">if</span> (instanceSupplier != <span class="hljs-keyword">null</span>) &#123;<br>		<span class="hljs-keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);<br>	&#125;<br>	<span class="hljs-comment">//采用工厂方法实例化</span><br>	<span class="hljs-keyword">if</span> (mbd.getFactoryMethodName() != <span class="hljs-keyword">null</span>) &#123;<br>		<span class="hljs-keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);<br>	&#125;<br><br>	<span class="hljs-comment">// 如果不是第一次创建，比如第二次创建 prototype bean。</span><br>	<span class="hljs-comment">// 这种情况下，我们可以从第一次创建知道，采用无参构造函数，还是构造函数依赖注入 来完成实例化</span><br>	<span class="hljs-keyword">boolean</span> resolved = <span class="hljs-keyword">false</span>;<br>	<span class="hljs-keyword">boolean</span> autowireNecessary = <span class="hljs-keyword">false</span>;<br>	<span class="hljs-keyword">if</span> (args == <span class="hljs-keyword">null</span>) &#123;<br>		<span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;<br>			<span class="hljs-keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="hljs-keyword">null</span>) &#123;<br>				resolved = <span class="hljs-keyword">true</span>;<br>				autowireNecessary = mbd.constructorArgumentsResolved;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (resolved) &#123;<br>		<span class="hljs-keyword">if</span> (autowireNecessary) &#123;<br>			<span class="hljs-comment">//构造函数自动注入</span><br>			<span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">//无参构造函数</span><br>			<span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 自动注入的候选构造器</span><br>	Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);<br>	<span class="hljs-comment">// 判断是否采用有参构造函数</span><br>	<span class="hljs-keyword">if</span> (ctors != <span class="hljs-keyword">null</span> || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR || mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123;<br>		<span class="hljs-comment">//构造函数自动注入</span><br>		<span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);<br>	&#125;<br><br>	<span class="hljs-comment">// Preferred constructors for default construction?</span><br>	ctors = mbd.getPreferredConstructors();<br>	<span class="hljs-keyword">if</span> (ctors != <span class="hljs-keyword">null</span>) &#123;<br>		<span class="hljs-comment">//构造函数自动注入</span><br>		<span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, <span class="hljs-keyword">null</span>);<br>	&#125;<br><br>	<span class="hljs-comment">// 无需特殊处理：只需不使用arg构造函数即可。</span><br>	<span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">instantiate</span><span class="hljs-params">(RootBeanDefinition bd, <span class="hljs-meta">@Nullable</span> String beanName, BeanFactory owner)</span> </span>&#123;<br>	<span class="hljs-comment">// 如果没有重写，不用CGLIB重写该类。</span><br>	<span class="hljs-keyword">if</span> (!bd.hasMethodOverrides()) &#123;<br>		Constructor&lt;?&gt; constructorToUse;<span class="hljs-comment">//构造器</span><br>		<span class="hljs-keyword">synchronized</span> (bd.constructorArgumentLock) &#123;<span class="hljs-comment">//加锁</span><br>			constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod;<br>			<span class="hljs-keyword">if</span> (constructorToUse == <span class="hljs-keyword">null</span>) &#123;<br>				<span class="hljs-comment">//获取类class</span><br>				<span class="hljs-keyword">final</span> Class&lt;?&gt; clazz = bd.getBeanClass();<br>				<span class="hljs-keyword">if</span> (clazz.isInterface()) &#123;<span class="hljs-comment">//如果是接口抛出异常</span><br>					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanInstantiationException(clazz, <span class="hljs-string">&quot;Specified class is an interface&quot;</span>);<br>				&#125;<br>				<span class="hljs-keyword">try</span> &#123;<br>					constructorToUse = clazz.getDeclaredConstructor();<span class="hljs-comment">//获取公开的构造器</span><br>					bd.resolvedConstructorOrFactoryMethod = constructorToUse;<br>				&#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanInstantiationException(clazz, <span class="hljs-string">&quot;No default constructor found&quot;</span>, ex);<br>				&#125;<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">//通过beanUtils进行反射实例化</span><br>		<span class="hljs-keyword">return</span> BeanUtils.instantiateClass(constructorToUse);<br>	&#125;<br>	<span class="hljs-comment">// 如果有重写的方法，采用cglib生成子类</span><br>	<span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-comment">// Must generate CGLIB subclass.</span><br>		<span class="hljs-keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>此时bean已经实例化完成，开始进行属性的注入，回到上面的的<strong>populateBean方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">populateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> BeanWrapper bw)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span> (bw == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//如果bean为空确有属性需要注入则抛出异常</span><br>		<span class="hljs-keyword">if</span> (mbd.hasPropertyValues()) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Cannot apply property values to null instance&quot;</span>);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">// 否则不需要任何注入直接返回</span><br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">//给实例化WareBean后处理器修改,这可以用来设置属性之前bean的状态</span><br>	<span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br>		<span class="hljs-keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;<br>			<span class="hljs-comment">// 如果返回 false，代表不需要进行后续的属性设值，也不需要再经过其他的 BeanPostProcessor 的处理</span><br>			<span class="hljs-keyword">if</span> (!bp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;<br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="hljs-keyword">null</span>);<br><br>	<span class="hljs-keyword">int</span> resolvedAutowireMode = mbd.getResolvedAutowireMode();<br>	<span class="hljs-keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME || resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;<br>		MutablePropertyValues newPvs = <span class="hljs-keyword">new</span> MutablePropertyValues(pvs);<br>		<span class="hljs-comment">// 根据autowire按名称添加特性值（如果适用）如果是 bean 依赖，先初始化依赖的 bean。记录依赖关系</span><br>		<span class="hljs-keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_NAME) &#123;<br>			autowireByName(beanName, mbd, bw, newPvs);<br>		&#125;<br>		<span class="hljs-comment">// 根据autowire按类型添加特性值（如果适用）</span><br>		<span class="hljs-keyword">if</span> (resolvedAutowireMode == AUTOWIRE_BY_TYPE) &#123;<br>			autowireByType(beanName, mbd, bw, newPvs);<br>		&#125;<br>		pvs = newPvs;<br>	&#125;<br><br>	<span class="hljs-keyword">boolean</span> hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();<br>	<span class="hljs-keyword">boolean</span> needsDepCheck = (mbd.getDependencyCheck() != AbstractBeanDefinition.DEPENDENCY_CHECK_NONE);<br><br>	<span class="hljs-keyword">if</span> (hasInstAwareBpps) &#123;<br>		<span class="hljs-keyword">if</span> (pvs == <span class="hljs-keyword">null</span>) &#123;<br>			pvs = mbd.getPropertyValues();<br>		&#125;<br>		<span class="hljs-keyword">for</span> (InstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().instantiationAware) &#123;<br>			<span class="hljs-comment">// 这里有个非常有用的 BeanPostProcessor 进到这里: AutowiredAnnotationBeanPostProcessor</span><br>			<span class="hljs-comment">// 对采用 @Autowired、@Value 注解的依赖进行设值，这里的内容也是非常丰富的</span><br>			PropertyValues pvsToUse = bp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName);<br>			<span class="hljs-keyword">if</span> (pvsToUse == <span class="hljs-keyword">null</span>) &#123;<br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>			pvs = pvsToUse;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (needsDepCheck) &#123;<br>		PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);<br>		checkDependencies(beanName, mbd, filteredPds, pvs);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (pvs != <span class="hljs-keyword">null</span>) &#123;<br>		applyPropertyValues(beanName, mbd, bw, pvs);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>调用各种回调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">initializeBean</span><span class="hljs-params">(String beanName, Object bean, <span class="hljs-meta">@Nullable</span> RootBeanDefinition mbd)</span> </span>&#123;<br>	<span class="hljs-comment">//调用回调</span><br>	invokeAwareMethods(beanName, bean);<br>	Object wrappedBean = bean;<br>	<span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span> || !mbd.isSynthetic()) &#123;<br>		wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);<br>	&#125;<br>	<span class="hljs-keyword">try</span> &#123;<br>		invokeInitMethods(beanName, wrappedBean, mbd);<br>	&#125;<br>	<span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException((mbd != <span class="hljs-keyword">null</span> ? mbd.getResourceDescription() : <span class="hljs-keyword">null</span>), beanName, <span class="hljs-string">&quot;Invocation of init method failed&quot;</span>, ex);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span> || !mbd.isSynthetic()) &#123;<br>		wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);<br>	&#125;<br>	<span class="hljs-keyword">return</span> wrappedBean;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getSingleton</span><span class="hljs-params">(String beanName, <span class="hljs-keyword">boolean</span> allowEarlyReference)</span> </span>&#123;<br>	<span class="hljs-comment">// 快速检查没有完整单例锁的现有实例</span><br>	Object singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);<br>    <span class="hljs-comment">//判断指定的单例bean当前是否正在创建中（在整个工厂内）。</span><br>	<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;<br>		singletonObject = <span class="hljs-keyword">this</span>.earlySingletonObjects.get(beanName);<br>		<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span> &amp;&amp; allowEarlyReference) &#123;<br>            <span class="hljs-comment">//加锁保证有且只有一条线程创建成功</span><br>			<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.singletonObjects) &#123;<br>                <span class="hljs-comment">// 没错这里就是解决依赖循环应用的关键了</span><br>				<span class="hljs-comment">// 在完整单例锁中一致创建早期引用</span><br>				singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);<span class="hljs-comment">//一级缓存中查找</span><br>				<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//一级缓存没有找到进入二级缓存查找</span><br>					singletonObject = <span class="hljs-keyword">this</span>.earlySingletonObjects.get(beanName);<span class="hljs-comment">//二级缓存中查找</span><br>					<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//二级缓存没有找到意味着bean还没有实例化，尝试进行实例化</span><br>                        <span class="hljs-comment">//获取该bean的bean工厂</span><br>						ObjectFactory&lt;?&gt; singletonFactory = <span class="hljs-keyword">this</span>.singletonFactories.get(beanName);<br>						<span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//如果该bean工厂存在则进行获取bean</span><br>							singletonObject = singletonFactory.getObject();<span class="hljs-comment">//从bean工厂中s</span><br>							<span class="hljs-keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);<span class="hljs-comment">//加入二级缓存</span><br>							<span class="hljs-keyword">this</span>.singletonFactories.remove(beanName);<span class="hljs-comment">//从一级缓存中移除</span><br>						&#125;<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> singletonObject;<span class="hljs-comment">//返回bean实例</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="-2"><a href="#-2" class="headerlink" title=""></a></h4><p>1.2.8.15 finishRefresh()</p>
<blockquote>
<p>最后一步：发布相应的事件</p>
</blockquote>
<p>DefaultSingletonBeanRegistry<br> </p>
<h2 id="1-3-流程图"><a href="#1-3-流程图" class="headerlink" title="1.3 流程图"></a>1.3 流程图</h2><p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/2630542/1656431125319-0ddf2542-edc2-41e4-8281-24f0dc0778f1.jpeg" srcset="/img/loading.gif" lazyload></p>
<h1 id="对象生命周期"><a href="#对象生命周期" class="headerlink" title="对象生命周期"></a>对象生命周期</h1><h2 id="五大阶段"><a href="#五大阶段" class="headerlink" title="五大阶段"></a>五大阶段</h2><ol>
<li><strong>创建准备：</strong></li>
</ol>
<p>通过获取注解配置、XML配置的相关Bean定义</p>
<ol start="2">
<li><strong>创建实例：</strong></li>
</ol>
<p>通过反射进行实例化对象，根据配置情况调用 Bean 构造方法或工厂方法实例化 Bean</p>
<ol start="3">
<li><strong>依赖注入：</strong></li>
</ol>
<blockquote>
<p>利用依赖注入完成 Bean 中所有属性值的配置注入，如果存在依赖则寻找依赖，通过三级缓存，提前曝光方式解决</p>
</blockquote>
<p><strong>Aware接口</strong></p>
<ul>
<li>如果 Bean 实现了 BeanNameAware 接口，则 Spring 调用 Bean 的 setBeanName() 方法传入当前 Bean 的 id 值。</li>
<li>如果 Bean 实现了 BeanFactoryAware 接口，则 Spring 调用 setBeanFactory() 方法传入当前工厂实例的引用。</li>
<li>如果 Bean 实现了 ApplicationContextAware 接口，则 Spring 调用 setApplicationContext() 方法传入当前 ApplicationContext 实例的引用。</li>
</ul>
<p><strong>BeanPostProcessor 前置处理</strong></p>
<p>如果 BeanPostProcessor 和 Bean 关联，则 Spring 将调用该接口的预初始化方法 postProcess<strong>Before</strong>Initialzation() 对 Bean 进行加工操作，Spring 的 AOP 就是利用它实现的。</p>
<p><strong>初始化方法</strong></p>
<p>如果 Bean 实现了 InitializingBean 接口，则 Spring 将调用 afterPropertiesSet() 方法。<br>如果在配置文件中通过 init-method 属性指定了初始化方法，则调用该初始化方法。</p>
<p><strong>BeanPostProcessor 后置处理</strong></p>
<p>如果 BeanPostProcessor 和 Bean 关联，则 Spring 将调用该接口的初始化方法 postProcess<strong>After</strong>Initialization()。此时，Bean 已经可以被应用系统使用了。</p>
<ol start="4">
<li><strong>容器缓存：</strong></li>
</ol>
<ul>
<li>如果指定了该 Bean 的作用范围为 scope=”singleton”，则将该 Bean 放入 Spring IOC 的缓存池中，将触发 Spring 对该 Bean 的生命周期管理；</li>
<li>如果指定了该 Bean 的作用范围为 scope=”prototype”，则将该 Bean 交给调用者，调用者管理该 Bean 的生命周期，Spring 不再管理该 Bean。</li>
</ul>
<ol start="5">
<li><strong>销毁实例：</strong></li>
</ol>
<p>如果 Bean 实现了 DisposableBean 接口，则 Spring 会调用 destory() 方法将 Spring 中的 Bean 销毁；如果在配置文件中通过 destory-method 属性指定了 Bean 的销毁方法，则 Spring 将调用该方法对 Bean 进行销毁</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/2630542/1667118753350-b276f6ac-3166-453d-9570-e976d04cfd45.jpeg" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br>public class SpringBeanLife implements BeanNameAware, ApplicationContextAware, InitializingBean, DisposableBean &#123;<br><br>    private String name;<br><br>    public <span class="hljs-function"><span class="hljs-title">SpringBeanLife</span></span>() &#123;<br>        System.out.println(<span class="hljs-string">&quot;第一步：实例化类&quot;</span>);<br>    &#125;<br><br>    public void setName(String name) &#123;<br>        System.out.println(<span class="hljs-string">&quot;第二步：设置属性&quot;</span>);<br>        this.name = name;<br>    &#125;<br><br>    @Override<br>    public void setBeanName(String s) &#123;<br>        System.out.println(<span class="hljs-string">&quot;第三步：设置bean的名称也就是spring容器中的名称，也就是id值&quot;</span> + name);<br>    &#125;<br><br>    @Override<br>    public void setApplicationContext(ApplicationContext applicationContext) &#123;<br>        System.out.println(<span class="hljs-string">&quot;第四步：了解工厂信息ApplicationContext&quot;</span>);<br>    &#125;<br>    //第五步执行初始化之前执行的方法<br>    @Override<br>    public void afterPropertiesSet() throws Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;第六步：属性设置后执行的方法&quot;</span>);<br>    &#125;<br><br>    public void <span class="hljs-function"><span class="hljs-title">setup</span></span>() &#123;<br>        System.out.println(<span class="hljs-string">&quot;第七步：执行自己配置的初始化方法&quot;</span>);<br>    &#125;<br><br>    //第八步执行初始化之后执行的方法<br>    public void <span class="hljs-function"><span class="hljs-title">biz</span></span>() &#123;<br>        System.out.println(<span class="hljs-string">&quot;第九步：执行自身的业务方法&quot;</span>);<br>    &#125;<br><br>    @Override<br>    public void <span class="hljs-function"><span class="hljs-title">destroy</span></span>() &#123;<br>        System.out.println(<span class="hljs-string">&quot;第十步：执行spring的销毁方法&quot;</span>);<br>    &#125;<br><br>    public void <span class="hljs-function"><span class="hljs-title">customDestroyMethod</span></span>() &#123;<br>        System.out.println(<span class="hljs-string">&quot;第十一步：执行自己配置的销毁方法&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="循环依赖分析"><a href="#循环依赖分析" class="headerlink" title="循环依赖分析"></a>循环依赖分析</h1><blockquote>
<p>循环依赖指的是在创建Bean的过程中，Bean A中有Bean B作为属性，而Bean B中又有Bean作为属性，此时创建Bean A过程中需要先去创建Bean B，而创建Bean B的过程中又发现需要先创建Bean A，造型循环依赖。</p>
</blockquote>
<h2 id="三种循环依赖"><a href="#三种循环依赖" class="headerlink" title="三种循环依赖"></a>三种循环依赖</h2><ul>
<li>构造器的循环依赖：这种依赖spring是处理不了的，直接抛出BeanCurrentlylnCreationException异常。</li>
<li>单例模式下的setter循环依赖：通过“三级缓存”处理循环依赖，能处理。</li>
<li>非单例循环依赖：无法处理。原型(Prototype)的场景是不支持循环依赖的，通常会走到AbstractBeanFactory类中下面的判断，抛出异常。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;  <br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName);<br>&#125;<br></code></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="三级对象缓存"><a href="#三级对象缓存" class="headerlink" title="三级对象缓存"></a>三级对象缓存</h2><p>那Spring中是如何解决这个问题的？我们先来看看在getSingleton获取bean的方法</p>
<p>我们需要先了解一下spring的三级缓存</p>
<ul>
<li><p>一级缓存为：singletonObjects；中缓存的是已经经历了完整生命周期的bean对象。</p>
</li>
<li><p>二级缓存为：earlySingletonObjects；比 singletonObjects 多了一个 early ，表示缓存的是早期的 bean对象。早期指的是 Bean 的生命周期还没走完就把这个 Bean 放入了 earlySingletonObjects。</p>
</li>
<li><p>三级缓存为：singletonFactories；中缓存的是 ObjectFactory，表示对象工厂，主要用来去生成原始对象进行了 AOP之后得到的「代理对象」，在每个 Bean 的生成过程中，都会提前暴露一个工厂，这个工厂可能用到，也可能用不到，如果没有出现循环依赖依赖本 bean，那么这个工厂无用，本 bean 按照自己的生命周期执行，执行完后直接把本 bean 放入 singletonObjects 中即可，如果出现了循环依赖依赖了本 bean，则另外那个 bean 执行 ObjectFactory 提交得到一个 AOP 之后的代理对象（如果有 AOP 的话，如果无需 AOP ，则直接得到一个原始对象）。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getSingleton</span><span class="hljs-params">(String beanName)</span> </span>&#123;<br>    <span class="hljs-comment">//缺省为允许bean提前曝光</span><br>	<span class="hljs-keyword">return</span> getSingleton(beanName, <span class="hljs-keyword">true</span>);<br>&#125;<br><span class="hljs-comment">//判断bean是否正在创建中</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isSingletonCurrentlyInCreation</span><span class="hljs-params">(String beanName)</span> </span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.singletonsCurrentlyInCreation.contains(beanName);<br>&#125;<br><span class="hljs-comment">//获取bean方法</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getSingleton</span><span class="hljs-params">(String beanName, <span class="hljs-keyword">boolean</span> allowEarlyReference)</span> </span>&#123;<br>	<span class="hljs-comment">// 快速检查没有完整单例实例</span><br>	Object singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);<br>    <span class="hljs-comment">// 判断指定的单例bean当前是否正在创建中（在整个工厂内）。</span><br>	<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;<br>        <span class="hljs-comment">//如果一级缓存中没有且当前bean正在创建中，则尝试去二级缓存中获取</span><br>		singletonObject = <span class="hljs-keyword">this</span>.earlySingletonObjects.get(beanName);<br>        <span class="hljs-comment">//如果二级缓存也没有且允许提前曝光</span><br>		<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span> &amp;&amp; allowEarlyReference) &#123;<br>            <span class="hljs-comment">//加锁保证有且只有一条线程创建成功</span><br>			<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.singletonObjects) &#123;<br>				singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);<span class="hljs-comment">//有可能其他线程已经创建过了，所以这里需要再次从一级缓存中查找</span><br>				<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//一级缓存没有找到进入二级缓存查找</span><br>					singletonObject = <span class="hljs-keyword">this</span>.earlySingletonObjects.get(beanName);<span class="hljs-comment">//二级缓存中查找</span><br>					<span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//二级缓存没有找到意味着bean还没有实例化，尝试进行实例化</span><br>                        <span class="hljs-comment">//从三级缓存中获取该bean的bean工厂</span><br>						ObjectFactory&lt;?&gt; singletonFactory = <span class="hljs-keyword">this</span>.singletonFactories.get(beanName);<br>						<span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//如果该bean工厂存在则进行获取bean</span><br>							singletonObject = singletonFactory.getObject();<span class="hljs-comment">//从bean工厂中获取该bean，主要此时的bean并没有完成创建，相当于只是得到这个bean的引用而以，打破bean的循环依赖</span><br>							<span class="hljs-keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);<span class="hljs-comment">//加入二级缓存</span><br>							<span class="hljs-keyword">this</span>.singletonFactories.remove(beanName);<span class="hljs-comment">//从三级级缓存中移除</span><br>						&#125;<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> singletonObject;<span class="hljs-comment">//返回bean实例</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>既然构成了循环那我们只要打破其中一个路径即可阻断循环，spring也是这么处理的</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/2630542/1654165300341-5ea7f309-685f-4e8e-8019-ce3721a5bd9e.jpeg" srcset="/img/loading.gif" lazyload></p>
<p>结论：Spring中通过三级缓存解决循环依赖问题，通过提前曝光bean在二级缓存（<strong>earlySingletonObjects</strong>）中，需要引用的对象之间可以在缓存中获取，阻断了循环去创建的发生。</p>
<h2 id="singletonFactories"><a href="#singletonFactories" class="headerlink" title="singletonFactories"></a><strong>singletonFactories</strong></h2><p>既然一个earlySigletonObjects缓存就可以解决循环依赖的问题了，为什么还需要<strong>singletonFactories</strong>呢？</p>
<p>这个时候我们就要来考虑一下这种情况：</p>
<blockquote>
<p>如果对象A的原始对象注入对象B（对象B提前曝光了）的属性之后，A的原始对象进行AOP产生了一个代理对象，此时对于A而言A的对象其实应该是他AOP后的对象，而B的属性对于的是A的原始对象，并不是AOP后的代理对象，此时出现问题。</p>
</blockquote>
<p><strong>我们先看看singletonFactories缓存是什么时候加入的</strong></p>
<p><strong>1.doCreateBean</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> <span class="hljs-keyword">throws</span> BeanCreationException </span>&#123;<br>		<span class="hljs-comment">// Instantiate the bean.</span><br>		BeanWrapper instanceWrapper = <span class="hljs-keyword">null</span>;<br>		<span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<span class="hljs-comment">//如果是single类型将其在factoryBean缓存中移除</span><br>			instanceWrapper = <span class="hljs-keyword">this</span>.factoryBeanInstanceCache.remove(beanName);<br>		&#125;<br>		<span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">//不是factoryBean，创建bean实例</span><br>			<span class="hljs-comment">//这里是创建实例化对象</span><br>			instanceWrapper = createBeanInstance(beanName, mbd, args);<br>		&#125;<br>        <span class="hljs-comment">//看这里看这里，考试要考的，这里通过实例包装类获取实例，我们要根据它去获取提前曝光的引用</span><br>		Object bean = instanceWrapper.getWrappedInstance();<br>		Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();<br>		<span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;<br>			mbd.resolvedTargetType = beanType;<br>		&#125;<br>		<span class="hljs-comment">// 允许后处理器修改合并的bean定义</span><br>		<span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;<br>			<span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;<br>				<span class="hljs-keyword">try</span> &#123;<br>					applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);<br>				&#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);<br>				&#125;<br>				mbd.postProcessed = <span class="hljs-keyword">true</span>;<br>			&#125;<br>		&#125;<br>        <span class="hljs-comment">//这里主要是为了获取当前这个正在创建的对象是否允许提前曝光，如果允许，则直接添加一个 ObjectFactory 到三级缓存</span><br>        <span class="hljs-comment">//其中this.allowCircularReferences的默认值是true，也就是说默认允许提前曝光来解决循环依赖的问题</span><br>		<span class="hljs-keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="hljs-keyword">this</span>.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName));<br>		<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>			<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;<br>				logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);<br>			&#125;<br>            <span class="hljs-comment">//看这里！看这里！看这里！这里添加进三级缓存，先获取bean的EarlyBeanReference，然后加入三级缓存</span><br>			addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));<br>		&#125;<br><br>		<span class="hljs-comment">// Initialize the bean instance.</span><br>		Object exposedObject = bean;<br>		<span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//填充属性</span><br>			populateBean(beanName, mbd, instanceWrapper);<br>            <span class="hljs-comment">//处理bean的创建完成的回调,执行初始化（如afterPropertiesSet）方法且创建代理</span><br>			exposedObject = initializeBean(beanName, exposedObject, mbd);<br>		&#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>			<span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;<br>				<span class="hljs-keyword">throw</span> (BeanCreationException) ex;<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Initialization of bean failed&quot;</span>, ex);<br>			&#125;<br>		&#125;<br>        <span class="hljs-comment">//如果是提前曝光的bean则尝试去一级缓存看看有没有实例化好</span><br>		<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;<br>			Object earlySingletonReference = getSingleton(beanName, <span class="hljs-keyword">false</span>);<br>            <span class="hljs-comment">//如果一级缓存中有了，则改bean已经初始化好了</span><br>			<span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-keyword">null</span>) &#123;<br>				<span class="hljs-keyword">if</span> (exposedObject == bean) &#123;<br>					exposedObject = earlySingletonReference;<br>				&#125;<br>                <span class="hljs-comment">//否则判断它是否有依赖的bean，有则尝试去获取实际依赖的bean</span><br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;<br>					String[] dependentBeans = getDependentBeans(beanName);<br>					Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(dependentBeans.length);<br>					<span class="hljs-keyword">for</span> (String dependentBean : dependentBeans) &#123;<br>						<span class="hljs-keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;<br>							actualDependentBeans.add(dependentBean);<br>						&#125;<br>					&#125;<br>					<span class="hljs-keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;<br>						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCurrentlyInCreationException(beanName,<br>								<span class="hljs-string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; has been injected into other beans [&quot;</span> +<br>								StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +<br>								<span class="hljs-string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +<br>								<span class="hljs-string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +<br>								<span class="hljs-string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +<br>								<span class="hljs-string">&quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);<br>					&#125;<br>				&#125;<br>			&#125;<br>		&#125;<br><br>		<span class="hljs-comment">// Register bean as disposable.</span><br>		<span class="hljs-keyword">try</span> &#123;<br>			registerDisposableBeanIfNecessary(beanName, bean, mbd);<br>		&#125; <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, ex);<br>		&#125;<br>		<span class="hljs-keyword">return</span> exposedObject;<br>	&#125;<br></code></pre></td></tr></table></figure>
<p>在上面的代码中我们可以看到，在创建当前bean的实例后（只是实例化了还没有初始化），判断是否可以提前曝光，如果可以提前曝光则把当前bean的ObjectFactory（包装了当前bean）放入三级缓存中去（singletonFactories）。</p>
<p>为什么不直接把这个bean引用放进去呢？回到上面我们考虑的情况，如果创建的 Bean 是有代理的，那么注入的就应该是代理 Bean，而不是原始的 Bean。但是 Spring 一开始并不知道 Bean 是否会有循环依赖，通常情况下（没有循环依赖的情况下），Spring 都会在完成填充属性，并且执行完初始化方法之后再为其创建代理。但是，如果出现了循环依赖的话，Spring 就不得不为其提前创建代理对象，否则注入的就是一个原始对象，而不是代理对象。因此，这里就涉及到应该在哪里提前创建代理对象？<br>Spring 的做法就是在 ObjectFactory 中去提前创建代理对象。<strong>它会执行 getObject() 方法来获取到 Bean</strong>。</p>
<p><strong>2.获取bean的早期引用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//获取提前访问指定bean的引用</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getEarlyBeanReference</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, Object bean)</span> </span>&#123;<br>	Object exposedObject = bean;<br>	<span class="hljs-comment">//isSynthetic返回此bean定义是否为“合成”，即不是由应用程序本身定义的。</span><br>	<span class="hljs-comment">//hasInstantiationAwareBeanPostProcessors是但其bean的所有bpp</span><br>	<span class="hljs-keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;<br>		<span class="hljs-keyword">for</span> (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) &#123;<br>            <span class="hljs-comment">// 如果需要代理，这里会返回代理对象；否则返回原始对象</span><br>			exposedObject = bp.getEarlyBeanReference(exposedObject, beanName);<br>		&#125;<br>	&#125;<br>	<span class="hljs-comment">//返回提前曝光的bean引用</span><br>	<span class="hljs-keyword">return</span> exposedObject;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>3.创建代理类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//获取Bean的早期引用</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getEarlyBeanReference</span><span class="hljs-params">(Object bean, String beanName)</span> </span>&#123;<br>	Object cacheKey = getCacheKey(bean.getClass(), beanName);<br>    <span class="hljs-comment">// 记录已被代理的对象</span><br>	<span class="hljs-keyword">this</span>.earlyProxyReferences.put(cacheKey, bean);<br>	<span class="hljs-keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);<br>&#125;<br><span class="hljs-comment">//获取缓存的key</span><br><span class="hljs-comment">//FACTORY_BEAN_PREFIX = &quot;&amp;&quot;;</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getCacheKey</span><span class="hljs-params">(Class&lt;?&gt; beanClass, <span class="hljs-meta">@Nullable</span> String beanName)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span> (StringUtils.hasLength(beanName)) &#123;<br>		<span class="hljs-keyword">return</span> (FactoryBean.class.isAssignableFrom(beanClass) ? BeanFactory.FACTORY_BEAN_PREFIX + beanName : beanName);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">return</span> beanClass;<br>	&#125;<br>&#125;<br><span class="hljs-comment">//对早期引用进行包装</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">wrapIfNecessary</span><span class="hljs-params">(Object bean, String beanName, Object cacheKey)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="hljs-keyword">this</span>.targetSourcedBeans.contains(beanName)) &#123;<br>		<span class="hljs-keyword">return</span> bean;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (Boolean.FALSE.equals(<span class="hljs-keyword">this</span>.advisedBeans.get(cacheKey))) &#123;<br>		<span class="hljs-keyword">return</span> bean;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;<br>		<span class="hljs-keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br>		<span class="hljs-keyword">return</span> bean;<br>	&#125;<br><br>	<span class="hljs-comment">// 为切面创建代理类</span><br>	Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="hljs-keyword">null</span>);<br>	<span class="hljs-keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;<br>		<span class="hljs-keyword">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);<br>		Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors, <span class="hljs-keyword">new</span> SingletonTargetSource(bean));<br>		<span class="hljs-keyword">this</span>.proxyTypes.put(cacheKey, proxy.getClass());<br>		<span class="hljs-keyword">return</span> proxy;<br>	&#125;<br><br>	<span class="hljs-keyword">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br>	<span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>4.添加进三级缓存</strong></p>
<blockquote>
<p>从doCreateBean代码第十三行中可以看到，传递过来的是一个匿名函数</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addSingletonFactory</span><span class="hljs-params">(String beanName, ObjectFactory&lt;?&gt; singletonFactory)</span> </span>&#123;<br>		Assert.notNull(singletonFactory, <span class="hljs-string">&quot;Singleton factory must not be null&quot;</span>);<br>		<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.singletonObjects) &#123;<br>			<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.singletonObjects.containsKey(beanName)) &#123;<span class="hljs-comment">//确保一级缓存没有该bean</span><br>				<span class="hljs-keyword">this</span>.singletonFactories.put(beanName, singletonFactory);<span class="hljs-comment">//添加进三级缓存</span><br>				<span class="hljs-keyword">this</span>.earlySingletonObjects.remove(beanName);<span class="hljs-comment">//确保一级缓存没有该bean</span><br>				<span class="hljs-keyword">this</span>.registeredSingletons.add(beanName);<br>			&#125;<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>


<p><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/2630542/1654238875533-c435a3ec-c457-486c-b7ec-43fba0cea49a.jpeg" srcset="/img/loading.gif" lazyload></p>
<h2 id="无法解决的循环依赖问题"><a href="#无法解决的循环依赖问题" class="headerlink" title="无法解决的循环依赖问题"></a>无法解决的循环依赖问题</h2><ul>
<li>在主bean中通过构造函数注入所依赖的bean。在上面的分析中都是预<strong>先执行构造函数</strong>获取实例，再将ObjectFactory加入三级缓存，如果是通过构造器注入，此时缓存中还没有对应的缓存，则实例化无法完成，失败。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>当存在循环依赖时，主bean对象不能通过构造函数的方式注入所依赖的bean对象，而所依赖的bean对象则不受限制，即可以通过三种注入方式的任意一种注入主bean对象。</p>
</blockquote>
<blockquote>
<p>如果主bean对象通过构造函数方式注入所依赖的bean对象，则无论所依赖的bean对象通过何种方式注入主bean，都无法解决循环依赖问题，程序无法启动。(其实在主bean加上@Lazy也能解决)</p>
</blockquote>
<h1 id="相关参考资料"><a href="#相关参考资料" class="headerlink" title="相关参考资料"></a>相关参考资料</h1><p><a target="_blank" rel="noopener" href="https://javadoop.com/post/spring-ioc">Spring核心IOC的源码分析</a></p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="category-chain-item">源码分析</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Spring/">#Spring</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>源码学习-Spring 源码分析</div>
      <div>https://mikeygithub.github.io/2022/02/28/yuque/gx3k97/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Mikey</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年2月28日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/03/01/yuque/pi1xft/" title="学习笔记-GraphQL">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">学习笔记-GraphQL</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/20/yuque/pea42q/" title="数据结构-Skip List 跳表">
                        <span class="hidden-mobile">数据结构-Skip List 跳表</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'mikeygithub/commit-utterance');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.13.10/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});
  });
</script>




  <!-- Custom -->
  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="https://octodex.github.com/images/jetpacktocat.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       Copyright © 麦奇 Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> and <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> core on github page 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      桂ICP备2020009931号-1
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=2020009931"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>桂公网安备2020009931号</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?74301a15e5497361e93588eeee69f4b2";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        MathJax = {
          tex    : {
            inlineMath: { '[+]': [['$', '$']] }
          },
          loader : {
            load: ['ui/lazy']
          },
          options: {
            renderActions: {
              findScript    : [10, doc => {
                document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                  const display = !!node.type.match(/; *mode=display/);
                  const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                  const text = document.createTextNode('');
                  node.parentNode.replaceChild(text, node);
                  math.start = { node: text, delim: '', n: 0 };
                  math.end = { node: text, delim: '', n: 0 };
                  doc.math.push(math);
                });
              }, '', false],
              insertedScript: [200, () => {
                document.querySelectorAll('mjx-container').forEach(node => {
                  let target = node.parentNode;
                  if (target.nodeName.toLowerCase() === 'li') {
                    target.parentNode.classList.add('has-jax');
                  }
                });
              }, '', false]
            }
          }
        };
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.0/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
