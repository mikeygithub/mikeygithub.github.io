

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer"/>
  <link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/favicon.png">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Mikey">
  <meta name="keywords" content="">
  
    <meta name="description" content="Kubernetes之所以同时支持Docker和Rocket这两种互相竞争的容器技术，是有深刻的历史原因的。快速发展的Docker打败了谷歌名噪-时的开源容器技术Imtfy,并迅速风摩世界。但是，作为-个已经对全球IT公司产生重要影响的技术，Docker容器标准的制定不可能被任何-个公司主导。于是，CoreOS推出 了与Docker抗衡的开源容器项目Rocket,动员一些知名IT公司-起主导容器技">
<meta property="og:type" content="article">
<meta property="og:title" content="云原生篇-Kubernetes权威指南">
<meta property="og:url" content="https://mikeygithub.github.io/2021/05/22/yuque/bbm2v9/index.html">
<meta property="og:site_name" content="麦奇">
<meta property="og:description" content="Kubernetes之所以同时支持Docker和Rocket这两种互相竞争的容器技术，是有深刻的历史原因的。快速发展的Docker打败了谷歌名噪-时的开源容器技术Imtfy,并迅速风摩世界。但是，作为-个已经对全球IT公司产生重要影响的技术，Docker容器标准的制定不可能被任何-个公司主导。于是，CoreOS推出 了与Docker抗衡的开源容器项目Rocket,动员一些知名IT公司-起主导容器技">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/2630542/1621697700831-44a13224-7288-4922-b9ad-193cdd83467a.png">
<meta property="article:published_time" content="2021-05-22T15:24:22.000Z">
<meta property="article:modified_time" content="2023-03-19T04:09:04.994Z">
<meta property="article:author" content="Mikey">
<meta property="article:tag" content="Kubernetes">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2021/png/2630542/1621697700831-44a13224-7288-4922-b9ad-193cdd83467a.png">
  
  
<!--    <meta name="referrer" content="no-referrer-when-downgrade">-->
  
  
  <title>云原生篇-Kubernetes权威指南 - 麦奇</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"mikeygithub.github.io","root":"/","version":"1.9.1","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":200}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"74301a15e5497361e93588eeee69f4b2","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="麦奇" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>麦奇</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/photo/">
                <i class="iconfont icon-image"></i>
                照片
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/music/">
                <i class="iconfont icon-music"></i>
                音乐
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss"></i>
                RSS
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="云原生篇-Kubernetes权威指南"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Mikey
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-05-22 23:24" pubdate>
          2021年5月22日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          61k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          511 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">云原生篇-Kubernetes权威指南</h1>
            
            <div class="markdown-body">
              
              <p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1621697700831-44a13224-7288-4922-b9ad-193cdd83467a.png#averageHue=%23f9f8fb&clientId=u786613b4-8b95-4&from=paste&height=428&id=u836f86fc&name=image.png&originHeight=428&originWidth=813&originalType=binary&ratio=1&rotation=0&showTitle=false&size=392974&status=done&style=none&taskId=u7397687f-348e-486f-a119-8d443230440&title=&width=813" srcset="/img/loading.gif" lazyload alt="image.png"><br>Kubernetes之所以同时支持Docker和Rocket这两种互相竞争的容器技术，是有深刻的历史原因的。快速发展的Docker打败了谷歌名噪-时的开源容器技术Imtfy,并迅速风摩世界。但是，作为-个已经对全球IT公司产生重要影响的技术，Docker容器标准的制定不可能被任何-个公司主导。于是，CoreOS推出 了与Docker抗衡的开源容器项目Rocket,动员一些知名IT公司-起主导容器技术的标准化，并与谷歌共同发起基于CoreOS+Rocket+Kubernetes的新项 目Tectonic, 使容器技术分裂态势加剧。最后，Linux基 金会于2015年6月宜布成立开放容器技术项目。</p>
<h1 id="Kubernetes入门"><a href="#Kubernetes入门" class="headerlink" title="Kubernetes入门"></a>Kubernetes入门</h1><h2 id="Kubernetes是什么"><a href="#Kubernetes是什么" class="headerlink" title="Kubernetes是什么"></a>Kubernetes是什么</h2><blockquote>
<p>他是一个全新的基于容器技术的分布式架构解决方案。确切地说，Kubernetes是谷歌严格保密十几年的秘密武器—Borg的一个开源版本。</p>
</blockquote>
<p>Kubernetes是-个完备的分布式系统支撑平台。Kubernetes具有完备的集群管理能力，包括多层次的安全防护和准入机制、多租户应用支撑能力、透明的服务注册和服务发现机制、内建的智能负载均衡器、强大的故障发现和自我修复能力、服务滚动升级和在线扩容能力、可扩展的资源自动调度机制，以及多粒度的资源配额管理能力。同时, Kubernetes提供了完善的管理工具，这些工具涵盖了包括开发、部署测试、运维监控在内的各个环节。因此，Kubernetes是一个全新的基于容器技术的分布式架构解决方案，并且是一个一站式的完备的分布式系统开发和支撑平台。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622015650517-20e874aa-b24c-4cb0-9795-b7ad0fd90b28.png#averageHue=%23707070&clientId=u8daca5e1-04c4-4&from=paste&height=1984&id=u94dd642c&name=image.png&originHeight=1984&originWidth=2409&originalType=binary&ratio=1&rotation=0&showTitle=false&size=324401&status=done&style=none&taskId=u971334fd-13c0-4491-bf84-0feefe16a2a&title=&width=2409" srcset="/img/loading.gif" lazyload alt="image.png"><br>特性：</p>
<ul>
<li><p>Service的服务进程目前都基于Socket通信方式对外提供服务，比如Redis、Memcache、MySQL、Web Server，或者是实现了某个具体业务的特定TCP Server进程。虽然一个Service通常由多个相关的服务进程提供服务，每个服务进程都有一个独立的Endpoint（IP+Port）访问点，但 Kubernetes能够让我们通过Service（虚拟Cluster IP +Service Port）连接到指定的Service。</p>
</li>
<li><p>容器提供了强大的隔离功能，所以有必要把为Service提供服务的这组进程放入容器中进行隔离。为此，Kubernetes设计了Pod对象，将每个服务进程都包装到相应的Pod中，使其成为在Pod中运行的一个容器 （Container）。为了建立Service和Pod间的关联关系，Kubernetes首先给每个Pod都贴上一个标签（Label），给运行MySQL的Pod贴上name=mysql标签，给运行PHP的Pod贴上name=php标签，然后给相应的Service定义标签选择器（Label Selector），比如MySQL Service的标签选择器的选择条件为name=mysql，意为该Service要作用于所有包含name=mysql Label的Pod。这样一来，就巧妙解决了Service与Pod的关联问题。</p>
</li>
</ul>
<h2 id="为什么要用Kubernetes"><a href="#为什么要用Kubernetes" class="headerlink" title="为什么要用Kubernetes"></a>为什么要用Kubernetes</h2><ul>
<li>降低协作难度，减少运维成本。</li>
<li>无需关注语言本身，完全面向微服务化架构。</li>
<li>自动弹性扩容，应对大流量。</li>
</ul>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><blockquote>
<p>Kubernetes中的大部分概念如Node、Pod、Replication Controller、Service等都可以被看作一种资源对象，几乎所有资源对象都可以通过Kubernetes提供的kubectl工具（或者API编程调用）执行增、删、改、查等操作并将其保存在etcd中持久化存储。</p>
</blockquote>
<h3 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h3><blockquote>
<p>集群控制节点，Kubernetes的所有控制命令都发给它，它负责具体的执行过程。Master通常会占据一个<br>独立的服务器（高可用部署建议用3台服务器），主要原因是它太重要了，是整个集群的“首脑”，如果它宕机或者不可用，那么对集群内容器应用的管理都将失效。 </p>
</blockquote>
<p>在Master上运行着以下关键进程。 </p>
<ul>
<li>Kubernetes API Server（kube-apiserver）：提供了HTTP Rest接口的关键服务进程，是Kubernetes里所有资源的增、删、改、查等操作的唯一入口，也是集群控制的入口进程。 </li>
<li>Kubernetes Controller Manager（kube-controller-manager）： Kubernetes里所有资源对象的自动化控制中心，可以将其理解为资源对象的“大总管”。 </li>
<li>Kubernetes Scheduler（kube-scheduler）：负责资源调度（Pod调度）的进程，相当于公交公司的“调度室”。 </li>
</ul>
<p>另外，在Master上通常还需要部署etcd服务，因为Kubernetes里的所有资源对象的数据都被保存在etcd中。</p>
<h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><blockquote>
<p>每个Node都会被Master分配一些工作负载（Docker容器），当某个Node宕机时，其上的工作负载会被Master自动转移到其他节点上。 </p>
</blockquote>
<p>在每个Node上都运行着以下关键进程。 </p>
<ul>
<li> kubelet：负责Pod对应的容器的创建、启停等任务，同时与Master密切协作，实现集群管理的基本功能。 </li>
<li> kube-proxy：实现Kubernetes Service的通信与负载均衡机制的重要组件。 </li>
<li>Docker Engine（docker）：Docker引擎，负责本机的容器创建和管理工作。 </li>
</ul>
<p>查看所有node列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">kubectl get nodes<br></code></pre></td></tr></table></figure>
<p>查看某个node的具体信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">kubectl describe node &lt;node_name&gt;<br></code></pre></td></tr></table></figure>
<p>展示了Node的如下关键信息：</p>
<ul>
<li>Node的基本信息：名称、标签、创建时间等。 </li>
<li>Node当前的运行状态：Node启动后会做一系列的自检工作比如磁盘空间是否不足（DiskPressure）、内存是否不足 （MemoryPressure）、网络是否正常（NetworkUnavailable）、PID资源是否充足（PIDPressure）。在一切正常时设置Node为Ready状态 （Ready=True），该状态表示Node处于健康状态，Master将可以在其上调度新的任务了（如启动Pod）。 </li>
<li>Node的主机地址与主机名。 </li>
<li>Node上的资源数量：描述Node可用的系统资源，包括CPU、 内存数量、最大可调度Pod数量等。 </li>
<li>Node可分配的资源量：描述Node当前可用于分配的资源量。 </li>
<li>主机系统信息：包括主机ID、系统UUID、Linux kernel版本号、操作系统类型与版本、Docker版本号、kubelet与kube-proxy的版本号等。</li>
<li>当前运行的Pod列表概要信息。 </li>
<li>已分配的资源使用概要信息，例如资源申请的最低、最大允许使用量占系统总量的百分比。</li>
<li>Node相关的Event信息。</li>
</ul>
<h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><blockquote>
<p>其根基容器为Pause</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622990490782-c6ceac53-4451-4539-9c58-815f98fcb223.png#averageHue=%23bcc8c4&clientId=ufe2744ca-714f-4&from=paste&height=306&id=u928918a6&name=image.png&originHeight=306&originWidth=436&originalType=binary&ratio=1&rotation=0&showTitle=false&size=64551&status=done&style=none&taskId=ub3f06974-7b80-4681-9984-5226df76f6c&title=&width=436" srcset="/img/loading.gif" lazyload alt="image.png"><br>Kubernetes为每个Pod都分配了唯一的IP地址，称之为Pod IP，一个Pod里的多个容器共享Pod IP地址。Kubernetes要求底层网络支持集群内任意两个Pod之间的TCP/IP直接通信，这通常采用虚拟二层网络技术来<br>实现，例如Flannel、Open vSwitch等，因此我们需要牢记一点：在Kubernetes里，一个Pod里的容器与另外主机上的Pod容器能够直接通信。</p>
<p>Pod其实有两种类型：普通的Pod及静态Pod（Static Pod）。后者比较特殊，它并没被存放在Kubernetes的etcd存储里，而是被存放在某个具体的Node上的一个具体文件中，并且只在此Node上启动、运行。而普通的Pod一旦被创建，就会被放入etcd中存储，随后会被Kubernetes Master调度到某个具体的Node上并进行绑定（Binding），随后该Pod被对应的Node上的kubelet进程实例化成一组相关的Docker容器并启动。在默认情况下，当Pod里的某个容器停止时，Kubernetes会自动检测到这个问题并且重新启动这个Pod（重启Pod里的所有容器），如果Pod所在的Node宕机，就会将这个Node上的所有Pod重新调度到其他节点上。 Pod、容器与Node的关系如图：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622991811497-c01821d9-7533-4d5f-85d4-1c55d94e9d36.png#averageHue=%23f7f7f2&clientId=ufe2744ca-714f-4&from=paste&height=298&id=u2c89a608&name=image.png&originHeight=298&originWidth=539&originalType=binary&ratio=1&rotation=0&showTitle=false&size=75998&status=done&style=none&taskId=ub8ad7d26-6dd1-4bcd-8e19-4a31c3fd1af&title=&width=539" srcset="/img/loading.gif" lazyload alt="image.png"><br>Pod资源文件定义</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">apiVersion: v1<br>kind: Pod<br>metadata :<br>  name: myweb<br>  labels:<br>	name: myweb <br>spec :<br>  containers:<br>  - name: myweb<br>	image: kubeguide/ tomcat- app:v1<br>    ports:<br>    - containerPort: <span class="hljs-number">8080</span><br>    env :<br>	- name: MYSQL SERVICE HOST<br>	value: <span class="hljs-string">&#x27;mysql&#x27;</span><br>	- name: MYSQL SERVICE PORT<br>    value: <span class="hljs-string">&#x27;3306&#x27;</span><br></code></pre></td></tr></table></figure>
<p>Event：</p>
<blockquote>
<p>Event是一个事件的记录，记录了事件的最早产生时间、最后重现时间、重复次数、发起者、类型，以及导致此事件的原因等众多信息。Event通常会被关联到某个具体的资源对象上，是排查故障的重要参考信息，之前我们看到Node的描述信息包括了Event，而Pod同样有Event记录，当我们发现某个Pod迟迟无法创建时，可以用<code>kubectl describe pod xxxx</code>来查看它的描述信息，以定位问题的成因，比如下面这个Event记录信息表明Pod里的一个容器被探针检测为失败一次： </p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622992693786-423482f9-1733-4b7b-9767-b9033188badd.png#averageHue=%23e3e3e3&clientId=ufe2744ca-714f-4&from=paste&height=224&id=u46b3f3bf&name=image.png&originHeight=224&originWidth=678&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45998&status=done&style=none&taskId=u5b73b613-6d23-48b7-b7fa-df2036b8a0e&title=&width=678" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>k8s分配资源以m为单位，其中100-300m表示占用0.1-0.3个CPU</p>
</blockquote>
<blockquote>
<p>在k8s中一个计算资源进行配额限制需要设置以下两个参数</p>
</blockquote>
<ul>
<li>Requests：该资源的最小申请量，系统必须满足要求。 </li>
<li>Limits：该资源最大允许使用的量，不能被突破，当容器试图使用超过这个量的资源时，可能会被Kubernetes“杀掉”并重启。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623029832711-16f6055d-7fd8-4466-aebf-71992ef8b81a.png#averageHue=%23e7e7e7&clientId=u83b58e58-0218-4&from=paste&height=173&id=ud50ce463&name=image.png&originHeight=173&originWidth=424&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11352&status=done&style=none&taskId=u1e662aa4-e1c2-402d-aa9d-bd3ff418780&title=&width=424" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623029851744-94b1b5b1-3148-40b3-8421-c1b64182d613.png#averageHue=%23fbfbf9&clientId=u83b58e58-0218-4&from=paste&height=190&id=u83de06a0&name=image.png&originHeight=190&originWidth=389&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29115&status=done&style=none&taskId=uc8f67322-57fc-4491-baef-f85e5741ef3&title=&width=389" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h3><blockquote>
<p>一个Label由（key=value）的键值对组成，其中key、value由用户自己定义， Label的定义可以是在各种资源上，Node、Pod、Service、RC等。Label通常在资源对象定义时确定，也可以在对象创建后动态添加或者删除</p>
</blockquote>
<p>常用的Label示例</p>
<ul>
<li>版本标签：”release”:”stable”、”release”:”canary”。 </li>
<li>环境标签：”environment”:”dev”、”environment”:”qa”、”environment”:”production”。</li>
<li>架构标签：”tier”:”frontend”、”tier”:”backend”、”tier”:”middleware”。 </li>
<li>分区标签：”partition”:”customerA”、”partition”:”customerB”。 </li>
<li>质量管控标签：”track”:”daily”、”track”:”weekly”。</li>
</ul>
<p>Label Selector可以被类比为SQL语句中的where查询条件，例如，name=redis-slave这个Label Selector作用于Pod时，可以被类比为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> pod <span class="hljs-keyword">where</span> pod’s name <span class="hljs-operator">=</span>‘redis<span class="hljs-operator">-</span>slave’<br></code></pre></td></tr></table></figure>
<p>这样的语句。</p>
<p>当前有两种Label Selector表达式：基于等式的（Equality-based）和基于集合的（Set-based），前者采用等式类表达式匹配标签，下面是一些具体的例子。 </p>
<ul>
<li> name=redis-slave：匹配所有具有标签name=redis-slave的资源对象。</li>
<li> env!=production：匹配所有不具有标签env=production的资源对象，比如env=test就是满足此条件的标签之一。 </li>
</ul>
<p>后者则使用集合操作类表达式匹配标签，下面是一些具体的例子。 </p>
<ul>
<li> name in（redis-master, redis-slave）：匹配所有具有标签 name=redis-master或者name=redis-slave的资源对象。 </li>
<li> name not in（php-frontend）：匹配所有不具有标签name=php-frontend的资源对象。 </li>
</ul>
<p>可以通过多个Label Selector表达式的组合实现复杂的条件选择，多个表达式之间用“，”进行分隔即可，几个条件之间是“AND”的关系，即同时满足多个条件，比如下面的例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sql">name<span class="hljs-operator">=</span>redis<span class="hljs-operator">-</span>salve,env<span class="hljs-operator">!=</span>production<br>name noint &#123;php<span class="hljs-operator">-</span>frontend&#125;,env<span class="hljs-operator">!=</span>production<br></code></pre></td></tr></table></figure>
<p>Labels定义在metadata中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sql">apiVersion: v1<br>kind: Pod<br>metadata :<br>  name: myweb<br>  labels:<br>	name: myweb<br></code></pre></td></tr></table></figure>
<p>管理对象RC和Service则通过Selector字段设置需要关联Pod的 Label：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623044657863-da44922e-e871-4dc5-b2ea-f1c8b9f8c96a.png#averageHue=%23e7e7e7&clientId=u83b58e58-0218-4&from=paste&height=323&id=u096ccef5&name=image.png&originHeight=323&originWidth=426&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20029&status=done&style=none&taskId=u7a140974-52af-4ac6-b677-5c1597fe597&title=&width=426" srcset="/img/loading.gif" lazyload alt="image.png"><br>其他管理对象如Deployment、ReplicaSet、DaemonSet和Job则可以在Selector中使用基于集合的筛选条件定义，例如：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623044757114-245de64f-cefb-4a8e-a090-47109679735a.png#averageHue=%23e6e6e6&clientId=u83b58e58-0218-4&from=paste&height=101&id=uc6d7623c&name=image.png&originHeight=101&originWidth=430&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10868&status=done&style=none&taskId=u40919521-404a-4cf8-addd-fd9e3f3afe7&title=&width=430" srcset="/img/loading.gif" lazyload alt="image.png"><br>matchLabels用于定义一组Label，与直接写在Selector中的作用相同；matchExpressions用于定义一组基于集合的筛选条件，可用的条件运算符包括In、NotIn、Exists和DoesNotExist。 </p>
<p>如果同时设置了matchLabels和matchExpressions，则两组条件为AND关系，即需要同时满足所有条件才能完成Selector的筛选。 </p>
<p>Label Selector在Kubernetes中的重要使用场景如下。 </p>
<ul>
<li> kube-controller进程通过在资源对象RC上定义的Label Selector来筛选要监控的Pod副本数量，使Pod副本数量始终符合预期设定的全自动控制流程。 </li>
<li>kube-proxy进程通过Service的Label Selector来选择对应的Pod，自动建立每个Service到对应Pod的请求转发路由表，从而实现Service的智能负载均衡机制。 </li>
<li> 通过对某些Node定义特定的Label，并且在Pod定义文件中使用NodeSelector这种标签调度策略，kube-scheduler进程可以实现Pod定向调度的特性。 </li>
</ul>
<h3 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h3><blockquote>
<p>RC定义了一个期望的场景，即声明某种Pod的副本数量在任意时刻都符合某个预期值，所以RC的定义包括如下几个部分。 </p>
</blockquote>
<blockquote>
<ul>
<li>Pod期待的副本数量。 </li>
<li>用于筛选目标Pod的Label Selector。 </li>
<li>当Pod的副本数量小于预期数量时，用于创建新Pod的Pod模板 （template）。</li>
</ul>
</blockquote>
<p>下面是一个完整的RC定义的例子，即确保拥有tier=frontend标签的这个Pod（运行Tomcat容器）在整个Kubernetes集群中始终只有一个副本：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623045883767-7ff23ccd-4fe7-4529-8ee0-79c9596f9e90.png#averageHue=%23e6e6e6&clientId=u83b58e58-0218-4&from=paste&height=365&id=udf139883&name=image.png&originHeight=365&originWidth=431&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53771&status=done&style=none&taskId=u70860821-486d-4c98-849b-bb8c4649599&title=&width=431" srcset="/img/loading.gif" lazyload alt="image.png"><br>在运行时，我们可以通过修改RC的副本数量，来实现Pod的动态缩放（Scaling），这可以通过执行kubectl scale命令来一键完成： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">kubectl scale re redis<span class="hljs-operator">-</span>salve <span class="hljs-comment">--replicas=3 scale</span><br></code></pre></td></tr></table></figure>
<p>需要注意的是，删除RC并不会影响通过该RC已创建好的Pod。为了删除所有Pod，可以设置replicas的值为0，然后更新该RC。另外，kubectl提供了stop和delete命令来一次性删除RC和RC控制的全部Pod。</p>
<p>在Kubernetes 1.2中，升级为另外一个新概念—Replica Set，官方解释其为“下一代的RC”。Replica Set与RC当前的唯一区别是，Replica Sets支持基于集合的Label selector（Set-based selector），而RC只支持基于等式的Label Selector（equality-based selector），这使得Replica Set的功能更强。下面是等价于之前RC例子的Replica Set的定义（省去了Pod模板部分的内容）：<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623065703452-eb9674f1-4187-494a-ae16-4c633cdd81b5.png#averageHue=%23e6e6e6&clientId=u83b58e58-0218-4&from=paste&height=365&id=u5c16ed81&name=image.png&originHeight=365&originWidth=831&originalType=binary&ratio=1&rotation=0&showTitle=false&size=120912&status=done&style=none&taskId=ubf2848dd-26f9-4784-a724-6e2a906aaa5&title=&width=831" srcset="/img/loading.gif" lazyload alt="image.png"><br>kubectl命令行工具适用于RC的绝大部分命令同样适用于ReplicaSet。此外，我们当前很少单独使用Replica Set，它主要被Deployment这个更高层的资源对象所使用，从而形成一整套Pod创建、删除、更新的编排机制。我们在使用Deployment时，无须关心它是如何创建和维护Replica Set的，这一切都是自动发生的。 </p>
<p>RC（Replica Set）的一些特性与作用。 </p>
<ul>
<li> 在大多数情况下，我们通过定义一个RC实现Pod的创建及副本数量的自动控制。 </li>
<li> 在RC里包括完整的Pod定义模板。 </li>
<li> RC通过Label Selector机制实现对Pod副本的自动控制。 </li>
<li> 通过改变RC里的Pod副本数量，可以实现Pod的扩容或缩容。 </li>
<li> 通过改变RC里Pod模板中的镜像版本，可以实现Pod的滚动升级。</li>
</ul>
<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><blockquote>
<p>Deployment极度相似。</p>
</blockquote>
<p>Deployment相对于RC的一个最大升级是我们可以随时知道当前 Pod“部署”的进度。实际上由于一个Pod的创建、调度、绑定节点及在目标Node上启动对应的容器这一完整过程需要一定的时间，所以我们期待系统启动N个Pod副本的目标状态，实际上是一个连续变化的“部署过程”导致的最终状态。 </p>
<p>Deployment的典型使用场景有以下几个：</p>
<ul>
<li> 创建一个Deployment对象来生成对应的Replica Set并完成Pod副本的创建。 </li>
<li> 检查Deployment的状态来看部署动作是否完成（Pod副本数量是否达到预期的值）。 </li>
<li> 更新Deployment以创建新的Pod（比如镜像升级）。</li>
<li> 如果当前Deployment不稳定，则回滚到一个早先的Deployment版本。</li>
<li> 暂停Deployment以便于一次性修改多个PodTemplateSpec的配置项，之后再恢复Deployment，进行新的发布。 </li>
<li> 扩展Deployment以应对高负载。 </li>
<li> 查看Deployment的状态，以此作为发布是否成功的指标。 </li>
<li> 清理不再需要的旧版本ReplicaSets。</li>
</ul>
<blockquote>
<p>Deployment的定义和RC也极度相似</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623067286569-305c8f34-f091-4476-bd46-33cc0c95e843.png#averageHue=%23e3e3e3&clientId=u83b58e58-0218-4&from=paste&height=82&id=u60bb0c44&name=image.png&originHeight=82&originWidth=561&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26419&status=done&style=none&taskId=u6f630de0-ae7d-4c73-a87c-c076e7742d9&title=&width=561" srcset="/img/loading.gif" lazyload alt="image.png"><br>完整案例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">frontend</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">tier:</span> <span class="hljs-string">frontend</span><br>    <span class="hljs-attr">matchExpressions:</span><br>      <span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">key:</span> <span class="hljs-string">tier</span>,<span class="hljs-attr">oprator:</span> <span class="hljs-string">In</span>,<span class="hljs-attr">values:</span> [<span class="hljs-string">frontend</span>]&#125;<br>    <span class="hljs-attr">template:</span><br>      <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">labels:</span><br>          <span class="hljs-attr">app:</span> <span class="hljs-string">app-demo</span><br>          <span class="hljs-attr">tier:</span> <span class="hljs-string">frontend</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">tomcat-demo</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">tomcat</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">ports:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure>
<p>创建Deployment</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">create</span> <span class="hljs-string">-f</span> <span class="hljs-string">tomcat-deployment.yaml</span><br></code></pre></td></tr></table></figure>
<p>查看信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">deployments</span><br></code></pre></td></tr></table></figure>
<p>查看rs</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">rs</span><br></code></pre></td></tr></table></figure>

<h3 id="Horizontal-Pod-Autoscaler"><a href="#Horizontal-Pod-Autoscaler" class="headerlink" title="Horizontal Pod Autoscaler"></a>Horizontal Pod Autoscaler</h3><blockquote>
<p>通过手工执行kubectl scale命令，我们可以实现Pod扩容或缩容。如果仅仅到此为止，显然不符合谷歌对Kubernetes的定位目标—自动化、 智能化。</p>
</blockquote>
<p>通过追踪分析指定RC控制的所有目标Pod的负载变化情况，来确定是否需要有针对性地调整目标Pod的副本数量，这是HPA的实现原理。当前，HPA有以下两种方式作为Pod负载的度量指标。 </p>
<ul>
<li>CPUUtilizationPercentage。 <blockquote>
<p>CPUUtilizationPercentage是一个算术平均值，即目标Pod所有副本自身的CPU利用率的平均值。</p>
</blockquote>
</li>
</ul>
<p>具体例子<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623079352966-ced60de1-19d3-499b-9ce1-710b7e149815.png#averageHue=%23e5e5e5&clientId=u83b58e58-0218-4&from=paste&height=247&id=uccd49c82&name=image.png&originHeight=247&originWidth=558&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29354&status=done&style=none&taskId=u9376b22b-ab07-4665-b9be-d86d8938444&title=&width=558" srcset="/img/loading.gif" lazyload alt="image.png"><br>等价于</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">autoscale</span> <span class="hljs-string">deployment</span> <span class="hljs-string">php-apache</span> <span class="hljs-string">--cpu-percent=90</span> <span class="hljs-string">--min=1</span> <span class="hljs-string">--max=10</span><br></code></pre></td></tr></table></figure>

<ul>
<li>应用程序自定义的度量指标，比如服务在每秒内的相应请求数 （TPS或QPS）</li>
</ul>
<h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>背景</p>
<blockquote>
<p>在Kubernetes系统中，Pod的管理对象RC、Deployment、DaemonSet和Job都面向无状态的服务。但现实中有很多服务是有状态的，特别是一些复杂的中间件集群，例如MySQL集群、MongoDB集群、Akka集群、ZooKeeper集群等，这些应用集群有4个共同点。 </p>
<p>（1）每个节点都有固定的身份ID，通过这个ID，集群中的成员可以相互发现并通信。<br>（2）集群的规模是比较固定的，集群规模不能随意变动。<br>（3）集群中的每个节点都是有状态的，通常会持久化数据到永久存储中。<br>（4）如果磁盘损坏，则集群里的某个节点无法正常运行，集群功能受损。</p>
</blockquote>
<p>StatefulSet从本质上来说，可以看作Deployment/RC的一个特殊变种，它有如下特性:</p>
<ul>
<li>StatefulSet里的每个Pod都有稳定、唯一的网络标识，可以用来发现集群内的其他成员。假设StatefulSet的名称为kafka，那么第1个Pod叫kafka-0，第2个叫kafka-1，以此类推。 </li>
<li> StatefulSet控制的Pod副本的启停顺序是受控的，操作第n个Pod时，前n-1个Pod已经是运行且准备好的状态。 </li>
<li>StatefulSet里的Pod采用稳定的持久化存储卷，通过PV或PVC来实现，删除Pod时默认不会删除StatefulSet相关的存储卷（为了保证数据的安全）。 </li>
</ul>
<p>Headless Service与普通Service的关键区别在于，它没有Cluster IP，如果解析Headless Service的DNS域名，则返回的是该Service对应的全部Pod的Endpoint列表。StatefulSet在Headless Service的基础上又为StatefulSet控制的每个Pod实例都创建了一个DNS域名，这个域名的格式为： </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">$(podname).$(headless</span> <span class="hljs-string">service</span> <span class="hljs-string">name)</span><br></code></pre></td></tr></table></figure>
<p>比如一个3节点的Kafka的StatefulSet集群对应的Headless Service的名称为kafka，StatefulSet的名称为kafka，则StatefulSet里的3个Pod的DNS名称分别为kafka-0.kafka、kafka-1.kafka、kafka-3.kafka，这些DNS名称可以直接在集群的配置文件中固定下来。 </p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><blockquote>
<p> Service服务也是Kubernetes里的核心资源对象之一，Kubernetes里的每个Service其实就是我们经常提起的微服务架构中的一个微服务</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623080292711-998344f4-2f2a-4213-b50f-68280a9efa16.png#averageHue=%23f8f7f5&clientId=u83b58e58-0218-4&from=paste&height=251&id=u0bffac3d&name=image.png&originHeight=251&originWidth=550&originalType=binary&ratio=1&rotation=0&showTitle=false&size=89979&status=done&style=none&taskId=u0728a840-f106-49a9-8a26-845b6750d74&title=&width=550" srcset="/img/loading.gif" lazyload alt="image.png"><br>Kubernetes的Service定义了一个服务的访问入口地址，前端的应用（Pod）通过这个入口地址访问其背后的一组由Pod副本组成的集群实例，Service与其后端Pod副本集群之间则是通过Label Selector来实现无缝对接的。RC的作用实际上是保证Service的服务能力和服务质量始终符合预期标准。<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623080389084-31370e03-11a8-4658-b881-b0b39069d7e0.png#averageHue=%23fbfcfa&clientId=u83b58e58-0218-4&from=paste&height=238&id=ue1de85fa&name=image.png&originHeight=238&originWidth=455&originalType=binary&ratio=1&rotation=0&showTitle=false&size=90074&status=done&style=none&taskId=u8ea96079-d2bf-403a-91f4-ed14e3af078&title=&width=455" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>Kubernetes也遵循负载均衡做法，运行在每个Node上的kube-proxy进程其实就是一个智能的软件负载均衡器，负责把对Service的请求转发到后端的某个Pod实例上，并在内部实现服务的负载均衡与会话保持机制。但Kubernetes发明了一种很巧妙又影响深远的设计：</p>
<blockquote>
<p>Service没有共用一个负载均衡器的IP地址，每个Service都被分配了一个全局唯一的虚拟IP地址，这个虚拟IP被称为Cluster IP。这样一来，每个服务就变成了具备唯一IP地址的通信节点，服务调用就变成了最基础的TCP网络通信问题。</p>
</blockquote>
<p>我们知道，Pod的Endpoint地址会随着Pod的销毁和重新创建而发生改变，因为新Pod的IP地址与之前旧Pod的不同。而Service一旦被创建，Kubernetes就会自动为它分配一个可用的Cluster IP，而且在Service的整个生命周期内，它的Cluster IP不会发生改变。于是，服务发现这个棘手的问题在Kubernetes的架构里也得以轻松解决：</p>
<blockquote>
<p>只要用Service的Name与Service的Cluster IP地址做一个DNS域名映射即可完美解决问题。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-string">kind：Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">tomcat-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">frontend</span><br></code></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 启动实例</span><br><span class="hljs-string">kubectl</span> <span class="hljs-string">create</span> <span class="hljs-string">-f</span> <span class="hljs-string">tomcat-server.yaml</span><br><span class="hljs-comment"># 查看暴露的端口</span><br><span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">endpoints</span><br><span class="hljs-comment"># 查看详细信息（Cluster IP）</span><br><span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">svc</span> <span class="hljs-string">tomcat-service</span> <span class="hljs-string">-o</span> <span class="hljs-string">yaml</span><br></code></pre></td></tr></table></figure>
<p>很多服务都存在多个端口的问题，通常一个端口提供业务服务，另外一个端口提供管理服务，比如Mycat、Codis等常见中间件。Kubernetes Service支持多个Endpoint，在存在多个Endpoint的情况下，要求每个Endpoint都定义一个名称来区分。下面是Tomcat多端口的Service定义样例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">tomcat-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-port</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8005</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">shutdown-port</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">frontend</span><br></code></pre></td></tr></table></figure>
<p>服务发现机制</p>
<blockquote>
<p>来Kubernetes通过Add-On增值包引入了DNS系统，把服务名作为DNS域名，这样程序就可以直接使用服务名来建立通信连接了。</p>
</blockquote>
<ul>
<li><p>Node IP：Node的IP地址。</p>
<blockquote>
</blockquote>
</li>
<li><p>Pod IP：Pod的IP地址。 </p>
<blockquote>
</blockquote>
</li>
<li><p>Cluster IP：Service的IP地址。</p>
<blockquote>
<p>Cluster IP仅仅作用于Kubernetes Service这个对象，并由Kubernetes管理和分配IP地址（来源于Cluster IP地址池）。 </p>
</blockquote>
</li>
</ul>
<p>◎ Cluster IP无法被Ping，因为没有一个“实体网络对象”来响应。<br>◎ Cluster IP只能结合Service Port组成一个具体的通信端口，单独的Cluster IP不具备TCP/IP通信的基础，并且它们属于Kubernetes集群这样一个封闭的空间，集群外的节点如果要访问这个通信端口，则需要做一些额外的工作。<br>◎ 在Kubernetes集群内，Node IP网、Pod IP网与Cluster IP网之间的通信，采用的是Kubernetes自己设计的一种编程方式的特殊路由规则，与我们熟知的IP路由有很大的不同。</p>
<p>Service的Cluster IP属于Kubernetes集群内部的地址，无法在集群外部直接使用这个地址。那么矛盾来了：实际上在我们开发的业务系统中肯定多少有一部分服务是要提供给Kubernetes集群外部的应用或者用户来使用的，典型的例子就是Web端的服务模块，比如上面的tomcat-service，那么用户怎么访问它？<br>采用NodePort是解决上述问题的最直接、有效的常见做法。以tomcat-service为例，在Service的定义里做如下扩展即可（见代码中的type部分）： </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">tomcat-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-port</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">tier:</span> <span class="hljs-string">frontend</span><br></code></pre></td></tr></table></figure>
<p>其中，nodePort:31002这个属性表明手动指定tomcat-service的NodePort为31002，否则Kubernetes会自动分配一个可用的端口。接下来在浏览器里访问http://<nodePortIP>:31002/，就可以看到Tomcat的欢迎界面了</p>
<p>NodePort的实现方式是在Kubernetes集群里的每个Node上都为需要外部访问的Service开启一个对应的TCP监听端口，外部系统只要用任意一个Node的IP地址+具体的NodePort端口号即可访问此服务，在任意Node上运行netstat命令，就可以看到有NodePort端口被监听：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623117947202-5cf2159c-a1ba-4a56-a682-aa6d434a8307.png#averageHue=%23e6e6e6&clientId=u2ced509c-70cf-4&from=paste&height=35&id=u3e5ebbff&name=image.png&originHeight=35&originWidth=444&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5730&status=done&style=none&taskId=u81b383a0-b5f4-4ef3-aeb6-3bc3706f1f1&title=&width=444" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><blockquote>
<p>与RC、Deployment、ReplicaSet、DaemonSet类似，Job也控制一组Pod容器。从这个角度来看，Job也是一种特殊的Pod副本自动控制器，同时Job控制Pod副本与RC等控制器的工作机制有以下重要差别。 </p>
</blockquote>
<p>（1）Job所控制的Pod副本是短暂运行的，可以将其视为一组Docker容器，其中的每个Docker容器都仅仅运行一次。当Job控制的所有Pod副本都运行结束时，对应的Job也就结束了。Job在实现方式上与<br>RC等副本控制器不同，Job生成的Pod副本是不能自动重启的，对应Pod副本的RestartPoliy都被设置为Never。因此，当对应的Pod副本都执行完成时，相应的Job也就完成了控制使命，即Job生成的Pod在Kubernetes中<br>是短暂存在的。Kubernetes在1.5版本之后又提供了类似crontab的定时任务——CronJob，解决了某些批处理任务需要定时反复执行的问题。 </p>
<p>（2）Job所控制的Pod副本的工作模式能够多实例并行计算，以TensorFlow框架为例，可以将一个机器学习的计算任务分布到10台机器上，在每台机器上都运行一个worker执行计算任务，这很适合通过Job生成10个Pod副本同时启动运算。 </p>
<h3 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h3><blockquote>
<p>Volume（存储卷）是Pod中能够被多个容器访问的共享目录。</p>
</blockquote>
<p>Kubernetes的Volume概念、用途和目的与Docker的Volume比较类似，但两者不能等价。首先，Kubernetes中的Volume被定义在Pod上，然后被一个Pod里的多个容器挂载到具体的文件目录下；其次，Kubernetes中的<br>Volume与Pod的生命周期相同，但与容器的生命周期不相关，当容器终止或者重启时，Volume中的数据也不会丢失。最后，Kubernetes支持多种类型的Volume，例如GlusterFS、Ceph等先进的分布式文件系统。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623131618080-4d0c3302-c699-4d4f-939b-c72315255fd5.png#averageHue=%23e5e5e5&clientId=u2ced509c-70cf-4&from=paste&height=383&id=u126e9558&name=image.png&originHeight=383&originWidth=648&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44054&status=done&style=none&taskId=u48dd0896-0dfc-4b2a-9f93-1bc801b8e0d&title=&width=648" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h4 id="Volume类型"><a href="#Volume类型" class="headerlink" title="Volume类型"></a>Volume类型</h4><h5 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h5><p>一个emptyDir Volume是在Pod分配到Node时创建的。从它的名称就可以看出，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为这是Kubernetes自动分配的一个目录，当Pod从Node上移除时，emptyDir中的数据也会被永久删除。emptyDir的一些用途如下。<br>◎ 临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留。<br>◎ 长时间任务的中间过程CheckPoint的临时保存目录。<br>◎ 一个容器需要从另一个容器中获取数据的目录（多容器共享目录）。<br>目前，用户无法控制emptyDir使用的介质种类。如果kubelet的配置是使用硬盘，那么所有emptyDir都将被创建在该硬盘上。Pod在将来可以设置emptyDir是位于硬盘、固态硬盘上还是基于内存的tmpfs上，上面的例子便采用了emptyDir类的Volume。 </p>
<h5 id="hostPath"><a href="#hostPath" class="headerlink" title="hostPath"></a>hostPath</h5><p>hostPath为在Pod上挂载宿主机上的文件或目录，它通常可以用于以下几方面。<br>◎ 容器应用程序生成的日志文件需要永久保存时，可以使用宿主机的高速文件系统进行存储。<br>◎ 需要访问宿主机上Docker引擎内部数据结构的容器应用时，可以通过定义hostPath为宿主机/var/lib/docker目录，使容器内部应用可以直接访问Docker的文件系统。在使用这种类型的Volume时，需要注意以下几点。<br>◎ 在不同的Node上具有相同配置的Pod，可能会因为宿主机上的目录和文件不同而导致对Volume上目录和文件的访问结果不一致。<br>◎ 如果使用了资源配额管理，则Kubernetes无法将hostPath在宿主机上使用的资源纳入管理。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">volumes:<br>- name: <span class="hljs-string">&quot;persistent-storage&quot;</span><br>  hostPaht:<br>	path: <span class="hljs-string">&quot;/data&quot;</span><br></code></pre></td></tr></table></figure>

<h5 id="gcePersistentDisk"><a href="#gcePersistentDisk" class="headerlink" title="gcePersistentDisk"></a>gcePersistentDisk</h5><p>使用这种类型的Volume表示使用谷歌公有云提供的永久磁盘（Persistent Disk，PD）存放Volume的数据，它与emptyDir不同，PD上的内容会被永久保存，当Pod被删除时，PD只是被卸载（Unmount），但不会被删除。需要注意的是，你需要先创建一个PD，才能使用gcePersistentDisk。 使用gcePersistentDisk时有以下一些限制条件。<br>◎ Node（运行kubelet的节点）需要是GCE虚拟机。<br>◎ 这些虚拟机需要与PD存在于相同的GCE项目和Zone中。 </p>
<p>通过gcloud命令即可创建一个PD： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">gcloud compute disks create --size=500GB --zone=us-centrall my-data-disk<br></code></pre></td></tr></table></figure>
<p>定义gcePersistentDisk类型的Volume的示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">volumes:<br>- name: test-volumes<br>  gcePersistentDisk:<br>	pdName: my-data-disk<br>    fsType: ext4<br></code></pre></td></tr></table></figure>

<h5 id="awsElasticBlockStore"><a href="#awsElasticBlockStore" class="headerlink" title="awsElasticBlockStore"></a>awsElasticBlockStore</h5><h5 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h5><blockquote>
<p>使用NFS网络文件系统提供的共享目录存储数据时，我们需要在系统中部署一个NFS Server。定义NFS类型的Volume的示例如下</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">volumes:<br>  - name: nfs<br>    nfs: <br>	  server: nfs-server.localhost<br>      path: <span class="hljs-string">&quot;/&quot;</span><br></code></pre></td></tr></table></figure>


<h5 id="其他类型的Volume"><a href="#其他类型的Volume" class="headerlink" title="其他类型的Volume"></a>其他类型的Volume</h5><p>◎ iscsi：使用iSCSI存储设备上的目录挂载到Pod中。<br>◎ flocker：使用Flocker管理存储卷。<br>◎ glusterfs：使用开源GlusterFS网络文件系统的目录挂载到Pod中。<br>◎ rbd：使用Ceph块设备共享存储（Rados Block Device）挂载到Pod中。<br>◎ gitRepo：通过挂载一个空目录，并从Git库clone一个git repository以供Pod使用。<br>◎ secret：一个Secret Volume用于为Pod提供加密的信息，你可以将定义在Kubernetes中的Secret直接挂载为文件让Pod访问。Secret Volume是通过TMFS（内存文件系统）实现的，这种类型的Volume总是不会被持久化的。 </p>
<h3 id="Persistent-Volume"><a href="#Persistent-Volume" class="headerlink" title="Persistent Volume"></a>Persistent Volume</h3><p>PV可以被理解成Kubernetes集群中的某个网络存储对应的一块存储，它与Volume类似，但有以下区别。 </p>
<ul>
<li>PV只能是网络存储，不属于任何Node，但可以在每个Node上访问。◎ PV并不是被定义在Pod上的，而是独立于Pod之外定义的。 </li>
<li>PV目前支持的类型包括：gcePersistentDisk、AWSElasticBlockStore、AzureFile、AzureDisk、FC（Fibre Channel）、Flocker、NFS、iSCSI、RBD（Rados Block Device）、CephFS、 Cinder、GlusterFS、VsphereVolume、Quobyte Volumes、VMware Photon、Portworx Volumes、ScaleIO Volumes和HostPath（仅供单机测试）。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">apiVersion: v1<br>kind: PersistentVolume<br>metadata:<br>  name: pv0003<br>spec:<br>  capacity:<br>	storage: 5Gi<br>  accessModes:<br>	- ReadWriteOnce<br>  nfs:<br>	path: /somepath<br>    server: <span class="hljs-number">172.147</span><span class="hljs-number">.0</span><span class="hljs-number">.156</span><br></code></pre></td></tr></table></figure>
<p>比较重要的是PV的accessModes属性，目前有以下类型。 </p>
<ul>
<li> ReadWriteOnce：读写权限，并且只能被单个Node挂载。 </li>
<li> ReadOnlyMany：只读权限，允许被多个Node挂载。 </li>
<li> ReadWriteMany：读写权限，允许被多个Node挂载。 </li>
</ul>
<p>如果某个Pod想申请某种类型的PV，则首先需要定义一个 PersistentVolumeClaim对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">apiVersion: v1<br>kind: PersistentVolumeClaim<br>metadata:<br>  name: myclaim<br>spec:<br>  accessModes:<br>    - ReadWriterOnce<br>  resource:<br>	requests:<br>	  storage: 8Gi<br></code></pre></td></tr></table></figure>
<p>这Pod的Volume定义中引用上述PVC即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">volumes:<br>  - name: mypd<br>    persistntVolumeClaim:<br>	  claimName: myclaim<br></code></pre></td></tr></table></figure>

<h3 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h3><blockquote>
<p>Namespace（命名空间）是Kubernetes系统中的另一个非常重要的概念，Namespace在很多情况下用于实现多租户的资源隔离。</p>
</blockquote>
<p>kubernetes默认会创建一个namespace，如果在创建资源时不指明namespace则默认在默认的namespace下。</p>
<p>创建namespace为development的namespace</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">apiVersion: v1<br>kind: Namespace<br>metadata:<br>  name: development<br></code></pre></td></tr></table></figure>
<p>在创建资源对象时指定对应的namespace</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: busybox<br>  namespace: development<br>spec:<br>  containers:<br>  - image: busybox<br>    commond:<br>	  - sleep<br>      - <span class="hljs-string">&quot;3306&quot;</span><br>    name: busybox<br></code></pre></td></tr></table></figure>
<p>查看对应的pod（需要指明namespace）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">kubectl get pods --namespace=development <br></code></pre></td></tr></table></figure>

<h3 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h3><p>Annotation（注解）与Label类似，也使用key/value键值对的形式进行定义。不同的是Label具有严格的命名规则，它定义的是Kubernetes对象的元数据（Metadata），并且用于Label Selector。Annotation则是用户<br>任意定义的附加信息，以便于外部工具查找。在很多时候，Kubernetes 的模块自身会通过Annotation标记资源对象的一些特殊信息。通常来说，用Annotation来记录的信息如下。 </p>
<ul>
<li> build信息、release信息、Docker镜像信息等，例如时间戳、release id号、PR号、镜像Hash值、Docker Registry地址等。 </li>
<li> 日志库、监控库、分析库等资源库的地址信息。 </li>
<li> 程序调试工具信息，例如工具名称、版本号等。 </li>
<li> 团队的联系信息，例如电话号码、负责人名称、网址等。 </li>
</ul>
<h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><blockquote>
<p>首先，把所有的配置项都当作key-value字符串，当然value可以来自某个文本文件，比如配置项password=123456、user=root、host=192.168.8.4用于表示连接FTP服务器的配置参数。这些配置项可以作为Map表中的一个项，整个Map的数据可以被持久化存储在Kubernetes的Etcd数据库中，然后提供API以方便Kubernetes相关组件或客户应用CRUD操作这些数据，上述专门用来保存配置参数的Map就是Kubernetes ConfigMap资源对象。 </p>
</blockquote>
<p>接下来，Kubernetes提供了一种内建机制，将存储在etcd中的ConfigMap通过Volume映射的方式变成目标Pod内的配置文件，不管目标Pod被调度到哪台服务器上，都会完成自动映射。进一步地，如果ConfigMap中的key-value数据被修改，则映射到Pod中的“配置文件”也会随之自动更新。于是，Kubernetes ConfigMap就成了分布式系统中最为简单（使用方法简单，但背后实现比较复杂）且对应用无侵入的配置中心。ConfigMap配置集中化的一种简单方案如图<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1623163264502-dc3036a0-73fa-4bc8-af69-cd1f95c2d824.png#averageHue=%23f5eeea&clientId=u2ced509c-70cf-4&from=paste&height=418&id=ud76a93f8&name=image.png&originHeight=418&originWidth=784&originalType=binary&ratio=1&rotation=0&showTitle=false&size=214401&status=done&style=none&taskId=u52bec702-6314-4b36-ba9f-859cc0fe88a&title=&width=784" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="ServiceAccount"><a href="#ServiceAccount" class="headerlink" title="ServiceAccount"></a>ServiceAccount</h3><p>Kubernetes ServiceAccount 是用来表示在 Pod 内运行的进程的身份的。它在 Kubernetes API 中提供了一个 API 对象，表示一组凭证，可以用来作为特定用户访问 API 服务器。ServiceAccounts 被用来给 Pods 访问 API 服务器的权限，用于执行诸如读写持久卷和修改其他 API 对象等任务。ServiceAccount 与一个或多个令牌相关联，可用于对 API 服务器进行身份验证。ServiceAccounts 还允许定义细粒度的授权策略，让控制特定 ServiceAccount 可以执行的操作。<br>Kubernetes ServiceAccounts 的主要目的是提供一种方法，让 Pods 具有身份和访问 API 服务器的授权，从而允许它们执行特定的操作</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">bookinfo-productpage</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">account:</span> <span class="hljs-string">productpage</span><br></code></pre></td></tr></table></figure>

<h2 id="安装Kubernetes"><a href="#安装Kubernetes" class="headerlink" title="安装Kubernetes"></a>安装Kubernetes</h2><blockquote>
<p>kubernetes的安装可以通过kubeadm或者二进制的方式进行安装</p>
</blockquote>
<ol>
<li><a href="https://mikeygithub.github.io/2021/05/17/yuque/am5lkt/">https://mikeygithub.github.io/2021/05/17/yuque/am5lkt/</a></li>
<li><a href="https://mikeygithub.github.io/2022/11/05/yuque/ii4c5fmarlf7iqma/">https://mikeygithub.github.io/2022/11/05/yuque/ii4c5fmarlf7iqma/</a></li>
</ol>
<h2 id="简单案例"><a href="#简单案例" class="headerlink" title="简单案例"></a>简单案例</h2><blockquote>
<p>搭建一个简单Java Web引用程序</p>
</blockquote>
<h3 id="1-3-1环境准备"><a href="#1-3-1环境准备" class="headerlink" title="1.3.1环境准备"></a>1.3.1环境准备</h3><p><a href="https://mikeygithub.github.io/2021/05/17/yuque/am5lkt/">搭建环境及启动集群</a></p>
<h3 id="1-3-2启-动MySQL服务"><a href="#1-3-2启-动MySQL服务" class="headerlink" title="1.3.2启 动MySQL服务"></a>1.3.2启 动MySQL服务</h3><p>1.生成配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">kubectl create deployment mysql --image=mysql -o yaml --dry-run &gt; mysql-rc.yaml<br></code></pre></td></tr></table></figure>
<p>2.配置文件(当然也可以在kubernetes dashboard上进行创建)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ReplicationController</span>　<span class="hljs-comment">#副本控制器</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mysql</span>	<span class="hljs-comment">#RC的名称，全局唯一</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>	<span class="hljs-comment">#pod副本的期待数量</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">mysql</span>	<span class="hljs-comment">#根据此模板创建的pod的副本(实例)</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">mysql</span>	<span class="hljs-comment">#pod副本拥有的标签,对应RC的Selector</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span>	<span class="hljs-comment">#容器定义配置</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mysql</span>	<span class="hljs-comment">#容器名称</span><br>         <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.6</span>	<span class="hljs-comment">#镜像</span><br>         <span class="hljs-attr">ports:</span><br>         <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">3306</span>	<span class="hljs-comment">#端口</span><br>         <span class="hljs-attr">env:</span>	<span class="hljs-comment">#环境变量</span><br>         <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD</span><br>           <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;123456&quot;</span><br></code></pre></td></tr></table></figure>
<p>3.查看创建结果<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622862903351-13e1b8a8-a547-4971-add4-c799bffb79b8.png#averageHue=%23ac976e&clientId=u75b3a40c-5a6e-4&from=paste&height=926&id=u0d58c3f0&name=image.png&originHeight=926&originWidth=1919&originalType=binary&ratio=1&rotation=0&showTitle=false&size=123582&status=done&style=none&taskId=u25618dc0-1f4e-4b48-9cd4-8e5067c3702&title=&width=1919" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> rc<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622863181352-d37ddc3c-4f7d-402f-9c68-9c9f6c0cb62a.png#averageHue=%2334312d&clientId=u75b3a40c-5a6e-4&from=paste&height=93&id=ud093cd52&name=image.png&originHeight=93&originWidth=396&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9496&status=done&style=none&taskId=u56fabb49-7bf0-4aa9-86e5-da85c833cc4&title=&width=396" srcset="/img/loading.gif" lazyload alt="image.png"><br>3.查看自动创建的pod</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> pods<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622863316209-c821065e-50a6-4ca4-84f9-6dd25818c5c7.png#averageHue=%2336332f&clientId=u75b3a40c-5a6e-4&from=paste&height=78&id=u92a6387e&name=image.png&originHeight=78&originWidth=450&originalType=binary&ratio=1&rotation=0&showTitle=false&size=10567&status=done&style=none&taskId=u72c7c45b-f23c-4667-8ff1-536a79137cd&title=&width=450" srcset="/img/loading.gif" lazyload alt="image.png"><br>4.创建与之关联的service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>　<span class="hljs-comment">#表明是K8s 的Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mysql</span>	<span class="hljs-comment">#Service的名称，全局唯一</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">3306</span> <span class="hljs-comment">#Service对外提供的端口号</span><br>  <span class="hljs-attr">selector:</span>     <span class="hljs-comment">#Service对应的Pod拥有这里定义的标签</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">mysql</span><br></code></pre></td></tr></table></figure>
<p>5.查看Service<br><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622863695888-492f4254-4bda-4fd5-bca7-7449e6ce47db.png#averageHue=%23d8bf8b&clientId=u75b3a40c-5a6e-4&from=paste&height=920&id=u0a724105&name=image.png&originHeight=920&originWidth=1919&originalType=binary&ratio=1&rotation=0&showTitle=false&size=119036&status=done&style=none&taskId=ua6cad9ad-b0a3-4a31-a365-3135bf58845&title=&width=1919" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get svc<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622863683444-282fad28-7eb7-4343-aba8-fb359741688f.png#averageHue=%2334312d&clientId=u75b3a40c-5a6e-4&from=paste&height=84&id=u4efa7f0e&name=image.png&originHeight=84&originWidth=641&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15858&status=done&style=none&taskId=ubef1078b-5814-4367-a025-9e99674742b&title=&width=641" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<blockquote>
<p>可以看到对应的IP和端口，集群中的其他Pod就可以通过Service的Cluster-ip和端口访问它了</p>
</blockquote>
<h3 id="1-3-3启动Tomcat应用"><a href="#1-3-3启动Tomcat应用" class="headerlink" title="1.3.3启动Tomcat应用"></a>1.3.3启动Tomcat应用</h3><p>1.创建RC</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ReplicationController</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">myweb</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">myweb</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">myweb</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myweb</span><br>         <span class="hljs-attr">image:</span> <span class="hljs-string">kubeguide/tomcat-app:v1</span><br>         <span class="hljs-attr">ports:</span><br>         <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl create -f myweb-rc.yaml<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622864066128-b48391aa-2440-4092-bee7-c5b868a5197a.png#averageHue=%23dac08b&clientId=u75b3a40c-5a6e-4&from=paste&height=921&id=u66861f05&name=image.png&originHeight=921&originWidth=1919&originalType=binary&ratio=1&rotation=0&showTitle=false&size=128771&status=done&style=none&taskId=ua4982724-abd4-4f64-8d8f-16bdcf83eca&title=&width=1919" srcset="/img/loading.gif" lazyload alt="image.png"><br>2.创建Service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">myweb</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30001</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">myweb</span><br></code></pre></td></tr></table></figure>
<p>3.浏览器访问</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#IP+端口(注意这个是物理机的IP不是k8s分配的Cluster-IP)</span><br><span class="hljs-string">http://10.42.0.232:30001/demo/</span><br></code></pre></td></tr></table></figure>

<h3 id="1-3-4通过浏览器访问网页"><a href="#1-3-4通过浏览器访问网页" class="headerlink" title="1.3.4通过浏览器访问网页"></a>1.3.4通过浏览器访问网页</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622865934440-8a6449c2-a8fe-4fdd-bf76-5d988ee378fe.png#averageHue=%23dddad0&clientId=u75b3a40c-5a6e-4&from=paste&height=1080&id=u567a0839&name=image.png&originHeight=1080&originWidth=1915&originalType=binary&ratio=1&rotation=0&showTitle=false&size=367560&status=done&style=none&taskId=ua2434f8f-b7fe-4b51-9b61-e06812aeb06&title=&width=1915" srcset="/img/loading.gif" lazyload alt="image.png"><img src="https://cdn.nlark.com/yuque/0/2021/png/2630542/1622866835519-c955d3f1-b222-4e05-9b23-e211348695f8.png#averageHue=%23f6f5f5&clientId=u75b3a40c-5a6e-4&from=paste&height=984&id=uacf27372&name=image.png&originHeight=984&originWidth=1863&originalType=binary&ratio=1&rotation=0&showTitle=false&size=101430&status=done&style=none&taskId=u24f19aad-e5ab-4b53-811f-4d28b39a1f6&title=&width=1863" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h1 id="深入掌握Pod"><a href="#深入掌握Pod" class="headerlink" title="深入掌握Pod"></a>深入掌握Pod</h1><p>YAML格式的Pod定义文件完整内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1(版本，String，必选)</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">string</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">string</span><br>  <span class="hljs-attr">labels:</span><br>  	<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span><br>  <span class="hljs-attr">annotations:</span><br>  	<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span><br><span class="hljs-attr">spec:</span><br>	<span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span><br>  <span class="hljs-attr">image:</span> <span class="hljs-string">string</span><br>  <span class="hljs-attr">imagePullPolicy:</span> [<span class="hljs-string">Always|Never|IfNotPresent</span>]<br>  <span class="hljs-attr">command:</span> [<span class="hljs-string">string</span>]<br>  <span class="hljs-attr">args:</span> [<span class="hljs-string">string</span>]<br>  <span class="hljs-attr">workingDir:</span> <span class="hljs-string">string</span><br>  <span class="hljs-attr">volumeMounts:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span><br>  	<span class="hljs-attr">mountPath:</span> <span class="hljs-string">string</span><br>  	<span class="hljs-attr">readOnly:</span> <span class="hljs-string">boolean</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span><br>  	<span class="hljs-attr">containerPort:</span> <span class="hljs-string">int</span><br>    <span class="hljs-attr">hostPort:</span> <span class="hljs-string">int</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">string</span><br>  <span class="hljs-attr">env:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">string</span><br>	<span class="hljs-attr">resources:</span><br>		<span class="hljs-attr">limits:</span><br>			<span class="hljs-attr">cpu:</span> <span class="hljs-string">string</span><br>			<span class="hljs-attr">memory:</span> <span class="hljs-string">string</span><br>		<span class="hljs-attr">requests:</span><br>			<span class="hljs-attr">cpu:</span> <span class="hljs-string">string</span><br>			<span class="hljs-attr">memory:</span> <span class="hljs-string">string</span><br>	<span class="hljs-attr">livenessProbe :</span><br>		<span class="hljs-attr">exec:</span><br>			<span class="hljs-attr">command:</span> [<span class="hljs-string">string</span>]<br>		<span class="hljs-attr">httpGet:</span><br>			<span class="hljs-attr">path:</span> <span class="hljs-string">string</span><br>			<span class="hljs-attr">port:</span> <span class="hljs-string">number</span><br>			<span class="hljs-attr">host:</span> <span class="hljs-string">string</span><br>			<span class="hljs-attr">scheme:</span> <span class="hljs-string">string</span><br>			<span class="hljs-attr">httpHeaders:</span><br>			<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span><br>				<span class="hljs-attr">value:</span> <span class="hljs-string">string</span><br>		<span class="hljs-attr">tcpSocket:</span><br>			<span class="hljs-attr">port:</span> <span class="hljs-string">number</span><br>		<span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">0</span><br>		<span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">0</span><br>		<span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">0</span><br>		<span class="hljs-attr">successThreshold:</span> <span class="hljs-number">0</span><br>		<span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">0</span><br>	<span class="hljs-attr">securityContext:</span><br>		<span class="hljs-attr">privileged:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">restartPolicy:</span> [<span class="hljs-string">Always|</span> <span class="hljs-string">Never</span> <span class="hljs-string">|</span> <span class="hljs-string">OnFailure</span>]<br><span class="hljs-attr">nodeSelector:</span> <span class="hljs-string">object</span><br><span class="hljs-attr">imagePullSecrets:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span><br><span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">volumes:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">string</span><br>	<span class="hljs-attr">emptyDir:</span> &#123;&#125;	<br>	<span class="hljs-attr">hostPath:</span><br>		<span class="hljs-attr">path:</span> <span class="hljs-string">string</span><br>	<span class="hljs-attr">secret:</span><br>		<span class="hljs-attr">secretName:</span> <span class="hljs-string">string</span><br>		<span class="hljs-attr">items:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">string</span><br>			<span class="hljs-attr">path:</span> <span class="hljs-string">string</span><br>	<span class="hljs-attr">configMap:</span><br>		<span class="hljs-attr">name:</span> <span class="hljs-string">string</span> <br>		<span class="hljs-attr">items:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">string</span><br>		  <span class="hljs-attr">path:</span> <span class="hljs-string">string</span><br><br></code></pre></td></tr></table></figure>
<p>各项详解</p>
<table>
<thead>
<tr>
<th>属性名称</th>
<th>取值类型</th>
<th>是否必选</th>
<th>取值说明</th>
</tr>
</thead>
<tbody><tr>
<td>version</td>
<td>String</td>
<td>Required</td>
<td>版本号，例如v1</td>
</tr>
<tr>
<td>kind</td>
<td>String</td>
<td>Required</td>
<td>Pod</td>
</tr>
<tr>
<td>metadata</td>
<td>Object</td>
<td>Required</td>
<td>元数据</td>
</tr>
<tr>
<td>metadata.name</td>
<td>String</td>
<td>Required</td>
<td>Pod的名称，命名规范需复合RFC1035规范</td>
</tr>
<tr>
<td>metadata.namespace</td>
<td>String</td>
<td>Required</td>
<td>Pod所属命名空间，缺省default</td>
</tr>
<tr>
<td>metadata.labels[]</td>
<td>List</td>
<td></td>
<td>自定义标签列表</td>
</tr>
<tr>
<td>metadata.annotation[]</td>
<td>List</td>
<td></td>
<td></td>
</tr>
<tr>
<td>自定义注解列表</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>spec</td>
<td>Object</td>
<td>Required</td>
<td>Pod中容器的详细定义</td>
</tr>
<tr>
<td>spec.containers[]</td>
<td>List</td>
<td>Required</td>
<td>Pod中的容器列表</td>
</tr>
<tr>
<td>spec.containers[].name</td>
<td>String</td>
<td>Required</td>
<td>容器名称，命名规范需复合RFC1035规范</td>
</tr>
<tr>
<td>spec.containers[].image</td>
<td>String</td>
<td>Required</td>
<td>容器镜像</td>
</tr>
<tr>
<td>spec.containers[].imagePullPolicy</td>
<td>String</td>
<td></td>
<td>Alway(默认值)/Never/IfNotPresetn/</td>
</tr>
<tr>
<td>spec.containers[].command[]</td>
<td>List</td>
<td></td>
<td>容器启动命令列表，缺省使用镜像打包时使用的启动命令</td>
</tr>
<tr>
<td>spec.containers[].args[]</td>
<td>List</td>
<td></td>
<td>容器的启动命令列表</td>
</tr>
<tr>
<td>spec.containers[].workingDir</td>
<td>String</td>
<td></td>
<td>容器的工作目录</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[]</td>
<td>List</td>
<td></td>
<td>挂载到容器内部的存储卷配置</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].name</td>
<td>String</td>
<td></td>
<td>卷名称</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].mountPath</td>
<td>String</td>
<td></td>
<td>挂载在容器内的绝对路径，应少于512字符</td>
</tr>
<tr>
<td>spec.containers[].volumeMounts[].readOnly</td>
<td>Boolean</td>
<td></td>
<td>是否只读，默认读写模式</td>
</tr>
<tr>
<td>spec.containers[].ports[]</td>
<td>List</td>
<td></td>
<td>容器需要暴露的端口</td>
</tr>
<tr>
<td>spec.containers[].ports[].name</td>
<td>String</td>
<td></td>
<td>端口名称</td>
</tr>
<tr>
<td>spec.containers[].ports[].containerPort</td>
<td>Int</td>
<td></td>
<td>容器需要监听的端口</td>
</tr>
<tr>
<td>spec.containers[].ports[].hostPort</td>
<td>Int</td>
<td></td>
<td>容器所在主机需要监听的端口，默认和containerPort相同，所在hostPort时，同一台宿主机无法启动该容器的第二份副本</td>
</tr>
<tr>
<td>spec.containers[].ports[].protocol</td>
<td>String</td>
<td></td>
<td>端口协议，支持TCP和UDP，默认TCP</td>
</tr>
<tr>
<td>spec.containers[].envs[]</td>
<td>List</td>
<td></td>
<td>容器运行前需设置的环境变量列表</td>
</tr>
<tr>
<td>spec.containers[].envs[].name</td>
<td>String</td>
<td></td>
<td>环境变量名称</td>
</tr>
<tr>
<td>spec.containers[].envs[].value</td>
<td>String</td>
<td></td>
<td>环境变量值</td>
</tr>
<tr>
<td>spec.containers[].resources</td>
<td>Object</td>
<td></td>
<td>资源限制和资源请求的设置</td>
</tr>
<tr>
<td>spec.containers[].resources.limits</td>
<td>Object</td>
<td></td>
<td>资源限制的设置</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.cpu</td>
<td>String</td>
<td></td>
<td>CPU限制，单位和core数，将用于docker run –cpu-shares参数</td>
</tr>
<tr>
<td>spec.containers[].resources.limits.memory</td>
<td>String</td>
<td></td>
<td>内存限制，单位可以是MiB、GiB等,将用于docker run –memory参数</td>
</tr>
<tr>
<td>spec.containers[].resources.requests</td>
<td>Object</td>
<td></td>
<td>资源请求的设置</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.cpu</td>
<td>String</td>
<td></td>
<td>CPU请求，单位为core数，容器启动的初始可用数量</td>
</tr>
<tr>
<td>spec.containers[].resources.requests.memory</td>
<td>String</td>
<td></td>
<td>内存请求，单位可以是MiB、GiB等,容器启动的初始可用数量</td>
</tr>
<tr>
<td>spec.volumes[]</td>
<td>List</td>
<td></td>
<td>在改Pod上定义的共享存储卷列表</td>
</tr>
<tr>
<td>spec.volumes[].name</td>
<td>String</td>
<td></td>
<td>共享存储卷的名称</td>
</tr>
<tr>
<td>spec.volumes[].emptyDir</td>
<td>Object</td>
<td></td>
<td>类型为emptyDir的存储卷，表示与Pod同生命周期的一个临时目录，其值为一个空对象{}</td>
</tr>
<tr>
<td>spec.volumes[].hostPath</td>
<td>Object</td>
<td></td>
<td>类型为hostPath的存储卷，表示与Pod挂载到宿主机目录</td>
</tr>
<tr>
<td>spec.volumes[].hostPath.path</td>
<td>String</td>
<td></td>
<td>Pod容器中挂载的宿主机路径</td>
</tr>
<tr>
<td>spec.volumes[].secret</td>
<td>Object</td>
<td></td>
<td>类型为secret的存储卷，表示挂载集群预定义的secret对象到容器内部</td>
</tr>
<tr>
<td>spec.volumes[].configMap</td>
<td>Object</td>
<td></td>
<td>类型为configMap的存储卷，表示挂载集群预定义的configMap对象到容器内部</td>
</tr>
<tr>
<td>spec.volumes[].livenessProbe</td>
<td>Object</td>
<td></td>
<td>对Pod内部容器健康检查的设置，当探测无响应几次后系统会自动重启该容器</td>
</tr>
<tr>
<td>spec.volumes[].livenessProbe.exec</td>
<td>Object</td>
<td></td>
<td>对Pod内容器健康检查的设置，exec方式</td>
</tr>
<tr>
<td>spec.volumes[].livenessProbe.exec.command[]</td>
<td>List</td>
<td></td>
<td>exec方式需要指定的命令或脚本</td>
</tr>
<tr>
<td>spec.volumes[].livenessProbe.httpGet</td>
<td>Object</td>
<td></td>
<td>对Pod内容器健康检查的设置，httpGet方式，需要指定path、port</td>
</tr>
<tr>
<td>spec.volumes[].livenessProbe.tcpSocket</td>
<td>Object</td>
<td></td>
<td>对Pod内容器健康检查的设置，tcpSocket方式</td>
</tr>
<tr>
<td>spec.volumes[].livenessProbe.initialDelaySeconds</td>
<td>Number</td>
<td></td>
<td>容器启动后首次探针的时间，单位为秒s</td>
</tr>
<tr>
<td>spec.volumes[].livenessProbe.timeoutSeconds</td>
<td>Number</td>
<td></td>
<td>对容器健康检查的超时时间</td>
</tr>
<tr>
<td>spec.volumes[].livenessProbe.periodSeconds</td>
<td>Number</td>
<td></td>
<td>定期检查事件，默认10秒</td>
</tr>
<tr>
<td>spec.restartPolicy</td>
<td>String</td>
<td></td>
<td>Pod重启策略，Always/OnFailure/Never</td>
</tr>
<tr>
<td>spec.nodeSelector</td>
<td>Object</td>
<td></td>
<td>设置Node的Label，以key:value格式指定，Pod将被调度到具有这些Label的Node上</td>
</tr>
<tr>
<td>spec.imagePullSecrets</td>
<td>Object</td>
<td></td>
<td>镜像下拉使用的secret，以key:value格式指定</td>
</tr>
<tr>
<td>spec.hostNetwork</td>
<td>Boolean</td>
<td></td>
<td>是否使用主机网络模式，默认false，启用true将不再使用docker网桥</td>
</tr>
</tbody></table>
<h2 id="Pod的基本用法"><a href="#Pod的基本用法" class="headerlink" title="Pod的基本用法"></a>Pod的基本用法</h2><p>一个Pod中可以包含多个容器，同一个Pod中的容器通信采用localhost就可以通信</p>
<h2 id="静态Pod"><a href="#静态Pod" class="headerlink" title="静态Pod"></a>静态Pod</h2><p>静态Pod是由kubelet进行管理的仅存在特定Node上的Pod，他们不能通过API Server进行管理，无法对ReplicationController、Deployment或者DaemonSet进行关联，静态Pod是由Node创建的所以总在kubelet所在Node上运行。</p>
<p>创建静态Pod有两种方式：配置文件方式和HTTP方式</p>
<ol>
<li><p>配置文件方式</p>
</li>
<li><p>HTTP方式</p>
<blockquote>
<p>通过设置kubelet的启动参数 <code>--mainfest-url</code>kubelet会定期从该url地址下载Pod的定义文件创建</p>
</blockquote>
</li>
</ol>
<h2 id="Pod容器共享Volume"><a href="#Pod容器共享Volume" class="headerlink" title="Pod容器共享Volume"></a>Pod容器共享Volume</h2><p>同一个Pod中的多个容器能够共享Pod级别的存储卷Volume。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: volume-pod<br>spec:<br>  containers:<br>    - name: tomcat<br>      image: tomcat<br>      ports:<br>        - containerPort: <span class="hljs-number">8080</span><br>      volumeMounts:<br>        - mountPath: /usr/local/tomcat/logs<br>          name: app-logs<br>    - name: busybox<br>      image: busybox<br>      command:<br>        - <span class="hljs-string">&quot;sh -c tail -f /logs/catalina*.log&quot;</span><br>      volumeMounts:<br>        - mountPath: /logs<br>          name: app-logs<br>  volumes:<br>    - name: app-logs<br>      emptyDir:<br>        &#123;&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>tip：在编写yaml可以在goland中下载k8s编辑插件，编写起来智能提示更加方便</p>
</blockquote>
<h2 id="Pod的配置管理"><a href="#Pod的配置管理" class="headerlink" title="Pod的配置管理"></a>Pod的配置管理</h2><p><strong>ConfigMap</strong></p>
<ul>
<li>生成容器内的环境变量</li>
<li>设置容器启动的命令和参数（需要设置为环境变量）</li>
<li>以Volume的形式挂载为容器内部的文件或目录</li>
</ul>
<ol>
<li><p>通过配置文件方式创建ConfigMap</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">apiVersion: v1<br>kind: ConfigMap<br>metadata: <br>  name: cm-appvars<br>data:<br>  apploglevel: info<br>  appdatadir: /<span class="hljs-keyword">var</span>/data<br></code></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">kubectl create -f cm-appvars.yaml<br></code></pre></td></tr></table></figure>
</li>
<li><p>通过kubectl命令行方式创建</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">kubectl create configmap NAME --from-file=[key=]source<br></code></pre></td></tr></table></figure>
<p>ConfigMap的使用</p>
</li>
<li><p>通过环境变量方式使用ConfigMap</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">env:<br>  - name: APPLOGLEVEL <br>    valueFrom:<br>      configMapKeyRef:<br>        key: apploglevel<br>        name: cm-appvars<br></code></pre></td></tr></table></figure>
</li>
<li><p>通过envForm方式</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">envFrom:<br>  - configMapRef:<br>      name: cm-appvars<br></code></pre></td></tr></table></figure>
</li>
<li><p>通过valueMount使用ConfigMap</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">volumes:<br>  - name: app-logs<br>    emptyDir:<br>      &#123;&#125;<br>  - name: serverxml<br>    configMap:<br>      name: cm-appvars<br>      items:<br>        - key: key-serverxml<br>          path: server.xml<br>        - key: key-loggingproperties<br>          path: logging.properties<br></code></pre></td></tr></table></figure>

</li>
</ol>
<p>使用ConfigMap的限制条件</p>
<ol>
<li>ConfigMap必须在Pod之前创建，Pod才能引用它</li>
<li>如果Pod使用envFrom基于ConfigMap定义环境变量，则无效的环境变量名称（如数字开头）将被忽略，并记录事件在InvalidVariableNames中</li>
<li>ConfigMap受命名空间限制，只有处于相同命名空间的Pod才能引用它</li>
<li>ConfigMap无法用于静态Pod</li>
</ol>
<h2 id="Pod的生命周期"><a href="#Pod的生命周期" class="headerlink" title="Pod的生命周期"></a>Pod的生命周期</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1673971134741-0166582d-a546-4058-8992-8bf398f921af.png#averageHue=%23dfe1de&clientId=u057889eb-9694-4&from=paste&height=211&id=u6aac122b&name=image.png&originHeight=422&originWidth=1602&originalType=binary&ratio=1&rotation=0&showTitle=false&size=931934&status=done&style=none&taskId=u2f038fac-68d9-4464-862d-67f79c9bec3&title=&width=801" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>Pod的重启策略</p>
<ul>
<li>Always: 当容器失效时，由kubelet自动重启该容器 </li>
<li>OnFailure: 当容器终止运行且退出码不为 0 时，由 kubelet 自动 重启该容器 </li>
<li>Never: 不论容器运行状态如何， kubelet 都不会重启该容器。</li>
</ul>
<p>Pod健康检查探针</p>
<ul>
<li>LivenessProbe探针：用于判断容器是否存活（Running状态），如果LivenessProbe探针探测到容器不健康，则kubelet将“杀掉容器”，如果容器不包含该探针则kubelet认为该容器返回值永远是SUCCESS</li>
<li>ReadinessProbe探针：用于判断容器是否可用（Ready状态），达到Ready状态才可以接收请求。</li>
<li>StartupProbe探针：某些应用会遇到启动比较慢的情况，例如应用程序启动时需 要与远程服务器建立网络连接，或者遇到网络访问较慢等情况时，会造成容器启动缓慢， 此时 ReadinessProbe 就不适用了，因为这属千“有且仅有一次＂的超长延时，可以通过 StartupProbe 探针解决该问题</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">spec:<br>  containers:<br>	livenessProbe:<br>        httpGet:<br>          port: <span class="hljs-number">80</span><br>          path: /status/health<br></code></pre></td></tr></table></figure>


<h2 id="Pod调度"><a href="#Pod调度" class="headerlink" title="Pod调度"></a>Pod调度</h2><ol>
<li><p>定义Deployment，其保护三个pod副本</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nginx-deployment<br>spec:<br>  selector:<br>    matchLabels:<br>      app: nginx<br>  replicas: <span class="hljs-number">3</span><br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:<br>        - name: nginx<br>          image: nginx:<span class="hljs-number">1.7</span><span class="hljs-number">.9</span><br>          ports:<br>            - containerPort: <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>创建Deployment</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">kubectl create -f nginx-deployment.yaml<br></code></pre></td></tr></table></figure>
</li>
<li><p>查看对应的Deployment</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">kubectl get deployments<br></code></pre></td></tr></table></figure>


</li>
</ol>
<h3 id="NodeSelector定向调度"><a href="#NodeSelector定向调度" class="headerlink" title="NodeSelector定向调度"></a>NodeSelector定向调度</h3><p>用于将Pod部署到指定的Node上</p>
<ol>
<li><p>首先需要在Node上打标签</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">kubectl label nodes kBs-node<span class="hljs-number">-1</span> zone=nort<br></code></pre></td></tr></table></figure>
</li>
<li><p>查看该节点的标签</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">kubectl describe node k8s-node01<br></code></pre></td></tr></table></figure>
</li>
<li><p>然后在Pod定义文件中修改配置 nodeSelector</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go">apiVersion: v1<br>kind: ReplicationController<br>metadata:<br>  name: redis-master<br>  labels:<br>    name: redis-master<br>spec:<br>  replicas: <span class="hljs-number">1</span><br>  selector:<br>    name: redis-master<br>  template:<br>    metadata:<br>      labels:<br>        name: redis-master<br>    spec:<br>      containers:<br>        - name: master<br>          image: kubeguide/redis-master<br>          ports:<br>            - containerPort: <span class="hljs-number">6379</span><br>      nodeSelector: #配置节点选择器只要节点的标签包含zone=north的才部署<br>        zone: north<br></code></pre></td></tr></table></figure>
<p>部署Pod</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">kubect create -f pod-node-selector.yaml<br></code></pre></td></tr></table></figure>
<p>查看日志</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">Normal   Scheduled               <span class="hljs-number">2</span>m27s              <span class="hljs-keyword">default</span>-scheduler  Successfully assigned <span class="hljs-keyword">default</span>/redis-master-vrnlb to k8s-node01<br></code></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="NodeAffinity"><a href="#NodeAffinity" class="headerlink" title="NodeAffinity"></a>NodeAffinity</h3><blockquote>
<p>Node亲和性调度，用于替换掉nodeSelector的机制</p>
</blockquote>
<ul>
<li><p>RequiredDuringSchedulingIgnoredDuringExecution: 须满足指定的规则才可以调 Pod Node 上（功能与 nodeSelector 很像，但是使用的是不同的语法），相当于硬限制。 </p>
</li>
<li><p>PreferredDuringSchedulingIgnoredDuringExecution: 强调优先满足指定规则，调度 器会尝试调度 Pod Node 上，但并不强求，相当于软限制 。多个优先级规则还 可以设置<strong>权重</strong> (weight) 值，以定义执行的先后顺序。</p>
</li>
</ul>
<ol>
<li>RequiredDuringSchedulingIgnoredDuringExecution在运行期间如果node的lable发生改变，其不在理会</li>
<li>如果同时定义了nodeSelector和nodeAffinity那么必须同时满足才能不是到对应的节点上</li>
<li></li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: with-node-affinity<br>spec:<br>  affinity: # 设置Pod的节点亲和性<br>    nodeAffinity:<br>      requiredDuringSchedulingIgnoredDuringExecution:<br>        nodeSelectorTerms: # 满足一个即可<br>          - matchExpressions: # 必须满足所有的exp<br>              - key: beta.kubernetes.io/arch<br>                operator: In<br>                values:<br>                  - arm64<br>      preferredDuringSchedulingIgnoredDuringExecution:<br>        - preference:<br>            matchExpressions:<br>              - key: disk-<span class="hljs-keyword">type</span><br>                operator: In<br>                values:<br>                  - ssd<br>          weight: <span class="hljs-number">1</span><br>  containers:<br>    - name: with-node-affinity<br>      image: gcr.io/google_containers/pause:<span class="hljs-number">2.0</span><br></code></pre></td></tr></table></figure>

<h3 id="PodAffinity"><a href="#PodAffinity" class="headerlink" title="PodAffinity"></a>PodAffinity</h3><blockquote>
<p>Pod亲和性与互斥调度策略，主要解决Pod之间相互依赖</p>
</blockquote>
<p>拓扑域：一个拓扑域由一些node节点组成，使用region表示机架、机房等的拓扑区域，用Zone表示地区，这样子跨度更大的拓扑区域</p>
<p>一般情况下我们可以认为一个Node就是一个拓扑域</p>
<p>kubernetes自带以下拓扑域</p>
<ul>
<li>kubernetes.io/hoostname</li>
<li>topology.kubernetes.io/region</li>
<li>topology.kubernetes.io/zone</li>
</ul>
<p>Pod的亲和性是在Pod的定义上添加<code>topologyKey</code> 属性</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go">apiVersion: v1<br>kind: Pod<br>metadata:<br>  name: pod-affinity<br>spec:<br>  affinity: # 设置Pod的节点亲和性<br>    podAffinity:<br>      requiredDuringSchedulingIgnoredDuringExecution:<br>        - topologyKey: kubernetes.io/hostname<br>          labelSelector:<br>            matchExpressions:<br>              - key: security<br>                operator: In<br>                values:<br>                  - S1<br>  containers:<br>    - name: pod-affinity<br>      image: gcr.io/google_containers/pause:<span class="hljs-number">2.0</span><br></code></pre></td></tr></table></figure>

<p>Pod的互斥性通过 <code>podAntiAffinity</code> 实现</p>
<h3 id="Taints-和-Tolerations"><a href="#Taints-和-Tolerations" class="headerlink" title="Taints 和 Tolerations"></a>Taints 和 Tolerations</h3><p>taint是解决Node拒绝Pod的运行，简单的说被标记为Taint的节点就是存在问题的节点，比如磁盘要满、资源不足等</p>
<p>为节点打taint</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">kubectl taint nodes k8s-node01 key=value:NoSchedule<br></code></pre></td></tr></table></figure>
<p>键为 key, 值为 value, Taint 的效果是 NoSchedule 这意味着除非 Pod 明确声明可以容忍这个 Taint, 不会被调度到 k8s-node01上。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go">tolerations:<br>  - key: <span class="hljs-string">&quot;key&quot;</span><br>    operator: <span class="hljs-string">&quot;Equal&quot;</span><br>    value: <span class="hljs-string">&quot;value&quot;</span><br>    effect: NoSchedule<br></code></pre></td></tr></table></figure>

<h3 id="Pod优先级调度"><a href="#Pod优先级调度" class="headerlink" title="Pod优先级调度"></a>Pod优先级调度</h3><blockquote>
<p>如果发生抢占的调度，高优先级Pod就可能抢占节点N，并将低优先级的节点驱逐出节点N</p>
</blockquote>
<p>配置优先级资源</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">apiVersion: scheduling.k8s.io/v1<br>kind: PriorityClass<br>metadata:<br>  name: high-priority<br>value: <span class="hljs-number">100000</span><br>globalDefault: <span class="hljs-literal">false</span><br>description: <span class="hljs-string">&quot;this priority class should be used for xxx service pods only&quot;</span><br></code></pre></td></tr></table></figure>
<p>引用优先级</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">high-priority-pod</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">env:</span> <span class="hljs-string">test</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>  <span class="hljs-attr">priorityClassName:</span> <span class="hljs-string">high-priority</span><br></code></pre></td></tr></table></figure>


<h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><blockquote>
<p>daemonSet是kubernetes 1.2版本新增的一种资源对象，用于管理集群中的每个Node上仅运行一份Pod的副本实例。</p>
</blockquote>
<p>适用场景</p>
<ul>
<li>在每个Node上都运行一个ClusterFs存储或者Ceph存储的Daemon进程</li>
<li>在每个Node上都运行一个日志采集程序，例如Fluentd或者Logstach</li>
<li>在每个Node上都运行一个性能监控程序，采集该节点的性能数据，例如Prometheus Node Exporter、Collectednew Relic agent或者Ganglia gmond等</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-cloud-logging</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd-cloud-logging</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-cloud-logging</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-cloud-logging</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-cloud-logging</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">gcr.io/google_containers/fluentd-elasticsearch:1.17</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">200Mi</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">FLUENTD_ARGS</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">-q</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/log</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">var-log</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/docker/containers</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">containers</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">containers</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/var/lib/docker/containers</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">var-log</span><br>          <span class="hljs-attr">hostPath:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/var/log</span><br></code></pre></td></tr></table></figure>
<p>查看结果</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@k8s-master01</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># kubectl get pods -n kube-system -o wide -l name=fluentd-cloud-logging</span><br><span class="hljs-string">NAME</span>                          <span class="hljs-string">READY</span>   <span class="hljs-string">STATUS</span>              <span class="hljs-string">RESTARTS</span>   <span class="hljs-string">AGE</span>   <span class="hljs-string">IP</span>       <span class="hljs-string">NODE</span>           <span class="hljs-string">NOMINATED</span> <span class="hljs-string">NODE</span>   <span class="hljs-string">READINESS</span> <span class="hljs-string">GATES</span><br><span class="hljs-string">fluentd-cloud-logging-g9tj4</span>   <span class="hljs-number">0</span><span class="hljs-string">/1</span>     <span class="hljs-string">ContainerCreating</span>   <span class="hljs-number">0</span>          <span class="hljs-string">16s</span>   <span class="hljs-string">&lt;none&gt;</span>   <span class="hljs-string">k8s-node02</span>     <span class="hljs-string">&lt;none&gt;</span>           <span class="hljs-string">&lt;none&gt;</span><br><span class="hljs-string">fluentd-cloud-logging-lqt87</span>   <span class="hljs-number">0</span><span class="hljs-string">/1</span>     <span class="hljs-string">ContainerCreating</span>   <span class="hljs-number">0</span>          <span class="hljs-string">16s</span>   <span class="hljs-string">&lt;none&gt;</span>   <span class="hljs-string">k8s-master01</span>   <span class="hljs-string">&lt;none&gt;</span>           <span class="hljs-string">&lt;none&gt;</span><br><span class="hljs-string">fluentd-cloud-logging-r294l</span>   <span class="hljs-number">0</span><span class="hljs-string">/1</span>     <span class="hljs-string">ContainerCreating</span>   <span class="hljs-number">0</span>          <span class="hljs-string">16s</span>   <span class="hljs-string">&lt;none&gt;</span>   <span class="hljs-string">k8s-node01</span>     <span class="hljs-string">&lt;none&gt;</span>           <span class="hljs-string">&lt;none&gt;</span><br>[<span class="hljs-string">root@k8s-master01</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure>


<h3 id="Job批处理调度"><a href="#Job批处理调度" class="headerlink" title="Job批处理调度"></a>Job批处理调度</h3><ul>
<li>Job Temlate Expansion 模式：一个Job对象对应一个待处理的Work item，有几个Work item就产生几个独立的Job</li>
<li>Queue with Pod Per Work Item 模式：采用任务队列存放Work item，在这种模式下Job会启动N个Pod每个Pod对应一个Work Item</li>
<li>Queue with Variable Pod Count 模式: 与上面的不同是Job启动的Pod数量是可变的</li>
<li>Single Job with Static Work Assignment 模式：一个Job产生多个Pod但它采用程序静态方式分配任务，而不是队列动态分配</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1674219860313-9a7b9e91-3c9c-4056-95bd-5d1a819ba211.png#averageHue=%23eeeeec&clientId=u5da1bd5a-8671-4&from=paste&height=454&id=u2709d4e4&name=image.png&originHeight=454&originWidth=1882&originalType=binary&ratio=1&rotation=0&showTitle=false&size=625860&status=done&style=none&taskId=ua49a868d-9163-4659-a074-a937a6003c0&title=&width=1882" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">process-item-task</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">jobgroup:</span> <span class="hljs-string">jobexample</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">jobexampple</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">jobgroup:</span> <span class="hljs-string">jobexample</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">c</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span><br>          <span class="hljs-attr">command:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;sh&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;-c&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;echo Processing item task&quot;</span><br>      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Never</span><br></code></pre></td></tr></table></figure>

<h3 id="CronJob定时任务"><a href="#CronJob定时任务" class="headerlink" title="CronJob定时任务"></a>CronJob定时任务</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml">&#123;<span class="hljs-string">Minutes</span>&#125; &#123;<span class="hljs-string">Hours</span>&#125; &#123;<span class="hljs-string">DayofMonth</span>&#125; &#123;<span class="hljs-string">Month</span>&#125; &#123;<span class="hljs-string">DayofWeek</span>&#125;<br></code></pre></td></tr></table></figure>
<p>Minutes : 可出现 “,” “-“ “*” “/“ 这四个字符，有效范围为 0-59</p>
<p>Hours : 可出现 “,” “-“ “*” “/“ 这四个字符，有效范围为 0-23</p>
<p>DayofMonth : 可出现 “,” “-“ “*” “/“ “?” “L” “W” “C” 这八个字符，有效范围为 1-31</p>
<p>Month : 可出现 “,” “-“ “*” “/“ 这四个字符，有效范围为 1-12的整数或者JAN-DEC</p>
<p>DayofWeek : 可出现 “,” “-“ “*” “/“ “?” “L” “W” “#” 这八个字符，有效范围为 1-7或者SUN-SAT</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">CronJob</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">jobTemplate:</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">template:</span><br>        <span class="hljs-attr">spec:</span><br>          <span class="hljs-attr">containers:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span><br>              <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span><br>              <span class="hljs-attr">args:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">/bin/sh</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">-c</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">date;</span> <span class="hljs-string">echo</span> <span class="hljs-string">Hello</span> <span class="hljs-string">from</span> <span class="hljs-string">the</span> <span class="hljs-string">Kubernetes</span> <span class="hljs-string">cluster</span><br>          <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">OnFailure</span><br>  <span class="hljs-attr">schedule:</span> <span class="hljs-string">&quot;*/1 * * * *&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="自定义调度器"><a href="#自定义调度器" class="headerlink" title="自定义调度器"></a>自定义调度器</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">schedulerName:</span> <span class="hljs-string">custom-scheduler</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br></code></pre></td></tr></table></figure>
<p>注意：如果自定义调度器还未在系统中部署，则默认的调度器会忽略这个Pod，这个Pod将永远处于Pending状态</p>
<h3 id="Pod容灾调度"><a href="#Pod容灾调度" class="headerlink" title="Pod容灾调度"></a>Pod容灾调度</h3><p>通过设置 topologySpreadConstraints 来将 Pod 均匀调度到不同的 Zone</p>
<p>案例：假如我们的集群被划分为多个Zone，我们有一个应用（对应的Pod标签为app=foo）需要在每个Zone均匀调度以实现容灾</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">topologySpreadConstraints:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">maxSkew:</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">topology.kubernetes.io/zone</span><br>    <span class="hljs-attr">whenUnsatisfiable:</span> <span class="hljs-string">DoNotSchedule</span><br>    <span class="hljs-attr">labelSelector:</span><br>      <span class="hljs-attr">matchLabels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">foo</span><br></code></pre></td></tr></table></figure>

<p>maxSkew: 用于指定Pod在各个Zone上调度时能容忍的最大不均衡数，数值越大，表示能接受的不均衡调度越大，值越小表示各个Zone的Pod数量分布越均匀</p>
<p><code>skew[topo]=count[topo]-min(count[topo])</code></p>
<p>例如有三个Zone，我们部署3个Pod到最高集群中，第一第二个Pod肯定是位于A、B中，第三个我们计算skew值</p>
<p>Zone A 的 skew=1-0=1<br>Zone B 的 skew=1-0=1<br>Zone C 的 skew=0-0=0<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1674225991483-369731c7-44f1-4e28-9bc6-19720658340f.png#averageHue=%23f0f0ef&clientId=u5da1bd5a-8671-4&from=paste&height=466&id=ua91362ca&name=image.png&originHeight=466&originWidth=1884&originalType=binary&ratio=1&rotation=0&showTitle=false&size=841296&status=done&style=none&taskId=uf0eca146-305b-4c05-acd0-98d4fb09571&title=&width=1884" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Init-Container初始化容器"><a href="#Init-Container初始化容器" class="headerlink" title="Init Container初始化容器"></a>Init Container初始化容器</h2><p>初始化操作</p>
<ul>
<li>等待其他关联组件正确运行（例如数据库或某个后台服务）</li>
<li>基于环境变量或配置模板生成配置文件</li>
<li>从远程数据库获取本地所需配置，或者将自身注册到某个中央数据库中</li>
<li>下载相关依赖包，或者对系统进行一些预配置操作</li>
</ul>
<p>根据Pod的重启策略，当init container运行失败而且设置了RestartPolicy=Never时，Pod将会启动失败；而设置RestartPolicy=Always时，Pod将会被系统自动重启。</p>
<p>案例：在创建Nginx的Pod之前进行创建index.html文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">initContainers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span><br>      <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">wget</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;-O&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;/work-dir/index.html&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">https://kubernetes.io</span><br>      <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/work-dir&quot;</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">workdir</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>      <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/usr/share/nginx/html</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">workdir</span><br>  <span class="hljs-attr">volumes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">workdir</span><br>      <span class="hljs-attr">emptyDir:</span><br>        &#123;&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Pod的升级和回滚"><a href="#Pod的升级和回滚" class="headerlink" title="Pod的升级和回滚"></a>Pod的升级和回滚</h2><p>kubernetes提供滚动升级，如果Pod是通过Deployment创建的，则用户可以在运行时修改Deployment的Pod定义（spec.template）或镜像名称，并应用到Deployment对象上，系统即可完成Deployment的rollout动作。</p>
<h3 id="Deployment的升级"><a href="#Deployment的升级" class="headerlink" title="Deployment的升级"></a>Deployment的升级</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-deployment</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.23.3</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure>

<ol>
<li><p>通过kubect set image 命令</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">set</span> <span class="hljs-string">image</span> <span class="hljs-string">deployment/nginx-deployment</span> <span class="hljs-string">nginx=nginx:latest</span><br></code></pre></td></tr></table></figure>
<p>或者通过kubectl edit 修改 Deployment</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">edit</span> <span class="hljs-string">deployment/nginx-deployment</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>使用 kubectl rollout status 命令查看 Deployment 的更新过程</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">status</span> <span class="hljs-string">deployment/nginx-deployment</span><br></code></pre></td></tr></table></figure>

</li>
</ol>
<p>滚动升级的原理</p>
<p>系统创建新的RelicaSet，并将其副本数量扩容，然后逐个对旧版本的Pod进行驱逐，最终只剩下新的RS中有Pod<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1674230629208-cbdb9085-7afe-4bad-a1cb-3251030a6aa4.png#averageHue=%23e3e4e1&clientId=uacf9b0d5-593f-4&from=paste&height=446&id=ucc6be652&name=image.png&originHeight=446&originWidth=2064&originalType=binary&ratio=1&rotation=0&showTitle=false&size=697885&status=done&style=none&taskId=ubda6e56c-8323-410d-b3a6-71cac1162e4&title=&width=2064" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Demplyment的回滚"><a href="#Demplyment的回滚" class="headerlink" title="Demplyment的回滚"></a>Demplyment的回滚</h3><ol>
<li><p>查看部署历史</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@k8s-master01</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># kubectl rollout history deployment/nginx-deployment </span><br><span class="hljs-string">deployment.apps/nginx-deployment</span> <br><span class="hljs-string">REVISION</span>  <span class="hljs-string">CHANGE-CAUSE</span><br><span class="hljs-number">1</span>         <span class="hljs-string">&lt;none&gt;</span><br><span class="hljs-number">2</span>         <span class="hljs-string">&lt;none&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>如果想要查看特定版本的信息 加上 –revision=3</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">history</span> <span class="hljs-string">deployment/nginx-deployment</span> <span class="hljs-string">--revision=3</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>回滚到上一个版本</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">undo</span> <span class="hljs-string">deployment/nginx-deployment</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>回滚到指定版本</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">undo</span> <span class="hljs-string">deployment/nginx-deployment</span> <span class="hljs-string">--to-revision=3</span><br></code></pre></td></tr></table></figure>
<p>暂停Deployment的滚动更新操作</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">rollout</span> <span class="hljs-string">pause</span> <span class="hljs-string">deployment/nginx-deployment</span><br></code></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="DaemonSet的更新策略"><a href="#DaemonSet的更新策略" class="headerlink" title="DaemonSet的更新策略"></a>DaemonSet的更新策略</h3><ul>
<li>OnDelete（缺省）</li>
<li>RollingUpdate</li>
</ul>
<p>OnDelete：新的Pod并不会被创建，直到用户将旧的Pod删除才会触发新建操作<br>RollingUpdate：该模式下会自动杀掉旧的Pod新建新的Pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd-cloud-logging</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">fluentd-cloud-logging</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">updateStrategy:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span><br></code></pre></td></tr></table></figure>

<h3 id="StatefulSet的更新策略"><a href="#StatefulSet的更新策略" class="headerlink" title="StatefulSet的更新策略"></a>StatefulSet的更新策略</h3><ul>
<li>updateStrategy</li>
<li>OnDelete</li>
<li>Partitioned</li>
<li>RollingUpdate</li>
</ul>
<h2 id="Pod的伸缩扩容"><a href="#Pod的伸缩扩容" class="headerlink" title="Pod的伸缩扩容"></a>Pod的伸缩扩容</h2><ul>
<li>手动模式：通过运行 kubectl scale 命令，对一个Deployment/RC进行Pod副本数量的设置。</li>
<li>自动模式：需要根据用户的指标或者自定义业务指标并指定Pod副本数量的范围。</li>
</ul>
<h3 id="手动模式"><a href="#手动模式" class="headerlink" title="手动模式"></a>手动模式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">scale</span> <span class="hljs-string">deployment</span> <span class="hljs-string">nginx-deployment</span> <span class="hljs-string">--replicas</span> <span class="hljs-number">5</span><br></code></pre></td></tr></table></figure>

<h3 id="自动模式"><a href="#自动模式" class="headerlink" title="自动模式"></a>自动模式</h3><p>HPA (Horizontal Pod Autoscaler)</p>
<p>指标类型</p>
<ol>
<li>Pod资源使用率：Pod级别的性能指标，通常是一个比率值，例如CPU的使用率</li>
<li>Pod自定义指标：Pod级别的性能指标，通常是一个数值，例如接收的请求数量</li>
<li>Object自定义指标或外包指标：通常是一个数值，需要容器应用以某种方式提供，例如HTTP URL “metrics”提供或者使用外部服务提供的指标采集URL</li>
</ol>
<p>扩容算法<code>desireReplicas=ceil[currentReplicas*(currentMetericValue/desiredMetericValue)]</code><br>即 <code>当前副本数 * （当前指标值/期望的指标值）</code>将结果向上取整</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">autoscaling/v2beta2</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">HorizontalPodAutoscaler</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">php-apache</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">maxReplicas:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 最大最小副本数</span><br>  <span class="hljs-attr">minReplicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">scaleTargetRef:</span> <span class="hljs-comment"># 目标作用对象，可以是Deployment、RC、RS</span><br>    <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br>    <span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">php-apache</span><br><span class="hljs-comment">#    V1版本</span><br><span class="hljs-comment">#  targetCPUUtilizationPercentage: 50 # 期望每个Pod的CPU使用率都是50%</span><br>  <span class="hljs-attr">metrics:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">Resource</span> <span class="hljs-comment"># Resource/Pods/Object/External</span><br>      <span class="hljs-attr">resource:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">cpu</span> <span class="hljs-comment"># CPU利用率超过50%后触发扩容</span><br>        <span class="hljs-attr">target:</span><br>          <span class="hljs-attr">type:</span> <span class="hljs-string">Utilization</span><br>          <span class="hljs-attr">averageUtilization:</span> <span class="hljs-number">50</span><br></code></pre></td></tr></table></figure>

<h4 id="基于自定义指标的HPA实践"><a href="#基于自定义指标的HPA实践" class="headerlink" title="基于自定义指标的HPA实践"></a>基于自定义指标的HPA实践</h4><p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1674274333780-ee084d95-c887-4cf4-89ec-3ae67929a567.png#averageHue=%23e3e4e2&clientId=u6905b23d-839c-4&from=paste&height=712&id=u6066da00&name=image.png&originHeight=712&originWidth=1212&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1071715&status=done&style=none&taskId=u2f8351f8-0753-467b-a59c-3fcccda0b77&title=&width=1212" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="使用StatefulSet搭建MongoDB集群"><a href="#使用StatefulSet搭建MongoDB集群" class="headerlink" title="使用StatefulSet搭建MongoDB集群"></a>使用StatefulSet搭建MongoDB集群</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1674274930170-169aa4d8-01d0-4086-89d9-5b69ec08dde6.png#averageHue=%23e1e3df&clientId=u6905b23d-839c-4&from=paste&height=1012&id=udc664209&name=image.png&originHeight=1012&originWidth=1696&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1718463&status=done&style=none&taskId=u377b4042-7f38-463a-85da-466dd5a5ba3&title=&width=1696" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ol>
<li>创建StorageClass对象<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 定义StorageClass</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">storage.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StorageClass</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">fast</span><br><span class="hljs-attr">provisioner:</span> <span class="hljs-string">kubernetes.io/glusterfs</span><br><span class="hljs-attr">parameters:</span><br>  <span class="hljs-attr">resturl:</span> <span class="hljs-string">&quot;http://&lt;heketi-rest-url&gt;&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># 定义Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mongo</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">mongo</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">27017</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">27017</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">role:</span> <span class="hljs-string">mongo</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># 定义 StatefulSet</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mongo</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">mongo</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">&quot;mongo&quot;</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">role:</span> <span class="hljs-string">mongo</span><br>        <span class="hljs-attr">environment:</span> <span class="hljs-string">test</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mongo</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">mongo</span><br>          <span class="hljs-attr">command:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;--repplSet&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">re0</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;--smallfiles&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;--norealloc&quot;</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">27017</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/data/db</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">mongo-persistent-storage</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mongo-sidecar</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">cvallance/mongo-k8s-sidecar</span><br>          <span class="hljs-attr">env:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MONGO_SIDECAR_POD_LABELS</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;role=mongo,environment=test&quot;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">KUBERNETES_MONGO_SERVICE_NAME</span><br>              <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;mongo&quot;</span><br>  <span class="hljs-attr">volumeClaimTemplates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">metadata:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">mongo-persistent-storage</span><br>        <span class="hljs-attr">annotations:</span><br>          <span class="hljs-attr">volume.beta.kubernetes.io/storage-class:</span> <span class="hljs-string">&quot;fast&quot;</span><br>      <span class="hljs-attr">spec:</span><br>        <span class="hljs-attr">accessModes:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;ReadWriteOnce&quot;</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">storage:</span> <span class="hljs-string">100Gi</span><br>    <br></code></pre></td></tr></table></figure>


</li>
</ol>
<h1 id="深入掌握Service"><a href="#深入掌握Service" class="headerlink" title="深入掌握Service"></a>深入掌握Service</h1><h2 id="Service定义详解"><a href="#Service定义详解" class="headerlink" title="Service定义详解"></a>Service定义详解</h2><table>
<thead>
<tr>
<th>属性名称</th>
<th>取值类型</th>
<th>是否必选</th>
<th>取值说明</th>
</tr>
</thead>
<tbody><tr>
<td>version</td>
<td>String</td>
<td>Required</td>
<td>版本号，例如v1</td>
</tr>
<tr>
<td>kind</td>
<td>String</td>
<td>Required</td>
<td>Service</td>
</tr>
<tr>
<td>metadata</td>
<td>Object</td>
<td>Required</td>
<td>元数据</td>
</tr>
<tr>
<td>metadata.name</td>
<td>String</td>
<td>Required</td>
<td>Pod的名称，命名规范需复合RFC1035规范</td>
</tr>
<tr>
<td>metadata.namespace</td>
<td>String</td>
<td>Required</td>
<td>Pod所属命名空间，缺省default</td>
</tr>
<tr>
<td>metadata.labels[]</td>
<td>List</td>
<td></td>
<td>自定义标签列表</td>
</tr>
<tr>
<td>metadata.annotation[]</td>
<td>List</td>
<td></td>
<td></td>
</tr>
<tr>
<td>自定义注解列表</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>spec</td>
<td>Object</td>
<td>Required</td>
<td>Service中容器的详细定义</td>
</tr>
<tr>
<td>spec.selector[]</td>
<td>List</td>
<td>Required</td>
<td>Label Selector配置，将具有指定Label标签的Pod作为管理范围</td>
</tr>
<tr>
<td>spec.type</td>
<td>string</td>
<td>required</td>
<td>Service的类型，指定Service的访问方式，默认值为ClusterIP。1.ClusterIP：虚拟服务IP地址，该地址用于Kubernetes集群内部的Pod访问，在Node上kube-proxy通过设置的iptables规则进行转发。2.NodePort：使用宿主机的端口，使能够访问各Node的外部客户端通过Node的IP地址和端口就能访问服务。3.LoadBalancer：使用外接负载均衡器完成到服务的负载分发，需要在spec.status.loadBalancer字段指定外部负载均衡器的IP地址，同时定义nodePort和ClusterIP，用于公有云环境</td>
</tr>
<tr>
<td>spec.clusterIP</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>虚拟服务的IP地址，当type=ClusterIP时，如果不指定，则系统进行自动分配，也可以手动指定；当type=LoadBalancer时，需要指定</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>spec.sessionAffinity</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>是否支持Session，可选值为ClientIP，默认值为None。ClientIP：表示将同一个客户端（根据客户端的IP地址决定）的访问请求都转发到同一个后端Pod</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>spec.ports[]</td>
<td>List</td>
<td></td>
<td>Service端口列表</td>
</tr>
<tr>
<td>spec.ports[].name</td>
<td>String</td>
<td></td>
<td>端口名称</td>
</tr>
<tr>
<td>spec.ports[].protocol</td>
<td>String</td>
<td></td>
<td>端口协议，支持TCP和UDP，默认TCP</td>
</tr>
<tr>
<td>spec.ports[].port</td>
<td>int</td>
<td></td>
<td>容器的工作目录</td>
</tr>
<tr>
<td>spec.ports[].targetPort</td>
<td>int</td>
<td></td>
<td>需要转发到后端Pod的端口号</td>
</tr>
<tr>
<td>spec.ports[].nodePort</td>
<td>int</td>
<td></td>
<td>当spec.type=NodePort时，指定映射到宿主机的端口号</td>
</tr>
<tr>
<td>status</td>
<td>Object</td>
<td></td>
<td>当spec.type=LoadBalancer时，设置外部负载均衡器的地址，用于公有云环境</td>
</tr>
<tr>
<td>status.loadBalancer</td>
<td>Object</td>
<td></td>
<td>外部负载均衡器</td>
</tr>
<tr>
<td>status.loadBalancer.ingress</td>
<td>Object</td>
<td></td>
<td>外部负载均衡器</td>
</tr>
<tr>
<td>status.loadBalancer.ingress.ip</td>
<td>String</td>
<td></td>
<td>外部负载均衡的IP地址</td>
</tr>
<tr>
<td>status.loadBalancer.ingress.hostname</td>
<td>String</td>
<td></td>
<td>外部负载均衡的主机名</td>
</tr>
</tbody></table>
<h2 id="Service的概念和原理"><a href="#Service的概念和原理" class="headerlink" title="Service的概念和原理"></a>Service的概念和原理</h2><h3 id="Service的概念"><a href="#Service的概念" class="headerlink" title="Service的概念"></a>Service的概念</h3><blockquote>
<p>Service主要用于提供网络服务，通过Service的定义，能够为客户端应用提供稳定的接口地址（域名或IP地址）和负载均衡功能，屏蔽后端Endpoint的变化。</p>
</blockquote>
<h3 id="创建Service"><a href="#创建Service" class="headerlink" title="创建Service"></a>创建Service</h3><ol>
<li><p>使用expose命令为某个Pod创建Service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">expose</span> <span class="hljs-string">deployment</span> <span class="hljs-string">webapp</span><br></code></pre></td></tr></table></figure>
<p>使用yaml文件方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span> <span class="hljs-comment">#Pod中所有含有标签 name=webapp的Pod</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>查看Service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">svc</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>通过Service的IP地址和Service的端口号就可以实现服务的访问</p>
</li>
</ol>
<h3 id="Service的负载均衡机制"><a href="#Service的负载均衡机制" class="headerlink" title="Service的负载均衡机制"></a>Service的负载均衡机制</h3><blockquote>
<p>从服务IP到后端Pod的负载均衡机制是由每个Node上的kube-proxy负责实现的</p>
</blockquote>
<h4 id="kube-proxy的代理模式"><a href="#kube-proxy的代理模式" class="headerlink" title="kube-proxy的代理模式"></a>kube-proxy的代理模式</h4><ul>
<li>userspace模式：用户空间模式，由kube-proxy完成代理的实现，效率最低，不推荐使用。</li>
<li>iptables模式：kube-proxy通过设置Linux Kernel的iptables规则，实现从Service到后端Endpoint列表的负载分发规则，效率高。但是，如果某个Endpoint在转发时不可用，此次客户端请求就会得到失败的响应，相比userspace模式更不可靠。应该通过Pod设置readinessprobe（服务可用健康检查）来保证只有达到ready状态的Endpoint才会被设置为Service的后端Endpoint。</li>
<li>kernelspace模式：windows server上的代理模式</li>
<li>ipvs模式：kube-proxy通过设置Linux Kernel的netlink接口设置IPVS规则，转发效率和吞吐量都最高，如果操作系统未启用IPVS内核模块，kube-proxy将会自动切换到iptable模式。其支持的负载均衡策略有：<ul>
<li>rr：round-robin，轮询</li>
<li>lc：least connection，最小连接数</li>
<li>dh：destination hashing，目的地址哈希</li>
<li>sh：source hashing，源地址哈希</li>
<li>sed：shortest expected delay，最短期望延时</li>
<li>nq：never queue，永不排队</li>
</ul>
</li>
</ul>
<h4 id="会话保持机制"><a href="#会话保持机制" class="headerlink" title="会话保持机制"></a>会话保持机制</h4><blockquote>
<p>通过设置sessionAffinity实现基于客户端IP保持机制，首次将某个客户端来源的请求转发到后端的某个Pod上，之后从相同的客户端IP发起的请求都将被转发到相同的Pod上。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">sessionAffinity:</span> <span class="hljs-string">ClientIP</span> <span class="hljs-comment"># 指定模式</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span><br></code></pre></td></tr></table></figure>
<p>设置会话的保持时间</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">sessionAffinity:</span> <span class="hljs-string">ClientIP</span> <span class="hljs-comment"># 指定模式</span><br>  <span class="hljs-attr">sessionAffinityConfig:</span> <span class="hljs-comment"># 配置</span><br>    <span class="hljs-attr">clientIP:</span><br>      <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">1000</span> <span class="hljs-comment"># 超时时间</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span><br></code></pre></td></tr></table></figure>

<h4 id="将外部访问定义未Service"><a href="#将外部访问定义未Service" class="headerlink" title="将外部访问定义未Service"></a>将外部访问定义未Service</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Endpoints</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br><span class="hljs-attr">subsets:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">addresses:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-number">1.2</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure>

<h4 id="将Service暴露到集群外部"><a href="#将Service暴露到集群外部" class="headerlink" title="将Service暴露到集群外部"></a>将Service暴露到集群外部</h4><p>Service的类型，指定Service的访问方式，默认值为ClusterIP。</p>
<ol>
<li><p>ClusterIP：虚拟服务IP地址，该地址用于Kubernetes集群内部的Pod访问，在Node上kube-proxy通过设置的iptables规则进行转发。</p>
</li>
<li><p>NodePort：使用宿主机的端口，使能够访问各Node的外部客户端通过Node的IP地址和端口就能访问服务。</p>
</li>
<li><p>LoadBalancer：使用外接负载均衡器完成到服务的负载分发，需要在spec.status.loadBalancer字段指定外部负载均衡器的IP地址，同时定义nodePort和ClusterIP，用于公有云环境</p>
</li>
<li><p>ExternalName：将Service映射为一个外部域名地址，通过externalName字段设置</p>
</li>
</ol>
<ul>
<li><p>NodePort类型</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">8081</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>LoadBalancer类型</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">MyApp</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9376</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-number">10.12</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br></code></pre></td></tr></table></figure>
<p>在服务创建成功之后，云服务商在Service的定义中补充LoadBalancer的IP的IP地址（staus字段）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">status:</span><br>	<span class="hljs-attr">loadBalancer:</span><br>  	<span class="hljs-attr">ingress:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">ip:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.100</span><span class="hljs-number">.21</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>ExternalName类型</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">prod</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ExternalName</span><br>  <span class="hljs-attr">externalName:</span> <span class="hljs-string">my.database.example.com</span><br></code></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Service支持的网络协议"><a href="#Service支持的网络协议" class="headerlink" title="Service支持的网络协议"></a>Service支持的网络协议</h3><ul>
<li>TCP</li>
<li>UDP</li>
<li>HTTP</li>
<li>PROXY</li>
<li>SCTP</li>
</ul>
<p>标记应用层协议，需要设置kube-apiserver启动参数，<code>--feature-gates=ServiceAppProtocol=true</code>进行开启</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">MyApp</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">9376</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">appProtocol:</span> <span class="hljs-string">HTTP</span> <span class="hljs-comment"># 应用层协议</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-number">10.12</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br></code></pre></td></tr></table></figure>

<h3 id="Kubernetes的服务发现机制"><a href="#Kubernetes的服务发现机制" class="headerlink" title="Kubernetes的服务发现机制"></a>Kubernetes的服务发现机制</h3><h4 id="环境变量方式"><a href="#环境变量方式" class="headerlink" title="环境变量方式"></a>环境变量方式</h4><blockquote>
<p>一个Pod运行起来的时候系统会自动为其容器运行环境注入所有集群中有效Service信息</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1674398850988-6a9c874e-c9fe-4e1c-82c8-254bce03cff8.png#averageHue=%23151728&clientId=u730d2129-d02b-4&from=paste&height=481&id=uf72fad29&name=image.png&originHeight=962&originWidth=1900&originalType=binary&ratio=1&rotation=0&showTitle=false&size=234519&status=done&style=none&taskId=uea6ec4a2-e2f5-4597-917b-40eac3a7364&title=&width=950" srcset="/img/loading.gif" lazyload alt="image.png"><br><code>curl http://$&#123;WEBAPP_SERVICE_HOST&#125;:$&#123;WEBAPP_SERVICE_HOST&#125;</code></p>
<h4 id="DNS方式"><a href="#DNS方式" class="headerlink" title="DNS方式"></a>DNS方式</h4><blockquote>
<p>Service在Kubernetes系统中遵循DNS命名规范，Service的DNS域名表示方法为 <code>&lt;servicename&gt;.&lt;namespace&gt;.svc.&lt;clusterdomain&gt;</code></p>
</blockquote>
<ul>
<li>servicename：服务的名称</li>
<li>namespace：所在namespace的名称</li>
<li>clusterdomain：Kubernetes集群设置的域名后缀</li>
</ul>
<h3 id="Headless-Service的概念和应用"><a href="#Headless-Service的概念和应用" class="headerlink" title="Headless Service的概念和应用"></a>Headless Service的概念和应用</h3><blockquote>
<p>这种Service没有入口访问地址（ClusterIP地址），kube-proxy不会为其创建负载转发规则，而服务名称（DNS域名）的解析规则取决于Headless Service是否设置了Label Selector</p>
</blockquote>
<ol>
<li><p>如果Headless Service设置了Label Selector将根据Label Selector查寻后端Pod列表，自动创建Endpoint列表，将服务名（DNS域名）的解析机制设置为当客户端访问服务名时，得到的是全部Endpoint列表，而不是一个确定的IP地址。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx</span><br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1674399893196-8ade8459-b4a4-4e69-9798-d7c30a38c3c8.png#averageHue=%23151728&clientId=u730d2129-d02b-4&from=paste&height=283&id=ud0b92079&name=image.png&originHeight=566&originWidth=958&originalType=binary&ratio=1&rotation=0&showTitle=false&size=90281&status=done&style=none&taskId=udeeb8733-c47f-4047-9026-11f888b9723&title=&width=479" srcset="/img/loading.gif" lazyload alt="image.png"></p>
</li>
<li><p>Headless Service 没有设置 Label Selector，k8s不会自动查看Endpoint列表</p>
</li>
</ol>
<h2 id="DNS服务搭建和配置指南"><a href="#DNS服务搭建和配置指南" class="headerlink" title="DNS服务搭建和配置指南"></a>DNS服务搭建和配置指南</h2><h3 id="修改每个Node上kubelet的DNS启动参数"><a href="#修改每个Node上kubelet的DNS启动参数" class="headerlink" title="修改每个Node上kubelet的DNS启动参数"></a>修改每个Node上kubelet的DNS启动参数</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">--cluster-dns=169.169.0.100:</span> <span class="hljs-string">为DNS服务的ClusterIP地址</span><br><span class="hljs-string">--cluster-domain=cluster.local:</span> <span class="hljs-string">为在DNS服务中设置的域名</span><br></code></pre></td></tr></table></figure>

<h3 id="部署CoreDNS服务"><a href="#部署CoreDNS服务" class="headerlink" title="部署CoreDNS服务"></a>部署CoreDNS服务</h3><ol>
<li><p>ConfigMap</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">coredns</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">EnsureExists</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">Corefile:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    cluster.local &#123;</span><br><span class="hljs-string">      errors</span><br><span class="hljs-string">      health &#123;</span><br><span class="hljs-string">        lameduck 5s</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">      ready</span><br><span class="hljs-string">      kubernetes cluster.local 169.169.0.0/16 &#123;</span><br><span class="hljs-string">        fallthrough in-addr.arpa ip6.arpa</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">      prometheus 9153</span><br><span class="hljs-string">      forward . /etc/resolv.conf</span><br><span class="hljs-string">      cache 30</span><br><span class="hljs-string">      loop</span><br><span class="hljs-string">      reload</span><br><span class="hljs-string">      loadbalance</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">    . &#123;</span><br><span class="hljs-string">      cache 30</span><br><span class="hljs-string">      loadbalance</span><br><span class="hljs-string">      forward . /etc/resolv.conf</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>
</li>
<li><p>Deployment</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">coredns</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kube-dns</span><br>    <span class="hljs-attr">kubernetes.io/name:</span> <span class="hljs-string">&quot;CoreDNS&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">strategy:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">RollingUpdate</span><br>    <span class="hljs-attr">rollingUpdate:</span><br>      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kube-dns</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kube-dns</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">priorityClassName:</span> <span class="hljs-string">system-cluster-critical</span><br>      <span class="hljs-attr">tolerations:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;CriticalAddonsOnly&quot;</span><br>          <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>      <span class="hljs-attr">nodeSelector:</span><br>        <span class="hljs-attr">kubernetes.io/os:</span> <span class="hljs-string">linux</span><br>      <span class="hljs-attr">affinity:</span><br>        <span class="hljs-attr">podAntiAffinity:</span><br>          <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">podAffinityTerm:</span><br>                <span class="hljs-attr">labelSelector:</span><br>                  <span class="hljs-attr">matchExpressions:</span><br>                    <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">k8s-app</span><br>                      <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                      <span class="hljs-attr">values:</span><br>                        <span class="hljs-bullet">-</span> <span class="hljs-string">kube-dns</span><br>                <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">kubernetes.io/hostname</span><br>              <span class="hljs-attr">weight:</span> <span class="hljs-number">100</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">coredns</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">coredns/coredns-arm64</span><br>          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>          <span class="hljs-attr">resources:</span><br>            <span class="hljs-attr">limits:</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">170Mi</span><br>            <span class="hljs-attr">requests:</span><br>              <span class="hljs-attr">cpu:</span> <span class="hljs-string">100m</span><br>              <span class="hljs-attr">memory:</span> <span class="hljs-string">70Mi</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">conf</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/coredns/Corefile</span><br>          <span class="hljs-attr">volumeMounts:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/coredns</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>              <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">53</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">dns</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">UDP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">53</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">dns-tcp</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9153</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">metrics</span><br>              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">securityContext:</span><br>            <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span><br>            <span class="hljs-attr">capabilities:</span><br>              <span class="hljs-attr">add:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">NET_BIND_SERVICE</span><br>              <span class="hljs-attr">drop:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">all</span><br>            <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">livenessProbe:</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/health</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span><br>            <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">successThreshold:</span> <span class="hljs-number">1</span><br>            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">readinessProbe:</span><br>            <span class="hljs-attr">httpGet:</span><br>              <span class="hljs-attr">port:</span> <span class="hljs-number">8181</span><br>              <span class="hljs-attr">scheme:</span> <span class="hljs-string">HTTP</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span><br>      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">Default</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>          <span class="hljs-attr">configMap:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">coredns</span><br>            <span class="hljs-attr">items:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">Corefile</span><br>                <span class="hljs-attr">path:</span> <span class="hljs-string">Corefile</span><br>              <br>              <br></code></pre></td></tr></table></figure>
</li>
<li><p> Service</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-dns</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">prometheus.io/port:</span> <span class="hljs-string">&quot;9153&quot;</span><br>    <span class="hljs-attr">prometheus.io/scrape:</span> <span class="hljs-string">&quot;true&quot;</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kube-dns</span><br>    <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">kubernetes.io/name:</span> <span class="hljs-string">&quot;CoreDNS&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kube-dns</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-number">169.169</span><span class="hljs-number">.0</span><span class="hljs-number">.100</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">53</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">dns</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">UDP</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">53</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">dns-tcp</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">9153</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">metrics</span><br></code></pre></td></tr></table></figure>
<p>使用一个带有 nslookup 工具的Pod来验证DNS服务</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">busybox</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">busybox</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">gcr.io/google_containers/busybox</span><br>      <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">sleep</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3600&quot;</span><br></code></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kubectl</span> <span class="hljs-string">exec</span> <span class="hljs-string">busybox</span> <span class="hljs-string">--</span> <span class="hljs-string">nslookup</span> <span class="hljs-string">redis-master</span><br></code></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="CoreDNS配置说明"><a href="#CoreDNS配置说明" class="headerlink" title="CoreDNS配置说明"></a>CoreDNS配置说明</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1674405639280-2ed32949-cc0f-4813-9176-57f87e5c25bf.png#averageHue=%23eaebe8&clientId=u730d2129-d02b-4&from=paste&height=404&id=u47df405c&name=image.png&originHeight=808&originWidth=1308&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1220374&status=done&style=none&taskId=ua0bb001a-77ec-4aea-8c41-4d294a91924&title=&width=654" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Node本地DNS缓存"><a href="#Node本地DNS缓存" class="headerlink" title="Node本地DNS缓存"></a>Node本地DNS缓存</h2><p>背景：</p>
<ol>
<li>CoreDNS以Service方式运行通过ClusterIP访问其访问量大时，其压力可能很大（可以通过扩容解决）</li>
<li>如果kube-proxy通过iptables解析域名性能可能很差</li>
</ol>
<p>基于以上原因引入了Node本地DNS缓存</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1674405958624-cf6a53be-589d-4436-bc8c-b6f9154ded1c.png#averageHue=%23e4e5e3&clientId=u730d2129-d02b-4&from=paste&height=343&id=u750be759&name=image.png&originHeight=686&originWidth=1342&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1225990&status=done&style=none&taskId=u11792168-d439-4274-974c-be103da5103&title=&width=671" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678593150327-2f015738-665d-4c90-ae76-87ab2a05a90f.png#averageHue=%23d9d9d7&clientId=uc9ee8b99-05f1-4&from=paste&height=430&id=u7eaeb234&name=image.png&originHeight=860&originWidth=1098&originalType=binary&ratio=2&rotation=0&showTitle=false&size=557552&status=done&style=none&taskId=u81e1261b-a10d-4c59-b22f-4d0c718283a&title=&width=549" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">node-local-dns</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-dns-upstream</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kube-dns</span><br>    <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br>    <span class="hljs-attr">kubernetes.io/name:</span> <span class="hljs-string">&quot;KubeDNSUpstream&quot;</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dns</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">53</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">UDP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">53</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dns-tcp</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">53</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">53</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kube-dns</span><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">node-local-dns</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">Corefile:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    cluster.local:53 &#123;</span><br><span class="hljs-string">        errors</span><br><span class="hljs-string">        cache &#123;</span><br><span class="hljs-string">                success 9984 30</span><br><span class="hljs-string">                denial 9984 5</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        reload</span><br><span class="hljs-string">        loop</span><br><span class="hljs-string">        bind 169.254.20.10</span><br><span class="hljs-string">        forward . 169.169.0.100 &#123;</span><br><span class="hljs-string">                force_tcp</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        prometheus :9253</span><br><span class="hljs-string">        health 169.254.20.10:8081</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    in-addr.arpa:53 &#123;</span><br><span class="hljs-string">        errors</span><br><span class="hljs-string">        cache 30</span><br><span class="hljs-string">        reload</span><br><span class="hljs-string">        loop</span><br><span class="hljs-string">        bind 169.254.20.10</span><br><span class="hljs-string">        forward . 169.169.0.100 &#123;</span><br><span class="hljs-string">                force_tcp</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        prometheus :9253</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    ip6.arpa:53 &#123;</span><br><span class="hljs-string">        errors</span><br><span class="hljs-string">        cache 30</span><br><span class="hljs-string">        reload</span><br><span class="hljs-string">        loop</span><br><span class="hljs-string">        bind 169.254.20.10</span><br><span class="hljs-string">        forward . 169.169.0.100 &#123;</span><br><span class="hljs-string">                force_tcp</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        prometheus :9253</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">    .:53 &#123;</span><br><span class="hljs-string">        errors</span><br><span class="hljs-string">        cache 30</span><br><span class="hljs-string">        reload</span><br><span class="hljs-string">        loop</span><br><span class="hljs-string">        bind 169.254.20.10</span><br><span class="hljs-string">        forward . 169.169.0.100 &#123;</span><br><span class="hljs-string">                force_tcp</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        prometheus :9253</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string"></span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">node-local-dns</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">node-local-dns</span><br>    <span class="hljs-attr">kubernetes.io/cluster-service:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">addonmanager.kubernetes.io/mode:</span> <span class="hljs-string">Reconcile</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">updateStrategy:</span><br>    <span class="hljs-attr">rollingUpdate:</span><br>      <span class="hljs-attr">maxUnavailable:</span> <span class="hljs-number">10</span><span class="hljs-string">%</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">node-local-dns</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">node-local-dns</span><br>      <span class="hljs-attr">annotations:</span><br>        <span class="hljs-attr">prometheus.io/port:</span> <span class="hljs-string">&quot;9253&quot;</span><br>        <span class="hljs-attr">prometheus.io/scrape:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">priorityClassName:</span> <span class="hljs-string">system-node-critical</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">node-local-dns</span><br>      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">Default</span>  <span class="hljs-comment"># Don&#x27;t use cluster DNS.</span><br>      <span class="hljs-attr">tolerations:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">&quot;CriticalAddonsOnly&quot;</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoExecute&quot;</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">&quot;NoSchedule&quot;</span><br>        <span class="hljs-attr">operator:</span> <span class="hljs-string">&quot;Exists&quot;</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">node-cache</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">k8s.gcr.io/k8s-dns-node-cache:1.15.13</span><br>        <span class="hljs-attr">resources:</span><br>          <span class="hljs-attr">requests:</span><br>            <span class="hljs-attr">cpu:</span> <span class="hljs-string">25m</span><br>            <span class="hljs-attr">memory:</span> <span class="hljs-string">5Mi</span><br>        <span class="hljs-attr">args:</span> [ <span class="hljs-string">&quot;-localip&quot;</span>, <span class="hljs-string">&quot;169.254.20.10&quot;</span>, <span class="hljs-string">&quot;-conf&quot;</span>, <span class="hljs-string">&quot;/etc/Corefile&quot;</span>, <span class="hljs-string">&quot;-upstreamsvc&quot;</span>, <span class="hljs-string">&quot;kube-dns-upstream&quot;</span> ]<br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">privileged:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">53</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">dns</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">UDP</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">53</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">dns-tcp</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">9253</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">metrics</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>        <span class="hljs-attr">livenessProbe:</span><br>          <span class="hljs-attr">httpGet:</span><br>            <span class="hljs-attr">host:</span> <span class="hljs-number">169.254</span><span class="hljs-number">.20</span><span class="hljs-number">.10</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/health</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/run/xtables.lock</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">xtables-lock</span><br>          <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/coredns</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kube-dns-config</span><br>          <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/kube-dns</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">xtables-lock</span><br>        <span class="hljs-attr">hostPath:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/run/xtables.lock</span><br>          <span class="hljs-attr">type:</span> <span class="hljs-string">FileOrCreate</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">kube-dns-config</span><br>        <span class="hljs-attr">configMap:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">coredns</span><br>          <span class="hljs-attr">optional:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span><br>        <span class="hljs-attr">configMap:</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">node-local-dns</span><br>          <span class="hljs-attr">items:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">Corefile</span><br>              <span class="hljs-attr">path:</span> <span class="hljs-string">Corefile.base</span><br></code></pre></td></tr></table></figure>

<h2 id="Pod-DNS-域名相关特性"><a href="#Pod-DNS-域名相关特性" class="headerlink" title="Pod DNS 域名相关特性"></a>Pod DNS 域名相关特性</h2><p>对Pod来说，Kubernetes会为其设置一个 <code>&lt;pod-ip&gt;.&lt;namespace&gt;.pod.&lt;cluster-domain&gt;</code>格式的域名，其中“-”替换掉“.”符号</p>
<h3 id="自定义子域名"><a href="#自定义子域名" class="headerlink" title="自定义子域名"></a>自定义子域名</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">webapp1</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">webapp1</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">hostname:</span> <span class="hljs-string">webapp-1</span><br>  <span class="hljs-attr">subdomain:</span> <span class="hljs-string">mysubdomain</span> <span class="hljs-comment">#自定义子域名</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">webapp1</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">kubeguide/tomcat-app:v1</span><br>    <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mysubdomain</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">webapp</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure>

<h3 id="Pod的DNS策略"><a href="#Pod的DNS策略" class="headerlink" title="Pod的DNS策略"></a>Pod的DNS策略</h3><p>Kubernetes可以在Pod级别通过dnsPolicy字段设置DNS策略，目前支持的</p>
<ul>
<li>Default：基础Pod所在宿主机的域名解析设置</li>
<li>ClusterFirst：优先使用Kubernetes环境的DNS服务</li>
<li>ClusterFirestWithHostNet：适用于hostNetwork模式运行的Pod</li>
<li>None：忽略Kubernetes集群的DNS配置，需要通过手动配置dnsConfig自定义</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirstWithHostNet</span><br></code></pre></td></tr></table></figure>


<h2 id="Ingress-7-层路由机制"><a href="#Ingress-7-层路由机制" class="headerlink" title="Ingress 7 层路由机制"></a>Ingress 7 层路由机制</h2><p>Service的表现形式是 IP+端口 可知其工作在TCP/IP层，我们应用层很多时候不同的路径请求到不同的应用上，service无法做到这一点（如<a target="_blank" rel="noopener" href="http://www.demo.com/a%E5%92%8Chttp://www.demo.com/b%E9%9C%80%E8%A6%81%E8%BD%AC%E5%88%B0%E4%B8%8D%E5%90%8C%E7%9A%84%E5%BA%94%E7%94%A8%E4%B8%8A%EF%BC%89">http://www.demo.com/a和http://www.demo.com/b需要转到不同的应用上）</a></p>
<p>基于上面Kubernetes提供了Ingress策略定义和一个具体提供转发服务的Ingress Controller，两者结合实现了基于灵活Ingress策略定义的服务路由功能</p>
<blockquote>
<p>Ingress只能以HTTP/S提供服务</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678614296066-1ab82039-7109-4803-a86e-19c5f36dd59e.png#averageHue=%23f5f6f4&clientId=uc9ee8b99-05f1-4&from=paste&height=285&id=u0b5b3cb2&name=image.png&originHeight=570&originWidth=798&originalType=binary&ratio=2&rotation=0&showTitle=false&size=407327&status=done&style=none&taskId=uc49b07d1-0409-4ba7-8248-3e0f900243b&title=&width=399" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678614660886-19faf86a-1798-4b2e-970f-0b57c715e0e5.png#averageHue=%23e6e7e4&clientId=uc9ee8b99-05f1-4&from=paste&height=91&id=u3968cf1d&name=image.png&originHeight=182&originWidth=1200&originalType=binary&ratio=2&rotation=0&showTitle=false&size=314971&status=done&style=none&taskId=u568739c1-e6b9-4f2a-957d-a3744593402&title=&width=600" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress</span><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">rules:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">secrets</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">update</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">create</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">events</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">create</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">patch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">extensions</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;extensions&quot;</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses/status</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">update</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">k8s.nginx.org</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">virtualservers</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">virtualserverroutes</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">globalconfigurations</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">transportservers</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">policies</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">k8s.nginx.org</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">virtualservers/status</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">virtualserverroutes/status</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">update</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default-server-secret</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">tls.crt:</span> <span class="hljs-string">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2akNDQWFZQ0NRREFPRjl0THNhWFhEQU5CZ2txaGtpRzl3MEJBUXNGQURBaE1SOHdIUVlEVlFRRERCWk8KUjBsT1dFbHVaM0psYzNORGIyNTBjbTlzYkdWeU1CNFhEVEU0TURreE1qRTRNRE16TlZvWERUSXpNRGt4TVRFNApNRE16TlZvd0lURWZNQjBHQTFVRUF3d1dUa2RKVGxoSmJtZHlaWE56UTI5dWRISnZiR3hsY2pDQ0FTSXdEUVlKCktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUwvN2hIUEtFWGRMdjNyaUM3QlBrMTNpWkt5eTlyQ08KR2xZUXYyK2EzUDF0azIrS3YwVGF5aGRCbDRrcnNUcTZzZm8vWUk1Y2Vhbkw4WGM3U1pyQkVRYm9EN2REbWs1Qgo4eDZLS2xHWU5IWlg0Rm5UZ0VPaStlM2ptTFFxRlBSY1kzVnNPazFFeUZBL0JnWlJVbkNHZUtGeERSN0tQdGhyCmtqSXVuektURXUyaDU4Tlp0S21ScUJHdDEwcTNRYzhZT3ExM2FnbmovUWRjc0ZYYTJnMjB1K1lYZDdoZ3krZksKWk4vVUkxQUQ0YzZyM1lma1ZWUmVHd1lxQVp1WXN2V0RKbW1GNWRwdEMzN011cDBPRUxVTExSakZJOTZXNXIwSAo1TmdPc25NWFJNV1hYVlpiNWRxT3R0SmRtS3FhZ25TZ1JQQVpQN2MwQjFQU2FqYzZjNGZRVXpNQ0F3RUFBVEFOCkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQWpLb2tRdGRPcEsrTzhibWVPc3lySmdJSXJycVFVY2ZOUitjb0hZVUoKdGhrYnhITFMzR3VBTWI5dm15VExPY2xxeC9aYzJPblEwMEJCLzlTb0swcitFZ1U2UlVrRWtWcitTTFA3NTdUWgozZWI4dmdPdEduMS9ienM3bzNBaS9kclkrcUI5Q2k1S3lPc3FHTG1US2xFaUtOYkcyR1ZyTWxjS0ZYQU80YTY3Cklnc1hzYktNbTQwV1U3cG9mcGltU1ZmaXFSdkV5YmN3N0NYODF6cFErUyt1eHRYK2VBZ3V0NHh3VlI5d2IyVXYKelhuZk9HbWhWNThDd1dIQnNKa0kxNXhaa2VUWXdSN0diaEFMSkZUUkk3dkhvQXprTWIzbjAxQjQyWjNrN3RXNQpJUDFmTlpIOFUvOWxiUHNoT21FRFZkdjF5ZytVRVJxbStGSis2R0oxeFJGcGZnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br>  <span class="hljs-attr">tls.key:</span> <span class="hljs-string">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdi91RWM4b1JkMHUvZXVJTHNFK1RYZUprckxMMnNJNGFWaEMvYjVyYy9XMlRiNHEvClJOcktGMEdYaVN1eE9ycXgrajlnamx4NXFjdnhkenRKbXNFUkJ1Z1B0ME9hVGtIekhvb3FVWmcwZGxmZ1dkT0EKUTZMNTdlT1l0Q29VOUZ4amRXdzZUVVRJVUQ4R0JsRlNjSVo0b1hFTkhzbysyR3VTTWk2Zk1wTVM3YUhudzFtMApxWkdvRWEzWFNyZEJ6eGc2clhkcUNlUDlCMXl3VmRyYURiUzc1aGQzdUdETDU4cGszOVFqVUFQaHpxdmRoK1JWClZGNGJCaW9CbTVpeTlZTW1hWVhsMm0wTGZzeTZuUTRRdFFzdEdNVWozcGJtdlFmazJBNnljeGRFeFpkZFZsdmwKMm82MjBsMllxcHFDZEtCRThCay90elFIVTlKcU56cHpoOUJUTXdJREFRQUJBb0lCQVFDZklHbXowOHhRVmorNwpLZnZJUXQwQ0YzR2MxNld6eDhVNml4MHg4Mm15d1kxUUNlL3BzWE9LZlRxT1h1SENyUlp5TnUvZ2IvUUQ4bUFOCmxOMjRZTWl0TWRJODg5TEZoTkp3QU5OODJDeTczckM5bzVvUDlkazAvYzRIbjAzSkVYNzZ5QjgzQm9rR1FvYksKMjhMNk0rdHUzUmFqNjd6Vmc2d2szaEhrU0pXSzBwV1YrSjdrUkRWYmhDYUZhNk5nMUZNRWxhTlozVDhhUUtyQgpDUDNDeEFTdjYxWTk5TEI4KzNXWVFIK3NYaTVGM01pYVNBZ1BkQUk3WEh1dXFET1lvMU5PL0JoSGt1aVg2QnRtCnorNTZud2pZMy8yUytSRmNBc3JMTnIwMDJZZi9oY0IraVlDNzVWYmcydVd6WTY3TWdOTGQ5VW9RU3BDRkYrVm4KM0cyUnhybnhBb0dCQU40U3M0ZVlPU2huMVpQQjdhTUZsY0k2RHR2S2ErTGZTTXFyY2pOZjJlSEpZNnhubmxKdgpGenpGL2RiVWVTbWxSekR0WkdlcXZXaHFISy9iTjIyeWJhOU1WMDlRQ0JFTk5jNmtWajJTVHpUWkJVbEx4QzYrCk93Z0wyZHhKendWelU0VC84ajdHalRUN05BZVpFS2FvRHFyRG5BYWkyaW5oZU1JVWZHRXFGKzJyQW9HQkFOMVAKK0tZL0lsS3RWRzRKSklQNzBjUis3RmpyeXJpY05iWCtQVzUvOXFHaWxnY2grZ3l4b25BWlBpd2NpeDN3QVpGdwpaZC96ZFB2aTBkWEppc1BSZjRMazg5b2pCUmpiRmRmc2l5UmJYbyt3TFU4NUhRU2NGMnN5aUFPaTVBRHdVU0FkCm45YWFweUNweEFkREtERHdObit3ZFhtaTZ0OHRpSFRkK3RoVDhkaVpBb0dCQUt6Wis1bG9OOTBtYlF4VVh5YUwKMjFSUm9tMGJjcndsTmVCaWNFSmlzaEhYa2xpSVVxZ3hSZklNM2hhUVRUcklKZENFaHFsV01aV0xPb2I2NTNyZgo3aFlMSXM1ZUtka3o0aFRVdnpldm9TMHVXcm9CV2xOVHlGanIrSWhKZnZUc0hpOGdsU3FkbXgySkJhZUFVWUNXCndNdlQ4NmNLclNyNkQrZG8wS05FZzFsL0FvR0FlMkFVdHVFbFNqLzBmRzgrV3hHc1RFV1JqclRNUzRSUjhRWXQKeXdjdFA4aDZxTGxKUTRCWGxQU05rMXZLTmtOUkxIb2pZT2pCQTViYjhibXNVU1BlV09NNENoaFJ4QnlHbmR2eAphYkJDRkFwY0IvbEg4d1R0alVZYlN5T294ZGt5OEp0ek90ajJhS0FiZHd6NlArWDZDODhjZmxYVFo5MWpYL3RMCjF3TmRKS2tDZ1lCbyt0UzB5TzJ2SWFmK2UwSkN5TGhzVDQ5cTN3Zis2QWVqWGx2WDJ1VnRYejN5QTZnbXo5aCsKcDNlK2JMRUxwb3B0WFhNdUFRR0xhUkcrYlNNcjR5dERYbE5ZSndUeThXczNKY3dlSTdqZVp2b0ZpbmNvVlVIMwphdmxoTUVCRGYxSjltSDB5cDBwWUNaS2ROdHNvZEZtQktzVEtQMjJhTmtsVVhCS3gyZzR6cFE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">data:</span><br><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-ingress</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-ingress</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">nodeSelector:</span><br>        <span class="hljs-attr">role:</span> <span class="hljs-string">ingress-nginx-controller</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">nginx-ingress</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">nginx/nginx-ingress:1.7.2</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-ingress</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>          <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>          <span class="hljs-attr">hostPort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">https</span><br>          <span class="hljs-attr">containerPort:</span> <span class="hljs-number">443</span><br>          <span class="hljs-attr">hostPort:</span> <span class="hljs-number">443</span><br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">101</span> <span class="hljs-comment">#nginx</span><br>          <span class="hljs-attr">capabilities:</span><br>            <span class="hljs-attr">drop:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">ALL</span><br>            <span class="hljs-attr">add:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">NET_BIND_SERVICE</span><br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAMESPACE</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.namespace</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">POD_NAME</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">fieldRef:</span><br>              <span class="hljs-attr">fieldPath:</span> <span class="hljs-string">metadata.name</span><br>        <span class="hljs-attr">args:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">-nginx-configmaps=$(POD_NAMESPACE)/nginx-config</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">-default-server-tls-secret=$(POD_NAMESPACE)/default-server-secret</span><br><br><br><br><br><span class="hljs-comment"># mywebsite-ingress.yaml</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mywebsite-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">mywebsite.com</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/demo</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">ImplementationSpecific</span><br>        <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">service:</span><br>            <span class="hljs-attr">name:</span> <span class="hljs-string">webapp</span><br>            <span class="hljs-attr">port:</span><br>              <span class="hljs-attr">number:</span> <span class="hljs-number">8080</span><br><br><br><br><span class="hljs-string">curl</span> <span class="hljs-string">--resolve</span> <span class="hljs-string">mywebsite.com:80:192.168.18.3</span> <span class="hljs-string">http://mywebsite.com/demo/</span><br><br><span class="hljs-string">curl</span> <span class="hljs-string">-H</span> <span class="hljs-string">&#x27;Host:mywebsite.com&#x27;</span> <span class="hljs-string">http://192.168.18.3/demo/</span><br></code></pre></td></tr></table></figure>

<h1 id="核心组件运行机制"><a href="#核心组件运行机制" class="headerlink" title="核心组件运行机制"></a>核心组件运行机制</h1><h2 id="Kubernetes-API-Server-原理解析"><a href="#Kubernetes-API-Server-原理解析" class="headerlink" title="Kubernetes API Server 原理解析"></a>Kubernetes API Server 原理解析</h2><p>api-server是提供Kubernetes各类资源对象（如Pod、RC、Service等）的CRUD及Watch等HTTP REST接口，称为集群内各个功能模块直接的数据交互和通信的中心枢纽。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678620486937-c41c7563-d250-43d4-b39a-16bfe285bc0c.png#averageHue=%23f1f2f0&clientId=uc9ee8b99-05f1-4&from=paste&height=503&id=ub686aaf0&name=image.png&originHeight=1006&originWidth=1034&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1306653&status=done&style=none&taskId=udc860bf1-d858-4d60-928f-1366bef1470&title=&width=517" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678620663601-2a3261f3-dc66-4dc1-b160-7b1019b48d66.png#averageHue=%23edefeb&clientId=uc9ee8b99-05f1-4&from=paste&height=353&id=uecfab59a&name=image.png&originHeight=706&originWidth=1242&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1017572&status=done&style=none&taskId=u534df1aa-b873-411b-8646-5dc6015ff36&title=&width=621" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<p>Kubernetes中的CRD在API Server中的设计和实现机制，每种官方的资源对象如Node、Pod、Service等的实现都包含以下功能</p>
<ul>
<li>资源对象的元数据（Schema）的定义：可以将其理解为数据库 Table的定义，定</li>
</ul>
<p>义了对应资源对象的数据结构，官方内建资源对象的元数据定义是固化在源码中的。</p>
<ul>
<li>资源对象的校验逻辑：确保用户提交的资源对象的属性的合法性。</li>
<li>资源对象的 CRUD 操作代码：可以将其理解为数据库表的 CRUD 代码，但比后</li>
</ul>
<p>者更难，因为 API Server 对资源对象的 CRUD 操作都会保存到etcd 数据库中，对处理性<br>能的要求也更高，还要考虑版本兼容性和版本转换等复杂问题。</p>
<ul>
<li>资源对象相关的“自动控制器”（如 RC、Deployment 等资源对象背后的控制器）：</li>
</ul>
<p>这是很重要的一个功能。Kubernetes 是一个以自动化为核心目标的平台，用户给出期望的<br>资源对象声明，运行过程中由资源背后的“自动控制器〞确保对应资源对象的数量、状态<br>行为等始终符合用户的预期。</p>
<p>类似地，每个自定义 CRD 的开发人员都需要实现上面的功能。为了降低编程难度与工作量，API Server 的设计者们做出了大量努力，使得直接编写 YAML 定义文件即可实现以上前了个功能。对于唯一需要编程的第 4个功能，由于 API Server 提供了大量的基础API 库，特别是易用的List-Watch 的编程框架，所以 CRD 自动控制器的编程难度大大降低。</p>
<h3 id="Kubernetes-Proxy-API-接口"><a href="#Kubernetes-Proxy-API-接口" class="headerlink" title="Kubernetes Proxy API 接口"></a>Kubernetes Proxy API 接口</h3><p>这类接口的作用是代理REST请求，即Kubernetes API Server把接收到的REST请求转发到某个Node上的kubelet时间戳的REST端口，由该进程负责响应</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678628479559-706fffd9-9343-4f59-a20b-5f053670e7b1.png#averageHue=%23b8bbb7&clientId=uc9ee8b99-05f1-4&from=paste&height=369&id=u993f318a&name=image.png&originHeight=738&originWidth=1302&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1335305&status=done&style=none&taskId=ue7b7dc90-e253-4f53-8148-813837b6f6a&title=&width=651" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="API-Server-网络隔离的设计"><a href="#API-Server-网络隔离的设计" class="headerlink" title="API Server 网络隔离的设计"></a>API Server 网络隔离的设计</h3><p>API Server Network Proxy的核心设计思想是将API Server放置在一个独立的网络中，与Node节点的网络相互隔离，然后增加独立的Network Proxy进程来解决这两个网络直接连通性（connectivity）问题<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678628838762-f2382760-d33f-4577-b39d-d543147e6b91.png#averageHue=%23dddfdb&clientId=uc9ee8b99-05f1-4&from=paste&height=312&id=u2cdc92b0&name=image.png&originHeight=624&originWidth=856&originalType=binary&ratio=2&rotation=0&showTitle=false&size=621854&status=done&style=none&taskId=u208d79b7-3483-4633-9c0a-31950553fc5&title=&width=428" srcset="/img/loading.gif" lazyload alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678629226854-88c0a5e0-3d8e-4c0c-9a00-5341252a4f3e.png#averageHue=%23edeeec&clientId=uc9ee8b99-05f1-4&from=paste&height=363&id=u646f79cb&name=image.png&originHeight=726&originWidth=1308&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1350750&status=done&style=none&taskId=ubb7ed8b4-551a-4c0a-92f6-0f10bce7e7c&title=&width=654" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="Controller-Manager-原理解析"><a href="#Controller-Manager-原理解析" class="headerlink" title="Controller Manager 原理解析"></a>Controller Manager 原理解析</h2><p>一般来说，智能系统和自动系统通常会通过一个“操作系统”不断修正系统的工作状态。在Kubernetes 集群中，每个 Controller 都是这样的一个“操作系统”，它们通过 API Server提供的 (List-Watch）接口实时监控集群中特定资源的状态变化，当发生各种故障导致某资源对象的状态变化时，Controller 会尝试将其状态调整为期望的状态。比如当某个 Node意外宕机时，Node Controller 会及时发现此故障并执行自动化修复流程，确保集群始终处手预期的工作状态下。Controller Manager 是 Kubernetes 中各种操作系统的管理者，是集群内部的管理控制中心，也是Kubernetes 自动化功能的核心。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678629339918-02def809-c50c-402b-be02-c6a0f1ff9a15.png#averageHue=%239b9e9a&clientId=uc9ee8b99-05f1-4&from=paste&height=211&id=uf295ab08&name=image.png&originHeight=422&originWidth=804&originalType=binary&ratio=2&rotation=0&showTitle=false&size=610692&status=done&style=none&taskId=u81c72dd9-478c-407e-bfd7-0032b518386&title=&width=402" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<ul>
<li>确保在当前集群中有N个Pod实例，N是在RC中定义的Pod副本数量</li>
<li>通过调整spec.replicas属性的值来实现系统扩容或者缩容</li>
<li>通过改变Pod模板（主要是镜像版本）来实现系统的滚动升级</li>
</ul>
<h3 id="Node-Controller"><a href="#Node-Controller" class="headerlink" title="Node Controller"></a>Node Controller</h3><p>kubelet进程在启动时通过API Server注册自身节点信息，并定时向API Server汇报状态信息，API Server在接收这些信息后会将这些信息更新到ETCD中。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678630411858-e02ec2a7-9f60-4b32-87df-9ab9a4b5c550.png#averageHue=%23f5f6f4&clientId=uc9ee8b99-05f1-4&from=paste&height=386&id=u286a65cf&name=image.png&originHeight=772&originWidth=1240&originalType=binary&ratio=2&rotation=0&showTitle=false&size=776945&status=done&style=none&taskId=ue30ac66a-8a6e-4e8a-ba02-4bab940c2c9&title=&width=620" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="ResourceQuota-Controller"><a href="#ResourceQuota-Controller" class="headerlink" title="ResourceQuota Controller"></a>ResourceQuota Controller</h3><p>资源配额管理确保指定的资源对象在任何时候都不会超量占用系统物理资源，避免由于某些业务进程在设计或实现上的缺陷导致整个系统紊乱甚至意外宕机。</p>
<p>k8s支持三个层次的资源配额管理</p>
<ul>
<li>容器级别，可以对CPU和Memory进行限制</li>
<li>Pod级别，可以对一个Pod内所有的容器的资源进行限制</li>
<li>Namespace级别，为Namespace级别的资源限制，包括：Pod数量、RC数量、Service数量等</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678631855225-a24e7189-9bbd-4482-820c-f9eb8b88b0c0.png#averageHue=%23fcfcfc&clientId=uc9ee8b99-05f1-4&from=paste&height=438&id=u8c05680c&name=image.png&originHeight=876&originWidth=1288&originalType=binary&ratio=2&rotation=0&showTitle=false&size=666081&status=done&style=none&taskId=uee040d04-cda3-4eaf-bf6a-ef61243c207&title=&width=644" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="Namespace-Controller"><a href="#Namespace-Controller" class="headerlink" title="Namespace Controller"></a>Namespace Controller</h3><p>用户通过API Server可以创建新的Namespace并将其保存在etcd中，Namespace Controller定时通过API Server读取这些Namespace的信息。</p>
<h3 id="Service-Controller-与-Endpoints-Controller"><a href="#Service-Controller-与-Endpoints-Controller" class="headerlink" title="Service Controller 与 Endpoints Controller"></a>Service Controller 与 Endpoints Controller</h3><h2 id="Scheduler原理解析"><a href="#Scheduler原理解析" class="headerlink" title="Scheduler原理解析"></a>Scheduler原理解析</h2><p>Kubernetes scheduler是复制Pod调度的进程（组件）</p>
<h3 id="Scheduler调度流程"><a href="#Scheduler调度流程" class="headerlink" title="Scheduler调度流程"></a>Scheduler调度流程</h3><p>将待调度的Pod（API 新创建的Pod、Controller Manager为补足副本而创建的Pod等）按照特定的调度算法和调度策略绑定（Bingding）到集群中某个合适的Node上，并将绑定信息写入etcd中。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678632406268-e6d6b5b0-5791-4892-b25d-a51a66132b6e.png#averageHue=%23f7f7f6&clientId=uc9ee8b99-05f1-4&from=paste&height=323&id=u99da70a8&name=image.png&originHeight=646&originWidth=1056&originalType=binary&ratio=2&rotation=0&showTitle=false&size=610171&status=done&style=none&taskId=u4843cbf9-da29-450c-be58-9c3fc63774b&title=&width=528" srcset="/img/loading.gif" lazyload alt="image.png"><br>scheduler只能API Server打交道</p>
<ul>
<li>输入：待调度的Pod和全部计算节点的信息</li>
<li>输出：目标Pod要“安家”的最优节点</li>
</ul>
<ul>
<li>过滤阶段：遍历所有目标Node，筛选出符合要求的候选节点。</li>
<li>打分阶段：在过滤阶段的基础上，采用优选策略计算出每个节点积分，挑选出最佳节点后Scheduler会把目标Pod安置到此节点上，调度完成。</li>
</ul>
<h3 id="Scheduler-Framework"><a href="#Scheduler-Framework" class="headerlink" title="Scheduler Framework"></a>Scheduler Framework</h3><p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678632993941-7e177821-99e3-414f-86ec-c6b3201df5fa.png#averageHue=%23e9eae8&clientId=uc9ee8b99-05f1-4&from=paste&height=336&id=u9032eeab&name=image.png&originHeight=672&originWidth=1324&originalType=binary&ratio=2&rotation=0&showTitle=false&size=975032&status=done&style=none&taskId=u0f7a1e18-2363-4601-a0ec-1091e7912f8&title=&width=662" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="多调度器特性"><a href="#多调度器特性" class="headerlink" title="多调度器特性"></a>多调度器特性</h3><p>Kubernetes自带一个默认调度器，从1.2版本开始引入自定义调度器的特征，支持用户实现的自定义调度器，多个自定义调度器可以与默认的调度器同时运行。</p>
<h2 id="kubelet运行机制解析"><a href="#kubelet运行机制解析" class="headerlink" title="kubelet运行机制解析"></a>kubelet运行机制解析</h2><p>在Kubernetes集群的每个ndoe上都会启动一个kubelet服务进程，该进程用于处理Master下发到本节点的任务，管理Pod及Pod中的容器。每个kubelet进程都会在API Server上注册节点自身的信息，定期向Master汇报节点资源的使用情况，并通过cAdvisor监控容器和节点资源。</p>
<h3 id="节点管理"><a href="#节点管理" class="headerlink" title="节点管理"></a>节点管理</h3><p>通过控制启动参数“–register-node”来决定是否想API Server注册自己</p>
<ul>
<li>–api-servsers：API Server的位置</li>
<li>–kubeconfig：kubeconfig文件，用于访问API Server的安全配置文件</li>
<li>–coud-provider：云服务商（Iaas）地址，仅用于公有云环境中。</li>
</ul>
<h3 id="Pod管理"><a href="#Pod管理" class="headerlink" title="Pod管理"></a>Pod管理</h3><p>kubelet通过以下方式获取在自身Node上要运行的Pod清单</p>
<ul>
<li><p>静态Pod配置文件：kubelet通过启动参数–config指定目录下的Pod YAML文件（默认目录为/etc/kubernetes/manifests/）,kubelet会持续监控指定目录下的文件变化，以创建和删除Pod。</p>
</li>
<li><p>HTTP端点（URL）：通过–manifest-url参数配置，通过–http-check-frequency设置检查该HTTP端点数据的时间间隔，默认为20s。</p>
</li>
<li><p>API Server：kubelet通过API Server监听etcd目录，同步Pod列表</p>
</li>
</ul>
<blockquote>
<p>所有以非API Server方式创建的Pod都叫做 static Pod</p>
</blockquote>
<h3 id="容器健康检查"><a href="#容器健康检查" class="headerlink" title="容器健康检查"></a>容器健康检查</h3><p>Pod通过两类探针来检测容器的健康状态</p>
<ul>
<li>LivenessProbe探针，用于判断容器是否健康并反馈给kubelet，如果LivenessProbe探针探测到容器不健康，则kubelet将删除该容器，并根据容器的重启策略做相应处理。</li>
<li>ReadinessProbe探针，用于判断容器是否启动完成，且准备接收请求，如果ReadinessProbe探测到容器启动失败，则Pod的状态将被修改，Endpoint Controller将从Service的Endpoint中删除包含该容器所在的Pod的IP地址的Endpoint条目。</li>
</ul>
<p>LivenessProbe三种实现方式：</p>
<ul>
<li>ExecAction：在容器内部运行一个命令，如果该命令的退出状态位0，则表明容器健康</li>
<li>TCPSocketAction：通过容器的IP地址和端口号执行TCP检查，如果端口能被访问，则表明容器健康。</li>
<li>HTTPGetAction：通过容器的IP地址和端口号及路径调用HTTP Get方法，如果响应的状态码大于或等于200且小于或等于400，则认为容器健康。</li>
</ul>
<h3 id="5-4-4-cAdvisor资源监控"><a href="#5-4-4-cAdvisor资源监控" class="headerlink" title="5.4.4 cAdvisor资源监控"></a>5.4.4 cAdvisor资源监控</h3><p>cAdvisor是一个开源的分析容器资源使用率和性能特性的代理工具，在4194端口提供简单UI和API服务，在1.12完全弃用，1.8版本后提供标准的Metrics API，Metrics Server用于提供Core Metrics（指标核心），包括Node和Pod的CPU和内存使用数据。其他自定义指标则通过第三方组件（如prometheus）采集和存储。</p>
<h3 id="5-4-5-容器运行时"><a href="#5-4-5-容器运行时" class="headerlink" title="5.4.5 容器运行时"></a>5.4.5 容器运行时</h3><p>容器技术最早来着Linux，所以又被称为Linux Container。LXC项目是一个Linux容器的工具集，也是真正意义上的一个Container Runtime，他的作用就是将用户的进程包装成一个Linux容器并启动运行。</p>
<p>Docker最早是基于LXC，后面自研Libcontainer，改名为runc，再后来为Kubernetes设计了containerd。</p>
<p>类似的还有红帽开源的CRI-O，openEuler社区开源的iSula等，这些container runtime还有一个共同特点就是都实现了Kubernetes提出的CRI接口规范，可直接接入Kubernetes。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678718033156-ac304d4e-a8d8-4004-a056-96a65b0da11f.png#averageHue=%23d2d3d1&clientId=u74c77042-3aec-4&from=paste&height=229&id=uc46011e9&name=image.png&originHeight=458&originWidth=1192&originalType=binary&ratio=2&rotation=0&showTitle=false&size=559168&status=done&style=none&taskId=u08c62405-94bd-4c14-b51c-4c5e2a04a74&title=&width=596" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="5-5-kube-proxy-运行机制解析"><a href="#5-5-kube-proxy-运行机制解析" class="headerlink" title="5.5 kube-proxy 运行机制解析"></a>5.5 kube-proxy 运行机制解析</h2><p>为了支持集群的水平拓展和高可用性，Kubernetes抽象出了Service的概念。Service是对一组Pod的抽象，它会根据访问策略（如负载均衡策略）来访问这组Pod。</p>
<p>Kubernetes在创建服务时会为服务分配一个虚拟IP地址，客户端通过访问这个虚拟IP来访问服务，服务则负责将请求转发到后端的Pod上。这其实就是一个反向代理，但与普通的反向代理有一些不同：他的IP地址是虚拟，若想从外面访问则需要一些技巧；它的部署和启动是由Kubernetes统一自动管理的。</p>
<h3 id="5-5-1-第一代-Proxy"><a href="#5-5-1-第一代-Proxy" class="headerlink" title="5.5.1 第一代 Proxy"></a>5.5.1 第一代 Proxy</h3><p>起初，kube-Proxy进程是一个真实的TCP/UDP代理，类似HA Proxy，负责转发从Service到Pod的访问流量，这被称为userspace（用户空间代理）模式。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678718911390-bdfdee4d-175f-40d7-a566-9e92074cd209.png#averageHue=%23f1f1ef&clientId=u74c77042-3aec-4&from=paste&height=335&id=uba00c114&name=image.png&originHeight=670&originWidth=868&originalType=binary&ratio=2&rotation=0&showTitle=false&size=645111&status=done&style=none&taskId=u54d966af-3223-4847-b86f-60191d08f81&title=&width=434" srcset="/img/loading.gif" lazyload alt="image.png"><br>起初，kube-proxy 进程是一个真实的 TCP/UDP 代理，类似 HA Proxy，负责转发从Service 到Pod 的访问流量，这被称为 userspace（用户空间代理）模式。如图5.17所示，当某个客户端Pod 以ClusterIP 地址访问某个Service 时，这个流量就被 Pod 所在 Node的<br>iptables 转发给 kube-proxy 进程，然后由 kube-proxy建立起到后端 Pod 的 TCP/UDP连接，再将请求转发到某个后端 Pod 上，并在这个过程中实现负载均衡功能。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678720239834-e6bfcdfb-d089-4fd7-945f-91ef963dc151.png#averageHue=%23f0f0ef&clientId=u74c77042-3aec-4&from=paste&height=401&id=u1e9849a4&name=image.png&originHeight=802&originWidth=1288&originalType=binary&ratio=2&rotation=0&showTitle=false&size=1194663&status=done&style=none&taskId=ua1dcad9e-28df-490c-a1ad-fd132f91d4c&title=&width=644" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="5-5-2-第二代Proxy"><a href="#5-5-2-第二代Proxy" class="headerlink" title="5.5.2 第二代Proxy"></a>5.5.2 第二代Proxy</h3><p>从1.2版本开始，Kubernetes将iptables作为kube-Proxy的默认模式，其工作原理<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678721050355-817eab61-51a6-440a-92bd-cccd3954d1e3.png#averageHue=%23e9eae7&clientId=u74c77042-3aec-4&from=paste&height=243&id=u1936893e&name=image.png&originHeight=486&originWidth=678&originalType=binary&ratio=2&rotation=0&showTitle=false&size=233770&status=done&style=none&taskId=ud148c641-e55b-49e8-91d6-2a9efa707f6&title=&width=339" srcset="/img/loading.gif" lazyload alt="image.png"><br>根据 Kubernetes 的网络模型，一个Node上的Pod与其他Node 上的Pod 应该能够直<br>接建立双向的ICP/IP通信通道，所以如果直接修改 iptables 规则，则也可以实现 kube-proxy的功能，只不过后者更加高端，因为是全自动模式的。与第一代的 userspace 模式相比，iptables 模式完全工作在内核态，不用再经过用户态的kube-proxy 中转，因而性能更强。</p>
<h3 id="5-5-2-第三代-Proxy"><a href="#5-5-2-第三代-Proxy" class="headerlink" title="5.5.2 第三代 Proxy"></a>5.5.2 第三代 Proxy</h3><p>第二代的iptables模式实现简单，性能也高，但是存在的缺点是当Service和Pod的数量过多时，每个节点上的iptables上的规则中的规则会急速膨胀，导致网络性能下降。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678722160630-c2599712-e60e-4c3e-900a-8c24ebd11cd0.png#averageHue=%23f4f4f3&clientId=u74c77042-3aec-4&from=paste&height=241&id=ucd38bf0f&name=image.png&originHeight=482&originWidth=668&originalType=binary&ratio=2&rotation=0&showTitle=false&size=381096&status=done&style=none&taskId=udff75811-8419-4db7-829a-32aafa9b484&title=&width=334" srcset="/img/loading.gif" lazyload alt="image.png"><br>1.8版本引入了IPVS（IP Virtual Server）模式，iptables与IPVS虽然都是基于 Netfilter实现的但是因为定位不同，二者有着本质上的区别，iptables是为防火墙设计的，IPVS是用于高性能负载均衡，并且使用了更高效的数据结构（哈希表），允许几乎无限的规模扩张。</p>
<p>优势：</p>
<ol>
<li>为大型集群提供了更好的可扩展性和性能；</li>
<li>支持比 iptables 更复杂的复制均衡算法（最小负载、最少连接、加权等)；</li>
<li>支持服务器健康检查和连接重试等功能；</li>
<li>可以动态修改 ipset 的集合，即使 iptables 的规则正在使用这个集合。</li>
</ol>
<h1 id="6-深入分析集群安全机制"><a href="#6-深入分析集群安全机制" class="headerlink" title="6.深入分析集群安全机制"></a>6.深入分析集群安全机制</h1><ol>
<li>保证容器与其所在宿主机的隔离 </li>
<li>限制容器给基础设施或其他容器带来的干扰 </li>
<li>最小权限原则，即合理限制所有组件的权限，确保组件只执行它被授权的行为， </li>
<li>通过限制单个组件的能力来限制它的权限范围 </li>
<li>明确组件间边界的划分 </li>
<li>划分普通用户和管理员的角色 </li>
<li>在必要时允许将管理员权限赋给普通用户 </li>
<li>允许拥有 Secret 数据 (Keys Certs Passwords) 的应用在集群中运行</li>
</ol>
<h2 id="6-1-API-Server-认证管理"><a href="#6-1-API-Server-认证管理" class="headerlink" title="6.1 API Server 认证管理"></a>6.1 API Server 认证管理</h2><p>Kubernetes有两种类型账号，一种是集群内部的ServiceAccount，另一种是外部用户账号。Kubernetes并不支持常规的个人账号，但拥有被Kubernetes集群的CA证书签名的有效整数，个人用户就可以被授权访问Kubernetes集群。</p>
<ul>
<li>以证书方式访问普通用户或进程，包括运维人员及kubectl、kubelets等进程</li>
<li>以Service Account方式访问Kubernetes的内部服务进程</li>
<li>以匿名方式访问的进程</li>
</ul>
<p>Kubernetes集群提供以下用户身份认证方式</p>
<ul>
<li>HTTPS证书认证：基于CA根证书签名的双向数字证书认证方式</li>
<li>HTTP Bearer Token认证：</li>
<li>OpenID Connect Token：</li>
<li>Wehook Token：</li>
<li>Authentication Proxy认证：</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/2630542/1678797484794-38e629ac-9415-4822-a3ff-303f39fb0b51.png#averageHue=%23f5f6f4&clientId=u74c77042-3aec-4&from=paste&height=269&id=u17fd651a&name=image.png&originHeight=538&originWidth=740&originalType=binary&ratio=2&rotation=0&showTitle=false&size=377492&status=done&style=none&taskId=ud6b3bdd4-f2f1-4875-a72a-fd8d582a5f1&title=&width=370" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h2 id="6-2-API-Server-授权管理"><a href="#6-2-API-Server-授权管理" class="headerlink" title="6.2 API Server 授权管理"></a>6.2 API Server 授权管理</h2><p>API Server目前支持以下授权</p>
<ul>
<li>AlwaysDeny：表示拒绝所有请求，仅用于测试</li>
<li>AlwaysAllow：允许接收所有请求，如果集群不需要授权流程，则可以采用该策略</li>
<li>ABAC：基于属性的权限控制</li>
<li>RBAC：基于角色的权限控制</li>
<li>Webhook：通过调用外部的REST服务对授权进行授权</li>
<li>Node：是对一种kubelet进行授权的特殊模式<blockquote>
<p>可以在API Server的启动参数 –authorization-mode 可配置多种授权策略，逗号分割</p>
</blockquote>
</li>
</ul>
<h2 id="6-3-Admission-Control"><a href="#6-3-Admission-Control" class="headerlink" title="6.3 Admission Control"></a>6.3 Admission Control</h2><blockquote>
<p>突破认证和鉴权两道关卡后，还需要通过admission control（准入控制）所控制的一个准入控制链。</p>
</blockquote>
<h2 id="6-4-Service-Account"><a href="#6-4-Service-Account" class="headerlink" title="6.4 Service Account"></a>6.4 Service Account</h2><blockquote>
<p>Service Account是提供给运行在Pod里的进程用的的，为Pod里的进程提供了必要身份证明。</p>
</blockquote>
<p>其主要原理是类似于在请求头中添加了Token字符串，该字符串来自Pod里指定路径下的一个文件（/run/secrets/kubernetes.io/serviceaccount/token）,该token是动态生成的，是由Kubernetes Controller进程用API Server的私钥（–service-account-private-file指定的私钥）签名生成的一个JWT Secret。</p>
<h2 id="6-5-Secret-私密凭据"><a href="#6-5-Secret-私密凭据" class="headerlink" title="6.5 Secret 私密凭据"></a>6.5 Secret 私密凭据</h2><blockquote>
<p>secret主要作用是保管私密数据，如密码、OAuth Token、SSH Keys等信息。</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mysecret</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">password:</span> <span class="hljs-string">dmFsdWUtMg0K</span><br>  <span class="hljs-attr">username:</span> <span class="hljs-string">dmFsdWUtMQ0K</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mypod</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">myns</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">containers:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mycontainer</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">volumeMounts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">foo</span><br>      <span class="hljs-attr">mountPath:</span> <span class="hljs-string">&quot;/etc/foo&quot;</span><br>      <span class="hljs-attr">readOnly:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">volumes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">foo</span><br>    <span class="hljs-attr">secret:</span><br>      <span class="hljs-attr">secretName:</span> <span class="hljs-string">mysecret</span><br></code></pre></td></tr></table></figure>

<h2 id="6-6-Pod-安全策略"><a href="#6-6-Pod-安全策略" class="headerlink" title="6.6 Pod 安全策略"></a>6.6 Pod 安全策略</h2><h1 id="7-网络原理"><a href="#7-网络原理" class="headerlink" title="7.网络原理"></a>7.网络原理</h1><h2 id="7-1-Kubernetes-网络模型"><a href="#7-1-Kubernetes-网络模型" class="headerlink" title="7.1 Kubernetes 网络模型"></a>7.1 Kubernetes 网络模型</h2><blockquote>
<p>每个Pod都拥有一个独立的IP地址，并假设所有Pod都在一个可以直接连通的、扁平的网络空间中。</p>
</blockquote>
<blockquote>
<p>实际上，在Kubernetes 世界里，卫是以Pod 为单位进行分配的。一个Pod 内部的所有容器共享一个网络堆栈（相当于一个网络命名空间，它们的工P地址、网络设备、配置等都是共享的）。按照这个网络原则抽象出来的为每个Pod 都设置一个I地址的模型也被称作 IP-per-Pod 模型。</p>
</blockquote>
<h1 id="8-共享存储原理"><a href="#8-共享存储原理" class="headerlink" title="8.共享存储原理"></a>8.共享存储原理</h1><h1 id="9-Kubernetes开发指南"><a href="#9-Kubernetes开发指南" class="headerlink" title="9.Kubernetes开发指南"></a>9.Kubernetes开发指南</h1><h1 id="10-Kubernetes集群管理"><a href="#10-Kubernetes集群管理" class="headerlink" title="10.Kubernetes集群管理"></a>10.Kubernetes集群管理</h1><h1 id="11-Trouble-Shooting指导"><a href="#11-Trouble-Shooting指导" class="headerlink" title="11.Trouble Shooting指导"></a>11.Trouble Shooting指导</h1><h1 id="12-Kubernetes开发中的新功能"><a href="#12-Kubernetes开发中的新功能" class="headerlink" title="12.Kubernetes开发中的新功能"></a>12.Kubernetes开发中的新功能</h1><h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ol>
<li>《Kubernetes权威指南》第四版</li>
<li>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1gnLAIg_M7m-4MwTSCA6U0Q?pwd=a6m2">https://pan.baidu.com/s/1gnLAIg_M7m-4MwTSCA6U0Q?pwd=a6m2</a> 提取码: a6m2 </li>
<li></li>
</ol>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="category-chain-item">读书笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Kubernetes/">#Kubernetes</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>云原生篇-Kubernetes权威指南</div>
      <div>https://mikeygithub.github.io/2021/05/22/yuque/bbm2v9/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Mikey</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年5月22日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/05/23/yuque/sby23l/" title="读书笔记-费曼学习法">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">读书笔记-费曼学习法</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/05/19/yuque/zzlqli/" title="读书笔记篇-Java并发编程实战">
                        <span class="hidden-mobile">读书笔记篇-Java并发编程实战</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'mikeygithub/commit-utterance');
      s.setAttribute('issue-term', 'pathname');
      
      s.setAttribute('label', 'utterances');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  





  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.13.10/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});
  });
</script>




  <!-- Custom -->
  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <img src="https://octodex.github.com/images/jetpacktocat.png" srcset="/img/loading.gif" lazyload class="rounded mx-auto d-block mt-5" style="width:150px; height:150px;">
    </div>
  </div>


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       Copyright © 麦奇 Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> and <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> core on github page 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      桂ICP备2020009931号-1
    </a>
  </span>
  
    
      <span>
        <a
          href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=2020009931"
          rel="nofollow noopener"
          class="beian-police"
          target="_blank"
        >
          
            <span style="visibility: hidden; width: 0">|</span>
            <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
          
          <span>桂公网安备2020009931号</span>
        </a>
      </span>
    
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?74301a15e5497361e93588eeee69f4b2";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        MathJax = {
          tex    : {
            inlineMath: { '[+]': [['$', '$']] }
          },
          loader : {
            load: ['ui/lazy']
          },
          options: {
            renderActions: {
              findScript    : [10, doc => {
                document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
                  const display = !!node.type.match(/; *mode=display/);
                  const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                  const text = document.createTextNode('');
                  node.parentNode.replaceChild(text, node);
                  math.start = { node: text, delim: '', n: 0 };
                  math.end = { node: text, delim: '', n: 0 };
                  doc.math.push(math);
                });
              }, '', false],
              insertedScript: [200, () => {
                document.querySelectorAll('mjx-container').forEach(node => {
                  let target = node.parentNode;
                  if (target.nodeName.toLowerCase() === 'li') {
                    target.parentNode.classList.add('has-jax');
                  }
                });
              }, '', false]
            }
          }
        };
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.0/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
