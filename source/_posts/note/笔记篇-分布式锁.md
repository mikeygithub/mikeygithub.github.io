---
title: 笔记篇-分布式锁的实现
index_img: 'https://cdn.jsdelivr.net/gh/mikeygithub/jsDeliver@master/resource/img/fbss.jpeg'
hide: false
date: 2021-04-04 21:12:46
category: 笔记
tags: 分布式锁
---

# 什么是分布式锁

>分布式锁是为了解决在不同机器上的应用仍能保证资源访问的有序性。当多个进程不在同一个系统中，就需要用分布式锁控制多个进程对资源的访问。

# 实现方式

>目前实现的方式有基于MySQL、基于Redis、基于Zookeeper

# 基于MySQL

## 基于表记录实现

>通过对数据库表设计时对其做唯一约束，需要加锁进行添加记录，释放锁将记录进行删除。

```sql
CREATE TABLE `database_lock` (
	`id` BIGINT NOT NULL AUTO_INCREMENT,
	`resource` int NOT NULL COMMENT '锁定的资源',
	`description` varchar(1024) NOT NULL DEFAULT "" COMMENT '描述',
	PRIMARY KEY (`id`),
	UNIQUE KEY `uiq_idx_resource` (`resource`) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据库分布式锁表';
```
需要获取锁时对数据表进行插入数据
```sql
INSERT INTO database_lock(resource, description) VALUES (1, 'lock');
```
释放锁时将记录进行删除
```sql
DELETE FROM database_lock WHERE resource=1;
```
## 基于乐观锁实现

>乐观锁的思想就是获取锁的时候并不进行判断，而是在更新的时候对其获取时的版本号进行对比，如果一致则进行更新。

```sql
CREATE TABLE `optimistic_lock` (
	`id` BIGINT NOT NULL AUTO_INCREMENT,
	`resource` int NOT NULL COMMENT '锁定的资源',
	`version` int NOT NULL COMMENT '版本信息',
	`created_at` datetime COMMENT '创建时间',
	`updated_at` datetime COMMENT '更新时间',
	`deleted_at` datetime COMMENT '删除时间', 
	PRIMARY KEY (`id`),
	UNIQUE KEY `uiq_idx_resource` (`resource`) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据库分布式锁表';
```

```sql
INSERT INTO optimistic_lock(resource, version, created_at, updated_at) VALUES(20, 1, CURTIME(), CURTIME());
```

STEP1 - 获取资源： `SELECT resource, version FROM optimistic_lock WHERE id = 1`
STEP2 - 执行业务逻辑
STEP3 - 更新资源：`UPDATE optimistic_lock SET resource = resource -1, version = version + 1 WHERE id = 1 AND version = oldVersion`

## 基于悲观锁实现

>

关闭事务自动提交
```sql
mysql> SET AUTOCOMMIT = 0;
Query OK, 0 rows affected (0.00 sec)
```

STEP1 - 获取锁：`SELECT * FROM database_lock WHERE id = 1 FOR UPDATE;`。
STEP2 - 执行业务逻辑。
STEP3 - 释放锁：COMMIT。

```sql
SELECT * FROM database_lock WHERE description='lock' FOR UPDATE;
```

# 基于Redis实现

## 加锁

>加锁实际上就是在redis中，给Key键设置一个值，为避免死锁，并给定一个过期时间。

`SET lock_key random_value NX PX 5000`

`random_value` 是客户端生成的唯一的字符串。
`NX` 代表只在键不存在时，才对键进行设置操作。
`PX 5000` 设置键的过期时间为5000毫秒。


# 基于Zookeeper实现

## 原理

## Curator介绍

> Curator是一个zookeeper的开源客户端，也提供了分布式锁的实现。他的使用方式也比较简单：

导入依赖

```xml
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-recipes</artifactId>
    <version>4.0.0</version>
    <exclusions>
        <exclusion>
            <groupId>org.apache.zookeeper</groupId>
            <artifactId>zookeeper</artifactId>
        </exclusion>
    </exclusions>
</dependency>
<dependency>
    <groupId>org.apache.zookeeper</groupId>
    <artifactId>zookeeper</artifactId>
    <version>3.4.7</version>
</dependency>
```

# 参考资料

[三种实现分布式锁的方式](https://www.cnblogs.com/liuqingzheng/p/11080501.html)

[分布式锁用 Redis 还是 Zookeeper](https://zhuanlan.zhihu.com/p/163224180?utm_source=wechat_session)

[基于zookeeper实现分布式锁](https://blog.csdn.net/sunfeizhi/article/details/51926396)


 